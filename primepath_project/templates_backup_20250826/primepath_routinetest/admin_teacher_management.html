{% extends "routinetest_base.html" %}
{% load static %}
{% load admin_filters %}

{% block title %}Teacher Access Management - Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* COMPREHENSIVE TEACHER ACCESS MANAGEMENT DASHBOARD STYLES */
    
    /* Main Container */
    .teacher-mgmt-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    /* Header Section */
    .mgmt-header {
        background: linear-gradient(135deg, #1B5E20 0%, #2E7D32 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .mgmt-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
    }
    
    .mgmt-header p {
        margin: 8px 0 0 0;
        opacity: 0.9;
        font-size: 16px;
    }
    
    /* View Mode Navigation */
    .view-mode-nav {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e0e0e0;
    }
    
    .view-mode-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .view-mode-btn {
        padding: 12px 24px;
        border: 2px solid #dee2e6;
        background: white;
        color: #495057;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .view-mode-btn:hover {
        border-color: #2E7D32;
        background: #E8F5E9;
        text-decoration: none;
        color: #1B5E20;
    }
    
    .view-mode-btn.active {
        background: #2E7D32;
        border-color: #2E7D32;
        color: white;
    }
    
    /* Analytics Cards */
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .analytics-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e0e0e0;
        text-align: center;
    }
    
    .analytics-card .number {
        font-size: 32px;
        font-weight: 700;
        color: #1B5E20;
        margin-bottom: 8px;
    }
    
    .analytics-card .label {
        font-size: 14px;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 500;
    }
    
    .analytics-card.highlight .number {
        color: #2E7D32;
    }
    
    .analytics-card.warning .number {
        color: #e74c3c;
    }
    
    .analytics-card.success .number {
        color: #00A65E;
    }
    
    /* Content Sections */
    .content-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e0e0e0;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .section-title {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
        color: #1B5E20;
    }
    
    /* Teacher Directory Styles */
    .teacher-directory-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }
    
    .teacher-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        background: #f8f9fa;
        transition: all 0.2s;
    }
    
    .teacher-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .teacher-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 16px;
    }
    
    .teacher-name {
        font-size: 16px;
        font-weight: 600;
        color: #1B5E20;
        margin: 0;
    }
    
    .teacher-meta {
        text-align: right;
        font-size: 12px;
        color: #6c757d;
    }
    
    .global-access-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
        margin-top: 4px;
    }
    
    .global-access-badge.full {
        background: #d4edda;
        color: #155724;
    }
    
    .global-access-badge.view {
        background: #fff3cd;
        color: #856404;
    }
    
    .teacher-classes {
        margin-top: 16px;
    }
    
    .class-assignment {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: white;
        border-radius: 6px;
        margin-bottom: 6px;
        border: 1px solid #e9ecef;
    }
    
    .class-name {
        font-size: 13px;
        color: #495057;
        font-weight: 500;
    }
    
    .access-level-badge {
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .access-level-badge.full {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .access-level-badge.view {
        background: #f8d7da;
        color: #721c24;
    }
    
    /* Class Directory Styles */
    .class-directory-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 20px;
    }
    
    .class-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        background: #f8f9fa;
        transition: all 0.2s;
    }
    
    .class-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .class-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 16px;
    }
    
    .class-name-display {
        font-size: 16px;
        font-weight: 600;
        color: #1B5E20;
        margin: 0;
    }
    
    .class-stats {
        text-align: right;
        font-size: 12px;
        color: #6c757d;
    }
    
    .teacher-count-badge {
        display: inline-block;
        background: #2E7D32;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        margin-top: 4px;
    }
    
    .teacher-count-badge.zero {
        background: #e74c3c;
    }
    
    .teacher-count-badge.multi {
        background: #00A65E;
    }
    
    .class-teachers {
        margin-top: 16px;
    }
    
    .teacher-assignment {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: white;
        border-radius: 6px;
        margin-bottom: 6px;
        border: 1px solid #e9ecef;
    }
    
    /* Matrix View Styles */
    .matrix-container {
        overflow-x: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: white;
    }
    
    .matrix-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    
    .matrix-table th,
    .matrix-table td {
        padding: 8px;
        text-align: center;
        border: 1px solid #e9ecef;
        font-size: 12px;
    }
    
    .matrix-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .matrix-table .teacher-name-col {
        background: #f8f9fa;
        font-weight: 500;
        text-align: left;
        position: sticky;
        left: 0;
        z-index: 5;
        min-width: 150px;
    }
    
    .matrix-cell {
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    
    .matrix-cell:hover {
        background: #e9ecef;
    }
    
    .matrix-cell.has-access {
        background: #d4edda;
        color: #155724;
    }
    
    .matrix-cell.no-access {
        background: #f8d7da;
        color: #721c24;
    }
    
    .matrix-cell.full-access {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .btn-primary-custom {
        background: #2E7D32;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary-custom:hover {
        background: #1B5E20;
        text-decoration: none;
        color: white;
    }
    
    .btn-secondary-custom {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-secondary-custom:hover {
        background: #545b62;
        text-decoration: none;
        color: white;
    }
    
    .btn-danger-custom {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .btn-danger-custom:hover {
        background: #c0392b;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .modal-title {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: #1B5E20;
    }
    
    .close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    
    .close:hover {
        color: #495057;
    }
    
    /* Form Styles */
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
    }
    
    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #2E7D32;
        box-shadow: 0 0 0 3px rgba(46,125,50,0.1);
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .empty-state h3 {
        margin-bottom: 12px;
        color: #495057;
    }
    
    /* Loading States */
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .loading::after {
        content: '';
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #e9ecef;
        border-radius: 50%;
        border-top: 2px solid #2E7D32;
        animation: spin 1s linear infinite;
        margin-left: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .teacher-mgmt-container {
            padding: 10px;
        }
        
        .mgmt-header {
            padding: 20px;
        }
        
        .view-mode-buttons {
            flex-direction: column;
        }
        
        .analytics-grid {
            grid-template-columns: 1fr;
        }
        
        .teacher-directory-grid,
        .class-directory-grid {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .modal-content {
            margin: 10% auto;
            width: 95%;
            padding: 20px;
        }
    }
    
    /* Console Debug Indicator */
    .debug-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #00A65E;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        z-index: 1000;
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block content %}
<div class="teacher-mgmt-container">
    
    <!-- Header Section -->
    <div class="mgmt-header">
        <h1>üéì Teacher Access Management Dashboard</h1>
        <p>Comprehensive teacher-class assignment management with multi-teacher support</p>
        <div style="margin-top: 15px; font-size: 14px; opacity: 0.8;">
            <span>Admin: {{ user.username }}</span>
            <span style="margin-left: 20px;">{{ timestamp|date:"M j, Y g:i A" }}</span>
            <span style="margin-left: 20px;">Rendered in {{ render_time }}</span>
        </div>
    </div>
    
    <!-- View Mode Navigation -->
    <div class="view-mode-nav">
        <div class="view-mode-buttons">
            <a href="?view=overview" class="view-mode-btn {% if view_mode == 'overview' %}active{% endif %}">
                <span>üìä</span>
                <span>Overview</span>
            </a>
            <a href="?view=teachers" class="view-mode-btn {% if view_mode == 'teachers' %}active{% endif %}">
                <span>üë®‚Äçüè´</span>
                <span>Teacher Directory</span>
            </a>
            <a href="?view=classes" class="view-mode-btn {% if view_mode == 'classes' %}active{% endif %}">
                <span>üè´</span>
                <span>Class Directory</span>
            </a>
            <a href="?view=matrix" class="view-mode-btn {% if view_mode == 'matrix' %}active{% endif %}">
                <span>üéØ</span>
                <span>Matrix View</span>
            </a>
            <a href="?view=requests" class="view-mode-btn {% if view_mode == 'requests' %}active{% endif %}">
                <span>üìã</span>
                <span>Access Requests</span>
                {% if pending_requests.count > 0 %}
                <span style="background: #dc3545; color: white; border-radius: 10px; padding: 2px 8px; font-size: 11px; margin-left: 4px;">{{ pending_requests.count }}</span>
                {% endif %}
            </a>
        </div>
    </div>
    
    <!-- Analytics Dashboard (Overview Mode) -->
    {% if view_mode == 'overview' %}
    <div class="analytics-grid">
        <div class="analytics-card highlight">
            <div class="number">{{ analytics.total_teachers }}</div>
            <div class="label">Total Teachers</div>
        </div>
        <div class="analytics-card">
            <div class="number">{{ analytics.total_classes }}</div>
            <div class="label">Total Classes</div>
        </div>
        <div class="analytics-card success">
            <div class="number">{{ analytics.active_assignments }}</div>
            <div class="label">Active Assignments</div>
        </div>
        <div class="analytics-card warning">
            <div class="number">{{ analytics.pending_requests }}</div>
            <div class="label">Pending Requests</div>
        </div>
        <div class="analytics-card">
            <div class="number">{{ analytics.classes_with_teachers }}</div>
            <div class="label">Classes with Teachers</div>
        </div>
        <div class="analytics-card warning">
            <div class="number">{{ analytics.classes_without_teachers }}</div>
            <div class="label">Classes without Teachers</div>
        </div>
        <div class="analytics-card success">
            <div class="number">{{ analytics.multi_teacher_classes }}</div>
            <div class="label">Multi-Teacher Classes</div>
        </div>
        <div class="analytics-card">
            <div class="number">{{ analytics.avg_classes_per_teacher }}</div>
            <div class="label">Avg Classes per Teacher</div>
        </div>
    </div>
    
    <!-- Quick Actions for Overview -->
    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title">üöÄ Quick Actions</h2>
        </div>
        <div class="action-buttons">
            <button onclick="openDirectAssignModal()" class="btn-primary-custom">
                <span>‚ûï</span>
                <span>Direct Assignment</span>
            </button>
            <button onclick="openBulkAssignModal()" class="btn-primary-custom">
                <span>üì¶</span>
                <span>Bulk Assignment</span>
            </button>
            <a href="?view=requests" class="btn-secondary-custom">
                <span>üìã</span>
                <span>Review Pending Requests</span>
                {% if pending_requests.count > 0 %}
                <span style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 2px 6px; font-size: 11px;">({{ pending_requests.count }})</span>
                {% endif %}
            </a>
            <a href="{% url 'RoutineTest:classes_exams_unified' %}" class="btn-secondary-custom">
                <span>üîô</span>
                <span>Back to Main Dashboard</span>
            </a>
        </div>
    </div>
    
    <!-- Recent Activity -->
    {% if recent_activity %}
    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title">üìà Recent Activity (Last 7 Days)</h2>
        </div>
        <div style="max-height: 300px; overflow-y: auto;">
            {% for activity in recent_activity %}
            <div style="padding: 12px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>{{ activity.get_action_display }}</strong>
                    <span style="color: #6c757d; margin-left: 8px;">
                        {{ activity.teacher.name|default:"Unknown" }} - {{ activity.class_code }}
                    </span>
                </div>
                <div style="font-size: 12px; color: #6c757d;">
                    {{ activity.timestamp|date:"M j, g:i A" }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}
    
    <!-- Teacher Directory View -->
    {% if view_mode == 'teachers' %}
    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title">üë®‚Äçüè´ Teacher Directory ({{ teacher_directory|length }} teachers)</h2>
            <div class="action-buttons">
                <button onclick="openDirectAssignModal()" class="btn-primary-custom">
                    <span>‚ûï</span>
                    <span>Assign Teacher</span>
                </button>
            </div>
        </div>
        
        {% if teacher_directory %}
        <div class="teacher-directory-grid">
            {% for teacher_data in teacher_directory %}
            <div class="teacher-card">
                <div class="teacher-card-header">
                    <div>
                        <h4 class="teacher-name">{{ teacher_data.teacher.name }}</h4>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">
                            {{ teacher_data.teacher.email }}
                        </div>
                        <div class="global-access-badge {{ teacher_data.global_access_level|lower }}">
                            {{ teacher_data.global_access_level }} Access
                        </div>
                    </div>
                    <div class="teacher-meta">
                        <div>{{ teacher_data.assignment_count }} Classes</div>
                        {% if teacher_data.pending_requests_count > 0 %}
                        <div style="color: #dc3545; font-weight: 500;">{{ teacher_data.pending_requests_count }} Pending</div>
                        {% endif %}
                        {% if teacher_data.last_login %}
                        <div>Last: {{ teacher_data.last_login|date:"M j" }}</div>
                        {% endif %}
                    </div>
                </div>
                
                {% if teacher_data.classes %}
                <div class="teacher-classes">
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 500;">
                        CLASS ASSIGNMENTS
                    </div>
                    {% for class_assignment in teacher_data.classes %}
                    <div class="class-assignment">
                        <span class="class-name">{{ class_assignment.class_name }}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="access-level-badge {{ class_assignment.access_level|lower }}">
                                {{ class_assignment.access_level }}
                            </span>
                            <button onclick="revokeAccess('{{ class_assignment.assignment_id }}', '{{ teacher_data.teacher.name }}', '{{ class_assignment.class_name }}')" 
                                    class="btn-danger-custom" title="Revoke Access">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state" style="padding: 20px;">
                    <div style="color: #6c757d; font-size: 14px;">No class assignments</div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h3>No Teachers Found</h3>
            <p>No active teachers in the system.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Class Directory View -->
    {% if view_mode == 'classes' %}
    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title">üè´ Class Directory ({{ class_directory|length }} classes)</h2>
            <div class="action-buttons">
                <button onclick="openBulkAssignModal()" class="btn-primary-custom">
                    <span>üì¶</span>
                    <span>Bulk Assign</span>
                </button>
            </div>
        </div>
        
        {% if class_directory %}
        <div class="class-directory-grid">
            {% for class_data in class_directory %}
            <div class="class-card">
                <div class="class-card-header">
                    <div>
                        <h4 class="class-name-display">{{ class_data.class_name }}</h4>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">
                            Code: {{ class_data.class_code }}
                        </div>
                        <div class="teacher-count-badge {% if class_data.teacher_count == 0 %}zero{% elif class_data.teacher_count > 1 %}multi{% endif %}">
                            {{ class_data.teacher_count }} Teacher{{ class_data.teacher_count|pluralize }}
                        </div>
                    </div>
                    <div class="class-stats">
                        <div>{{ class_data.exam_count }} Exams</div>
                        <div>{{ class_data.student_count }} Students</div>
                        {% if class_data.pending_requests %}
                        <div style="color: #dc3545; font-weight: 500;">{{ class_data.pending_requests|length }} Pending</div>
                        {% endif %}
                    </div>
                </div>
                
                {% if class_data.teachers %}
                <div class="class-teachers">
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 500;">
                        ASSIGNED TEACHERS
                    </div>
                    {% for teacher_assignment in class_data.teachers %}
                    <div class="teacher-assignment">
                        <div>
                            <span style="font-weight: 500;">{{ teacher_assignment.teacher.name }}</span>
                            <div style="font-size: 11px; color: #6c757d;">
                                Global: {{ teacher_assignment.global_access_level }}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="access-level-badge {{ teacher_assignment.access_level|lower }}">
                                {{ teacher_assignment.access_level }}
                            </span>
                            <button onclick="revokeAccess('{{ teacher_assignment.assignment_id }}', '{{ teacher_assignment.teacher.name }}', '{{ class_data.class_name }}')" 
                                    class="btn-danger-custom" title="Revoke Access">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state" style="padding: 20px;">
                    <div style="color: #6c757d; font-size: 14px;">No teachers assigned</div>
                    <button onclick="openDirectAssignModalForClass('{{ class_data.class_code }}')" 
                            style="margin-top: 8px; padding: 8px 16px; background: #2E7D32; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                        Assign Teacher
                    </button>
                </div>
                {% endif %}
                
                {% if class_data.pending_requests %}
                <div style="margin-top: 16px; padding: 12px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7;">
                    <div style="font-size: 12px; color: #856404; font-weight: 500; margin-bottom: 8px;">
                        PENDING REQUESTS ({{ class_data.pending_requests|length }})
                    </div>
                    {% for request in class_data.pending_requests %}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span style="font-size: 12px;">{{ request.teacher.name }}</span>
                        <span style="font-size: 11px; color: #6c757d;">{{ request.requested_at|date:"M j" }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h3>No Classes Found</h3>
            <p>No classes configured in the system.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Matrix View -->
    {% if view_mode == 'matrix' %}
    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title">üéØ Teacher-Class Assignment Matrix</h2>
            <div style="font-size: 14px; color: #6c757d;">
                Showing first {{ matrix_teachers|length }} teachers √ó {{ matrix_classes|length }} classes
            </div>
        </div>
        
        {% if matrix_teachers and matrix_classes %}
        <div class="matrix-container">
            <table class="matrix-table">
                <thead>
                    <tr>
                        <th class="teacher-name-col">Teacher</th>
                        {% for class_data in matrix_classes %}
                        <th title="{{ class_data.class_name }}">{{ class_data.class_code }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for teacher_data in matrix_teachers %}
                    <tr>
                        <td class="teacher-name-col">
                            <div style="font-weight: 500;">{{ teacher_data.teacher.name }}</div>
                            <div style="font-size: 10px; color: #6c757d;">{{ teacher_data.global_access_level }}</div>
                        </td>
                        {% for class_data in matrix_classes %}
                        {% get_matrix_cell matrix_data teacher_data.teacher.id class_data.class_code as cell %}
                        <td class="matrix-cell {% if cell.has_access %}has-access{% else %}no-access{% endif %}"
                            onclick="toggleMatrixAssignment('{{ teacher_data.teacher.id }}', '{{ class_data.class_code }}', '{{ teacher_data.teacher.name }}', '{{ class_data.class_name }}', {% if cell.has_access %}true{% else %}false{% endif %}, '{{ cell.assignment_id|default:"" }}')"
                            title="{% if cell.has_access %}{{ cell.access_level }} access{% else %}No access{% endif %}">
                            {% if cell.has_access %}
                                <span style="font-weight: 500; color: #155724;">{{ cell.access_level|slice:":1" }}</span>
                            {% else %}
                                <span style="color: #721c24;">‚úï</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #6c757d;">
            <strong>Legend:</strong>
            <span style="margin-left: 15px;">‚úï = No Access</span>
            <span style="margin-left: 15px;">F = Full Access</span>
            <span style="margin-left: 15px;">V = View Access</span>
            <span style="margin-left: 15px;">Click cells to toggle assignments</span>
        </div>
        {% else %}
        <div class="empty-state">
            <h3>No Data for Matrix</h3>
            <p>No teachers or classes available for matrix display.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Request Management View -->
    {% if view_mode == 'requests' %}
    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title">üìã Access Request Management</h2>
            <div class="action-buttons">
                {% if pending_requests.count > 1 %}
                <button onclick="bulkApproveAllRequests()" class="btn-primary-custom">
                    <span>‚úÖ</span>
                    <span>Approve All ({{ pending_requests.count }})</span>
                </button>
                {% endif %}
            </div>
        </div>
        
        {% if request_management_data %}
        <div style="display: grid; gap: 20px;">
            {% for req_data in request_management_data %}
            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                    <div>
                        <h4 style="margin: 0; color: #2c3e50;">{{ req_data.request.teacher.name }}</h4>
                        <div style="font-size: 14px; color: #6c757d; margin-top: 4px;">
                            {{ req_data.request.teacher.email }}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="background: #FFF9C4; color: #F57C00; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                            {{ req_data.days_pending }} day{{ req_data.days_pending|pluralize }} ago
                        </div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">
                            {{ req_data.request.requested_at|date:"M j, Y g:i A" }}
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 16px; border-radius: 6px; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 12px; color: #6c757d; font-weight: 500; margin-bottom: 4px;">CLASS REQUESTED</div>
                            <div style="font-weight: 600;">{{ req_data.class_name }}</div>
                            <div style="font-size: 12px; color: #6c757d;">{{ req_data.request.class_code }}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6c757d; font-weight: 500; margin-bottom: 4px;">ACCESS LEVEL</div>
                            <div style="font-weight: 600; color: {% if req_data.request.requested_access_level == 'FULL' %}#00A65E{% else %}#2E7D32{% endif %};">
                                {{ req_data.request.get_requested_access_level_display }}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: #6c757d; font-weight: 500; margin-bottom: 4px;">REASON</div>
                        <div>{{ req_data.request.get_reason_code_display }}</div>
                        {% if req_data.request.reason_text %}
                        <div style="font-style: italic; margin-top: 4px; color: #6c757d;">{{ req_data.request.reason_text }}</div>
                        {% endif %}
                    </div>
                    
                    {% if req_data.current_teachers %}
                    <div>
                        <div style="font-size: 12px; color: #6c757d; font-weight: 500; margin-bottom: 8px;">
                            CURRENT TEACHERS ({{ req_data.current_teacher_count }})
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            {% for current_teacher in req_data.current_teachers %}
                            <span style="background: #e9ecef; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                {{ current_teacher.teacher.name }} ({{ current_teacher.access_level }})
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="denyRequest('{{ req_data.request.id }}')" 
                            style="background: #e74c3c !important; color: #FFFFFF !important; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 500; cursor: pointer; display: inline-block;"
                            onmouseover="this.style.background='#c0392b'" 
                            onmouseout="this.style.background='#e74c3c'">
                        Deny Request
                    </button>
                    <button onclick="approveRequest('{{ req_data.request.id }}')" 
                            style="background: #00A65E !important; color: #FFFFFF !important; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 500; cursor: pointer; display: inline-block;"
                            onmouseover="this.style.background='#2E7D32'" 
                            onmouseout="this.style.background='#00A65E'">
                        Approve Request
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <h3>‚úÖ All Caught Up!</h3>
            <p>No pending access requests to review.</p>
            <a href="?view=overview" class="btn-primary-custom">
                <span>üìä</span>
                <span>Back to Overview</span>
            </a>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
</div>

<!-- Direct Assignment Modal -->
<div id="directAssignModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">‚ûï Direct Teacher Assignment</h3>
            <button class="close" onclick="closeDirectAssignModal()">&times;</button>
        </div>
        <form id="directAssignForm">
            <div class="form-group">
                <label class="form-label">Teacher</label>
                <select class="form-control" name="teacher_id" required>
                    <option value="">Select Teacher...</option>
                    {% for teacher_data in teacher_directory %}
                    <option value="{{ teacher_data.teacher.id }}">
                        {{ teacher_data.teacher.name }} ({{ teacher_data.global_access_level }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Class</label>
                <select class="form-control" name="class_code" required>
                    <option value="">Select Class...</option>
                    {% for class_code, class_name in all_classes_for_assignment %}
                    <option value="{{ class_code }}">{{ class_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Access Level</label>
                <select class="form-control" name="access_level" required>
                    <option value="FULL">Full Access</option>
                    <option value="VIEW">View Only</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea class="form-control" name="notes" rows="3" placeholder="Administrative notes about this assignment..."></textarea>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" onclick="closeDirectAssignModal()" class="btn-secondary-custom">Cancel</button>
                <button type="submit" class="btn-primary-custom">
                    <span>‚úÖ</span>
                    <span>Assign Teacher</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Assignment Modal -->
<div id="bulkAssignModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">üì¶ Bulk Teacher Assignment</h3>
            <button class="close" onclick="closeBulkAssignModal()">&times;</button>
        </div>
        <form id="bulkAssignForm">
            <div class="form-group">
                <label class="form-label">Teachers (Hold Ctrl/Cmd to select multiple)</label>
                <select class="form-control" name="teacher_ids" multiple required style="height: 120px;">
                    {% for teacher_data in teacher_directory %}
                    <option value="{{ teacher_data.teacher.id }}">
                        {{ teacher_data.teacher.name }} ({{ teacher_data.global_access_level }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Classes (Hold Ctrl/Cmd to select multiple)</label>
                <select class="form-control" name="class_codes" multiple required style="height: 120px;">
                    {% for class_code, class_name in all_classes_for_assignment %}
                    <option value="{{ class_code }}">{{ class_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Access Level</label>
                <select class="form-control" name="access_level" required>
                    <option value="FULL">Full Access</option>
                    <option value="VIEW">View Only</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-control" name="notes" rows="2" placeholder="Bulk assignment notes...">Bulk assignment by admin</textarea>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" onclick="closeBulkAssignModal()" class="btn-secondary-custom">Cancel</button>
                <button type="submit" class="btn-primary-custom">
                    <span>üì¶</span>
                    <span>Bulk Assign</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Console Debug Indicator -->
<div class="debug-indicator">
    üîç Console Logging Active
</div>

<!-- JavaScript for Interactive Functionality -->
<script>
console.log('[TEACHER_MGMT_DASHBOARD] Dashboard loaded successfully');
console.log('[TEACHER_MGMT_DASHBOARD] View mode:', '{{ view_mode }}');
console.log('[TEACHER_MGMT_DASHBOARD] Analytics:', {{ analytics|safe }});

// CSRF Token Setup
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Direct Assignment Modal Functions
function openDirectAssignModal(preSelectedClass = null) {
    console.log('[DIRECT_ASSIGN] Opening modal, pre-selected class:', preSelectedClass);
    const modal = document.getElementById('directAssignModal');
    
    if (preSelectedClass) {
        const classSelect = modal.querySelector('select[name="class_code"]');
        classSelect.value = preSelectedClass;
    }
    
    modal.style.display = 'block';
}

function openDirectAssignModalForClass(classCode) {
    openDirectAssignModal(classCode);
}

function closeDirectAssignModal() {
    document.getElementById('directAssignModal').style.display = 'none';
    document.getElementById('directAssignForm').reset();
}

// Direct Assignment Form Handler
document.getElementById('directAssignForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        teacher_id: formData.get('teacher_id'),
        class_code: formData.get('class_code'),
        access_level: formData.get('access_level'),
        notes: formData.get('notes')
    };
    
    console.log('[DIRECT_ASSIGN] Submitting assignment:', data);
    
    fetch('{% url "RoutineTest:admin_direct_assign_teacher" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        console.log('[DIRECT_ASSIGN] Response:', data);
        if (data.success) {
            alert(data.message);
            closeDirectAssignModal();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('[DIRECT_ASSIGN] Error:', error);
        alert('An error occurred. Please try again.');
    });
});

// Bulk Assignment Modal Functions
function openBulkAssignModal() {
    console.log('[BULK_ASSIGN] Opening modal');
    document.getElementById('bulkAssignModal').style.display = 'block';
}

function closeBulkAssignModal() {
    document.getElementById('bulkAssignModal').style.display = 'none';
    document.getElementById('bulkAssignForm').reset();
}

// Bulk Assignment Form Handler
document.getElementById('bulkAssignForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const teacherIds = Array.from(formData.getAll('teacher_ids'));
    const classCodes = Array.from(formData.getAll('class_codes'));
    
    const data = {
        teacher_ids: teacherIds,
        class_codes: classCodes,
        access_level: formData.get('access_level'),
        notes: formData.get('notes')
    };
    
    console.log('[BULK_ASSIGN] Submitting bulk assignment:', data);
    
    const totalOperations = teacherIds.length * classCodes.length;
    if (!confirm(`This will create ${totalOperations} assignment operations. Continue?`)) {
        return;
    }
    
    fetch('{% url "RoutineTest:admin_bulk_assign_teachers" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        console.log('[BULK_ASSIGN] Response:', data);
        if (data.success) {
            alert(data.message);
            closeBulkAssignModal();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('[BULK_ASSIGN] Error:', error);
        alert('An error occurred. Please try again.');
    });
});

// Revoke Access Function
function revokeAccess(assignmentId, teacherName, className) {
    console.log('[REVOKE_ACCESS] Revoking:', assignmentId, teacherName, className);
    
    if (!confirm(`Remove ${teacherName} from ${className}?`)) {
        return;
    }
    
    const reason = prompt('Reason for removal (optional):') || 'Removed by admin';
    
    fetch('{% url "RoutineTest:admin_revoke_teacher_access" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            assignment_id: assignmentId,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('[REVOKE_ACCESS] Response:', data);
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('[REVOKE_ACCESS] Error:', error);
        alert('An error occurred. Please try again.');
    });
}

// Matrix Toggle Function
function toggleMatrixAssignment(teacherId, classCode, teacherName, className, hasAccess, assignmentId) {
    console.log('[MATRIX_TOGGLE] Toggle:', teacherId, classCode, hasAccess);
    
    if (hasAccess) {
        // Revoke access
        if (confirm(`Remove ${teacherName} from ${className}?`)) {
            revokeAccess(assignmentId, teacherName, className);
        }
    } else {
        // Assign access - open modal with pre-selected values
        const modal = document.getElementById('directAssignModal');
        const teacherSelect = modal.querySelector('select[name="teacher_id"]');
        const classSelect = modal.querySelector('select[name="class_code"]');
        
        teacherSelect.value = teacherId;
        classSelect.value = classCode;
        
        modal.style.display = 'block';
    }
}

// Request Management Functions
function approveRequest(requestId) {
    console.log('[APPROVE_REQUEST] Approving:', requestId);
    
    if (!confirm('Approve this access request?')) {
        return;
    }
    
    fetch(`{% url 'RoutineTest:approve_request' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', requestId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('[APPROVE_REQUEST] Response:', data);
        if (data.success) {
            alert('Request approved successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to approve request'));
        }
    })
    .catch(error => {
        console.error('[APPROVE_REQUEST] Error:', error);
        alert('An error occurred. Please try again.');
    });
}

function denyRequest(requestId) {
    console.log('[DENY_REQUEST] Denying:', requestId);
    
    const reason = prompt('Reason for denial:');
    if (!reason) {
        return;
    }
    
    fetch(`{% url 'RoutineTest:deny_request' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', requestId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ reason: reason })
    })
    .then(response => response.json())
    .then(data => {
        console.log('[DENY_REQUEST] Response:', data);
        if (data.success) {
            alert('Request denied.');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to deny request'));
        }
    })
    .catch(error => {
        console.error('[DENY_REQUEST] Error:', error);
        alert('An error occurred. Please try again.');
    });
}

function bulkApproveAllRequests() {
    console.log('[BULK_APPROVE] Approving all pending requests');
    
    if (!confirm('Approve ALL pending requests? This action cannot be undone.')) {
        return;
    }
    
    fetch('{% url "RoutineTest:bulk_approve" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('[BULK_APPROVE] Response:', data);
        if (data.success) {
            alert(`Successfully approved ${data.approved_count} request(s)!`);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to approve requests'));
        }
    })
    .catch(error => {
        console.error('[BULK_APPROVE] Error:', error);
        alert('An error occurred. Please try again.');
    });
}

// Close modals when clicking outside
window.onclick = function(event) {
    const directModal = document.getElementById('directAssignModal');
    const bulkModal = document.getElementById('bulkAssignModal');
    
    if (event.target === directModal) {
        closeDirectAssignModal();
    }
    if (event.target === bulkModal) {
        closeBulkAssignModal();
    }
}

// Template filter helpers for JavaScript access
const templateFilters = {
    get_item: function(dict, key) {
        return dict[key];
    }
};

console.log('[TEACHER_MGMT_DASHBOARD] All JavaScript initialized successfully');
</script>

{% endblock %}