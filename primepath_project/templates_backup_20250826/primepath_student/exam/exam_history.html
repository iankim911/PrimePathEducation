{% extends 'student_base.html' %}
{% load static %}

{% block title %}Exam History - PrimePath Student Portal{% endblock %}

{% block extra_styles %}
<style>
    /* History Container */
    .history-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Page Header */
    .page-header {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .page-title {
        font-size: 28px;
        font-weight: bold;
        color: #333;
        margin: 0;
    }
    
    .page-subtitle {
        color: #666;
        margin-top: 10px;
    }
    
    /* Filter Section */
    .filter-section {
        background: #F5F7FA;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-label {
        font-size: 14px;
        color: #666;
        font-weight: 600;
    }
    
    .filter-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        min-width: 150px;
    }
    
    /* Stats Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #1565C0;
    }
    
    .stat-card.excellent {
        border-left-color: #43A047;
    }
    
    .stat-card.warning {
        border-left-color: #FFA726;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 14px;
        color: #666;
    }
    
    /* Exam History Table */
    .history-table-container {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow-x: auto;
    }
    
    .history-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .history-table thead {
        background: #F5F7FA;
    }
    
    .history-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #666;
        border-bottom: 2px solid #E0E0E0;
    }
    
    .history-table td {
        padding: 15px 12px;
        border-bottom: 1px solid #F0F0F0;
    }
    
    .history-table tbody tr:hover {
        background: #FAFAFA;
    }
    
    /* Class Badge */
    .class-badge {
        display: inline-block;
        padding: 4px 10px;
        background: #E3F2FD;
        color: #1565C0;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
    }
    
    /* Score Display */
    .score-display {
        font-weight: bold;
        font-size: 18px;
    }
    
    .score-excellent {
        color: #43A047;
    }
    
    .score-good {
        color: #1976D2;
    }
    
    .score-fair {
        color: #FFA726;
    }
    
    .score-poor {
        color: #E53935;
    }
    
    /* Status Badge */
    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .status-completed {
        background: #C8E6C9;
        color: #2E7D32;
    }
    
    .status-expired {
        background: #FFCCBC;
        color: #D84315;
    }
    
    /* Action Button */
    .btn-view {
        padding: 6px 16px;
        background: #1565C0;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        transition: all 0.3s;
    }
    
    .btn-view:hover {
        background: #1976D2;
        transform: translateY(-1px);
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: #F5F7FA;
        border-radius: 12px;
    }
    
    .empty-icon {
        font-size: 64px;
        color: #BDBDBD;
        margin-bottom: 20px;
    }
    
    .empty-title {
        font-size: 24px;
        color: #666;
        margin-bottom: 10px;
    }
    
    .empty-text {
        color: #999;
    }
    
    /* Back Button */
    .back-button {
        margin-bottom: 20px;
    }
    
    .btn-back {
        padding: 10px 20px;
        background: #757575;
        color: white;
        border: none;
        border-radius: 4px;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s;
    }
    
    .btn-back:hover {
        background: #616161;
    }
</style>
{% endblock %}

{% block content %}
<div class="history-container">
    <!-- Back Button -->
    <div class="back-button">
        <a href="{% url 'primepath_student:dashboard' %}" class="btn-back">
            ‚Üê Back to Dashboard
        </a>
    </div>
    
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">üìä Exam History</h1>
        <p class="page-subtitle">View all your completed exams across all classes</p>
    </div>
    
    {% if sessions %}
    <!-- Statistics Cards -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-value">{{ sessions|length }}</div>
            <div class="stat-label">Total Exams Taken</div>
        </div>
        <div class="stat-card excellent">
            <div class="stat-value">
                {% with total_score=0 count=0 %}
                {% for session in sessions %}
                    {% if session.score %}
                        {{ session.score|add:total_score }}
                        {{ count|add:1 }}
                    {% endif %}
                {% endfor %}
                {% if count > 0 %}
                    {{ total_score|floatformat:0 }}%
                {% else %}
                    N/A
                {% endif %}
                {% endwith %}
            </div>
            <div class="stat-label">Average Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {{ sessions.0.completed_at|date:"M j" }}
            </div>
            <div class="stat-label">Most Recent Exam</div>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-group">
            <label class="filter-label">Class</label>
            <select class="filter-select" id="classFilter" onchange="filterTable()">
                <option value="">All Classes</option>
                {% for session in sessions %}
                    {% if session.class_assignment.get_class_code_display not in classes %}
                        <option value="{{ session.class_assignment.class_code }}">
                            {{ session.class_assignment.get_class_code_display }}
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Time Period</label>
            <select class="filter-select" id="periodFilter" onchange="filterTable()">
                <option value="">All Time</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="semester">This Semester</option>
            </select>
        </div>
    </div>
    
    <!-- History Table -->
    <div class="history-table-container">
        <table class="history-table" id="historyTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Exam Name</th>
                    <th>Class</th>
                    <th>Score</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for session in sessions %}
                <tr data-class="{{ session.class_assignment.class_code }}" 
                    data-date="{{ session.completed_at|date:'Y-m-d' }}">
                    <td>{{ session.completed_at|date:"M j, Y g:i A" }}</td>
                    <td>
                        <strong>{{ session.exam.name }}</strong>
                    </td>
                    <td>
                        <span class="class-badge">
                            {{ session.class_assignment.get_class_code_display }}
                        </span>
                    </td>
                    <td>
                        {% if session.score %}
                        <span class="score-display 
                            {% if session.score >= 80 %}score-excellent
                            {% elif session.score >= 60 %}score-good
                            {% elif session.score >= 40 %}score-fair
                            {% else %}score-poor{% endif %}">
                            {{ session.score|floatformat:0 }}%
                        </span>
                        {% else %}
                        <span style="color: #999;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ session.status }}">
                            {{ session.get_status_display }}
                        </span>
                    </td>
                    <td>
                        <a href="{% url 'primepath_student:exam_result' session.id %}" class="btn-view">
                            View Results
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">üìù</div>
        <h2 class="empty-title">No Exam History Yet</h2>
        <p class="empty-text">Your completed exams will appear here</p>
    </div>
    {% endif %}
</div>

<script>
function filterTable() {
    const classFilter = document.getElementById('classFilter').value;
    const periodFilter = document.getElementById('periodFilter').value;
    const rows = document.querySelectorAll('#historyTable tbody tr');
    const today = new Date();
    
    rows.forEach(row => {
        let showRow = true;
        
        // Class filter
        if (classFilter && row.dataset.class !== classFilter) {
            showRow = false;
        }
        
        // Period filter
        if (periodFilter && showRow) {
            const rowDate = new Date(row.dataset.date);
            const daysDiff = (today - rowDate) / (1000 * 60 * 60 * 24);
            
            if (periodFilter === 'week' && daysDiff > 7) {
                showRow = false;
            } else if (periodFilter === 'month' && daysDiff > 30) {
                showRow = false;
            } else if (periodFilter === 'semester' && daysDiff > 120) {
                showRow = false;
            }
        }
        
        row.style.display = showRow ? '' : 'none';
    });
}
</script>
{% endblock %}