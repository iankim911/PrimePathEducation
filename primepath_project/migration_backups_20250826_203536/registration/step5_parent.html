{% extends "base.html" %}
{% load static %}

{% block title %}Parent/Guardian Information - Step 5{% endblock %}

{% block extra_css %}
<style>
    .registration-container {
        max-width: 600px;
        margin: 50px auto;
        padding: 30px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .progress-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        position: relative;
    }
    
    .progress-bar::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e0e0e0;
        z-index: -1;
    }
    
    .progress-step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        position: relative;
        background: white;
        border: 2px solid #e0e0e0;
    }
    
    .progress-step.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .progress-step.completed {
        background: #28a745;
        color: white;
        border-color: #28a745;
    }
    
    .step-label {
        position: absolute;
        top: 50px;
        width: 100px;
        text-align: center;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        color: #666;
    }
    
    .form-section {
        margin-bottom: 30px;
    }
    
    .form-section h3 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.3rem;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }
    
    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }
    
    .form-group label .required {
        color: #dc3545;
        margin-left: 3px;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 15px;
        transition: border-color 0.3s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .form-control.is-invalid {
        border-color: #dc3545;
    }
    
    .invalid-feedback {
        display: none;
        color: #dc3545;
        font-size: 13px;
        margin-top: 5px;
    }
    
    .form-control.is-invalid ~ .invalid-feedback {
        display: block;
    }
    
    .help-text {
        font-size: 13px;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .skip-notice {
        background: #e7f1ff;
        border: 1px solid #007bff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 25px;
    }
    
    .skip-notice h4 {
        color: #007bff;
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .skip-notice p {
        color: #333;
        font-size: 14px;
        margin: 0;
    }
    
    .parent-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
    }
    
    .parent-option {
        flex: 1;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .parent-option:hover {
        border-color: #007bff;
        background: #f8f9fa;
    }
    
    .parent-option.selected {
        border-color: #007bff;
        background: #e7f1ff;
    }
    
    .parent-option input[type="radio"] {
        display: none;
    }
    
    .parent-label {
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }
    
    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid #e0e0e0;
    }
    
    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
    }
    
    .btn-outline {
        background: white;
        color: #007bff;
        border: 2px solid #007bff;
    }
    
    .btn-outline:hover {
        background: #007bff;
        color: white;
    }
    
    .parent-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .parent-section h4 {
        color: #333;
        font-size: 16px;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    .add-parent-btn {
        display: inline-block;
        padding: 8px 16px;
        background: #28a745;
        color: white;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
        margin-top: 15px;
    }
    
    .add-parent-btn:hover {
        background: #218838;
    }
    
    .remove-parent-btn {
        display: inline-block;
        padding: 6px 12px;
        background: #dc3545;
        color: white;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        margin-left: 10px;
    }
    
    .remove-parent-btn:hover {
        background: #c82333;
    }
</style>
{% endblock %}

{% block content %}
<div class="registration-container">
    <h2 style="text-align: center; color: #333; margin-bottom: 30px;">Parent/Guardian Information</h2>
    
    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-step completed">
            ‚úì
            <span class="step-label">Basic Info</span>
        </div>
        <div class="progress-step completed">
            ‚úì
            <span class="step-label">Personal</span>
        </div>
        <div class="progress-step completed">
            ‚úì
            <span class="step-label">Contact</span>
        </div>
        <div class="progress-step completed">
            ‚úì
            <span class="step-label">Academic</span>
        </div>
        <div class="progress-step active">
            5
            <span class="step-label">Parent Info</span>
        </div>
        <div class="progress-step">
            6
            <span class="step-label">Additional</span>
        </div>
    </div>
    
    <!-- Skip notice for adult learners -->
    <div class="skip-notice" id="skipNotice" style="display: none;">
        <h4>üìò Adult Learner</h4>
        <p>As an adult learner, you can skip this section or provide emergency contact information.</p>
    </div>
    
    <form method="post" id="parentInfoForm">
        {% csrf_token %}
        
        <!-- Parent selector -->
        <div class="parent-selector">
            <label class="parent-option" for="parent_count_1">
                <input type="radio" name="parent_count" id="parent_count_1" value="1" checked>
                <div class="parent-label">One Parent/Guardian</div>
            </label>
            
            <label class="parent-option" for="parent_count_2">
                <input type="radio" name="parent_count" id="parent_count_2" value="2">
                <div class="parent-label">Two Parents/Guardians</div>
            </label>
        </div>
        
        <!-- First Parent/Guardian -->
        <div class="parent-section" id="parent1Section">
            <h4>Primary Parent/Guardian</h4>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="parent1_first_name">
                        First Name
                        <span class="required">*</span>
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="parent1_first_name" 
                           name="parent1_first_name" 
                           required
                           placeholder="Parent's first name"
                           value="{{ form.parent1_first_name.value|default:'' }}">
                    <div class="invalid-feedback">First name is required.</div>
                </div>
                
                <div class="form-group">
                    <label for="parent1_last_name">
                        Last Name
                        <span class="required">*</span>
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="parent1_last_name" 
                           name="parent1_last_name" 
                           required
                           placeholder="Parent's last name"
                           value="{{ form.parent1_last_name.value|default:'' }}">
                    <div class="invalid-feedback">Last name is required.</div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="parent1_relationship">
                        Relationship
                        <span class="required">*</span>
                    </label>
                    <select class="form-control" id="parent1_relationship" name="parent1_relationship" required>
                        <option value="">Select relationship</option>
                        <option value="mother">Mother</option>
                        <option value="father">Father</option>
                        <option value="stepmother">Stepmother</option>
                        <option value="stepfather">Stepfather</option>
                        <option value="grandmother">Grandmother</option>
                        <option value="grandfather">Grandfather</option>
                        <option value="aunt">Aunt</option>
                        <option value="uncle">Uncle</option>
                        <option value="guardian">Legal Guardian</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="parent1_occupation">
                        Occupation
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="parent1_occupation" 
                           name="parent1_occupation" 
                           placeholder="Occupation (optional)"
                           value="{{ form.parent1_occupation.value|default:'' }}">
                </div>
            </div>
            
            <div class="form-group">
                <label for="parent1_email">
                    Email Address
                    <span class="required">*</span>
                </label>
                <input type="email" 
                       class="form-control" 
                       id="parent1_email" 
                       name="parent1_email" 
                       required
                       placeholder="parent@example.com"
                       value="{{ form.parent1_email.value|default:'' }}">
                <div class="invalid-feedback">Please enter a valid email address.</div>
                <div class="help-text">Parent will receive progress reports and communications</div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="parent1_phone">
                        Phone Number
                        <span class="required">*</span>
                    </label>
                    <input type="tel" 
                           class="form-control" 
                           id="parent1_phone" 
                           name="parent1_phone" 
                           required
                           placeholder="010-1234-5678"
                           value="{{ form.parent1_phone.value|default:'' }}">
                    <div class="invalid-feedback">Phone number is required.</div>
                </div>
                
                <div class="form-group">
                    <label for="parent1_phone_type">
                        Phone Type
                    </label>
                    <select class="form-control" id="parent1_phone_type" name="parent1_phone_type">
                        <option value="mobile">Mobile</option>
                        <option value="home">Home</option>
                        <option value="work">Work</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="parent1_preferred_contact">
                    Preferred Contact Method
                </label>
                <select class="form-control" id="parent1_preferred_contact" name="parent1_preferred_contact">
                    <option value="email">Email</option>
                    <option value="phone">Phone Call</option>
                    <option value="text">Text Message</option>
                    <option value="kakao">KakaoTalk</option>
                </select>
            </div>
        </div>
        
        <!-- Second Parent/Guardian -->
        <div class="parent-section" id="parent2Section" style="display: none;">
            <h4>
                Secondary Parent/Guardian
                <button type="button" class="remove-parent-btn" onclick="removeSecondParent()">Remove</button>
            </h4>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="parent2_first_name">
                        First Name
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="parent2_first_name" 
                           name="parent2_first_name" 
                           placeholder="Parent's first name"
                           value="{{ form.parent2_first_name.value|default:'' }}">
                </div>
                
                <div class="form-group">
                    <label for="parent2_last_name">
                        Last Name
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="parent2_last_name" 
                           name="parent2_last_name" 
                           placeholder="Parent's last name"
                           value="{{ form.parent2_last_name.value|default:'' }}">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="parent2_relationship">
                        Relationship
                    </label>
                    <select class="form-control" id="parent2_relationship" name="parent2_relationship">
                        <option value="">Select relationship</option>
                        <option value="mother">Mother</option>
                        <option value="father">Father</option>
                        <option value="stepmother">Stepmother</option>
                        <option value="stepfather">Stepfather</option>
                        <option value="grandmother">Grandmother</option>
                        <option value="grandfather">Grandfather</option>
                        <option value="aunt">Aunt</option>
                        <option value="uncle">Uncle</option>
                        <option value="guardian">Legal Guardian</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="parent2_occupation">
                        Occupation
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="parent2_occupation" 
                           name="parent2_occupation" 
                           placeholder="Occupation (optional)"
                           value="{{ form.parent2_occupation.value|default:'' }}">
                </div>
            </div>
            
            <div class="form-group">
                <label for="parent2_email">
                    Email Address
                </label>
                <input type="email" 
                       class="form-control" 
                       id="parent2_email" 
                       name="parent2_email" 
                       placeholder="parent@example.com"
                       value="{{ form.parent2_email.value|default:'' }}">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="parent2_phone">
                        Phone Number
                    </label>
                    <input type="tel" 
                           class="form-control" 
                           id="parent2_phone" 
                           name="parent2_phone" 
                           placeholder="010-1234-5678"
                           value="{{ form.parent2_phone.value|default:'' }}">
                </div>
                
                <div class="form-group">
                    <label for="parent2_phone_type">
                        Phone Type
                    </label>
                    <select class="form-control" id="parent2_phone_type" name="parent2_phone_type">
                        <option value="mobile">Mobile</option>
                        <option value="home">Home</option>
                        <option value="work">Work</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Communication Preferences -->
        <div class="form-section">
            <h3>Communication Preferences</h3>
            
            <div class="form-group">
                <label for="communication_language">
                    Preferred Communication Language
                </label>
                <select class="form-control" id="communication_language" name="communication_language">
                    <option value="ko">Korean (ÌïúÍµ≠Ïñ¥)</option>
                    <option value="en">English</option>
                    <option value="both">Both Korean and English</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    Communication Topics (Select all that apply)
                </label>
                <div style="margin-top: 10px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: normal;">
                        <input type="checkbox" name="comm_topics" value="progress" checked>
                        Student progress reports
                    </label>
                    <label style="display: block; margin-bottom: 10px; font-weight: normal;">
                        <input type="checkbox" name="comm_topics" value="homework" checked>
                        Homework and assignments
                    </label>
                    <label style="display: block; margin-bottom: 10px; font-weight: normal;">
                        <input type="checkbox" name="comm_topics" value="schedule" checked>
                        Schedule changes
                    </label>
                    <label style="display: block; margin-bottom: 10px; font-weight: normal;">
                        <input type="checkbox" name="comm_topics" value="events">
                        Events and activities
                    </label>
                    <label style="display: block; margin-bottom: 10px; font-weight: normal;">
                        <input type="checkbox" name="comm_topics" value="billing">
                        Billing and payments
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Error messages -->
        {% if form.errors %}
        <div class="alert alert-danger">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="form-actions">
            <a href="{% url 'registration:step' 'academic' %}" class="btn btn-secondary">
                ‚Üê Back to Step 4
            </a>
            <button type="button" class="btn btn-outline" onclick="skipParentInfo()">
                Skip This Step
            </button>
            <button type="submit" class="btn btn-primary">
                Continue to Step 6 ‚Üí
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Parent count selector
    const parentCountRadios = document.querySelectorAll('input[name="parent_count"]');
    const parent2Section = document.getElementById('parent2Section');
    
    parentCountRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === '2') {
                parent2Section.style.display = 'block';
            } else {
                parent2Section.style.display = 'none';
            }
            
            // Update selection styles
            document.querySelectorAll('.parent-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.closest('.parent-option').classList.add('selected');
        });
    });
    
    // Set initial selected state
    document.querySelector('input[name="parent_count"]:checked').closest('.parent-option').classList.add('selected');
    
    // Check if adult learner (from session data)
    const accountType = sessionStorage.getItem('account_type');
    const currentGrade = sessionStorage.getItem('current_grade');
    
    if (accountType === 'ADULT' || currentGrade === 'ADULT' || currentGrade === 'COLLEGE') {
        document.getElementById('skipNotice').style.display = 'block';
    }
    
    // Phone number formatting
    const phoneInputs = ['parent1_phone', 'parent2_phone'];
    phoneInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                const phoneValue = this.value.replace(/[^0-9]/g, '');
                if (phoneValue.length === 10) {
                    this.value = phoneValue.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
                } else if (phoneValue.length === 11) {
                    this.value = phoneValue.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                }
            });
        }
    });
    
    // Form validation
    document.getElementById('parentInfoForm').addEventListener('submit', function(e) {
        let isValid = true;
        const parentCount = document.querySelector('input[name="parent_count"]:checked').value;
        
        // Validate first parent (required)
        const parent1RequiredFields = [
            'parent1_first_name', 'parent1_last_name', 
            'parent1_relationship', 'parent1_email', 'parent1_phone'
        ];
        
        parent1RequiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const parent1Email = document.getElementById('parent1_email');
        if (parent1Email.value && !emailRegex.test(parent1Email.value)) {
            parent1Email.classList.add('is-invalid');
            isValid = false;
        }
        
        // Validate phone format
        const phoneRegex = /^[0-9]{3}-[0-9]{3,4}-[0-9]{4}$/;
        const parent1Phone = document.getElementById('parent1_phone');
        if (parent1Phone.value && !phoneRegex.test(parent1Phone.value)) {
            parent1Phone.classList.add('is-invalid');
            isValid = false;
        }
        
        // If second parent is selected, validate those fields too (but they're optional)
        if (parentCount === '2') {
            const parent2Email = document.getElementById('parent2_email');
            if (parent2Email.value && !emailRegex.test(parent2Email.value)) {
                parent2Email.classList.add('is-invalid');
                isValid = false;
            }
            
            const parent2Phone = document.getElementById('parent2_phone');
            if (parent2Phone.value && !phoneRegex.test(parent2Phone.value)) {
                parent2Phone.classList.add('is-invalid');
                isValid = false;
            }
        }
        
        if (!isValid) {
            e.preventDefault();
        }
    });
});

function removeSecondParent() {
    document.getElementById('parent2Section').style.display = 'none';
    document.getElementById('parent_count_1').checked = true;
    document.querySelector('label[for="parent_count_1"]').classList.add('selected');
    document.querySelector('label[for="parent_count_2"]').classList.remove('selected');
    
    // Clear second parent fields
    const parent2Fields = document.querySelectorAll('#parent2Section input, #parent2Section select');
    parent2Fields.forEach(field => {
        if (field.type !== 'radio' && field.type !== 'checkbox') {
            field.value = '';
        }
    });
}

function skipParentInfo() {
    // Save skip flag and move to next step
    sessionStorage.setItem('parent_info_skipped', 'true');
    window.location.href = "{% url 'registration:step' 'additional' %}";
}
</script>
{% endblock %}