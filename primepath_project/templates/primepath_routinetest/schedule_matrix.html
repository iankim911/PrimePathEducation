{% extends 'routinetest_base.html' %}
{% load static %}
{% load matrix_filters %}

{% block title %}Exam Assignments - RoutineTest{% endblock %}

{% block extra_css %}
<!-- Modular Schedule Matrix Styles -->
<link rel="stylesheet" href="{% static 'css/routinetest/schedule-matrix.css' %}?v=3.0.0">
{% endblock %}

{% block header %}üìä Exam Assignments{% endblock %}

{% block content %}

<!-- COMPREHENSIVE CLIENT-SIDE LOGGING -->
<script>
console.group('%c[MATRIX_CLIENT] Schedule Matrix Page Loaded', 'background: #4CAF50; color: white; padding: 5px 10px; border-radius: 3px;');
console.log('[MATRIX_CLIENT] User: {{ user.username }}');
console.log('[MATRIX_CLIENT] User Type: {{ user_type|default:"Unknown" }}');
console.log('[MATRIX_CLIENT] Is Admin: {{ is_admin|lower }}');
console.log('[MATRIX_CLIENT] Total Classes: {{ total_classes|default:0 }}');
console.log('[MATRIX_CLIENT] Academic Year: {{ current_year }}');
console.log('[MATRIX_CLIENT] Timestamp: ' + new Date().toISOString());

// Log assigned classes
console.group('[MATRIX_CLIENT] Assigned Classes ({{ assigned_classes|length }})');
{% for assignment in assigned_classes %}
console.log('  - {{ assignment.get_class_code_display }} ({{ assignment.access_level }})');
{% endfor %}
console.groupEnd();

// Check if page was redirected
if (document.referrer) {
    console.log('[MATRIX_CLIENT] Referrer:', document.referrer);
    if (document.referrer.includes('my-classes')) {
        console.warn('[MATRIX_CLIENT] ‚ö†Ô∏è Was redirected from My Classes page');
    }
}

// Check URL parameters
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.toString()) {
    console.log('[MATRIX_CLIENT] URL Parameters:', Object.fromEntries(urlParams));
}

console.groupEnd();
</script>

<!-- Main Container -->
<div class="matrix-container">
    <!-- Header with Controls -->
    <div class="matrix-header">
        <h1 class="matrix-title">
            <span>üìä</span>
            <span>Class Exam Management{% if user_type %} - {{ user_type }} View{% endif %}</span>
        </h1>
        <div class="matrix-controls">
            <label for="year-selector">Academic Year:</label>
            <select id="year-selector" class="year-selector">
                {% for year in available_years %}
                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-matrix-primary" data-action="refresh">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <!-- Tab Container with Proper Panels -->
    <div class="tab-container">
        <!-- Tab Navigation -->
        <nav class="tab-navigation" role="tablist" aria-label="Exam type selection">
            <button class="tab-button active" 
                    data-tab="monthly" 
                    role="tab"
                    aria-selected="true"
                    aria-controls="monthly-panel"
                    id="monthly-tab">
                <span class="tab-icon">üìÖ</span>
                <span class="tab-label">Monthly/Review Exams</span>
            </button>
            <button class="tab-button" 
                    data-tab="quarterly"
                    role="tab"
                    aria-selected="false"
                    aria-controls="quarterly-panel"
                    id="quarterly-tab">
                <span class="tab-icon">üìä</span>
                <span class="tab-label">Quarterly Exams</span>
            </button>
        </nav>

        <!-- Tab Panels -->
        <div class="tab-panels">
            <!-- Monthly Panel -->
            <div id="monthly-panel" 
                 class="tab-panel active"
                 role="tabpanel"
                 aria-labelledby="monthly-tab"
                 aria-hidden="false">
                
                <div class="matrix-wrapper">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Curriculum</th>
                                {% for month in months %}
                                <th>{{ month_names|get_item:month }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for class_code, class_data in monthly_matrix.items %}
                            <tr data-class="{{ class_code }}">
                                <td>{{ class_data.display_name }}</td>
                                <td class="curriculum-mapping">
                                    {% if class_data.curriculum_mapping.combined != 'Not Assigned' %}
                                    <span class="curriculum-badge">{{ class_data.curriculum_mapping.combined }}</span>
                                    {% else %}
                                    <span class="curriculum-badge not-assigned">Not Assigned</span>
                                    {% endif %}
                                </td>
                                {% for month in months %}
                                {% with cell=class_data.cells|get_item:month %}
                                <td>
                                    <div class="matrix-cell {% if cell.exam_count > 2 %}multiple-exams{% elif cell.exam_count > 0 %}has-exams{% else %}empty{% endif %} {{ cell.status|lower }}"
                                         data-cell-id="{{ cell.id }}"
                                         data-class="{{ class_code }}"
                                         data-period="{{ month }}"
                                         data-type="monthly"
                                         data-exam-count="{{ cell.exam_count }}"
                                         title="üì± Click to view {{ cell.exam_count }} exam{{ cell.exam_count|pluralize }} ‚Ä¢ {{ cell_info.class_display }} - {{ month_names|get_item:month }}"
                                         style="cursor: pointer;">
                                        {% if cell.exam_count > 0 %}
                                            {% if cell.exams %}
                                                {% for exam in cell.exams %}
                                                    <div class="exam-info" style="font-size: 11px; line-height: 1.2; margin: 2px 0;">
                                                        <strong style="color: #1B5E20;">{{ exam.name|truncatechars:20 }}</strong>
                                                        {% if exam.curriculum %}
                                                        <div style="font-size: 9px; color: #666;">{{ exam.curriculum|truncatechars:25 }}</div>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="cell-count">{{ cell.exam_count }}</div>
                                                <div style="font-size: 10px; color: #666;">exam{{ cell.exam_count|pluralize }}</div>
                                            {% endif %}
                                        {% else %}
                                            <div class="cell-empty" style="color: #999; font-size: 20px;">‚ûï</div>
                                            <div style="font-size: 9px; color: #999; margin-top: 2px;">Add Exam</div>
                                        {% endif %}
                                        {% if cell.scheduled_date %}
                                        <div class="cell-date" style="font-size: 9px; color: #888; margin-top: 2px;">üìÖ {{ cell.scheduled_date|date:"M d" }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                {% endwith %}
                                {% endfor %}
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{{ months|length|add:2 }}" style="text-align: center; padding: 40px;">
                                    No classes assigned. Please contact your administrator.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Quarterly Panel -->
            <div id="quarterly-panel" 
                 class="tab-panel"
                 role="tabpanel"
                 aria-labelledby="quarterly-tab"
                 aria-hidden="true">
                
                <div class="matrix-wrapper">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Curriculum</th>
                                {% for quarter in quarters %}
                                <th>{{ quarter_names|get_item:quarter }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for class_code, class_data in quarterly_matrix.items %}
                            <tr data-class="{{ class_code }}">
                                <td>{{ class_data.display_name }}</td>
                                <td class="curriculum-mapping">
                                    {% if class_data.curriculum_mapping.combined != 'Not Assigned' %}
                                    <span class="curriculum-badge">{{ class_data.curriculum_mapping.combined }}</span>
                                    {% else %}
                                    <span class="curriculum-badge not-assigned">Not Assigned</span>
                                    {% endif %}
                                </td>
                                {% for quarter in quarters %}
                                {% with cell=class_data.cells|get_item:quarter %}
                                <td>
                                    <div class="matrix-cell {% if cell.exam_count > 2 %}multiple-exams{% elif cell.exam_count > 0 %}has-exams{% else %}empty{% endif %} {{ cell.status|lower }}"
                                         data-cell-id="{{ cell.id }}"
                                         data-class="{{ class_code }}"
                                         data-period="{{ quarter }}"
                                         data-type="quarterly"
                                         data-exam-count="{{ cell.exam_count }}"
                                         title="üì± Click to view {{ cell.exam_count }} exam{{ cell.exam_count|pluralize }} ‚Ä¢ {{ class_data.display_name }} - {{ quarter_names|get_item:quarter }}"
                                         style="cursor: pointer;">
                                        {% if cell.exam_count > 0 %}
                                            {% if cell.exams %}
                                                {% for exam in cell.exams %}
                                                    <div class="exam-info" style="font-size: 11px; line-height: 1.2; margin: 2px 0;">
                                                        <strong style="color: #1B5E20;">{{ exam.name|truncatechars:20 }}</strong>
                                                        {% if exam.curriculum %}
                                                        <div style="font-size: 9px; color: #666;">{{ exam.curriculum|truncatechars:25 }}</div>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="cell-count">{{ cell.exam_count }}</div>
                                                <div style="font-size: 10px; color: #666;">exam{{ cell.exam_count|pluralize }}</div>
                                            {% endif %}
                                        {% else %}
                                            <div class="cell-empty" style="color: #999; font-size: 20px;">‚ûï</div>
                                            <div style="font-size: 9px; color: #999; margin-top: 2px;">Add Exam</div>
                                        {% endif %}
                                        {% if cell.scheduled_date %}
                                        <div class="cell-date" style="font-size: 9px; color: #888; margin-top: 2px;">üìÖ {{ cell.scheduled_date|date:"M d" }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                {% endwith %}
                                {% endfor %}
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{{ quarters|length|add:2 }}" style="text-align: center; padding: 40px;">
                                    No classes assigned. Please contact your administrator.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Enhanced Legend -->
        <div class="matrix-legend">
            <div class="legend-title">üìä Assignment Status Legend</div>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%); border-color: #EF5350;"></div>
                    <span class="legend-label">‚ùå No Exams</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); border-color: #66BB6A;"></div>
                    <span class="legend-label">‚úÖ Has Exams</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 50%, #A5D6A7 100%); border-color: #4CAF50; position: relative;">
                        <div style="position: absolute; top: 1px; right: 1px; width: 8px; height: 8px; background: #2E7D32; border-radius: 50%;"></div>
                    </div>
                    <span class="legend-label">üî¢ Multiple Exams</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); border-color: #42A5F5;"></div>
                    <span class="legend-label">üìÖ Scheduled</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%); border-color: #AB47BC;"></div>
                    <span class="legend-label">‚úîÔ∏è Completed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); border-color: #FFA726;"></div>
                    <span class="legend-label">üìù Draft</span>
                </div>
            </div>
            <div class="legend-help">
                üí° <strong>Tip:</strong> Click any cell to view and manage exam assignments
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="matrix-actions">
            <button class="btn btn-matrix-primary" onclick="ScheduleMatrix.openBulkAssign()">
                ‚ûï Bulk Assign Exams
            </button>
            <button class="btn btn-matrix-secondary" onclick="ScheduleMatrix.exportMatrix()">
                üì• Export Schedule
            </button>
            <button class="btn btn-matrix-secondary" onclick="window.print()">
                üñ®Ô∏è Print View
            </button>
        </div>
    </div>
</div>

<!-- Cell Detail Modal -->
<div id="cell-detail-modal" class="matrix-modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title">Manage Exam Assignments</h2>
            <button class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body" id="cell-detail-content">
            <div class="matrix-loading">
                <div class="spinner"></div>
                <p>Loading exam details...</p>
            </div>
        </div>
    </div>
</div>

<!-- Debug Panel (Hidden by default) -->
<div id="matrix-debug-panel" class="debug-panel" aria-hidden="true">
    <div class="debug-header">
        <span>üêõ Schedule Matrix Debug</span>
        <button onclick="ScheduleMatrix.DebugPanel.close()">√ó</button>
    </div>
    <div class="debug-content" id="debug-info">
        <div>Press Ctrl+Shift+D to toggle debug panel</div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Load Modular JavaScript -->
<script src="{% static 'js/routinetest/schedule-matrix.js' %}?v=3.0.0"></script>

<!-- Initialize with Configuration -->
<script>
    // Configuration passed from Django
    const MATRIX_CONFIG = {
        teacher: {
            id: {{ teacher.id|default:"null" }},
            name: "{{ teacher.name|default:'' }}"
        },
        currentYear: "{{ current_year }}",
        classCount: {{ assigned_classes.count|default:0 }},
        csrfToken: "{{ csrf_token }}",
        endpoints: {
            cellDetail: "/RoutineTest/schedule-matrix/cell/",
            bulkAssign: "/RoutineTest/bulk-assign-exams/",
            matrixData: "/RoutineTest/matrix-data/"
        }
    };

    // Debug logging
    console.group('%c[EXAM_ASSIGNMENTS] Page Configuration', 'background: #00A65E; color: white; padding: 5px; border-radius: 3px; font-weight: bold;');
    console.log('Module: Exam Assignments (Clean Architecture v3.0)');
    console.log('Teacher:', MATRIX_CONFIG.teacher.name);
    console.log('Academic Year:', MATRIX_CONFIG.currentYear);
    console.log('Assigned Classes:', MATRIX_CONFIG.classCount);
    console.log('JavaScript Module: Loaded');
    console.log('CSS Module: Loaded');
    console.groupEnd();

    // Additional initialization if needed
    document.addEventListener('scheduleMatrixReady', function(e) {
        console.log('[EXAM_ASSIGNMENTS] Schedule Matrix Module Ready:', e.detail);
        
        // Any additional setup after module initialization
        if (window.ScheduleMatrix) {
            // Example: Set custom configuration
            // ScheduleMatrix.setConfig(MATRIX_CONFIG);
        }
    });

    // Export functions (for backward compatibility if needed)
    window.openBulkAssign = function() {
        console.log('[EXAM_ASSIGNMENTS] Opening bulk assign modal');
        // Implementation would go here
        alert('Bulk assign feature coming soon!');
    };

    window.exportMatrix = function() {
        console.log('[EXAM_ASSIGNMENTS] Exporting matrix data');
        // Implementation would go here
        alert('Export feature coming soon!');
    };
</script>
{% endblock %}