{% extends "routinetest_base.html" %}
{% load static %}

{% block title %}Manage Classes - Admin{% endblock %}

{% block content %}
<div style="padding: 20px;">
    <h1>üìö Manage Classes</h1>
    
    <!-- Create New Class Form -->
    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <h2>Create New Class</h2>
        <form id="createClassForm" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
            {% csrf_token %}
            <div>
                <label for="className">Class Name*</label>
                <input type="text" id="className" name="name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div>
                <label for="gradeLevel">Grade Level*</label>
                <input type="text" id="gradeLevel" name="grade_level" required placeholder="e.g., Grade 5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div>
                <label for="section">Section</label>
                <input type="text" id="section" name="section" placeholder="e.g., A, B, C" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <button type="submit" style="padding: 8px 20px; background: #28A745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ‚ûï Create Class
            </button>
        </form>
    </div>
    
    <!-- Existing Classes -->
    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h2>Existing Classes ({{ classes|length }})</h2>
        
        {% if classes %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Class Name</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Grade Level</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Section</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Assigned Teachers</th>
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Students</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 2px solid #dee2e6;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for class in classes %}
                <tr style="transition: background-color 0.2s ease;" onmouseover="this.style.background='var(--green-bg-lightest)'" onmouseout="this.style.background='var(--neutral-white)'">
                    <td style="padding: var(--spacing-lg) var(--spacing-xl); border-bottom: 1px solid var(--neutral-border); font-size: var(--font-body); color: var(--text-primary);">{{ class.name }}</td>
                    <td style="padding: var(--spacing-lg) var(--spacing-xl); border-bottom: 1px solid var(--neutral-border); font-size: var(--font-body); color: var(--text-primary);">{{ class.grade_level }}</td>
                    <td style="padding: var(--spacing-lg) var(--spacing-xl); border-bottom: 1px solid var(--neutral-border); font-size: var(--font-body); color: var(--text-primary);">{{ class.section|default:"-" }}</td>
                    <td style="padding: var(--spacing-lg) var(--spacing-xl); border-bottom: 1px solid var(--neutral-border);">
                        <div class="teacher-list" data-class-id="{{ class.id }}">
                            {% if class.assigned_teachers.all %}
                                {% for teacher in class.assigned_teachers.all %}
                                    <span style="display: inline-block; padding: 3px 8px; background: #E3F2FD; border-radius: 15px; margin: 2px; font-size: 14px;">
                                        {{ teacher.name }}
                                        <button onclick="removeTeacher('{{ class.id }}', '{{ teacher.id }}')" style="background: none; border: none; color: red; cursor: pointer;">√ó</button>
                                    </span>
                                {% endfor %}
                            {% else %}
                                <span style="color: #999;">No teachers assigned</span>
                            {% endif %}
                        </div>
                    </td>
                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: center;">
                        {{ class.student_count }}
                    </td>
                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: center;">
                        <button onclick="showAssignTeacherModal('{{ class.id }}', '{{ class.name }}')" style="padding: 5px 10px; background: #1B5E20; color: white; border: none; border-radius: 3px; cursor: pointer; margin: 2px; transition: background-color 0.3s;" onmouseover="this.style.backgroundColor='#2E7D32'" onmouseout="this.style.backgroundColor='#1B5E20'">
                            Add Teacher
                        </button>
                        <button onclick="deleteClass('{{ class.id }}', '{{ class.name }}')" style="padding: 5px 10px; background: #DC3545; color: white; border: none; border-radius: 3px; cursor: pointer; margin: 2px;">
                            Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #666; text-align: center; padding: 20px;">No classes created yet. Create your first class above!</p>
        {% endif %}
    </div>
    
    <!-- Back to Dashboard -->
    <div style="margin-top: 30px;">
        <a href="{% url 'RoutineTest:admin_dashboard' %}" style="padding: 10px 20px; background: #6C757D; color: white; text-decoration: none; border-radius: 5px;">
            ‚Üê Back to Dashboard
        </a>
    </div>
</div>

<!-- Assign Teacher Modal -->
<div id="assignTeacherModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 400px;">
        <h3>Assign Teacher to <span id="modalClassName"></span></h3>
        <select id="teacherSelect" style="width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ddd; border-radius: 5px;">
            <option value="">Select a teacher...</option>
            {% for teacher in teachers %}
            <option value="{{ teacher.id }}">{{ teacher.name }}</option>
            {% endfor %}
        </select>
        <div style="text-align: right;">
            <button onclick="closeModal()" style="padding: 8px 15px; background: #6C757D; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                Cancel
            </button>
            <button onclick="assignTeacher()" style="padding: 8px 15px; background: #28A745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Assign
            </button>
        </div>
    </div>
</div>

<script>
// CSRF token for AJAX requests
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
let currentClassId = null;

// Create new class
document.getElementById('createClassForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('className').value,
        grade_level: document.getElementById('gradeLevel').value,
        section: document.getElementById('section').value
    };
    
    try {
        const response = await fetch('{% url "RoutineTest:create_class" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    } catch (error) {
        alert('Error creating class: ' + error);
    }
});

// Show assign teacher modal
function showAssignTeacherModal(classId, className) {
    currentClassId = classId;
    document.getElementById('modalClassName').textContent = className;
    document.getElementById('assignTeacherModal').style.display = 'block';
}

// Close modal
function closeModal() {
    document.getElementById('assignTeacherModal').style.display = 'none';
    document.getElementById('teacherSelect').value = '';
    currentClassId = null;
}

// Assign teacher
async function assignTeacher() {
    const teacherId = document.getElementById('teacherSelect').value;
    
    if (!teacherId) {
        alert('Please select a teacher');
        return;
    }
    
    try {
        const response = await fetch(`/RoutineTest/admin/classes/${currentClassId}/assign-teacher/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ teacher_id: teacherId })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    } catch (error) {
        alert('Error assigning teacher: ' + error);
    }
    
    closeModal();
}

// Remove teacher
async function removeTeacher(classId, teacherId) {
    if (!confirm('Remove this teacher from the class?')) return;
    
    try {
        const response = await fetch(`/RoutineTest/admin/classes/${classId}/remove-teacher/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ teacher_id: teacherId })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            location.reload();
        } else {
            alert(data.message);
        }
    } catch (error) {
        alert('Error removing teacher: ' + error);
    }
}

// Delete class
async function deleteClass(classId, className) {
    if (!confirm(`Delete class "${className}"? This action cannot be undone.`)) return;
    
    try {
        const response = await fetch(`/RoutineTest/admin/classes/${classId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    } catch (error) {
        alert('Error deleting class: ' + error);
    }
}
</script>
{% endblock %}