{% extends 'routinetest_base.html' %}
{% load static %}
{% load matrix_filters %}

{% block title %}Exam Assignments - RoutineTest{% endblock %}

{% block extra_css %}
<!-- Modular Schedule Matrix Styles -->
<link rel="stylesheet" href="{% static 'css/routinetest/schedule-matrix.css' %}?v=3.0.0">
{% endblock %}

{% block header %}üìä Exam Assignments{% endblock %}

{% block content %}
<!-- Main Container -->
<div class="matrix-container">
    <!-- Header with Controls -->
    <div class="matrix-header">
        <h1 class="matrix-title">
            <span>üìä</span>
            <span>Exam Assignments Overview</span>
        </h1>
        <div class="matrix-controls">
            <label for="year-selector">Academic Year:</label>
            <select id="year-selector" class="year-selector">
                {% for year in available_years %}
                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-matrix-primary" data-action="refresh">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <!-- Tab Container with Proper Panels -->
    <div class="tab-container">
        <!-- Tab Navigation -->
        <nav class="tab-navigation" role="tablist" aria-label="Exam type selection">
            <button class="tab-button active" 
                    data-tab="monthly" 
                    role="tab"
                    aria-selected="true"
                    aria-controls="monthly-panel"
                    id="monthly-tab">
                <span class="tab-icon">üìÖ</span>
                <span class="tab-label">Monthly/Review Exams</span>
            </button>
            <button class="tab-button" 
                    data-tab="quarterly"
                    role="tab"
                    aria-selected="false"
                    aria-controls="quarterly-panel"
                    id="quarterly-tab">
                <span class="tab-icon">üìä</span>
                <span class="tab-label">Quarterly Exams</span>
            </button>
        </nav>

        <!-- Tab Panels -->
        <div class="tab-panels">
            <!-- Monthly Panel -->
            <div id="monthly-panel" 
                 class="tab-panel active"
                 role="tabpanel"
                 aria-labelledby="monthly-tab"
                 aria-hidden="false">
                
                <div class="matrix-wrapper">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Curriculum</th>
                                {% for month in months %}
                                <th>{{ month_names|get_item:month }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for class_code, class_data in monthly_matrix.items %}
                            <tr data-class="{{ class_code }}">
                                <td>{{ class_data.display_name }}</td>
                                <td class="curriculum-mapping">
                                    {% if class_data.curriculum_mapping.combined != 'Not Assigned' %}
                                    <span class="curriculum-badge">{{ class_data.curriculum_mapping.combined }}</span>
                                    {% else %}
                                    <span class="curriculum-badge not-assigned">Not Assigned</span>
                                    {% endif %}
                                </td>
                                {% for month in months %}
                                {% with cell=class_data.cells|get_item:month %}
                                <td>
                                    <div class="matrix-cell {% if cell.exam_count > 0 %}has-exams{% else %}empty{% endif %} {{ cell.status|lower }}"
                                         data-cell-id="{{ cell.id }}"
                                         data-class="{{ class_code }}"
                                         data-period="{{ month }}"
                                         data-type="monthly"
                                         title="Click to manage exams">
                                        {% if cell.exam_count > 0 %}
                                        <div class="cell-count">{{ cell.exam_count }}</div>
                                        {% else %}
                                        <div class="cell-icon">‚ûñ</div>
                                        {% endif %}
                                        {% if cell.scheduled_date %}
                                        <div class="cell-date">{{ cell.scheduled_date|date:"M d" }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                {% endwith %}
                                {% endfor %}
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{{ months|length|add:2 }}" style="text-align: center; padding: 40px;">
                                    No classes assigned. Please contact your administrator.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Quarterly Panel -->
            <div id="quarterly-panel" 
                 class="tab-panel"
                 role="tabpanel"
                 aria-labelledby="quarterly-tab"
                 aria-hidden="true">
                
                <div class="matrix-wrapper">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Curriculum</th>
                                {% for quarter in quarters %}
                                <th>{{ quarter_names|get_item:quarter }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for class_code, class_data in quarterly_matrix.items %}
                            <tr data-class="{{ class_code }}">
                                <td>{{ class_data.display_name }}</td>
                                <td class="curriculum-mapping">
                                    {% if class_data.curriculum_mapping.combined != 'Not Assigned' %}
                                    <span class="curriculum-badge">{{ class_data.curriculum_mapping.combined }}</span>
                                    {% else %}
                                    <span class="curriculum-badge not-assigned">Not Assigned</span>
                                    {% endif %}
                                </td>
                                {% for quarter in quarters %}
                                {% with cell=class_data.cells|get_item:quarter %}
                                <td>
                                    <div class="matrix-cell {% if cell.exam_count > 0 %}has-exams{% else %}empty{% endif %} {{ cell.status|lower }}"
                                         data-cell-id="{{ cell.id }}"
                                         data-class="{{ class_code }}"
                                         data-period="{{ quarter }}"
                                         data-type="quarterly"
                                         title="Click to manage exams">
                                        {% if cell.exam_count > 0 %}
                                        <div class="cell-count">{{ cell.exam_count }}</div>
                                        {% else %}
                                        <div class="cell-icon">‚ûñ</div>
                                        {% endif %}
                                        {% if cell.scheduled_date %}
                                        <div class="cell-date">{{ cell.scheduled_date|date:"M d" }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                {% endwith %}
                                {% endfor %}
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{{ quarters|length|add:2 }}" style="text-align: center; padding: 40px;">
                                    No classes assigned. Please contact your administrator.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="matrix-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #FFEBEE; border-color: #FFCDD2;"></div>
                <span class="legend-label">No Exams</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #E8F5E9; border-color: #A5D6A7;"></div>
                <span class="legend-label">Has Exams</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #E3F2FD; border-color: #90CAF9;"></div>
                <span class="legend-label">Scheduled</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F3E5F5; border-color: #CE93D8;"></div>
                <span class="legend-label">Completed</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="matrix-actions">
            <button class="btn btn-matrix-primary" onclick="ScheduleMatrix.openBulkAssign()">
                ‚ûï Bulk Assign Exams
            </button>
            <button class="btn btn-matrix-secondary" onclick="ScheduleMatrix.exportMatrix()">
                üì• Export Schedule
            </button>
            <button class="btn btn-matrix-secondary" onclick="window.print()">
                üñ®Ô∏è Print View
            </button>
        </div>
    </div>
</div>

<!-- Cell Detail Modal -->
<div id="cell-detail-modal" class="matrix-modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title">Manage Exam Assignments</h2>
            <button class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body" id="cell-detail-content">
            <div class="matrix-loading">
                <div class="spinner"></div>
                <p>Loading exam details...</p>
            </div>
        </div>
    </div>
</div>

<!-- Debug Panel (Hidden by default) -->
<div id="matrix-debug-panel" class="debug-panel" aria-hidden="true">
    <div class="debug-header">
        <span>üêõ Schedule Matrix Debug</span>
        <button onclick="ScheduleMatrix.DebugPanel.close()">√ó</button>
    </div>
    <div class="debug-content" id="debug-info">
        <div>Press Ctrl+Shift+D to toggle debug panel</div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Load Modular JavaScript -->
<script src="{% static 'js/routinetest/schedule-matrix.js' %}?v=3.0.0"></script>

<!-- Initialize with Configuration -->
<script>
    // Configuration passed from Django
    const MATRIX_CONFIG = {
        teacher: {
            id: {{ teacher.id|default:"null" }},
            name: "{{ teacher.name|default:'' }}"
        },
        currentYear: "{{ current_year }}",
        classCount: {{ assigned_classes.count|default:0 }},
        csrfToken: "{{ csrf_token }}",
        endpoints: {
            cellDetail: "{% url 'RoutineTest:matrix_cell_detail' 'PLACEHOLDER' %}".replace('PLACEHOLDER', ''),
            bulkAssign: "{% url 'RoutineTest:bulk_assign_exams' %}",
            matrixData: "{% url 'RoutineTest:get_matrix_data' %}"
        }
    };

    // Debug logging
    console.group('%c[EXAM_ASSIGNMENTS] Page Configuration', 'background: #00A65E; color: white; padding: 5px; border-radius: 3px; font-weight: bold;');
    console.log('Module: Exam Assignments (Clean Architecture v3.0)');
    console.log('Teacher:', MATRIX_CONFIG.teacher.name);
    console.log('Academic Year:', MATRIX_CONFIG.currentYear);
    console.log('Assigned Classes:', MATRIX_CONFIG.classCount);
    console.log('JavaScript Module: Loaded');
    console.log('CSS Module: Loaded');
    console.groupEnd();

    // Additional initialization if needed
    document.addEventListener('scheduleMatrixReady', function(e) {
        console.log('[EXAM_ASSIGNMENTS] Schedule Matrix Module Ready:', e.detail);
        
        // Any additional setup after module initialization
        if (window.ScheduleMatrix) {
            // Example: Set custom configuration
            // ScheduleMatrix.setConfig(MATRIX_CONFIG);
        }
    });

    // Export functions (for backward compatibility if needed)
    window.openBulkAssign = function() {
        console.log('[EXAM_ASSIGNMENTS] Opening bulk assign modal');
        // Implementation would go here
        alert('Bulk assign feature coming soon!');
    };

    window.exportMatrix = function() {
        console.log('[EXAM_ASSIGNMENTS] Exporting matrix data');
        // Implementation would go here
        alert('Export feature coming soon!');
    };
</script>
{% endblock %}