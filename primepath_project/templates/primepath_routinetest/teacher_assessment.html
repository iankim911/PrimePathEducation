{% extends "unified_base.html" %}
{% block module_name %}primepath_routinetest{% endblock %}
{% comment %}
Migrated to unified_base.html on 2025-08-26
Original base template: routinetest_base.html
{% endcomment %}

{% load static %}

{% block title %}Teacher Class Assessment - Admin Only{% endblock %}

{% block extra_css %}
<style>
/* Teacher Assessment Module Styles */
.assessment-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.assessment-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #2E7D32;
}

.section-title {
    font-size: 1.4rem;
    font-weight: 600;
    color: #1B5E20;
}

.badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.badge-pending {
    background: #FFF3E0;
    color: #E65100;
}

.badge-approved {
    background: #E8F5E9;
    color: #2E7D32;
}

.badge-denied {
    background: #FFEBEE;
    color: #C62828;
}

/* Statistics Bar */
.stats-bar {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%);
    border-radius: 8px;
}

.stat-item {
    text-align: center;
    padding: 10px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2E7D32;
}

.stat-label {
    font-size: 0.85rem;
    color: #666;
    margin-top: 5px;
}

/* Teacher List Styles */
.teacher-list {
    max-height: 600px;
    overflow-y: auto;
}

.teacher-card {
    background: #FAFAFA;
    border: 1px solid #E0E0E0;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.teacher-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.teacher-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.teacher-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
}

.teacher-email {
    font-size: 0.9rem;
    color: #666;
}

.class-assignments {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.class-badge {
    padding: 4px 10px;
    background: #E3F2FD;
    color: #1565C0;
    border-radius: 4px;
    font-size: 0.85rem;
    border: 1px solid #90CAF9;
}

.class-badge.full-access {
    background: #E8F5E9;
    color: #2E7D32;
    border-color: #81C784;
}

.class-badge.view-only {
    background: #FFF3E0;
    color: #E65100;
    border-color: #FFB74D;
}

/* Request Cards */
.request-card {
    background: white;
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #FF9800;
}

.request-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.request-teacher {
    font-weight: 600;
    color: #333;
}

.request-class {
    color: #1565C0;
    font-weight: 500;
}

.request-reason {
    background: #F5F5F5;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    font-size: 0.9rem;
    color: #555;
}

.request-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn-approve {
    flex: 1;
    padding: 8px 16px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
}

.btn-approve:hover {
    background: #45a049;
}

.btn-deny {
    flex: 1;
    padding: 8px 16px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
}

.btn-deny:hover {
    background: #da190b;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-action {
    padding: 4px 8px;
    font-size: 0.85rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-revoke {
    background: #FFEBEE;
    color: #C62828;
}

.btn-revoke:hover {
    background: #EF5350;
    color: white;
}

.btn-assign {
    background: #E8F5E9;
    color: #2E7D32;
}

.btn-assign:hover {
    background: #4CAF50;
    color: white;
}

/* Modal Styles */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    border-radius: 8px;
    padding: 25px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #E0E0E0;
}

.modal-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #333;
}

/* Admin Badge */
.admin-badge {
    display: inline-block;
    padding: 4px 10px;
    background: linear-gradient(135deg, #FF6B00 0%, #FF9800 100%);
    color: white;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
    margin-left: 10px;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #DDD;
}

/* Scrollbar Styles */
.teacher-list::-webkit-scrollbar,
.request-list::-webkit-scrollbar {
    width: 8px;
}

.teacher-list::-webkit-scrollbar-track,
.request-list::-webkit-scrollbar-track {
    background: #F5F5F5;
}

.teacher-list::-webkit-scrollbar-thumb,
.request-list::-webkit-scrollbar-thumb {
    background: #2E7D32;
    border-radius: 4px;
}

.teacher-list::-webkit-scrollbar-thumb:hover,
.request-list::-webkit-scrollbar-thumb:hover {
    background: #1B5E20;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .assessment-container {
        grid-template-columns: 1fr;
    }
    
    .stats-bar {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 768px) {
    .stats-bar {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .request-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Console Debugging -->
<script>
console.group('%c[TEACHER_ASSESSMENT] Module Loaded', 'background: #FF9800; color: white; padding: 5px; font-weight: bold;');
console.log('User: {{ request.user.username }}');
console.log('Mode: {{ current_view_mode }}');
console.log('Admin Access: true');
console.log('Timestamp:', new Date().toISOString());
console.groupEnd();
</script>

<!-- Admin Only Warning -->
<div style="background: linear-gradient(135deg, #FF6B00 0%, #FF9800 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <strong>ðŸ”’ Admin Only Module</strong> - Teacher Class Assessment & Management
    <span class="admin-badge">ADMIN MODE</span>
</div>

<!-- Statistics Bar -->
<div class="stats-bar">
    <div class="stat-item">
        <div class="stat-value">{{ stats.total_teachers }}</div>
        <div class="stat-label">Total Teachers</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ stats.teachers_with_classes }}</div>
        <div class="stat-label">With Classes</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ stats.total_assignments }}</div>
        <div class="stat-label">Active Assignments</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ stats.pending_requests }}</div>
        <div class="stat-label">Pending Requests</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ stats.approved_today }}</div>
        <div class="stat-label">Approved Today</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ stats.denied_today }}</div>
        <div class="stat-label">Denied Today</div>
    </div>
</div>

<!-- Main Assessment Grid -->
<div class="assessment-container">
    <!-- Left Side: Teacher Assignments -->
    <div class="assessment-section">
        <div class="section-header">
            <h2 class="section-title">Teacher Class Assignments</h2>
            <button class="btn btn-primary" onclick="showDirectAssignModal()">+ Direct Assign</button>
        </div>
        
        <div class="teacher-list">
            {% for teacher in teachers %}
            <div class="teacher-card" data-teacher-id="{{ teacher.id }}">
                <div class="teacher-header">
                    <div>
                        <div class="teacher-name">
                            {{ teacher.name }}
                            {% if teacher.is_head_teacher %}
                                <span style="color: #FF9800; font-size: 0.9rem;">ðŸ‘‘ Head Teacher</span>
                            {% endif %}
                        </div>
                        <div class="teacher-email">{{ teacher.email }}</div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-action btn-assign" onclick="assignTeacher('{{ teacher.id }}', '{{ teacher.name }}')">
                            + Assign
                        </button>
                    </div>
                </div>
                
                <div class="class-assignments">
                    {% if teacher.active_assignments %}
                        {% for assignment in teacher.active_assignments %}
                        <div class="class-badge {{ assignment.access_level|lower }}-access" 
                             data-assignment-id="{{ assignment.id }}">
                            {{ assignment.get_class_code_display }}
                            <button class="btn-revoke" style="margin-left: 5px; padding: 2px 5px; font-size: 0.7rem;"
                                    onclick="revokeAccess('{{ assignment.id }}', '{{ teacher.name }}', '{{ assignment.get_class_code_display }}')">
                                Ã—
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <span style="color: #999; font-size: 0.9rem;">No class assignments</span>
                    {% endif %}
                </div>
                
                {% if teacher.pending_requests %}
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #E0E0E0;">
                    <span style="color: #FF9800; font-size: 0.85rem;">
                        ðŸ“‹ {{ teacher.pending_requests|length }} pending request(s)
                    </span>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p>No teachers found</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Right Side: Pending Requests -->
    <div class="assessment-section">
        <div class="section-header">
            <h2 class="section-title">Class Assignment Requests</h2>
            <span class="badge badge-pending">{{ pending_requests|length }} Pending</span>
        </div>
        
        <div class="request-list" style="max-height: 600px; overflow-y: auto;">
            {% for request in pending_requests %}
            <div class="request-card" data-request-id="{{ request.id }}">
                <div class="request-header">
                    <span class="request-teacher">{{ request.teacher.name }}</span>
                    <span class="request-class">{{ request.get_class_code_display }}</span>
                </div>
                
                <div style="font-size: 0.85rem; color: #666; margin: 5px 0;">
                    <i class="far fa-clock"></i> {{ request.requested_at|timesince }} ago
                    | Type: {{ request.get_request_type_display }}
                </div>
                
                <div class="request-reason">
                    <strong>Reason:</strong> {{ request.reason_text }}
                </div>
                
                {% if request.duration_start and request.duration_end %}
                <div style="font-size: 0.85rem; color: #666; margin: 5px 0;">
                    <i class="far fa-calendar"></i> Duration: {{ request.duration_start }} to {{ request.duration_end }}
                </div>
                {% endif %}
                
                <div class="request-actions">
                    <button class="btn-approve" onclick="approveRequest('{{ request.id }}')">
                        âœ“ Approve
                    </button>
                    <button class="btn-deny" onclick="denyRequest('{{ request.id }}', '{{ request.teacher.name }}')">
                        Ã— Deny
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No pending requests</p>
                <p style="font-size: 0.85rem; color: #BBB;">All requests have been processed</p>
            </div>
            {% endfor %}
        </div>
        
        {% if pending_requests|length > 3 %}
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #E0E0E0; text-align: center;">
            <button class="btn btn-secondary" onclick="bulkApproveAll()">
                Bulk Approve All ({{ pending_requests|length }})
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Class Assignment Matrix -->
<div class="assessment-section" id="class-matrix" style="margin-top: 20px;">
    <div class="section-header">
        <h2 class="section-title">Class Coverage Matrix</h2>
    </div>
    
    <!-- Class filters -->
    <div style="margin-bottom: 15px;">
        <label style="margin-right: 10px;">Filter by Category:</label>
        <select id="categoryFilter" onchange="filterClassMatrix()" style="padding: 5px 10px; margin-right: 10px;">
            <option value="">All Categories</option>
            <option value="PRIMARY">Primary School</option>
            <option value="MIDDLE">Middle School</option>
            <option value="HIGH">High School</option>
        </select>
        
        <label style="margin-right: 10px;">Filter by Grade:</label>
        <select id="gradeFilter" onchange="filterClassMatrix()" style="padding: 5px 10px;">
            <option value="">All Grades</option>
            {% for grade in "123456789101112"|make_list %}
            <option value="{{ grade }}">Grade {{ grade }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div id="classMatrixContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;">
        {% for class_code, class_info in class_matrix.items %}
        <div class="class-matrix-item" 
             data-category="{% if 'PRIMARY' in class_code %}PRIMARY{% elif 'MIDDLE' in class_code %}MIDDLE{% elif 'HIGH' in class_code %}HIGH{% endif %}"
             data-grade="{% if 'PRIMARY_1' in class_code %}1{% elif 'PRIMARY_2' in class_code %}2{% elif 'PRIMARY_3' in class_code %}3{% elif 'PRIMARY_4' in class_code %}4{% elif 'PRIMARY_5' in class_code %}5{% elif 'PRIMARY_6' in class_code %}6{% elif 'MIDDLE_7' in class_code %}7{% elif 'MIDDLE_8' in class_code %}8{% elif 'MIDDLE_9' in class_code %}9{% elif 'HIGH_10' in class_code %}10{% elif 'HIGH_11' in class_code %}11{% elif 'HIGH_12' in class_code %}12{% endif %}"
             style="background: #F5F5F5; padding: 10px; border-radius: 6px; border: 1px solid #E0E0E0;">
            <div style="font-weight: 600; color: #333; margin-bottom: 5px; font-size: 0.9rem;">
                {{ class_info.name }}
            </div>
            <div style="font-size: 0.8rem; color: #666; margin-bottom: 3px;">
                {% if 'PRIMARY' in class_code %}
                    ðŸŽ’ Primary
                {% elif 'MIDDLE' in class_code %}
                    ðŸ“š Middle
                {% elif 'HIGH' in class_code %}
                    ðŸŽ“ High School
                {% endif %}
            </div>
            <div style="font-size: 0.85rem; color: #666;">
                {{ class_info.count }} teacher(s)
            </div>
            {% if class_info.count == 0 %}
            <div style="color: #F44336; font-size: 0.8rem; margin-top: 5px;">
                âš  No teacher assigned
            </div>
            {% elif class_info.count > 3 %}
            <div style="color: #FF9800; font-size: 0.8rem; margin-top: 5px;">
                âš¡ High capacity
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Direct Assignment Modal -->
<div id="directAssignModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Direct Teacher Assignment</h3>
        </div>
        <form id="directAssignForm">
            <input type="hidden" id="assignTeacherId">
            
            <div class="form-group">
                <label>Teacher:</label>
                <input type="text" id="assignTeacherName" class="form-control" readonly>
            </div>
            
            <div class="form-group">
                <label>Select Class:</label>
                <select id="assignClassCode" class="form-control" required>
                    <option value="">-- Select Class --</option>
                    
                    <optgroup label="PRIMARY SCHOOL (Grades 1-6)">
                        {% for code, name in class_choices %}
                            {% if 'PRIMARY' in code %}
                            <option value="{{ code }}">{{ name }}</option>
                            {% endif %}
                        {% endfor %}
                    </optgroup>
                    
                    <optgroup label="MIDDLE SCHOOL (Grades 7-9)">
                        {% for code, name in class_choices %}
                            {% if 'MIDDLE' in code %}
                            <option value="{{ code }}">{{ name }}</option>
                            {% endif %}
                        {% endfor %}
                    </optgroup>
                    
                    <optgroup label="HIGH SCHOOL (Grades 10-12)">
                        {% for code, name in class_choices %}
                            {% if 'HIGH' in code %}
                            <option value="{{ code }}">{{ name }}</option>
                            {% endif %}
                        {% endfor %}
                    </optgroup>
                </select>
            </div>
            
            <div class="form-group">
                <label>Access Level:</label>
                <select id="assignAccessLevel" class="form-control" required>
                    <option value="FULL">Full Access</option>
                    <option value="VIEW">View Only</option>
                    <option value="CO_TEACHER">Co-Teacher</option>
                    <option value="SUBSTITUTE">Substitute</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Notes (Optional):</label>
                <textarea id="assignNotes" class="form-control" rows="3"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">Assign</button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Deny Reason Modal -->
<div id="denyReasonModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Deny Request</h3>
        </div>
        <form id="denyReasonForm">
            <input type="hidden" id="denyRequestId">
            
            <div class="form-group">
                <label>Teacher:</label>
                <input type="text" id="denyTeacherName" class="form-control" readonly>
            </div>
            
            <div class="form-group">
                <label>Reason for Denial:</label>
                <textarea id="denyReason" class="form-control" rows="4" required 
                          placeholder="Please provide a reason for denying this request..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-danger" style="flex: 1;">Confirm Deny</button>
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeDenyModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Console debugging for all actions
function logAction(action, details) {
    console.log(`%c[TEACHER_ASSESSMENT] ${action}`, 'color: #FF9800; font-weight: bold;', details);
}

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Approve Request
function approveRequest(requestId) {
    logAction('APPROVE_REQUEST', {requestId: requestId});
    
    if (!confirm('Are you sure you want to approve this request?')) {
        return;
    }
    
    fetch(`/RoutineTest/assessment/approve/${requestId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logAction('REQUEST_APPROVED', data);
            // Remove the request card with animation
            const card = document.querySelector(`[data-request-id="${requestId}"]`);
            if (card) {
                card.style.transition = 'opacity 0.3s, transform 0.3s';
                card.style.opacity = '0';
                card.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    card.remove();
                    updatePendingCount();
                }, 300);
            }
            // Reload page after short delay to show updated assignments
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error approving request:', error);
        alert('An error occurred while approving the request');
    });
}

// Deny Request
function denyRequest(requestId, teacherName) {
    logAction('INIT_DENY_REQUEST', {requestId: requestId, teacher: teacherName});
    
    document.getElementById('denyRequestId').value = requestId;
    document.getElementById('denyTeacherName').value = teacherName;
    document.getElementById('denyReason').value = '';
    document.getElementById('denyReasonModal').style.display = 'flex';
}

// Submit Deny Form
document.getElementById('denyReasonForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const requestId = document.getElementById('denyRequestId').value;
    const reason = document.getElementById('denyReason').value;
    
    logAction('DENY_REQUEST', {requestId: requestId, reason: reason});
    
    fetch(`/RoutineTest/assessment/deny/${requestId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({reason: reason})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logAction('REQUEST_DENIED', data);
            closeDenyModal();
            // Remove the request card
            const card = document.querySelector(`[data-request-id="${requestId}"]`);
            if (card) {
                card.style.transition = 'opacity 0.3s';
                card.style.opacity = '0';
                setTimeout(() => {
                    card.remove();
                    updatePendingCount();
                }, 300);
            }
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error denying request:', error);
        alert('An error occurred while denying the request');
    });
});

// Revoke Access
function revokeAccess(assignmentId, teacherName, className) {
    logAction('INIT_REVOKE_ACCESS', {
        assignmentId: assignmentId,
        teacher: teacherName,
        class: className
    });
    
    const reason = prompt(`Why are you revoking ${teacherName}'s access to ${className}?`);
    if (!reason) {
        return;
    }
    
    fetch('/RoutineTest/assessment/revoke/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            assignment_id: assignmentId,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logAction('ACCESS_REVOKED', data);
            // Remove the class badge
            const badge = document.querySelector(`[data-assignment-id="${assignmentId}"]`);
            if (badge) {
                badge.style.transition = 'opacity 0.3s';
                badge.style.opacity = '0';
                setTimeout(() => badge.remove(), 300);
            }
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error revoking access:', error);
        alert('An error occurred while revoking access');
    });
}

// Direct Assignment
function assignTeacher(teacherId, teacherName) {
    logAction('INIT_DIRECT_ASSIGN', {teacherId: teacherId, teacher: teacherName});
    
    document.getElementById('assignTeacherId').value = teacherId;
    document.getElementById('assignTeacherName').value = teacherName;
    document.getElementById('directAssignModal').style.display = 'flex';
}

function showDirectAssignModal() {
    // Show a select teacher first
    const teacherSelect = prompt('Enter teacher ID or select from list');
    // For now, just show the modal with empty fields
    document.getElementById('directAssignModal').style.display = 'flex';
}

// Submit Direct Assignment
document.getElementById('directAssignForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const data = {
        teacher_id: document.getElementById('assignTeacherId').value,
        class_code: document.getElementById('assignClassCode').value,
        access_level: document.getElementById('assignAccessLevel').value,
        notes: document.getElementById('assignNotes').value
    };
    
    logAction('SUBMIT_DIRECT_ASSIGN', data);
    
    fetch('/RoutineTest/assessment/direct-assign/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logAction('ASSIGNMENT_CREATED', data);
            closeModal();
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error creating assignment:', error);
        alert('An error occurred while creating the assignment');
    });
});

// Bulk Approve
function bulkApproveAll() {
    logAction('INIT_BULK_APPROVE', {});
    
    if (!confirm('Are you sure you want to approve ALL pending requests?')) {
        return;
    }
    
    const requestIds = Array.from(document.querySelectorAll('.request-card'))
        .map(card => card.dataset.requestId);
    
    logAction('BULK_APPROVE', {count: requestIds.length, ids: requestIds});
    
    fetch('/RoutineTest/assessment/bulk-approve/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({request_ids: requestIds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logAction('BULK_APPROVE_SUCCESS', data);
            location.reload();
        } else {
            alert('Some errors occurred: ' + data.message);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error in bulk approval:', error);
        alert('An error occurred during bulk approval');
    });
}

// Modal Controls
function closeModal() {
    document.getElementById('directAssignModal').style.display = 'none';
    document.getElementById('directAssignForm').reset();
}

function closeDenyModal() {
    document.getElementById('denyReasonModal').style.display = 'none';
    document.getElementById('denyReasonForm').reset();
}

// Update pending count badge
function updatePendingCount() {
    const cards = document.querySelectorAll('.request-card').length;
    const badge = document.querySelector('.badge-pending');
    if (badge) {
        badge.textContent = `${cards} Pending`;
    }
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
});

// Class Matrix Filtering
function filterClassMatrix() {
    const categoryFilter = document.getElementById('categoryFilter').value;
    const gradeFilter = document.getElementById('gradeFilter').value;
    const items = document.querySelectorAll('.class-matrix-item');
    
    let visibleCount = 0;
    
    items.forEach(item => {
        const category = item.getAttribute('data-category');
        const grade = item.getAttribute('data-grade');
        
        let showItem = true;
        
        if (categoryFilter && category !== categoryFilter) {
            showItem = false;
        }
        
        if (gradeFilter && grade !== gradeFilter) {
            showItem = false;
        }
        
        if (showItem) {
            item.style.display = 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    console.log(`[CLASS_FILTER] Showing ${visibleCount} of ${items.length} classes`);
    console.log(`[CLASS_FILTER] Category: ${categoryFilter || 'All'}, Grade: ${gradeFilter || 'All'}`);
}

// Page Load Analytics
window.addEventListener('DOMContentLoaded', function() {
    console.group('%c[TEACHER_ASSESSMENT] Page Analytics', 'background: #4CAF50; color: white; padding: 5px;');
    console.log('Total Teachers:', {{ stats.total_teachers }});
    console.log('Active Assignments:', {{ stats.total_assignments }});
    console.log('Pending Requests:', {{ stats.pending_requests }});
    console.log('Total Classes:', document.querySelectorAll('.class-matrix-item').length);
    console.log('Page Load Time:', performance.now() + 'ms');
    console.groupEnd();
});
</script>
{% endblock %}