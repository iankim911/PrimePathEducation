{% extends "routinetest_base.html" %}
{% load static %}
{% load access_display %}

{% block title %}Classes & Exams - RoutineTest{% endblock %}

{% block extra_css %}
<!-- Unified Classes & Exams Styles with Cache Busting v2.1 -->
<style>
    /* Main Container */
    .unified-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Access Summary Section - NEW CLEAN MINIMAL DESIGN */
    .access-summary-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        color: #333;
    }
    
    .access-summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .access-title {
        margin: 0;
        font-size: 20px;
        font-weight: 500;
        color: #495057;
    }
    
    .access-date {
        font-size: 14px;
        color: #6c757d;
    }
    
    /* Admin Access Box - CLEAN MINIMAL DESIGN */
    .access-admin-box {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }
    
    .access-admin-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding: 10px 15px;
        background: #e8f5e9;
        border: 1px solid #2e7d32;
        border-radius: 8px;
        width: fit-content;
        color: #1b5e20;
    }
    
    .badge-icon {
        font-size: 24px;
    }
    
    .badge-text {
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 1px;
    }
    
    .access-admin-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .access-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: 600;
        color: #495057;
    }
    
    .stat-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 5px;
    }
    
    .access-admin-note {
        font-size: 14px;
        color: #6c757d;
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    /* NEW SIMPLIFIED TEACHER ACCESS SECTION - MINIMAL DESIGN */
    .teacher-access-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .global-access-badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
        margin-bottom: 20px;
    }
    
    .global-access-badge.full {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #4caf50;
    }
    
    .global-access-badge.view-only {
        background: #fff3e0;
        color: #f57c00;
        border: 1px solid #ff9800;
    }
    
    .assigned-classes-list {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }
    
    .assigned-classes-title {
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        margin-bottom: 10px;
    }
    
    .class-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .class-item {
        padding: 6px 12px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 13px;
        color: #495057;
    }
    
    /* NEW MINIMAL TEACHER STATS */
    .teacher-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .teacher-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        text-align: center;
    }
    
    .teacher-stat .stat-icon {
        font-size: 20px;
        margin-bottom: 8px;
        color: #6c757d;
    }
    
    .teacher-stat .stat-value {
        font-size: 20px;
        font-weight: 600;
        color: #495057;
        margin-bottom: 4px;
    }
    
    .teacher-stat .stat-label {
        font-size: 11px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .teacher-stat.pending .stat-value {
        color: #f57c00;
    }
    
    /* Classes Section */
    .classes-section {
        background: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 3px solid #2E7D32;
    }
    
    .section-title {
        font-size: 24px;
        font-weight: bold;
        color: #2E7D32;
    }
    
    /* Program-based Organization */
    .program-section {
        margin-bottom: 35px;
        background: #f8f9fa !important;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #dee2e6;
    }
    
    /* Force proper colors for all program headers - override any cached styles */
    .program-header {
        background: #f8f9fa !important;
        color: inherit !important;
    }
    
    .program-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid;
        cursor: pointer;
        user-select: none;
    }
    
    .program-header.core { border-bottom-color: #2E7D32; }
    .program-header.ascent { border-bottom-color: #1B5E20; }
    .program-header.edge { border-bottom-color: #0D4F1F; }
    .program-header.pinnacle { border-bottom-color: #00A65E; }
    
    .program-title {
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .program-title.core { color: #2E7D32 !important; background: transparent !important; }
    .program-title.ascent { color: #1B5E20 !important; background: transparent !important; }
    .program-title.edge { color: #0D4F1F !important; background: transparent !important; }
    .program-title.pinnacle { color: #00A65E !important; background: transparent !important; }
    
    /* Ensure no teal/turquoise backgrounds anywhere */
    .program-section, .program-header, .program-title, .program-classes {
        background-color: #f8f9fa !important;
    }
    
    /* Override any potential inline styles or cached CSS */
    .program-header.core {
        background-color: #f8f9fa !important;
        border-bottom-color: #2E7D32 !important;
    }
    
    .program-summary {
        display: flex;
        gap: 15px;
        align-items: center;
        font-size: 14px;
        color: #6c757d;
    }
    
    .program-toggle {
        font-size: 18px;
        transition: transform 0.3s;
    }
    
    .program-section.collapsed .program-toggle {
        transform: rotate(-90deg);
    }
    
    .program-section.collapsed .program-classes {
        display: none;
    }
    
    .program-classes {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.95); }
    }
    
    .class-card {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s ease;
        background: white;
        cursor: pointer;
        position: relative;
    }
    
    .class-card:hover {
        border-color: #2E7D32;
        box-shadow: 0 5px 15px rgba(46, 125, 50, 0.2);
        transform: translateY(-2px);
    }
    
    .class-card.incomplete {
        border-left: 4px solid #ff9800;
    }
    
    .class-card.complete {
        border-left: 4px solid #2E7D32;
    }
    
    .class-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .class-name {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
    
    .class-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .badge-full {
        background: #2E7D32;
        color: white;
    }
    
    .badge-limited {
        background: #1B5E20;
        color: white;
    }
    
    /* Class Summary Info */
    .class-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin: 15px 0;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .class-summary-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #495057;
    }
    
    .class-summary-item .icon {
        font-size: 18px;
    }
    
    .class-summary-item strong {
        color: #212529;
        margin: 0 3px;
    }
    
    .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .status-indicator.complete { background: #2E7D32; }
    .status-indicator.incomplete { background: #ff9800; }
    .status-indicator.not-started { background: #f44336; }
    
    /* Matrix Preview CSS removed - visual component eliminated */
    
    /* Exam count display */
    .exam-count {
        display: block;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 4px;
    }
    
    .exam-count.count-0 {
        color: #D32F2F;  /* Red for 0 */
    }
    
    .exam-count.count-1 {
        color: #388E3C;  /* Green for 1 */
    }
    
    .exam-count.count-multiple {
        color: #1B5E20;  /* Dark green for 2+ */
    }
    
    /* Legacy support */
    .has-exam {
        background: #E8F5E9;
    }
    
    /* Curriculum Mapping Column */
    .curriculum-mapping {
        padding: 6px;
        background: #F8F9FA;
        font-size: 11px;
        max-width: 140px;
        width: 140px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .curriculum-badge {
        display: inline-block;
        padding: 3px 6px;
        background: #E8F5E9;
        color: #1B5E20;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        white-space: nowrap;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .curriculum-badge.not-assigned {
        background: #FFF3E0;
        color: #E65100;
        font-style: italic;
    }
    
    /* Exam indicators container */
    .exam-indicators {
        display: flex;
        justify-content: center;
        gap: 4px;
        margin-top: 4px;
    }
    
    .exam-indicator {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
        color: white;
        margin: 2px;
    }
    
    .exam-indicator.exam-review {
        background: #2E7D32;
    }
    
    .exam-indicator.exam-quarterly {
        background: #FF9800;
    }
    
    .exam-review {
        background: #2E7D32;
        color: white;
    }
    
    .exam-quarterly {
        background: #FF9800;
        color: white;
    }
    
    /* Scroll indicator */
    .scroll-indicator {
        text-align: center;
        margin: 20px 0;
        animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-10px);
        }
        60% {
            transform: translateY(-5px);
        }
    }
    
    /* Loading states */
    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .class-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* ===== EXAM TYPE TAB TOGGLE STYLES ===== */
    .exam-type-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .exam-type-tab {
        flex: 1;
        padding: 12px 16px;
        text-align: center;
        cursor: pointer;
        background: #f8f9fa;
        border: none;
        color: #6c757d;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        outline: none;
    }
    
    .exam-type-tab:hover {
        background: #e9ecef;
        color: #495057;
    }
    
    .exam-type-tab.active {
        background: #2E7D32;
        color: white;
        font-weight: 600;
        box-shadow: inset 0 -3px 0 rgba(255, 255, 255, 0.3);
    }
    
    .exam-type-tab.active:hover {
        background: #1B5E20;
    }
    
    .tab-icon {
        font-size: 1rem;
    }
    
    .tab-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 600;
        min-width: 20px;
        text-align: center;
        background: rgba(0, 0, 0, 0.1);
    }
    
    .exam-type-tab.active .tab-badge {
        background: rgba(255, 255, 255, 0.2);
    }
    
    /* Matrix content CSS removed - visual component eliminated */
    
    /* Admin Section Styles */
    .admin-section {
        background: #FFF3E0;
        border: 2px solid #FF9800;
        border-radius: 15px;
        padding: 30px;
        margin-top: 40px;
        box-shadow: 0 5px 15px rgba(255, 152, 0, 0.1);
    }
    
    .admin-section .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #FF9800;
    }
    
    .admin-section .section-title {
        font-size: 24px;
        font-weight: bold;
        color: #E65100;
    }
    
    .admin-section .section-subtitle {
        color: #F57C00;
        font-size: 14px;
    }
    
    .admin-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .admin-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .admin-table thead {
        background: #FF9800;
        color: white;
    }
    
    .admin-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    
    .admin-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #F0F0F0;
    }
    
    .admin-table tbody tr:hover {
        background: #FFF9F0;
    }
    
    .curriculum-select {
        padding: 4px 8px;
        border: 1px solid #DDD;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .btn-edit {
        background: #2E7D32;
        color: white;
        border: none;
        padding: 4px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-right: 5px;
    }
    
    .btn-delete {
        background: #F44336;
        color: white;
        border: none;
        padding: 4px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    /* Matrix filter CSS removed - visual component eliminated */
</style>
{% endblock %}

{% block header %}Classes & Exams Management{% endblock %}

{% block content %}

<!-- Debug Console Logging -->
<script>
console.group('%c[UNIFIED_VIEW] Classes & Exams Page Loaded', 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 5px 10px; border-radius: 3px; font-weight: bold;');
console.log('üìä View Type: Unified (Classes & Exams)');
console.log('üë§ User:', '{{ user.username }}');
console.log('üéì Is Admin:', {{ is_admin|lower }});
console.log('üìÖ Academic Year:', {{ current_year }});
console.log('‚è±Ô∏è Render Time:', '{{ render_time }}');
console.log('üîÑ Cache Bust:', '{{ cache_bust }}');
console.log('üìã Total Classes:', {{ classes_info|length }});

console.groupEnd();

// Matrix debugging JavaScript removed - visual component eliminated
console.log('[MATRIX_REMOVAL] Matrix debugging and analysis code removed from template');
</script>


<div class="unified-container">
    {% if error %}
    <!-- Error State -->
    <div class="alert alert-danger">
        <h4>Error Loading Classes & Exams</h4>
        <p>{{ error_message }}</p>
        <a href="{% url 'RoutineTest:index' %}" class="btn btn-primary">Return to Dashboard</a>
    </div>
    {% else %}
    
    <!-- My Access Summary Section -->
    <div class="access-summary-section">
        <div class="access-summary-header">
            <h3 class="access-title">
                {% if is_admin %}
                    Administrator Access Overview
                {% else %}
                    My Access Overview
                {% endif %}
            </h3>
            <span class="access-date">{{ current_date|date:"F j, Y" }}</span>
        </div>
        
        <div class="access-summary-content">
            {% if is_admin %}
                <!-- Admin Summary -->
                <div class="access-admin-box">
                    <div class="access-admin-badge">
                        <span class="badge-icon">üîê</span>
                        <span class="badge-text">FULL ADMINISTRATOR</span>
                    </div>
                    <div class="access-admin-details">
                        <div class="access-stat">
                            <span class="stat-number">{{ total_classes|default:"0" }}</span>
                            <span class="stat-label">Total Classes</span>
                        </div>
                        <div class="access-stat">
                            <span class="stat-number">{{ total_students|default:"0" }}</span>
                            <span class="stat-label">Total Students</span>
                        </div>
                        <div class="access-stat">
                            <span class="stat-number">{{ total_exams|default:"0" }}</span>
                            <span class="stat-label">Total Exams</span>
                        </div>
                        <div class="access-stat">
                            <span class="stat-number">ALL</span>
                            <span class="stat-label">Access Level</span>
                        </div>
                    </div>
                    <div class="access-admin-note">
                        You have full administrative access to all classes, exams, and student data across all programs.
                    </div>
                    
                    <!-- Admin Notifications - Pending Requests -->
                    {% if admin_pending_requests_count > 0 %}
                    <div class="admin-notifications" style="margin-top: 20px; padding: 16px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; border-left: 4px solid #f39c12;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 20px;">üîî</span>
                                <div>
                                    <div style="font-weight: 600; color: #856404; margin-bottom: 4px;">
                                        {{ admin_pending_requests_count }} Class Access Request{{ admin_pending_requests_count|pluralize }} Pending
                                    </div>
                                    <div style="font-size: 13px; color: #6c5b00;">
                                        Teachers are requesting access to classes and need your approval.
                                    </div>
                                </div>
                            </div>
                            <a href="{% url 'RoutineTest:admin_pending_requests' %}" 
                               class="btn btn-warning" 
                               style="background: #f39c12; border: none; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 500; transition: background 0.2s;"
                               onmouseover="this.style.background='#e67e22'" 
                               onmouseout="this.style.background='#f39c12'">
                                Review Requests
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            {% else %}
                <!-- NEW SIMPLIFIED TEACHER ACCESS SECTION -->
                <div class="teacher-access-section">
                    <!-- Global Access Level Badge -->
                    <div class="global-access-badge {% if global_access_level == 'FULL' %}full{% else %}view-only{% endif %}">
                        {% if global_access_level == 'FULL' %}
                            <span>‚úÖ</span>
                            <span>Full Access - Can manage all assigned classes</span>
                        {% else %}
                            <span>üëÅÔ∏è</span>
                            <span>View Only - Can view but not edit assigned classes</span>
                        {% endif %}
                    </div>
                    
                    <!-- Global Access Message -->
                    {% if global_access_message %}
                    <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 14px; color: #1976d2;">
                        ‚ÑπÔ∏è {{ global_access_message }}
                    </div>
                    {% endif %}
                    
                    <!-- Teacher Stats Grid -->
                    <div class="teacher-stats-grid">
                        <div class="teacher-stat">
                            <span class="stat-icon">üìö</span>
                            <span class="stat-value">{{ total_assigned_classes|default:"0" }}</span>
                            <span class="stat-label">Assigned Classes</span>
                        </div>
                        <div class="teacher-stat">
                            <span class="stat-icon">üë•</span>
                            <span class="stat-value">{{ total_assigned_students|default:"0" }}</span>
                            <span class="stat-label">Students</span>
                        </div>
                        <div class="teacher-stat">
                            <span class="stat-icon">üìù</span>
                            <span class="stat-value">{{ total_assigned_exams|default:"0" }}</span>
                            <span class="stat-label">Active Exams</span>
                        </div>
                        {% if pending_requests_count > 0 %}
                        <div class="teacher-stat pending">
                            <span class="stat-icon">‚è≥</span>
                            <span class="stat-value">{{ pending_requests_count }}</span>
                            <span class="stat-label">Pending</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Assigned Classes List -->
                    {% if assigned_classes %}
                    <div class="assigned-classes-list">
                        <div class="assigned-classes-title">
                            Your Assigned Classes ({{ assigned_classes|length }})
                        </div>
                        <div class="class-list">
                            {% for class in assigned_classes %}
                            <div class="class-item">
                                {{ class.class_code }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Request Access Button for Teachers -->
                    {% if not is_admin %}
                    <div class="request-access-section" style="margin-top: 20px; text-align: center;">
                        <button type="button" class="btn btn-primary" id="requestAccessBtn" onclick="openRequestAccessModal()" style="background: #2E7D32; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 500; display: flex; align-items: center; gap: 8px; margin: 0 auto;">
                            <span>‚ûï</span>
                            <span>Request Access to Classes</span>
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            Need access to additional classes? Submit a request for admin approval.
                        </div>
                    </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Admin Badge (Simple) - Removed as it's now in the Access Summary -->
    {% comment %}
    {% if is_admin %}
    <div style="text-align: center; margin-bottom: 20px;">
        <span class="badge badge-full" style="font-size: 14px; padding: 8px 16px; background: #2E7D32; color: white; border-radius: 20px;">
            üëë ADMIN - Full Access to All Classes
        </span>
    </div>
    {% endif %}
    {% endcomment %}
    
    <!-- SECTION 1: Class Management (Program-based Organization) -->
    <div class="classes-section">
        <div class="section-header">
            <div class="section-title">üìö Class Management</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                {% if is_admin %}
                <span class="badge badge-full" style="background: #2E7D32;">Admin - All Classes</span>
                {% else %}
                <span style="color: #6c757d; font-size: 14px;">Showing your assigned classes</span>
                {% endif %}
                {% if not is_admin and pending_requests_count > 0 %}
                <span class="badge badge-warning">{{ pending_requests_count }} Pending Request{{ pending_requests_count|pluralize }}</span>
                {% endif %}
            </div>
        </div>
        
        <!-- Programs Container -->
        <div class="programs-container">
            {% for program in programs_data %}
            <div class="program-section" id="program-{{ program.name|lower }}">
                <div class="program-header {{ program.name|lower }}" onclick="toggleProgram('{{ program.name|lower }}')">
                    <div class="program-title {{ program.name|lower }}">
                        {% if program.name == 'CORE' %}üìó{% elif program.name == 'ASCENT' %}üìò{% elif program.name == 'EDGE' %}üìô{% else %}üìï{% endif %}
                        {{ program.name }} Program
                    </div>
                    <div class="program-summary">
                        <span>{{ program.classes|length }} Classes</span>
                        <span>‚Ä¢</span>
                        <span>{{ program.total_students }} Students</span>
                        <span>‚Ä¢</span>
                        <span>{{ program.total_exams }} Exams</span>
                        {% if program.incomplete_assignments > 0 %}
                        <span>‚Ä¢</span>
                        <span style="color: #ff9800;">‚ö†Ô∏è {{ program.incomplete_assignments }} Incomplete</span>
                        {% endif %}
                    </div>
                    <div class="program-toggle">‚ñº</div>
                </div>
                
                <div class="program-classes">
                    {% for class in program.classes %}
                    <div class="class-card {% if class.all_exams_assigned %}complete{% elif class.active_exams > 0 %}incomplete{% else %}not-started{% endif %}" 
                         onclick="viewClassDetails('{{ class.class_code }}')" 
                         title="Click to view class details">
                        
                        <div class="class-header">
                            <div class="class-name">{{ class.class_name }}</div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div class="class-badge badge-{{ class.access_level|access_level_class }}">
                                    {{ class.access_level|display_access_level }}
                                </div>
                                {% if is_admin %}
                                <button onclick="event.stopPropagation(); confirmDeleteClass('{{ class.class_code }}', '{{ class.class_name|escapejs }}', event); return false;" 
                                        class="btn-delete-class"
                                        style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;"
                                        onmouseover="this.style.background='#c82333'" 
                                        onmouseout="this.style.background='#dc3545'"
                                        title="Delete Class">
                                    üóëÔ∏è
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="class-summary">
                            <div class="class-summary-item">
                                <span class="icon">üë•</span>
                                <span><strong>{{ class.student_count }}</strong> Students</span>
                            </div>
                            <div class="class-summary-item">
                                {% if class.active_exams > 0 %}
                                <span class="icon">üìù</span>
                                <span><strong>{{ class.active_exams }}</strong> Exams Assigned</span>
                                {% else %}
                                <span class="icon" style="color: #dc3545;">üî¥</span>
                                <span style="color: #dc3545; font-weight: 600;">No Exams Assigned</span>
                                {% endif %}
                            </div>
                            <div class="class-summary-item">
                                <span class="icon">üìö</span>
                                <span><strong>{{ class.curriculum_full|default:class.curriculum_level|default:"Level 1" }}</strong></span>
                            </div>
                            <div class="class-summary-item">
                                <span class="icon">üîë</span>
                                <span><strong>{{ class.access_level }}</strong> Access</span>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div style="padding: 20px; text-align: center; color: #6c757d;">
                        No classes assigned in {{ program.name }} program
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% empty %}
            <div style="padding: 40px; text-align: center; color: #6c757d;">
                <p>No classes available to display.</p>
                {% if not is_admin %}
                <p>Please contact your administrator to be assigned to classes.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- SECTION 2: Teachers Management (Admin Only) - MOVED AND MERGED -->
    {% if is_admin %}
    <div class="admin-section" style="margin: var(--spacing-xl) 0; padding: var(--spacing-xl); background: var(--green-bg-lightest); border: 3px solid var(--primary-dark-green); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);">
        <div class="section-header" style="margin-bottom: var(--spacing-lg); border-bottom: 3px solid var(--primary-dark-green); padding-bottom: var(--spacing-lg);">
            <div class="section-title" style="font-size: var(--font-h2); font-weight: var(--font-weight-bold); color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-md);">
                <span style="font-size: 28px;">üéì</span>
                Teachers Management
            </div>
            <div style="color: var(--text-muted); font-size: var(--font-small); margin-top: var(--spacing-sm);">
                Comprehensive teacher access control and class assignment management
            </div>
        </div>
        
        <!-- Quick Stats - Professional Dark Green Theme -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-xl);">
            <div style="background: var(--neutral-white); border: 2px solid var(--primary-medium-green); padding: var(--spacing-lg); border-radius: var(--radius-md); text-align: center; box-shadow: var(--shadow-sm);">
                <div style="color: var(--primary-dark-green); font-size: var(--font-h1); font-weight: var(--font-weight-bold);">{{ admin_pending_requests_count|default:"0" }}</div>
                <div style="color: var(--text-muted); font-size: var(--font-small); text-transform: uppercase; margin-top: var(--spacing-xs);">Pending Requests</div>
            </div>
            <div style="background: var(--neutral-white); border: 2px solid var(--primary-medium-green); padding: var(--spacing-lg); border-radius: var(--radius-md); text-align: center; box-shadow: var(--shadow-sm);">
                <div style="color: var(--primary-dark-green); font-size: var(--font-h1); font-weight: var(--font-weight-bold);">{{ total_teachers|default:"0" }}</div>
                <div style="color: var(--text-muted); font-size: var(--font-small); text-transform: uppercase; margin-top: var(--spacing-xs);">Active Teachers</div>
            </div>
            <div style="background: var(--neutral-white); border: 2px solid var(--primary-medium-green); padding: var(--spacing-lg); border-radius: var(--radius-md); text-align: center; box-shadow: var(--shadow-sm);">
                <div style="color: var(--primary-dark-green); font-size: var(--font-h1); font-weight: var(--font-weight-bold);">{{ total_assignments|default:"0" }}</div>
                <div style="color: var(--text-muted); font-size: var(--font-small); text-transform: uppercase; margin-top: var(--spacing-xs);">Class Assignments</div>
            </div>
        </div>
        
        <!-- Management Actions -->
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Teacher Access Management -->
            <a href="{% url 'RoutineTest:admin_teacher_management_dashboard' %}" 
               class="unified-btn unified-btn-primary" 
               style="background: var(--primary-dark-green); border: 2px solid var(--primary-dark-green); color: var(--text-on-green); padding: 18px 24px; border-radius: var(--radius-md); text-decoration: none; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s; box-shadow: var(--shadow-md);"
               onmouseover="this.style.background='var(--primary-medium-green)'; this.style.borderColor='var(--primary-medium-green)'" 
               onmouseout="this.style.background='var(--primary-dark-green)'; this.style.borderColor='var(--primary-dark-green)'">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 24px;">üë•</span>
                    <div>
                        <div style="font-weight: var(--font-weight-bold); font-size: var(--font-body);">Teacher Access Dashboard</div>
                        <div style="font-size: var(--font-small); opacity: 0.9; margin-top: 2px;">Manage teacher-class assignments and multi-teacher support</div>
                    </div>
                </div>
                <span style="font-size: 20px;">‚Üí</span>
            </a>
            
            <!-- Classes & Teachers Configuration -->
            <a href="{% url 'RoutineTest:admin_classes_teachers' %}" 
               class="unified-btn unified-btn-secondary" 
               style="background: var(--neutral-white); border: 2px solid var(--primary-dark-green); color: var(--text-primary); padding: 18px 24px; border-radius: var(--radius-md); text-decoration: none; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s; box-shadow: var(--shadow-sm);"
               onmouseover="this.style.background='var(--green-bg-lightest)'; this.style.borderColor='var(--primary-medium-green)'" 
               onmouseout="this.style.background='var(--neutral-white)'; this.style.borderColor='var(--primary-dark-green)'">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 24px;">‚öôÔ∏è</span>
                    <div>
                        <div style="font-weight: var(--font-weight-bold); font-size: var(--font-body);">Classes & Curriculum Configuration</div>
                        <div style="font-size: var(--font-small); opacity: 0.8; margin-top: 2px;">Set curriculum recommendations and manage class settings</div>
                    </div>
                </div>
                <span style="font-size: 20px;">‚Üí</span>
            </a>
            
            {% if admin_pending_requests_count > 0 %}
            <!-- Pending Requests Alert - Special Dark Green Notification -->
            <a href="{% url 'RoutineTest:admin_pending_requests' %}" 
               class="unified-btn" 
               style="background: var(--primary-dark-green); border: 3px solid var(--primary-medium-green); color: var(--text-on-green); padding: 18px 24px; border-radius: var(--radius-md); text-decoration: none; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-lg); transition: all 0.3s; position: relative; overflow: hidden;"
               onmouseover="this.style.transform='translateY(-2px)'; this.style.background='var(--primary-medium-green)'" 
               onmouseout="this.style.transform='translateY(0)'; this.style.background='var(--primary-dark-green)'">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 24px; animation: pulse 2s infinite;">üîî</span>
                    <div>
                        <div style="font-weight: var(--font-weight-bold); font-size: var(--font-body);">{{ admin_pending_requests_count }} Pending Request{{ admin_pending_requests_count|pluralize }}</div>
                        <div style="font-size: var(--font-small); opacity: 0.9; margin-top: 2px;">Teachers are waiting for your approval</div>
                    </div>
                </div>
                <span style="font-size: 20px;">‚Üí</span>
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Add pulse animation for notification bell -->
    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
    {% endif %}
    
    <!-- 
    MATRIX COMPONENT REMOVED (COMPREHENSIVE REMOVAL):
    The Exam Assignments Matrix visual display has been completely removed as requested.
    
    Removed components:
    - Matrix preview table showing class √ó timeslot grid
    - Exam type toggle tabs (Review/Quarterly/All Exams)
    - Matrix legend and visual indicators
    - Interactive matrix cell functionality
    
    IMPORTANT: The underlying exam assignment functionality via ExamScheduleMatrix model
    remains intact for API operations (copying, deleting, assigning exams).
    Only the visual matrix display has been removed.
    
    Console logging added for removal tracking.
    -->
    <script>
    console.log('[MATRIX_REMOVAL] Exam Assignments Matrix display has been removed from UI');
    console.log('[MATRIX_REMOVAL] Underlying exam functionality preserved for API operations');
    console.log('[MATRIX_REMOVAL] Timestamp:', new Date().toISOString());
    </script>
    
    {% endif %}
    
    <!-- Admin-Only Curriculum Management Section -->
    {% if user.is_superuser %}
    <div class="admin-section">
        <div class="section-header">
            <div class="section-title">üîê Admin: Curriculum Management</div>
            <div class="section-subtitle">Manage class-curriculum mappings and class configurations</div>
        </div>
        
        <div class="admin-controls">
            <button class="btn btn-primary" onclick="showCreateClassDialog()">
                Create New Class
            </button>
            <button class="btn btn-secondary" onclick="refreshClassList()">
                Refresh
            </button>
        </div>
        
        <div class="admin-classes-table">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Class Code</th>
                        <th>Class Name</th>
                        <th>Current Curriculum</th>
                        <th>Program</th>
                        <th>Sub-Program</th>
                        <th>Level</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adminClassTableBody">
                    <!-- Dynamically populated -->
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
</div>

<!-- Create/Edit Class Modal -->
<div id="classManagementModal" class="modal" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="classModalTitle">Create New Class</h4>
                <button type="button" class="close-modal" onclick="closeClassModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="classForm">
                    <div class="form-group">
                        <label>Class Code:</label>
                        <input type="text" id="classCode" class="form-control" placeholder="e.g., CLASS_1A" required>
                    </div>
                    <div class="form-group">
                        <label>Class Name:</label>
                        <input type="text" id="className" class="form-control" placeholder="e.g., Grade 1 Section A" required>
                    </div>
                    
                    <hr>
                    <h5>Curriculum Mapping</h5>
                    
                    <div class="form-group">
                        <label>Program:</label>
                        <select id="programSelect" class="form-control" onchange="loadSubPrograms()">
                            <option value="">-- Select Program --</option>
                            <option value="CORE">PRIME CORE</option>
                            <option value="ASCENT">PRIME ASCENT</option>
                            <option value="EDGE">PRIME EDGE</option>
                            <option value="PINNACLE">PRIME PINNACLE</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Sub-Program:</label>
                        <select id="subProgramSelect" class="form-control" onchange="loadLevels()" disabled>
                            <option value="">-- Select Sub-Program --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Level:</label>
                        <select id="levelSelect" class="form-control" disabled>
                            <option value="">-- Select Level --</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeClassModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveClass()">Save Class</button>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic Updates Script -->
<script>
// Program toggle function
function toggleProgram(programName) {
    const programSection = document.getElementById('program-' + programName);
    if (programSection) {
        programSection.classList.toggle('collapsed');
        console.log('[CLASS_MANAGEMENT] Toggled program:', programName);
    }
}

// View class details function
function viewClassDetails(classCode) {
    console.log('[CLASS_MANAGEMENT] Navigating to class details:', classCode);
    // Navigate to the new class details page with Student Management and Exam Schedule
    window.location.href = '/RoutineTest/class/' + classCode + '/details/';
}

// Class deletion confirmation
function confirmDeleteClass(classCode, className, event) {
    // Stop event propagation to prevent card click
    if (event) {
        event.stopPropagation();
    }
    
    if (confirm(`Are you sure you want to delete class "${className}"?\n\nThis will:\n‚Ä¢ Remove the class from the system\n‚Ä¢ Delete all associated assignments\n‚Ä¢ Remove student enrollments\n\nThis action cannot be undone.`)) {
        deleteClass(classCode);
    }
    return false;
}

async function deleteClass(classCode) {
    try {
        const deleteUrl = `/RoutineTest/class/${classCode}/delete/`;
        
        const response = await fetch(deleteUrl, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                // Remove the class card from DOM
                const classCard = document.querySelector(`[onclick*="${classCode}"]`);
                if (classCard) {
                    classCard.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => {
                        classCard.remove();
                    }, 300);
                }
                
                // Show success message
                alert(`Class "${classCode}" has been deleted successfully.`);
                
                // Optionally reload the page to refresh the data
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else {
                alert('Error deleting class: ' + (result.error || 'Unknown error'));
            }
        } else {
            alert('Error deleting class. Please try again.');
        }
    } catch (error) {
        console.error('Error deleting class:', error);
        alert('Error deleting class. Please check your connection and try again.');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('[UNIFIED_VIEW] DOM loaded, initializing dynamic features...');
    
    // ===== EXAM TYPE TAB TOGGLE SYSTEM =====
    // Matrix tab toggle JavaScript removed - visual component eliminated
    console.log('[MATRIX_REMOVAL] Matrix tab toggle functionality removed from template');
    
    // Auto-refresh stats every 5 minutes
    setInterval(function() {
        console.log('[UNIFIED_VIEW] Auto-refreshing statistics...');
        // Could implement AJAX refresh here if needed
    }, 300000);
    
    // Smooth scroll to sections
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            }
        });
    });
    
    // Add loading states for async operations
    document.querySelectorAll('.class-card').forEach(card => {
        card.addEventListener('click', function() {
            console.log('[UNIFIED_VIEW] Class card clicked:', this.querySelector('.class-name').textContent);
        });
    });
    
    console.log('[UNIFIED_VIEW] Initialization complete');
});
</script>

<!-- Include Exam Management Modal -->
{% include 'primepath_routinetest/includes/exam_management_modal.html' %}

<!-- Debug Script for Modal Issues -->
<script>
// Global error handler for debugging modal issues
window.addEventListener('error', function(e) {
    console.error('[GLOBAL_ERROR] JavaScript error detected:', {
        message: e.message,
        filename: e.filename,
        lineno: e.lineno,
        colno: e.colno,
        error: e.error
    });
    
    // Check if this is related to exam modal
    if (e.message && (e.message.includes('openExamModal') || e.message.includes('exam'))) {
        console.error('[EXAM_MODAL_ERROR] This error is related to exam modal functionality');
    }
});

// Debug function to check modal elements
function debugModalElements() {
    console.group('[MODAL_DEBUG] Checking Modal Elements');
    
    const requiredElements = [
        'examManagementModal',
        'modalClassCode',
        'modalTimeslot',
        'overviewClassCode',
        'overviewCurriculum',
        'overviewPeriod',
        'overviewAccessLevel',
        'currentExamsList',
        'examTableBody',
        'totalStudents',
        'activeStudents',
        'studentTableBody'
    ];
    
    requiredElements.forEach(id => {
        const element = document.getElementById(id);
        console.log(`${id}: ${element ? '‚úÖ Found' : '‚ùå Missing'}`);
    });
    
    console.groupEnd();
}

// Check modal elements on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('[MODAL_DEBUG] Page loaded, checking modal elements...');
    setTimeout(debugModalElements, 100); // Give time for elements to load
});

// Test function to verify modal functionality
function testExamModal() {
    console.log('[MODAL_TEST] Testing exam modal functionality...');
    
    // Find first class card to test with
    const firstClassCard = document.querySelector('.class-card');
    if (firstClassCard) {
        const className = firstClassCard.querySelector('.class-name')?.textContent || 'TEST_CLASS';
        console.log(`[MODAL_TEST] Testing with class: ${className}`);
        
        // Try to open modal
        try {
            openExamModal(className, 'overview', 'FULL');
            console.log('[MODAL_TEST] Modal opened successfully');
            
            // Close modal after 2 seconds
            setTimeout(() => {
                closeExamModal();
                console.log('[MODAL_TEST] Modal closed successfully');
            }, 2000);
        } catch (error) {
            console.error('[MODAL_TEST] Error opening modal:', error);
        }
    } else {
        console.warn('[MODAL_TEST] No class cards found to test with');
    }
}

// Add test button to console
console.log('[MODAL_DEBUG] To test the modal, run: testExamModal()');
</script>

<!-- Request Access Modal -->
<div id="requestAccessModal" class="modal fade" tabindex="-1" role="dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1050;">
    <div class="modal-dialog modal-lg" role="document" style="position: relative; max-width: 600px; margin: 30px auto; pointer-events: none;">
        <div class="modal-content" style="position: relative; background-color: white; border: 1px solid rgba(0,0,0,0.2); border-radius: 6px; box-shadow: 0 3px 9px rgba(0,0,0,0.5); pointer-events: auto;">
            <div class="modal-header" style="background: #2E7D32; color: white; border-bottom: 1px solid #dee2e6; padding: 20px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title" style="color: white; font-weight: 600; margin: 0; font-size: 18px;">
                    <span style="margin-right: 8px;">‚ûï</span>
                    Request Access to Classes
                </h5>
                <button type="button" class="close" onclick="closeRequestAccessModal()" style="background: none; border: none; font-size: 28px; color: white; cursor: pointer; opacity: 0.8; line-height: 1;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="requestAccessForm">
                    {% csrf_token %}
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="requestedClass" style="font-weight: 500; color: #2c3e50; margin-bottom: 8px; display: block;">Class Code *</label>
                        <select id="requestedClass" name="class_code" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;">
                            <option value="">-- Select a class --</option>
                            {% if available_classes %}
                                {% comment %} DEBUG: Template-level debugging for class dropdown {% endcomment %}
                                {% for class in available_classes %}
                                    <option value="{{ class.class_code }}">{{ class.class_name }}</option>
                                {% endfor %}
                                {% comment %} DEBUG: Log available classes count {% endcomment %}
                                <!-- DEBUG: {{ available_classes|length }} classes available for request -->
                            {% else %}
                                <!-- Fallback if no dynamic classes available -->
                                <optgroup label="CORE Program">
                                    <option value="PS1">PS1 - CORE Phonics Level 1</option>
                                    <option value="P2">P2 - CORE Phonics Level 3</option>
                                    <option value="A2">A2 - CORE Sigma Level 1</option>
                                    <option value="B2">B2 - CORE Sigma Level 2</option>
                                    <option value="B3">B3 - CORE Sigma Level 3</option>
                                    <option value="B4">B4 - CORE Elite Level 1</option>
                                    <option value="B5">B5 - CORE Elite Level 2</option>
                                    <option value="S2">S2 - CORE Elite Level 3</option>
                                </optgroup>
                                <optgroup label="EDGE Program">
                                    <option value="Young-cho2">Young-cho2 - EDGE Rise Level 1</option>
                                    <option value="Chung-cho4">Chung-cho4 - EDGE Rise Level 2</option>
                                    <option value="Chung-cho1">Chung-cho1 - EDGE Rise Level 3</option>
                                    <option value="SejongM">SejongM - EDGE Pursuit Level 3</option>
                                    <option value="MAS">MAS - EDGE Pro Level 1</option>
                                </optgroup>
                                <optgroup label="ASCENT Program">
                                    <option value="TaejoC">TaejoC - ASCENT Drive Level 1</option>
                                    <option value="TaejoD">TaejoD - ASCENT Drive Level 2</option>
                                    <option value="TaejoE">TaejoE - ASCENT Drive Level 3</option>
                                    <option value="SungjongM">SungjongM - ASCENT Pro Level 1</option>
                                    <option value="D2">D2 - ASCENT Nova Level 1</option>
                                </optgroup>
                                <optgroup label="PINNACLE Program">
                                    <option value="High1.SatSun.3-5">High1.SatSun.3-5 - PINNACLE Vision Level 1</option>
                                    <option value="High1/2.SatSun.11-1">High1/2.SatSun.11-1 - PINNACLE Endeavor Level 2</option>
                                </optgroup>
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- Access level hidden since only Full Access is available for requests -->
                    <input type="hidden" name="requested_access_level" value="FULL">
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="requestReason" style="font-weight: 500; color: #2c3e50; margin-bottom: 8px; display: block;">Reason for Request *</label>
                        <select id="requestReason" name="reason" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;">
                            <option value="">-- Select reason --</option>
                            <option value="NEW_ASSIGNMENT">New class assignment</option>
                            <option value="SUBSTITUTE">Substituting for another teacher</option>
                            <option value="CO_TEACHING">Co-teaching arrangement</option>
                            <option value="CURRICULUM_EXPERTISE">Have expertise in curriculum</option>
                            <option value="SCHEDULE_OPTIMIZATION">Better schedule alignment</option>
                            <option value="OTHER">Other reason</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="requestNotes" style="font-weight: 500; color: #2c3e50; margin-bottom: 8px; display: block;">Additional Notes</label>
                        <textarea id="requestNotes" name="notes" rows="3" placeholder="Please provide any additional context for your request..." style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="background: #f8f9fa; border-top: 1px solid #dee2e6; padding: 20px; display: flex; justify-content: flex-end; gap: 12px; border-radius: 0 0 6px 6px;">
                <button type="button" class="btn btn-secondary" onclick="closeRequestAccessModal()" style="background: #6c757d; border: none; color: white; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: 500;">
                    Cancel
                </button>
                <button type="button" class="btn btn-success" onclick="submitAccessRequest()" id="submitRequestBtn" style="background: #2E7D32; border: none; color: white; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: 500;">
                    <span id="submitBtnText">Submit Request</span>
                    <span id="submitBtnLoader" style="display: none;">
                        <span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: spin 1s ease-in-out infinite;"></span>
                        Submitting...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Request Access Modal Functions
function openRequestAccessModal() {
    console.log('[REQUEST_ACCESS] Opening modal...');
    
    // DEBUG: Log dropdown options to verify class codes
    const classDropdown = document.getElementById('requestedClass');
    if (classDropdown) {
        console.log('[CLASS_DROPDOWN_DEBUG] === FRONTEND DROPDOWN OPTIONS ===');
        console.log('[CLASS_DROPDOWN_DEBUG] Total options:', classDropdown.options.length);
        
        for (let i = 0; i < Math.min(classDropdown.options.length, 15); i++) {
            const option = classDropdown.options[i];
            console.log(`[CLASS_DROPDOWN_DEBUG] ${i}. Value: "${option.value}" | Text: "${option.text}"`);
        }
        
        if (classDropdown.options.length > 15) {
            console.log(`[CLASS_DROPDOWN_DEBUG] ... and ${classDropdown.options.length - 15} more options`);
        }
        console.log('[CLASS_DROPDOWN_DEBUG] === END FRONTEND DEBUG ===');
    } else {
        console.error('[CLASS_DROPDOWN_DEBUG] ERROR: requestedClass dropdown not found!');
    }
    
    document.getElementById('requestAccessModal').style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeRequestAccessModal() {
    console.log('[REQUEST_ACCESS] Closing modal...');
    document.getElementById('requestAccessModal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
    
    // Reset form
    document.getElementById('requestAccessForm').reset();
    
    // Reset button state
    document.getElementById('submitBtnText').style.display = 'inline';
    document.getElementById('submitBtnLoader').style.display = 'none';
    document.getElementById('submitRequestBtn').disabled = false;
}

function submitAccessRequest() {
    console.log('[REQUEST_ACCESS] Submitting request...');
    
    const form = document.getElementById('requestAccessForm');
    const formData = new FormData(form);
    
    // Validate form
    const classCode = formData.get('class_code');
    const accessLevel = formData.get('requested_access_level');
    const reason = formData.get('reason');
    
    if (!classCode || !accessLevel || !reason) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Show loading state
    document.getElementById('submitBtnText').style.display = 'none';
    document.getElementById('submitBtnLoader').style.display = 'inline';
    document.getElementById('submitRequestBtn').disabled = true;
    
    // Submit request via AJAX
    fetch('{% url "RoutineTest:request_access" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Access request submitted successfully! Admin will review and respond.');
            closeRequestAccessModal();
            
            // Optionally refresh page to show updated pending count
            if (data.refresh_page) {
                location.reload();
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to submit request'));
        }
    })
    .catch(error => {
        console.error('[REQUEST_ACCESS] Error:', error);
        alert('An error occurred while submitting your request. Please try again.');
    })
    .finally(() => {
        // Reset button state
        document.getElementById('submitBtnText').style.display = 'inline';
        document.getElementById('submitBtnLoader').style.display = 'none';
        document.getElementById('submitRequestBtn').disabled = false;
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('requestAccessModal');
    if (event.target === modal) {
        closeRequestAccessModal();
    }
});

// Loading spinner CSS animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>

<!-- Exam Management Script -->
<script src="{% static 'js/routinetest/exam-management.js' %}?v={{ cache_bust }}"></script>

<!-- Curriculum Management Script (Admin Only) -->
{% if user.is_superuser %}
<script src="{% static 'js/routinetest/curriculum-management.js' %}"></script>
{% endif %}

{% endblock %}