{% extends "routinetest_base.html" %}
{% load static %}
{% load custom_filters %}
{% load access_display %}
{# Template Version 6.0 - Hierarchical Library View with Permissions #}

{% block title %}Exam Library - RoutineTest{% endblock %}

{% block header %}Exam Library{% endblock %}

{% block extra_css %}
<!-- PrimePath Brand Override CSS -->
<link rel="stylesheet" href="{% static 'css/routinetest-brand-override.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<!-- ============================================================================ -->
<!-- CRITICAL: Global Functions - MUST load before any buttons are rendered      -->
<!-- ============================================================================ -->
{% include 'primepath_routinetest/exam_list_hierarchical_critical_functions.html' %}

<style>
    /* Main Layout */
    .exam-library-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .library-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    /* Global Access Level Indicator */
    .global-access-indicator {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 20px;
    }
    
    .global-access-indicator.view-only {
        background: #fff3e0;
        border: 1px solid #ff9800;
        color: #f57c00;
    }
    
    .global-access-indicator.full-access {
        background: #e8f5e9;
        border: 1px solid #4caf50;
        color: #2e7d32;
    }
    
    .library-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .header-controls {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    /* Filter Toggle */
    .filter-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .filter-toggle input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .filter-toggle label {
        cursor: pointer;
        user-select: none;
        font-weight: 500;
    }
    
    /* NEW OWNERSHIP TAB SYSTEM */
    .ownership-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 20px;
        border-bottom: 3px solid #dee2e6;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px 12px 0 0;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .ownership-tab {
        flex: 1;
        padding: 18px 25px;
        text-align: center;
        cursor: pointer;
        background: transparent;
        border: none;
        color: #495057;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        position: relative;
    }
    
    .ownership-tab:hover {
        background: rgba(46, 125, 50, 0.1);
        color: #1B5E20;
        transform: translateY(-2px);
        font-weight: 600;
    }
    
    /* WCAG AAA Compliant - High Contrast Active Ownership Tab */
    .ownership-tab.active {
        background: linear-gradient(135deg, #E8F5E9, #F1F8F4);
        color: #0D4F1F;
        font-weight: 700;
        box-shadow: inset 0 3px 0 #2E7D32, 0 2px 4px rgba(0,0,0,0.1);
        border-top: 3px solid #2E7D32;
    }
    
    .ownership-tab.active:hover {
        transform: none;
        background: linear-gradient(135deg, #F1F8F4, #FFFFFF);
        color: #0D4F1F;
    }
    
    /* Sub Tab System (Exam Types) */
    .exam-type-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 30px;
        border-bottom: 2px solid #dee2e6;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
    }
    
    .exam-type-tab {
        flex: 1;
        padding: 15px 20px;
        text-align: center;
        cursor: pointer;
        background: #f8f9fa;
        border: none;
        color: #6c757d;
        font-weight: 500;
        transition: all 0.3s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .exam-type-tab:hover {
        background: #e0f2e1;
        color: #1B5E20;
        transition: all 0.3s ease;
    }
    
    /* WCAG AAA Compliant - High Contrast Active Exam Type Tab */
    .exam-type-tab.active {
        background: #E8F5E9;
        color: #0D4F1F;
        font-weight: 600;
        border-bottom: 3px solid #2E7D32;
        box-shadow: inset 0 -3px 0 #2E7D32;
    }
    
    .tab-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
        background: rgba(0,0,0,0.1);
        min-width: 24px;
    }
    
    .exam-type-tab.active .tab-badge {
        background: #2E7D32;
        color: white;
        font-weight: bold;
    }
    
    /* Focus States for Keyboard Accessibility */
    .ownership-tab:focus,
    .exam-type-tab:focus {
        outline: 2px solid #2E7D32;
        outline-offset: 2px;
        z-index: 1;
    }
    
    .ownership-tab.active:focus,
    .exam-type-tab.active:focus {
        outline: 2px solid #0D4F1F;
        outline-offset: 2px;
    }
    
    /* Button Contrast Improvements - Removed duplicate .btn-edit styles */
    
    /* Hierarchical Display */
    .program-section {
        margin-bottom: 40px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    /* WCAG Compliant Program Headers */
    .program-header {
        background: linear-gradient(135deg, #F1F8F4, #E8F5E9);
        color: #0D4F1F;
        padding: 15px 20px;
        font-size: 1.3rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid #2E7D32;
        border-bottom: 2px solid #E8F5E9;
    }
    
    .program-header:hover {
        background: linear-gradient(135deg, #E8F5E9, #DFF2E1);
        color: #0A3D19;
    }
    
    .program-toggle {
        font-size: 1.2rem;
        transition: transform 0.3s;
    }
    
    .program-section.collapsed .program-toggle {
        transform: rotate(-90deg);
    }
    
    .program-content {
        padding: 20px;
        background: #fafafa;
    }
    
    .program-section.collapsed .program-content {
        display: none;
    }
    
    /* Class Sections */
    .class-section {
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        background: white;
    }
    
    .class-section.accessible {
        border: 2px solid #81C784;
        background: linear-gradient(to right, #E8F5E9 0%, white 5%);
    }
    
    .class-header {
        padding: 14px 18px;
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s ease;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .class-header:hover {
        background: linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%);
    }
    
    .class-section.accessible .class-header {
        background: linear-gradient(135deg, #E8F5E9 0%, #E0F2E0 100%);
    }
    
    .class-section.accessible .class-header:hover {
        background: linear-gradient(135deg, #E0F2E0 0%, #D4E8D4 100%);
    }
    
    .class-name {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .access-badge {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .access-badge.full {
        background: #4CAF50;
        color: white;
    }
    
    .access-badge.co-teacher {
        background: #1B5E20;
        color: white;
    }
    
    .access-badge.view {
        background: #9E9E9E;
        color: white;
    }
    
    .access-badge.owner {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(40,167,69,0.2);
        animation: subtle-glow 2s ease-in-out infinite;
    }
    
    @keyframes subtle-glow {
        0%, 100% { box-shadow: 0 2px 4px rgba(40,167,69,0.2); }
        50% { box-shadow: 0 2px 8px rgba(40,167,69,0.4); }
    }
    
    .class-toggle {
        transition: transform 0.3s;
    }
    
    .class-section.collapsed .class-toggle {
        transform: rotate(-90deg);
    }
    
    .class-exams {
        padding: 15px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 15px;
    }
    
    .class-section.collapsed .class-exams {
        display: none;
    }
    
    /* Exam Cards */
    .exam-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
        margin-bottom: 15px;
    }
    
    .exam-card:hover {
        box-shadow: 0 4px 12px rgba(27, 41, 81, 0.15);
        transform: translateX(4px);
    }
    
    .exam-card.editable {
        border-left: 4px solid #2E7D32;  /* Green for editable */
    }
    
    /* Program-specific exam card borders - All Green Theme */
    .program-section[data-program="CORE"] .exam-card {
        border-left: 3px solid #4CAF50;  /* Primary green */
    }
    
    .program-section[data-program="ASCENT"] .exam-card {
        border-left: 3px solid #2E7D32;  /* Dark green */
    }
    
    .program-section[data-program="EDGE"] .exam-card {
        border-left: 3px solid #388E3C;  /* Medium green */
    }
    
    .program-section[data-program="PINNACLE"] .exam-card {
        border-left: 3px solid #1B5E20;  /* Deep green */
    }
    
    .exam-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 1rem;
    }
    
    .exam-meta {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .exam-meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    /* Answer Mapping Status */
    .answer-status {
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
    
    .answer-status.complete {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .answer-status.partial {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
    }
    
    .answer-status.not-started {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .answer-progress-bar {
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin: 5px 0;
    }
    
    .answer-progress-fill {
        height: 100%;
        transition: width 0.3s;
    }
    
    .answer-progress-fill.complete {
        background: #28a745;
    }
    
    .answer-progress-fill.partial {
        background: #ffc107;
    }
    
    /* Action Buttons - Improved alignment */
    .exam-actions {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;  /* Keep buttons on same line */
        margin-top: 10px;
        align-items: center;
    }
    
    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 0.9rem;
        text-decoration: none;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-weight: 500;
        min-width: 90px;
        text-align: center;
        display: inline-block;
    }
    
    .btn-view {
        background: #6c757d;
        color: white !important;  /* Ensure white text */
        border-color: #6c757d;
        font-weight: 500;
    }
    
    .btn-view:hover {
        background: #5a6268;
        border-color: #545b62;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
    }
    
    .btn-edit {
        background: #28a745;  /* Green for edit/create actions */
        color: white !important;  /* Ensure white text */
        border-color: #28a745;
        font-weight: 500;
    }
    
    .btn-edit:hover {
        background: #218838;
        border-color: #1e7e34;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }
    
    .btn-copy {
        background: #43A047;  /* Medium green for copy */
        color: white !important;  /* Ensure white text */
        border-color: #43A047;
        font-weight: 500;
    }
    
    .btn-copy:hover {
        background: #388E3C;
        border-color: #2E7D32;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(67, 160, 71, 0.3);
    }
    
    /* Delete Button - Clean Red Styling */
    .btn-danger {
        background: #dc3545;
        color: white !important;  /* Ensure white text */
        border-color: #dc3545;
        font-weight: 500;
    }
    
    .btn-danger:hover {
        background: #c82333;
        border-color: #bd2130;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
    
    .btn-danger:active {
        background: #bd2130;
        border-color: #b21f2d;
    }
    
    /* ULTIMATE DELETE BUTTON FIX - Maximum CSS specificity and comprehensive coverage */
    
    /* Target ALL possible delete button selectors with maximum specificity */
    html body.routinetest-theme .exam-library-container .exam-actions button.btn-danger,
    html body.routinetest-theme .exam-library-container .exam-actions button[onclick*="confirmDelete"],
    html body.routinetest-theme .exam-hierarchy .exam-actions button.btn-danger,
    html body.routinetest-theme .exam-hierarchy .exam-actions button[onclick*="confirmDelete"],
    html body .exam-library-container .exam-actions button.btn-danger,
    html body .exam-library-container .exam-actions button[onclick*="confirmDelete"],
    html body .exam-hierarchy .exam-actions button.btn-danger,
    html body .exam-hierarchy .exam-actions button[onclick*="confirmDelete"],
    /* Fallback selectors for various scenarios */
    button.btn-danger,
    .btn.btn-danger,
    .exam-actions .btn-danger,
    button[onclick*="confirmDelete"],
    .exam-actions button[onclick*="confirmDelete"],
    /* Override theme CSS that might be greening the buttons */
    .routinetest-theme .btn.btn-danger,
    .routinetest-theme button.btn-danger,
    .routinetest-theme .exam-actions .btn-danger,
    .routinetest-theme .exam-actions button[onclick*="confirmDelete"] {
        background: #dc3545 !important;
        background-color: #dc3545 !important;
        background-image: none !important;
        color: white !important;
        border: 1px solid #dc3545 !important;
        border-color: #dc3545 !important;
        border-top-color: #dc3545 !important;
        border-right-color: #dc3545 !important;
        border-bottom-color: #dc3545 !important;
        border-left-color: #dc3545 !important;
        /* Prevent any theme overrides */
        box-shadow: none !important;
        transform: none !important;
    }
    
    /* Hover states with same specificity pattern */
    html body.routinetest-theme .exam-library-container .exam-actions button.btn-danger:hover,
    html body.routinetest-theme .exam-library-container .exam-actions button[onclick*="confirmDelete"]:hover,
    html body.routinetest-theme .exam-hierarchy .exam-actions button.btn-danger:hover,
    html body.routinetest-theme .exam-hierarchy .exam-actions button[onclick*="confirmDelete"]:hover,
    html body .exam-library-container .exam-actions button.btn-danger:hover,
    html body .exam-library-container .exam-actions button[onclick*="confirmDelete"]:hover,
    html body .exam-hierarchy .exam-actions button.btn-danger:hover,
    html body .exam-hierarchy .exam-actions button[onclick*="confirmDelete"]:hover,
    button.btn-danger:hover,
    .btn.btn-danger:hover,
    .exam-actions .btn-danger:hover,
    button[onclick*="confirmDelete"]:hover,
    .exam-actions button[onclick*="confirmDelete"]:hover,
    .routinetest-theme .btn.btn-danger:hover,
    .routinetest-theme button.btn-danger:hover,
    .routinetest-theme .exam-actions .btn-danger:hover,
    .routinetest-theme .exam-actions button[onclick*="confirmDelete"]:hover {
        background: #c82333 !important;
        background-color: #c82333 !important;
        background-image: none !important;
        border-color: #bd2130 !important;
        border-top-color: #bd2130 !important;
        border-right-color: #bd2130 !important;
        border-bottom-color: #bd2130 !important;
        border-left-color: #bd2130 !important;
        color: white !important;
        /* Keep hover effects but ensure red color */
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3) !important;
    }
    
    /* Focus and active states */
    html body .exam-actions button.btn-danger:focus,
    html body .exam-actions button.btn-danger:active,
    html body .exam-actions button[onclick*="confirmDelete"]:focus,
    html body .exam-actions button[onclick*="confirmDelete"]:active {
        background: #bd2130 !important;
        background-color: #bd2130 !important;
        border-color: #bd2130 !important;
        color: white !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .no-exams {
        padding: 20px;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
    
    /* Summary Stats */
    .summary-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .stat-label {
        font-weight: 500;
        color: #6c757d;
    }
    
    .stat-value {
        font-weight: 600;
        color: #2c3e50;
    }
    
    /* Modal Styles - Fixed with proper specificity */
    .modal {
        display: none;
        position: fixed;
        z-index: 10001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    /* High specificity rule to ensure modal shows */
    body .modal.show,
    body #copyExamModal.show {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        z-index: 10002;
    }
    
    /* Ensure modal content is visible */
    #copyExamModal .modal-content {
        background-color: white !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 28px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
        line-height: 20px;
        width: 30px;
        height: 30px;
        text-align: center;
    }
    
    .modal-close:hover,
    .modal-close:focus {
        color: #000;
    }
    
    .modal-content h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #2c3e50;
        font-size: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #495057;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 1rem;
    }
    
    .form-group p {
        margin: 5px 0;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #dee2e6;
    }
    
    .modal-actions .btn {
        min-width: 100px;
    }
    
    .modal-actions .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .modal-actions .btn-secondary:hover {
        background-color: #5a6268;
    }
    
    /* Ensure modal is always on top */
    #copyExamModal {
        z-index: 10000;
    }
    
    #copyExamModal .modal-content {
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .library-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .class-exams {
            grid-template-columns: 1fr;
        }
        
        /* Responsive button layout for mobile */
        .exam-actions {
            flex-wrap: wrap;  /* Allow wrapping on small screens */
        }
        
        .exam-actions .btn {
            flex: 1;  /* Equal width buttons on mobile */
            min-width: 80px;  /* Smaller minimum width on mobile */
        }
        
        .summary-stats {
            flex-direction: column;
        }
        
        .modal-content {
            width: 95%;
            padding: 20px;
        }
    }
</style>

<div class="exam-library-container">
    <!-- Header -->
    <div class="library-header">
        <h1 class="library-title">Exam Library</h1>
        <div class="header-controls">
            <!-- Upload Button (Admin or Full Access Teachers) -->
            {% if is_admin or can_manage_exams %}
            <a href="{% url 'RoutineTest:create_exam' %}" class="btn btn-edit">
                üì§ Upload New Exam
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Global Access Level Indicator -->
    {% if not is_admin %}
    <div class="global-access-indicator {% if is_view_only_teacher %}view-only{% else %}full-access{% endif %}">
        {% if is_view_only_teacher %}
            üëÅÔ∏è View Only Access - You can view exams but cannot edit or delete them
        {% else %}
            ‚úÖ Full Access - You can create, edit, and delete exams in your assigned classes
        {% endif %}
    </div>
    {% endif %}
    
    <!-- NEW: Ownership-based Tab Layer -->
    <div class="ownership-tabs">
        <a href="?ownership=my&exam_type={{ exam_type_filter }}" 
           class="ownership-tab {% if is_my_files_active %}active{% endif %}"
           onclick="return handleOwnershipTabSwitch('my', '{{ exam_type_filter }}')">
            <span>üìÅ My Test Files</span>
        </a>
        
        <a href="?ownership=others&exam_type={{ exam_type_filter }}" 
           class="ownership-tab {% if is_others_files_active %}active{% endif %}"
           onclick="return handleOwnershipTabSwitch('others', '{{ exam_type_filter }}')">
            <span>üë• Other Teachers' Test Files</span>
        </a>
    </div>
    
    <!-- Summary Stats -->
    <div class="summary-stats">
        <div class="stat-item">
            <span class="stat-label">Total Exams:</span>
            <span class="stat-value">{{ mapping_summary.total }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Complete:</span>
            <span class="stat-value" style="color: #28a745;">{{ mapping_summary.complete }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Partial:</span>
            <span class="stat-value" style="color: #ffc107;">{{ mapping_summary.partial }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Not Started:</span>
            <span class="stat-value" style="color: #dc3545;">{{ mapping_summary.not_started }}</span>
        </div>
        {% if not is_admin %}
        <div class="stat-item">
            <span class="stat-label">Editable:</span>
            <span class="stat-value" style="color: #4CAF50;">{{ mapping_summary.editable }}</span>
        </div>
        {% endif %}
    </div>
    
    <!-- UPDATED: Exam Type Tabs with New Ownership System -->
    <div class="exam-type-tabs">
        <a href="?ownership={{ ownership_filter }}&exam_type=REVIEW" 
           class="exam-type-tab {% if exam_type_filter == 'REVIEW' %}active{% endif %}"
           onclick="return handleExamTypeTabSwitch('{{ ownership_filter }}', 'REVIEW')">
            <span>üìö Review / Monthly</span>
            <span class="tab-badge">{{ exam_type_counts.review }}</span>
        </a>
        
        <a href="?ownership={{ ownership_filter }}&exam_type=QUARTERLY" 
           class="exam-type-tab {% if exam_type_filter == 'QUARTERLY' %}active{% endif %}"
           onclick="return handleExamTypeTabSwitch('{{ ownership_filter }}', 'QUARTERLY')">
            <span>üìä Quarterly</span>
            <span class="tab-badge">{{ exam_type_counts.quarterly }}</span>
        </a>
        
        <a href="?ownership={{ ownership_filter }}&exam_type=ALL" 
           class="exam-type-tab {% if exam_type_filter == 'ALL' %}active{% endif %}"
           onclick="return handleExamTypeTabSwitch('{{ ownership_filter }}', 'ALL')">
            <span>üìã All Exams</span>
            <span class="tab-badge">{{ exam_type_counts.all }}</span>
        </a>
    </div>
    
    <!-- Hierarchical Exam Display -->
    <!-- DEBUG SECTION - Server Data Analysis -->
    {% if show_assigned_only %}
    <script>
        console.log('========================================');
        console.log('[SERVER_DATA_DEBUG] FILTER IS ON - Analyzing server data');
        console.log('[SERVER_DATA_DEBUG] Filter state from Django: {{ show_assigned_only }}');
        
        // Count VIEW ONLY exams in server data
        let serverViewOnlyCount = 0;
        let serverTotalExams = 0;
        
        {% for program in program_order %}
            {% with program_exams=hierarchical_exams|get_item:program %}
            {% if program_exams and program_exams|length > 0 %}
                {% for class_code, class_exams in program_exams.items %}
                    {% for exam in class_exams %}
                        serverTotalExams++;
                        {% if exam.access_badge == 'VIEW ONLY' %}
                            serverViewOnlyCount++;
                            console.log('[SERVER_DATA_DEBUG] ‚ùå VIEW ONLY exam in server data: {{ exam.name|escapejs }} (ID: {{ exam.id }})');
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
            {% endwith %}
        {% endfor %}
        
        console.log('[SERVER_DATA_DEBUG] Total exams from server:', serverTotalExams);
        console.log('[SERVER_DATA_DEBUG] VIEW ONLY exams from server:', serverViewOnlyCount);
        
        if (serverViewOnlyCount > 0) {
            console.log('[SERVER_DATA_DEBUG] ‚ùå‚ùå‚ùå CRITICAL: Server sent VIEW ONLY exams when filter is ON!');
        } else {
            console.log('[SERVER_DATA_DEBUG] ‚úÖ Server data is correct - no VIEW ONLY exams');
        }
        console.log('========================================');
    </script>
    {% endif %}
    
    <!-- Debug: hierarchical_exams = {{ hierarchical_exams }} -->
    <div class="exam-hierarchy">
        {% for program in program_order %}
            {% with program_exams=hierarchical_exams|get_item:program %}
            {% if program_exams and program_exams|length > 0 %}
            <div class="program-section" data-program="{{ program }}">
                <div class="program-header" onclick="toggleProgram('{{ program }}')">
                    <span>{{ program }} Program</span>
                    <span class="program-toggle">‚ñº</span>
                </div>
                
                <div class="program-content">
                    <!-- Debug: {{ program_exams|length }} classes in {{ program }} -->
                    {% for class_code, class_exams in program_exams.items %}
                        {# CRITICAL FIX: Only show class sections that have exams after filtering #}
                        {% if class_exams|length > 0 %}
                        {% with access_level=teacher_assignments|get_item:class_code is_owned_class=ownership_overrides|get_item:class_code base_access=base_assignments|get_item:class_code %}
                        <!-- OWNERSHIP FIX DEBUG -->
                        <script>
                            console.log('[OWNERSHIP_FIX] Class {{ class_code }}', {
                                'is_owned_class': '{{ is_owned_class }}',
                                'base_access': '{{ base_access }}',
                                'effective_access': '{{ access_level }}',
                                'has_ownership_override': {{ is_owned_class|yesno:"true,false" }},
                                'exam_count': {{ class_exams|length }}
                            });
                        </script>
                        <div class="class-section {% if access_level and access_level != 'VIEW' %}accessible{% endif %}" 
                             data-class="{{ class_code }}">
                            <div class="class-header" onclick="toggleClass('{{ class_code }}')">
                                <div class="class-name">
                                    <span style="display: flex; align-items: center; gap: 8px;">
                                        <span style="background: #f0f4f8; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; color: #495057; font-weight: 500;">
                                            <i class="fas fa-chalkboard" style="margin-right: 4px; color: #6c757d;"></i>
                                            Class Code: <strong style="color: #2c3e50;">{{ class_code }}</strong>
                                        </span>
                                        {% if get_class_display_name|get_item:class_code and get_class_display_name|get_item:class_code != class_code %}
                                            <span style="color: #495057; font-style: italic;">
                                                ({{ get_class_display_name|get_item:class_code }})
                                            </span>
                                        {% endif %}
                                    </span>
                                    <!-- OWNERSHIP FIX: Display correct badge based on ownership -->
                                    {% if is_owned_class %}
                                        <!-- Teacher owns exam(s) in this class -->
                                        <span class="access-badge owner" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: 600; padding: 4px 12px; border-radius: 4px; box-shadow: 0 2px 4px rgba(40,167,69,0.2);">üëë OWNER - Full Access</span>
                                    {% elif access_level %}
                                        {% if access_level == 'FULL' %}
                                            <span class="access-badge full">Full Access</span>
                                        {% elif access_level == 'CO_TEACHER' %}
                                            <span class="access-badge co-teacher">Co-Teacher</span>
                                        {% elif access_level == 'VIEW' %}
                                            <span class="access-badge view">View Only</span>
                                        {% endif %}
                                    {% elif not is_admin %}
                                        <span class="access-badge view">View Only</span>
                                    {% endif %}
                                    <span style="color: #6c757d;">({{ class_exams|length }} exam{{ class_exams|length|pluralize }})</span>
                                </div>
                                <span class="class-toggle">‚ñº</span>
                            </div>
                            
                            <div class="class-exams">
                                {% for exam in class_exams %}
                                <!-- COMPREHENSIVE DEBUG START -->
                                <!-- 
                                    DELETE BUTTON DEBUG:
                                    - is_admin = {{ is_admin }}
                                    - exam.can_edit = {{ exam.can_edit }}
                                    - exam.id = {{ exam.id }}
                                    - exam.name = {{ exam.name }}
                                    - User: {{ user.username }}
                                    - User.is_superuser = {{ user.is_superuser }}
                                    - User.is_staff = {{ user.is_staff }}
                                    - Condition (is_admin or exam.can_edit) = {% if is_admin or exam.can_edit %}TRUE{% else %}FALSE{% endif %}
                                -->
                                <!-- EXAM-LEVEL OWNERSHIP DEBUG -->
                                <script>
                                    console.log('[EXAM_OWNERSHIP_DEBUG] Exam: {{ exam.name|escapejs }}', {
                                        'exam_id': '{{ exam.id }}',
                                        'exam_owner': '{{ exam.created_by.name|default:"Unknown" }}',
                                        'is_owner': {{ exam.is_owner|yesno:"true,false" }},
                                        'access_badge': '{{ exam.access_badge }}',
                                        'class_is_owned': '{{ is_owned_class }}',
                                        'can_edit': {{ exam.can_edit|yesno:"true,false" }},
                                        'can_delete': {{ exam.can_delete|yesno:"true,false" }}
                                    });
                                    console.log('[DELETE_BUTTON_DEBUG] Exam: {{ exam.name|escapejs }}', {
                                        is_admin: {{ is_admin|lower }},
                                        exam_can_edit: {{ exam.can_edit|lower }},
                                        user_is_superuser: {{ user.is_superuser|lower }},
                                        user_is_staff: {{ user.is_staff|lower }},
                                        should_show_delete: {% if is_admin or exam.can_edit %}true{% else %}false{% endif %}
                                    });
                                </script>
                                <!-- COMPREHENSIVE DEBUG END -->
                                <div class="exam-card {% if exam.can_edit %}editable{% endif %}">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <div class="exam-title">{{ exam.name }}</div>
                                            <!-- Year and Month/Quarter Display -->
                                            <div style="margin-top: 4px; display: flex; gap: 8px; align-items: center;">
                                                {% if exam.academic_year %}
                                                <span style="background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                                    {{ exam.academic_year|slice:":4" }}
                                                </span>
                                                {% endif %}
                                                {% if exam.exam_type == 'REVIEW' and exam.time_period_month %}
                                                <span style="background: #f3e5f5; color: #6a1b9a; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                                    {{ exam.get_time_period_month_display }}
                                                </span>
                                                {% elif exam.exam_type == 'QUARTERLY' and exam.time_period_quarter %}
                                                <span style="background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                                    {{ exam.get_time_period_quarter_display }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if exam.access_badge %}
                                        {% comment %}ADMIN badge removed - was misleading and not useful{% endcomment %}
                                        {% endif %}
                                    </div>
                                    
                                    <div class="exam-meta">
                                        <div class="exam-meta-item">
                                            üìÑ {{ exam.routine_questions.count }} Questions
                                        </div>
                                        <div class="exam-meta-item">
                                            üéµ {{ exam.routine_audio_files.count }} Audio
                                        </div>
                                    </div>
                                    
                                    <!-- Answer Mapping Status -->
                                    <div class="answer-status {{ exam.answer_mapping_status.status_class }}">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Answer Keys: {{ exam.answer_mapping_status.status_label }}</span>
                                            <span>{{ exam.answer_mapping_status.percentage_complete }}%</span>
                                        </div>
                                        <div class="answer-progress-bar">
                                            <div class="answer-progress-fill {{ exam.answer_mapping_status.status_class }}"
                                                 style="width: {{ exam.answer_mapping_status.percentage_complete }}%"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="exam-actions">
                                        {% if exam.can_edit %}
                                            <a href="{% url 'RoutineTest:preview_exam' exam.id %}" class="btn btn-edit">
                                                Edit Answers
                                            </a>
                                        {% else %}
                                            <a href="{% url 'RoutineTest:preview_exam' exam.id %}" class="btn btn-view">
                                                View Answers
                                            </a>
                                        {% endif %}
                                        
                                        {% if exam.can_copy %}
                                            <button onclick="openCopyModal('{{ exam.id }}', '{{ exam.name|escapejs }}')" class="btn btn-copy">
                                                Copy Exam
                                            </button>
                                        {% endif %}
                                        
                                        {% if exam.can_delete %}
                                            <button onclick="confirmDelete('{{ exam.id }}', '{{ exam.name|escapejs }}')" 
                                                    class="btn btn-danger delete-exam-btn">
                                                Delete
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% empty %}
                                <div class="no-exams">No exams in this class</div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endwith %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endwith %}
        {% endfor %}
        
        {% comment %}Show empty state if no exams in any program{% endcomment %}
        {% if mapping_summary.total == 0 and exam_type_counts.all > 0 %}
        <div class="empty-state">
            <h3>Exams not organized</h3>
            <p>{{ exam_type_counts.all }} exam(s) found in database but could not be organized into programs. This typically means exams are missing class assignments.</p>
            <p><small>Debug: hierarchical_exams has {{ hierarchical_exams|length }} programs</small></p>
        </div>
        {% elif mapping_summary.total == 0 %}
        <div class="empty-state">
            <h3>No exams found</h3>
            <p>{% if show_assigned_only %}No exams in your assigned classes. Try turning off the filter.{% else %}No exams available in the library.{% endif %}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Copy Exam Modal -->
<div id="copyExamModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeCopyModal()">&times;</span>
        <h3>Copy Exam to Another Class</h3>
        <form id="copyExamForm">
            <input type="hidden" id="sourceExamId" name="source_exam_id">
            
            <div class="form-group">
                <label>Source Exam:</label>
                <p id="sourceExamName" style="font-weight: 600; color: #2c3e50;">Loading...</p>
            </div>
            
            <div class="form-group">
                <label for="targetClass">Target Class:</label>
                <select id="targetClass" name="target_class" required>
                    <option value="">Select a class...</option>
                    {% for class_code, access_level in teacher_assignments.items %}
                        {% if access_level == 'FULL' or access_level == 'CO_TEACHER' %}
                        <option value="{{ class_code }}">{{ get_class_display_name|get_item:class_code|default:class_code }}</option>
                        {% endif %}
                    {% endfor %}
                    {% if is_admin %}
                        <!-- Admin can copy to any class -->
                        {% for program, classes in hierarchical_exams.items %}
                            {% for class_code, exams in classes.items %}
                                {% if class_code not in teacher_assignments %}
                                <option value="{{ class_code }}">{{ get_class_display_name|get_item:class_code|default:class_code }} (Admin)</option>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="copyExamType">Exam Type:</label>
                <select id="copyExamType" name="exam_type" required>
                    <option value="">Select exam type...</option>
                    <option value="REVIEW">Review / Monthly</option>
                    <option value="QUARTERLY">Quarterly</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="academicYear">Academic Year:</label>
                <select id="academicYear" name="academic_year" required>
                    <option value="">Select year...</option>
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="timeslot">Time Period:</label>
                <select id="timeslot" name="timeslot" required disabled>
                    <option value="">First select exam type...</option>
                </select>
                <small class="form-text text-muted" id="timeslotDebugInfo" style="display: none;">
                    If dropdown remains disabled: Open browser console and run <code>fixTimeslotDropdown()</code>
                </small>
            </div>
            
            <!-- Curriculum Selection Section -->
            <div class="form-group">
                <h5 style="margin-top: 20px; margin-bottom: 15px; color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 8px;">
                    <i class="fas fa-graduation-cap"></i> Curriculum Selection
                </h5>
            </div>
            
            <div class="form-group">
                <label for="copyProgramSelect">Program:</label>
                <select id="copyProgramSelect" name="program_select" required>
                    <option value="">-- Select Program --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="copySubprogramSelect">SubProgram:</label>
                <select id="copySubprogramSelect" name="subprogram_select" required disabled>
                    <option value="">-- First select a Program --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="copyLevelSelect">Level:</label>
                <select id="copyLevelSelect" name="level_select" required disabled>
                    <option value="">-- First select a SubProgram --</option>
                </select>
            </div>
            
            <!-- Hidden field to store the curriculum level ID -->
            <input type="hidden" id="copyCurriculumLevel" name="curriculum_level" value="">
            
            <div class="form-group">
                <label for="customSuffix">Custom Name Suffix (Optional):</label>
                <input type="text" id="customSuffix" name="custom_suffix" class="form-control" 
                       placeholder="e.g., 123 or version2" maxlength="50">
                <small class="text-muted">This will be appended to the auto-generated exam name (e.g., _123)</small>
            </div>
            
            <div class="form-group">
                <label>Preview of New Exam Name:</label>
                <div id="examNamePreview" style="padding: 10px; background: #f0f0f0; border-radius: 4px; font-weight: 600;">
                    <span id="previewText">Please complete all fields to see preview...</span>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" onclick="closeCopyModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-copy">Copy Exam</button>
            </div>
        </form>
    </div>
</div>

<!-- Copy Exam Modal JavaScript - Clean Implementation -->
<script>
// Minimal initialization to ensure functions are available immediately
console.log('[COPY_EXAM_CLEAN] Initializing clean copy exam modal system...');

// Placeholder functions to prevent errors until the main script loads
window.openCopyModal = function(examId, examName) {
    console.log('[COPY_EXAM_PLACEHOLDER] Copy modal function called, waiting for main script...');
    setTimeout(function() {
        if (window.openCopyModal.isPlaceholder) {
            alert('Copy Exam feature is still loading. Please try again in a moment.');
        } else {
            window.openCopyModal(examId, examName);
        }
    }, 500);
};
window.openCopyModal.isPlaceholder = true;

window.closeCopyModal = function() {
    const modal = document.getElementById('copyExamModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
};

console.log('[COPY_EXAM_CLEAN] Placeholder functions ready. Main script will load shortly...');
</script>

<script>
// Main copy exam functionality script

// ============================================================================
// CLOSE MODAL FUNCTION - Internal implementation
// ============================================================================
window.closeCopyModalInternal = function() {
    console.group('%c[COPY MODAL] Closing Modal', 'color: #888; font-weight: bold;');
    
    try {
        const modal = document.getElementById('copyExamModal');
        if (!modal) {
            console.warn('[COPY MODAL] Modal element not found during close');
            console.groupEnd();
            return;
        }
        
        // Hide the modal
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = ''; // Restore scrolling
        
        // Clear state
        window.CopyModalState.currentExamId = null;
        window.CopyModalState.currentExamName = null;
        
        // Reset form
        const copyForm = document.getElementById('copyExamForm');
        if (copyForm) {
            copyForm.reset();
            console.log('[COPY MODAL] Form reset on close');
        }
        
        // Remove event handlers
        modal.onclick = null;
        
        console.log('[COPY MODAL] Modal closed successfully');
        console.groupEnd();
        
    } catch (error) {
        console.error('[COPY MODAL] Error during close:', error);
        console.groupEnd();
    }
};

// Create global aliases for backward compatibility
var openCopyModal = window.openCopyModal;
var closeCopyModal = window.closeCopyModal;

console.log('[COPY MODAL] Functions registered globally:');
console.log('  - window.openCopyModal:', typeof window.openCopyModal);
console.log('  - window.closeCopyModal:', typeof window.closeCopyModal);
console.log('  - openCopyModal (alias):', typeof openCopyModal);
console.log('  - closeCopyModal (alias):', typeof closeCopyModal);

// Tab switching handlers - Clear all filters when switching tabs
// Function to update filter badges (if needed)
function updateFilterBadges() {
    console.log('[FILTER_BADGES] Updating filter badges...');
    // This function can be implemented later if badge updates are needed
    // For now, it prevents the "undefined function" error
}

function handleOwnershipTabSwitch(ownership, examType) {
    console.log('[TAB_SWITCH] Switching ownership tab to:', ownership);
    console.log('[TAB_SWITCH] Exam type:', examType);
    
    // Build clean URL with only ownership and exam_type parameters
    const newUrl = `?ownership=${ownership}&exam_type=${examType}`;
    
    console.log('[TAB_SWITCH] Navigating to clean URL:', newUrl);
    window.location.href = newUrl;
    
    // Prevent default link behavior
    return false;
}

function handleExamTypeTabSwitch(ownership, examType) {
    console.log('[TAB_SWITCH] Switching exam type tab to:', examType);
    console.log('[TAB_SWITCH] Ownership:', ownership);
    
    // Build clean URL with only ownership and exam_type parameters
    const newUrl = `?ownership=${ownership}&exam_type=${examType}`;
    
    console.log('[TAB_SWITCH] Navigating to clean URL:', newUrl);
    window.location.href = newUrl;
    
    // Prevent default link behavior
    return false;
}

// Make tab switching functions globally available
window.handleOwnershipTabSwitch = handleOwnershipTabSwitch;
window.handleExamTypeTabSwitch = handleExamTypeTabSwitch;

// PAGE LOAD DEBUGGING - Track exams and filter state - ENHANCED VERSION
(function() {
    console.log('========================================');
    console.log('[PAGE_LOAD_DEBUG] Exam Library Page Loaded - ENHANCED DEBUGGING v2');
    console.log('[PAGE_LOAD_DEBUG] Current URL:', window.location.href);
    console.log('[PAGE_LOAD_DEBUG] Timestamp:', new Date().toISOString());
    
    // NEW: Check ownership state
    const urlParams = new URLSearchParams(window.location.search);
    const ownershipState = urlParams.get('ownership') || 'my';  // Default to 'my'
    const examTypeState = urlParams.get('exam_type') || 'ALL';
    
    console.log('[PAGE_LOAD_DEBUG] NEW Ownership parameter:', ownershipState);
    console.log('[PAGE_LOAD_DEBUG] NEW Exam type parameter:', examTypeState);
    console.log('[PAGE_LOAD_DEBUG] Server-side ownership filter: {{ ownership_filter }}');
    console.log('[PAGE_LOAD_DEBUG] Legacy show_assigned_only: {{ show_assigned_only|lower }}');
    
    // Count and log exam cards with their badges
    const examCards = document.querySelectorAll('.exam-card');
    console.log('[PAGE_LOAD_DEBUG] Total exam cards displayed:', examCards.length);
    
    // Analyze access badges
    const badgeCounts = {
        'OWNER': 0,
        'FULL ACCESS': 0,
        'EDIT': 0,
        'VIEW ONLY': 0
    };
    
    examCards.forEach((card, index) => {
        const badge = card.querySelector('.access-badge');
        const examName = card.querySelector('.exam-title')?.textContent?.trim() || 'Unknown';
        const badgeText = badge?.textContent?.trim() || 'NO BADGE';
        
        if (index < 5) { // Log first 5 exams for detailed debugging
            console.log(`[PAGE_LOAD_DEBUG] Exam ${index + 1}: "${examName}" - Badge: ${badgeText}`);
        }
        
        // Count badges
        if (badgeCounts.hasOwnProperty(badgeText)) {
            badgeCounts[badgeText]++;
        }
    });
    
    console.log('[PAGE_LOAD_DEBUG] Badge distribution:', badgeCounts);
    
    // NEW: Check if we're in "My Test Files" mode (equivalent to old filter)
    if (ownershipState === 'my') {
        console.log('[PAGE_LOAD_DEBUG] ‚ö†Ô∏è OWNERSHIP: My Test Files - Should show exams from EDITABLE classes only');
        console.log('[PAGE_LOAD_DEBUG] Expected: Exams with OWNER, FULL ACCESS and EDIT badges only');
        console.log('[PAGE_LOAD_DEBUG] NOT Expected: VIEW ONLY badges (should be filtered out)');
        if (badgeCounts['VIEW ONLY'] > 0) {
            console.log('[PAGE_LOAD_DEBUG] ‚ùå‚ùå‚ùå CRITICAL BUG DETECTED ‚ùå‚ùå‚ùå');
            console.log('[PAGE_LOAD_DEBUG] Found ' + badgeCounts['VIEW ONLY'] + ' VIEW ONLY exams that should be HIDDEN!');
            
            // List all VIEW ONLY exams that shouldn't be visible
            console.log('[PAGE_LOAD_DEBUG] VIEW ONLY exams that should be hidden:');
            examCards.forEach((card, index) => {
                const badge = card.querySelector('.badge');
                const examName = card.querySelector('.exam-title')?.textContent?.trim() || 'Unknown';
                const badgeText = badge?.textContent?.trim() || 'NO BADGE';
                
                if (badgeText === 'VIEW ONLY' || badgeText.includes('VIEW')) {
                    const examClasses = card.querySelector('.exam-classes')?.textContent || 'No classes';
                    console.log(`[PAGE_LOAD_DEBUG]   ‚ùå Exam "${examName}"`);
                    console.log(`[PAGE_LOAD_DEBUG]      Badge: ${badgeText}`);
                    console.log(`[PAGE_LOAD_DEBUG]      Classes: ${examClasses}`);
                }
            });
        } else {
            console.log('[PAGE_LOAD_DEBUG] ‚úÖ Correct: No VIEW ONLY exams shown (filtered out as expected)');
        }
    } else if (ownershipState === 'others') {
        console.log('[PAGE_LOAD_DEBUG] OWNERSHIP: Other Teachers\' Test Files - Showing all visible exams');
        console.log('[PAGE_LOAD_DEBUG] Expected: All badges including VIEW ONLY');
        console.log('[PAGE_LOAD_DEBUG] VIEW ONLY exams should be visible in this mode');
    }
    
    console.log('========================================');
})();

// IMMEDIATE DELETE BUTTON FIX - Run once without infinite loop
(function() {
    // Apply red color to all delete buttons immediately
    const fixDeleteButtons = function() {
        const deleteButtons = document.querySelectorAll('.btn-danger:not([data-delete-fixed]), button[onclick*="confirmDelete"]:not([data-delete-fixed])');
        deleteButtons.forEach(button => {
            // Force red styling via inline styles with highest priority
            button.style.setProperty('background-color', '#dc3545', 'important');
            button.style.setProperty('border-color', '#dc3545', 'important');
            button.style.setProperty('color', 'white', 'important');
            
            // Remove any conflicting classes
            button.classList.remove('btn-success', 'btn-primary', 'btn-secondary');
            // Ensure btn-danger class is present
            if (!button.classList.contains('btn-danger')) {
                button.classList.add('btn-danger');
            }
            
            // Mark as fixed to avoid reprocessing
            button.setAttribute('data-delete-fixed', 'true');
        });
    };
    
    // Run immediately
    fixDeleteButtons();
    
    // Run on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fixDeleteButtons);
    }
    
    // Run once after a short delay to catch any late-applied styles
    setTimeout(fixDeleteButtons, 100);
})();

// DELETE BUTTON FIX CONTINUES HERE - Functions already defined above

// Note: Toggle functions (toggleProgram, toggleClass) are now defined in critical functions file

// NEW: Ownership Tab Navigation Logging (No JavaScript needed - handled by server)
(function() {
    console.log('[OWNERSHIP_SYSTEM] ‚úÖ New tab-based navigation system active');
    console.log('[OWNERSHIP_SYSTEM] Current ownership filter: {{ ownership_filter }}');
    console.log('[OWNERSHIP_SYSTEM] Filter intent: {{ filter_intent }}');
    console.log('[OWNERSHIP_SYSTEM] Current exam type filter: {{ exam_type_filter }}');
    console.log('[OWNERSHIP_SYSTEM] Navigation handled by server-side routing');
    
    // Log tab state for debugging
    const ownershipTabs = document.querySelectorAll('.ownership-tab');
    const examTypeTabs = document.querySelectorAll('.exam-type-tab');
    
    console.log('[OWNERSHIP_SYSTEM] Ownership tabs found:', ownershipTabs.length);
    console.log('[OWNERSHIP_SYSTEM] Exam type tabs found:', examTypeTabs.length);
    
    ownershipTabs.forEach((tab, index) => {
        const isActive = tab.classList.contains('active');
        const href = tab.getAttribute('href');
        console.log(`[OWNERSHIP_SYSTEM] Tab ${index + 1}: ${isActive ? 'ACTIVE' : 'inactive'}, URL: ${href}`);
    });
})();

// COMPREHENSIVE FILTERING VALIDATION AND DEBUGGING
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const ownership = urlParams.get('ownership') || 'my';  // Default to 'my'
    
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë            EXAM FILTERING VALIDATION SYSTEM ACTIVE            ‚ïë');
    console.log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');
    console.log(`‚ïë Current Mode: ${ownership === 'my' ? 'MY TEST FILES' : 'OTHER TEACHERS\' TEST FILES'}${' '.repeat(ownership === 'my' ? 34 : 24)}‚ïë`);
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    
    // Comprehensive badge analysis
    function analyzeAndValidateExams() {
        const badges = document.querySelectorAll('.badge');
        const analysis = {
            'VIEW ONLY': [],
            'FULL ACCESS': [],
            'OWNER': [],
            'EDIT': [],
            'CO_TEACHER': [],
            'OTHER': []
        };
        
        badges.forEach(badge => {
            const text = badge.textContent.trim().toUpperCase();
            const examCard = badge.closest('.exam-card');
            const examName = examCard ? examCard.querySelector('.exam-title')?.textContent.trim() : 'Unknown';
            
            // Categorize badges
            if (text.includes('VIEW')) {
                analysis['VIEW ONLY'].push(examName);
            } else if (text.includes('FULL')) {
                analysis['FULL ACCESS'].push(examName);
            } else if (text.includes('OWNER')) {
                analysis['OWNER'].push(examName);
            } else if (text.includes('EDIT')) {
                analysis['EDIT'].push(examName);
            } else if (text.includes('CO_TEACHER')) {
                analysis['CO_TEACHER'].push(examName);
            } else {
                analysis['OTHER'].push(`${examName} (${text})`);
            }
        });
        
        // Validation based on current mode
        console.log('\nüìä BADGE ANALYSIS RESULTS:');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        let hasError = false;
        
        if (ownership === 'my') {
            // MY TEST FILES: Should ONLY have FULL/OWNER/EDIT badges
            console.log('‚úÖ EXPECTED: FULL ACCESS, OWNER, EDIT, CO_TEACHER badges');
            console.log('‚ùå NOT EXPECTED: VIEW ONLY badges\n');
            
            if (analysis['VIEW ONLY'].length > 0) {
                hasError = true;
                console.error('üö®üö®üö® CRITICAL ERROR: Found VIEW ONLY exams in MY TEST FILES mode!');
                console.error('The following exams should NOT be visible:');
                analysis['VIEW ONLY'].forEach(exam => {
                    console.error(`  ‚ùå ${exam}`);
                });
                
                // Auto-fix: Hide these incorrect exams
                console.log('\nüîß APPLYING AUTO-FIX: Hiding VIEW ONLY exams...');
                badges.forEach(badge => {
                    if (badge.textContent.trim().toUpperCase().includes('VIEW')) {
                        const examCard = badge.closest('.exam-card');
                        if (examCard) {
                            examCard.style.display = 'none';
                            console.log(`  üîß Hidden: ${examCard.querySelector('.exam-title')?.textContent.trim()}`);
                        }
                    }
                });
            }
            
            // Show what IS correctly displayed
            console.log('\n‚úÖ Correctly displayed exams:');
            ['OWNER', 'FULL ACCESS', 'EDIT', 'CO_TEACHER'].forEach(type => {
                if (analysis[type].length > 0) {
                    console.log(`  ${type}: ${analysis[type].length} exam(s)`);
                    if (analysis[type].length <= 3) {
                        analysis[type].forEach(exam => console.log(`    ‚Ä¢ ${exam}`));
                    }
                }
            });
            
        } else if (ownership === 'others') {
            // OTHER TEACHERS' TEST FILES: Should ONLY have VIEW ONLY badges
            console.log('‚úÖ EXPECTED: VIEW ONLY badges');
            console.log('‚ùå NOT EXPECTED: FULL ACCESS, OWNER, EDIT badges\n');
            
            const wrongBadges = ['FULL ACCESS', 'OWNER', 'EDIT', 'CO_TEACHER'];
            wrongBadges.forEach(type => {
                if (analysis[type].length > 0) {
                    hasError = true;
                    console.error(`üö® ERROR: Found ${type} exams in OTHER TEACHERS' mode!`);
                    console.error(`The following ${type} exams should NOT be visible:`);
                    analysis[type].forEach(exam => {
                        console.error(`  ‚ùå ${exam}`);
                    });
                }
            });
            
            if (hasError) {
                // Auto-fix: Hide incorrect exams
                console.log('\nüîß APPLYING AUTO-FIX: Hiding non-VIEW ONLY exams...');
                badges.forEach(badge => {
                    const text = badge.textContent.trim().toUpperCase();
                    if (!text.includes('VIEW')) {
                        const examCard = badge.closest('.exam-card');
                        if (examCard) {
                            examCard.style.display = 'none';
                            console.log(`  üîß Hidden: ${examCard.querySelector('.exam-title')?.textContent.trim()}`);
                        }
                    }
                });
            }
            
            // Show what IS correctly displayed
            if (analysis['VIEW ONLY'].length > 0) {
                console.log(`\n‚úÖ Correctly displayed VIEW ONLY exams: ${analysis['VIEW ONLY'].length}`);
                if (analysis['VIEW ONLY'].length <= 5) {
                    analysis['VIEW ONLY'].forEach(exam => console.log(`    ‚Ä¢ ${exam}`));
                }
            }
        }
        
        // Final status
        console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        if (hasError) {
            console.error('‚ùå FILTER VALIDATION FAILED - Auto-fix applied');
            console.log('üìù Please report this issue to development team');
        } else {
            console.log('‚úÖ FILTER VALIDATION PASSED - All exams correctly filtered');
        }
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
        
        return !hasError;
    }
    
    // Run analysis immediately
    const isValid = analyzeAndValidateExams();
    
    // Re-run after DOM changes
    setTimeout(() => {
        console.log('üîÑ Re-validating after DOM settlement...');
        analyzeAndValidateExams();
    }, 500);
    
    // Monitor for dynamic changes
    const observer = new MutationObserver(() => {
        console.log('üîÑ DOM changed, re-validating...');
        analyzeAndValidateExams();
    });
    
    // Only observe if we found errors initially
    if (!isValid) {
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
})();

// ============================================================================
// COPY MODAL EVENT INITIALIZATION AND FORM HANDLING
// ============================================================================
console.log('[COPY MODAL] Setting up event handlers and form submission...');
        modal.style.removeProperty('visibility');
        modal.style.removeProperty('opacity');
        
        // Force a reflow to ensure the class change is applied
        modal.offsetHeight;
        
        console.log('Modal should be visible now');
        console.log('Modal classes:', modal.className);
        console.log('Computed display:', window.getComputedStyle(modal).display);
        console.log('Computed visibility:', window.getComputedStyle(modal).visibility);
        
        // Add click handler to close on background click
        modal.onclick = function(event) {
            if (event.target === modal) {
                closeCopyModal();
            }
        };
        
    } catch (error) {
        console.error('Error opening copy modal:', error);
        alert('Error opening copy modal: ' + error.message);
    }
}

// This function is now defined in critical_functions.html
// which calls closeCopyModalInternal defined above
console.log('[FUNCTION_NOTE] closeCopyModal is defined globally, using closeCopyModalInternal internally');

// Validate that all copy modal functions are available
function validateCopyModalFunctions() {
    console.log('[VALIDATE] Checking copy modal functions...');
    const checks = {
        modal: document.getElementById('copyExamModal'),
        form: document.getElementById('copyExamForm'),
        openCopyModal: typeof window.openCopyModal === 'function',
        closeCopyModal: typeof window.closeCopyModal === 'function',
        openCopyModalInternal: typeof window.openCopyModalInternal === 'function',
        closeCopyModalInternal: typeof window.closeCopyModalInternal === 'function'
    };
    
    console.log('[VALIDATE] Copy modal status:', checks);
    return checks;
}

// Handle copy form submission
function initializeCopyFormSubmission() {
    const copyExamForm = document.getElementById('copyExamForm');
    if (!copyExamForm) {
        console.error('copyExamForm not found');
        return;
    }
    
    copyExamForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Copy form submitted');
        
        const formData = new FormData(this);
        const data = {
            source_exam_id: formData.get('source_exam_id'),
            target_class: formData.get('target_class'),
            target_timeslot: formData.get('timeslot')
        };
        
        console.log('Form data:', data);
        
        // Validate data
        if (!data.source_exam_id || !data.target_class || !data.target_timeslot) {
            console.error('Validation failed:', data);
            showErrorNotification('Please fill in all required fields');
            return;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Copying...';
        submitBtn.disabled = true;
    
    try {
        const response = await fetch('/RoutineTest/api/copy-exam/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccessNotification(result.message || 'Exam copied successfully!');
            closeCopyModal();
            // Reload after a short delay to show the notification
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showErrorNotification(result.error || 'Failed to copy exam');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Copy error:', error);
        showErrorNotification('Error copying exam: ' + error.message);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
    });
    
    console.log('Copy form submission handler initialized');
}

// Delete functions are now defined in critical_functions.html at the top of the page
// This ensures they're available before any onclick handlers are rendered
// The functions are: window.confirmDelete and window.deleteExam

// Verify delete functions are available
function verifyDeleteFunctions() {
    const functionsAvailable = {
        confirmDelete: typeof window.confirmDelete === 'function',
        deleteExam: typeof window.deleteExam === 'function',
        openCopyModal: typeof window.openCopyModal === 'function',
        closeCopyModal: typeof window.closeCopyModal === 'function',
        ready: window.EXAM_FUNCTIONS_READY
    };
    
    console.log('[VERIFY] Critical functions status:', functionsAvailable);
    
    if (!functionsAvailable.confirmDelete || !functionsAvailable.deleteExam) {
        console.error('[VERIFY] Critical delete functions not available!');
    }
    
    return functionsAvailable;
}

// Notification helper functions
function showSuccessNotification(message) {
    showNotification(message, 'success');
}

function showErrorNotification(message) {
    showNotification(message, 'error');
}

function showNotification(message, type = 'info') {
    // Remove any existing notification
    const existingNotification = document.getElementById('exam-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create new notification
    const notification = document.createElement('div');
    notification.id = 'exam-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 4px;
        z-index: 10000;
        transition: opacity 0.3s;
        font-weight: 500;
        min-width: 250px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    
    // Set colors based on type
    if (type === 'success') {
        notification.style.backgroundColor = '#d4edda';
        notification.style.color = '#155724';
        notification.style.border = '1px solid #c3e6cb';
    } else if (type === 'error') {
        notification.style.backgroundColor = '#f8d7da';
        notification.style.color = '#721c24';
        notification.style.border = '1px solid #f5c6cb';
    } else {
        notification.style.backgroundColor = '#d1ecf1';
        notification.style.color = '#0c5460';
        notification.style.border = '1px solid #bee5eb';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Fade in
    setTimeout(() => {
        notification.style.opacity = '1';
    }, 10);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 3000);
}

// Delete button color enforcement - Fixed to prevent infinite loop
let isProcessingDeleteButtons = false;

function enforceDeleteButtonColors() {
    // Prevent recursive calls
    if (isProcessingDeleteButtons) {
        return;
    }
    
    isProcessingDeleteButtons = true;
    
    // Find all possible delete button selectors that haven't been fixed yet
    const deleteButtons = document.querySelectorAll(`
        button[onclick*="confirmDelete"]:not([data-delete-button-fixed]),
        .btn-danger:not([data-delete-button-fixed]),
        button.btn-danger:not([data-delete-button-fixed]),
        .exam-actions button[onclick*="confirmDelete"]:not([data-delete-button-fixed]),
        .exam-actions .btn-danger:not([data-delete-button-fixed])
    `);
    
    if (deleteButtons.length === 0) {
        isProcessingDeleteButtons = false;
        return; // No buttons to fix
    }
    
    console.log(`[DELETE FIX] Found ${deleteButtons.length} delete buttons to fix`);
    
    deleteButtons.forEach((button, index) => {
        // Remove any conflicting theme classes that might make it green
        button.classList.remove('btn-success', 'btn-primary', 'btn-secondary', 'btn-info');
        
        // Ensure btn-danger class is present
        if (!button.classList.contains('btn-danger')) {
            button.classList.add('btn-danger');
        }
        
        // Force red styling with maximum specificity through inline styles
        button.style.setProperty('background-color', '#dc3545', 'important');
        button.style.setProperty('background', '#dc3545', 'important');
        button.style.setProperty('border-color', '#dc3545', 'important');
        button.style.setProperty('color', 'white', 'important');
        button.style.setProperty('background-image', 'none', 'important');
        
        // Set data attribute for identification
        button.setAttribute('data-delete-button-fixed', 'true');
        
        // Remove and re-add hover event listeners to prevent conflicts
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Add proper hover events
        newButton.addEventListener('mouseenter', function(e) {
            e.target.style.setProperty('background-color', '#c82333', 'important');
            e.target.style.setProperty('background', '#c82333', 'important');
            e.target.style.setProperty('border-color', '#bd2130', 'important');
            e.target.style.setProperty('transform', 'translateY(-2px)', 'important');
            e.target.style.setProperty('box-shadow', '0 4px 8px rgba(220, 53, 69, 0.3)', 'important');
        });
        
        newButton.addEventListener('mouseleave', function(e) {
            e.target.style.setProperty('background-color', '#dc3545', 'important');
            e.target.style.setProperty('background', '#dc3545', 'important');
            e.target.style.setProperty('border-color', '#dc3545', 'important');
            e.target.style.setProperty('transform', 'none', 'important');
            e.target.style.setProperty('box-shadow', 'none', 'important');
        });
        
        console.log(`[DELETE FIX] Fixed button ${index}: ${newButton.textContent.trim()}`);
    });
    
    // Release the processing flag
    isProcessingDeleteButtons = false;
    
    // Check once more after a delay for any dynamically added buttons
    setTimeout(() => {
        // Only process if not already processing
        if (!isProcessingDeleteButtons) {
            const themeButtons = document.querySelectorAll('.routinetest-theme .btn:not([data-delete-button-fixed])');
            themeButtons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes('confirmDelete')) {
                    // Fix this specific button inline without recursion
                    btn.classList.remove('btn-success', 'btn-primary', 'btn-secondary', 'btn-info');
                    btn.classList.add('btn-danger');
                    btn.style.setProperty('background-color', '#dc3545', 'important');
                    btn.style.setProperty('border-color', '#dc3545', 'important');
                    btn.style.setProperty('color', 'white', 'important');
                    btn.setAttribute('data-delete-button-fixed', 'true');
                }
        });
    }, 100);
}

// Run immediately when page loads
document.addEventListener('DOMContentLoaded', enforceDeleteButtonColors);

// Run after a short delay to catch theme-applied buttons
setTimeout(enforceDeleteButtonColors, 500);

// Watch for dynamic content changes - Fixed to prevent infinite loop
let observerTimeoutId;

const observer = new MutationObserver(function(mutations) {
    // Clear any pending timeouts
    clearTimeout(observerTimeoutId);
    
    // Debounce the enforcement to prevent rapid re-processing
    observerTimeoutId = setTimeout(() => {
        let hasNewDeleteButtons = false;
        
        mutations.forEach(function(mutation) {
            // Only process new nodes, not attribute changes
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === 1 && (
                        (node.matches && node.matches('button[onclick*="confirmDelete"]:not([data-delete-button-fixed])')) ||
                        (node.querySelector && node.querySelector('button[onclick*="confirmDelete"]:not([data-delete-button-fixed])'))
                    )) {
                        hasNewDeleteButtons = true;
                    }
                });
            }
        });
        
        if (hasNewDeleteButtons) {
            console.log('[DELETE FIX] New delete buttons detected, processing');
            enforceDeleteButtonColors();
        }
    }, 250); // Debounce for 250ms
});

// Start observing with more specific configuration (only childList changes)
observer.observe(document.body, {
    childList: true,
    subtree: true
    // Removed attributes watching to prevent infinite loop
});

// Function to update the exam name preview
window.updateCopyExamNamePreview = function() {
    console.log('[COPY_MODAL_PREVIEW] Updating exam name preview...');
    
    try {
        const examTypeSelect = document.getElementById('copyExamType');
        const timeslotSelect = document.getElementById('timeslot');
        const programSelect = document.getElementById('copyProgramSelect');
        const subprogramSelect = document.getElementById('copySubprogramSelect');
        const levelSelect = document.getElementById('copyLevelSelect');
        const customSuffixInput = document.getElementById('customSuffix');
        const previewText = document.getElementById('previewText');
        
        if (!previewText) {
            console.error('[COPY_MODAL_PREVIEW] Preview text element not found');
            return;
        }
    
    // Check if basic required fields are filled (allow partial preview)
    if (!examTypeSelect?.value || !timeslotSelect?.value) {
        previewText.textContent = 'Please select exam type and time period to see preview...';
        console.log('[COPY_MODAL_PREVIEW] Missing basic required fields:', {
            examType: examTypeSelect?.value,
            timeslot: timeslotSelect?.value
        });
        return;
    }
    
    // Build the name preview with curriculum selection
    let nameParts = [];
    
    // Add exam type prefix based on selection
    if (examTypeSelect.value === 'QUARTERLY') {
        nameParts.push('[QTR]');
    } else if (examTypeSelect.value === 'REVIEW') {
        nameParts.push('[RVW]');
    }
    
    // Add time period based on exam type
    const year = new Date().getFullYear();
    if (examTypeSelect.value === 'QUARTERLY') {
        // For quarterly exams, use the selected quarter
        const quarterValue = timeslotSelect.value; // e.g., 'Q1', 'Q2', etc.
        nameParts.push(`${quarterValue} ${year}`);
    } else if (examTypeSelect.value === 'REVIEW') {
        // For review/monthly exams, use the selected month
        const monthText = timeslotSelect.options[timeslotSelect.selectedIndex]?.text || timeslotSelect.value;
        nameParts.push(`${monthText} ${year}`);
    }
    
    // Add curriculum information
    if (programSelect?.value && subprogramSelect?.value && levelSelect?.value) {
        // Use selected curriculum
        const program = programSelect.value;
        const subprogram = subprogramSelect.value;
        const levelNumber = levelSelect.options[levelSelect.selectedIndex].text.replace('Level ', '');
        const curriculum = `${program} ${subprogram} Lv${levelNumber}`;
        nameParts.push(curriculum);
        console.log('[COPY_MODAL_PREVIEW] Using selected curriculum:', curriculum);
    } else {
        // Fallback to extracting from source exam name
        const sourceExamNameElement = document.getElementById('sourceExamName');
        const sourceExamNameText = sourceExamNameElement?.textContent || '';
        
        if (sourceExamNameText && sourceExamNameText !== 'Loading...') {
            const curriculumMatch = sourceExamNameText.match(/(CORE|ASCENT|EDGE|PINNACLE)\s+(\w+)\s+Lv(\d+)/);
            if (curriculumMatch) {
                const curriculum = `${curriculumMatch[1]} ${curriculumMatch[2]} Lv${curriculumMatch[3]}`;
                nameParts.push(curriculum);
                console.log('[COPY_MODAL_PREVIEW] Using source curriculum (fallback):', curriculum);
            } else {
                // Try to extract any curriculum-like pattern
                const levelMatch = sourceExamNameText.match(/Lv\d+/);
                if (levelMatch) {
                    const beforeLevel = sourceExamNameText.substring(
                        sourceExamNameText.lastIndexOf('-') + 1,
                        sourceExamNameText.indexOf(levelMatch[0])
                    ).trim();
                    if (beforeLevel) {
                        nameParts.push(`${beforeLevel}${levelMatch[0]}`);
                        console.log('[COPY_MODAL_PREVIEW] Using extracted curriculum pattern:', `${beforeLevel}${levelMatch[0]}`);
                    }
                }
            }
        }
    }
    
    // Join parts
    let previewName = nameParts.join(' - ');
    
    // Add custom suffix if provided
    const customSuffix = customSuffixInput?.value?.trim();
    if (customSuffix) {
        previewName += customSuffix.startsWith('_') ? customSuffix : `_${customSuffix}`;
    }
    
        previewText.textContent = previewName;
        console.log('[COPY_MODAL_PREVIEW] Generated preview:', previewName);
    } catch (error) {
        console.error('[COPY_MODAL_PREVIEW] Error updating preview:', error);
        const previewText = document.getElementById('previewText');
        if (previewText) {
            previewText.textContent = 'Error generating preview';
        }
    }
};

// Populate timeslots based on exam type
function initializeCopyExamEventListeners() {
    console.log('Initializing copy exam event listeners...');
    
    const copyExamTypeSelect = document.getElementById('copyExamType');
    if (!copyExamTypeSelect) {
        console.error('copyExamType element not found');
        return;
    }
    
    // Remove any existing event listeners to prevent duplicates
    const newCopyExamTypeSelect = copyExamTypeSelect.cloneNode(true);
    copyExamTypeSelect.parentNode.replaceChild(newCopyExamTypeSelect, copyExamTypeSelect);
    
    newCopyExamTypeSelect.addEventListener('change', function() {
        console.log('[COPY_MODAL] Exam type changed to:', this.value);
        
        const timeslotSelect = document.getElementById('timeslot');
        if (!timeslotSelect) {
            console.error('[COPY_MODAL] timeslot element not found');
            return;
        }
        
        // Clear existing options
        timeslotSelect.innerHTML = '<option value="">Select time period...</option>';
        
        if (this.value === 'REVIEW') {
            console.log('[COPY_MODAL] Setting up monthly timeslots...');
            // Enable the select
            timeslotSelect.disabled = false;
            
            // Monthly timeslots with proper month codes
            const months = [
                {value: 'JAN', text: 'January'},
                {value: 'FEB', text: 'February'},
                {value: 'MAR', text: 'March'},
                {value: 'APR', text: 'April'},
                {value: 'MAY', text: 'May'},
                {value: 'JUN', text: 'June'},
                {value: 'JUL', text: 'July'},
                {value: 'AUG', text: 'August'},
                {value: 'SEP', text: 'September'},
                {value: 'OCT', text: 'October'},
                {value: 'NOV', text: 'November'},
                {value: 'DEC', text: 'December'}
            ];
            
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.text;
                timeslotSelect.appendChild(option);
            });
        } else if (this.value === 'QUARTERLY') {
            console.log('[COPY_MODAL] Setting up quarterly timeslots...');
            // Enable the select
            timeslotSelect.disabled = false;
            timeslotSelect.style.color = '#333';
            timeslotSelect.style.backgroundColor = '#fff';
            console.log('[COPY_MODAL] Quarterly dropdown enabled, disabled state:', timeslotSelect.disabled);
            
            // Quarterly timeslots
            ['Q1', 'Q2', 'Q3', 'Q4'].forEach(quarter => {
                const option = document.createElement('option');
                option.value = quarter;
                option.textContent = quarter;
                timeslotSelect.appendChild(option);
            });
        } else {
            console.log('[COPY_MODAL] No exam type selected, disabling timeslot');
            // No exam type selected, disable timeslot
            timeslotSelect.disabled = true;
            timeslotSelect.innerHTML = '<option value="">First select exam type...</option>';
            
            // Hide debug info when no exam type is selected
            const debugInfo = document.getElementById('timeslotDebugInfo');
            if (debugInfo) {
                debugInfo.style.display = 'none';
            }
        }
        
        // Show debug info if the dropdown is still disabled when it should be enabled
        setTimeout(() => {
            const debugInfo = document.getElementById('timeslotDebugInfo');
            if (debugInfo && this.value && timeslotSelect.disabled) {
                console.log('[DEBUG] Timeslot dropdown should be enabled but is still disabled');
                debugInfo.style.display = 'block';
            } else if (debugInfo && !timeslotSelect.disabled) {
                debugInfo.style.display = 'none';
            }
        }, 100);
        
        // Update name preview
        updateCopyExamNamePreview();
    });
    
    // Add event listeners for name preview updates
    const timeslotSelect = document.getElementById('timeslot');
    const academicYearSelect = document.getElementById('academicYear');
    const customSuffixInput = document.getElementById('customSuffix');
    
    if (timeslotSelect) {
        timeslotSelect.addEventListener('change', updateCopyExamNamePreview);
    }
    
    if (academicYearSelect) {
        academicYearSelect.addEventListener('change', updateCopyExamNamePreview);
    }
    
    if (customSuffixInput) {
        customSuffixInput.addEventListener('input', updateCopyExamNamePreview);
    }
    
    // Initialize curriculum cascading dropdowns
    initializeCopyCurriculumCascading();
    
    console.log('Copy exam event listeners initialized successfully');
}

// Debug function to fix the timeslot dropdown manually
function fixTimeslotDropdown() {
    console.log('[DEBUG] Attempting to fix timeslot dropdown...');
    
    const examTypeSelect = document.getElementById('copyExamType');
    const timeslotSelect = document.getElementById('timeslot');
    
    if (!examTypeSelect || !timeslotSelect) {
        console.error('[DEBUG] Required elements not found');
        return false;
    }
    
    console.log('[DEBUG] Current exam type:', examTypeSelect.value);
    console.log('[DEBUG] Current timeslot disabled state:', timeslotSelect.disabled);
    
    if (examTypeSelect.value === 'QUARTERLY') {
        console.log('[DEBUG] Forcing quarterly dropdown to be enabled...');
        
        timeslotSelect.disabled = false;
        timeslotSelect.style.color = '#333';
        timeslotSelect.style.backgroundColor = '#fff';
        timeslotSelect.style.cursor = 'pointer';
        
        // Clear and repopulate options
        timeslotSelect.innerHTML = '<option value="">Select time period...</option>';
        ['Q1', 'Q2', 'Q3', 'Q4'].forEach(quarter => {
            const option = document.createElement('option');
            option.value = quarter;
            option.textContent = quarter;
            timeslotSelect.appendChild(option);
        });
        
        console.log('[DEBUG] Timeslot dropdown fixed. New disabled state:', timeslotSelect.disabled);
        return true;
    } else if (examTypeSelect.value === 'REVIEW') {
        console.log('[DEBUG] Forcing monthly dropdown to be enabled...');
        
        timeslotSelect.disabled = false;
        timeslotSelect.style.color = '#333';
        timeslotSelect.style.backgroundColor = '#fff';
        timeslotSelect.style.cursor = 'pointer';
        
        // Clear and repopulate options
        timeslotSelect.innerHTML = '<option value="">Select time period...</option>';
        const months = [
            {value: 'JAN', text: 'January'}, {value: 'FEB', text: 'February'}, {value: 'MAR', text: 'March'},
            {value: 'APR', text: 'April'}, {value: 'MAY', text: 'May'}, {value: 'JUN', text: 'June'},
            {value: 'JUL', text: 'July'}, {value: 'AUG', text: 'August'}, {value: 'SEP', text: 'September'},
            {value: 'OCT', text: 'October'}, {value: 'NOV', text: 'November'}, {value: 'DEC', text: 'December'}
        ];
        
        months.forEach(month => {
            const option = document.createElement('option');
            option.value = month.value;
            option.textContent = month.text;
            timeslotSelect.appendChild(option);
        });
        
        console.log('[DEBUG] Timeslot dropdown fixed. New disabled state:', timeslotSelect.disabled);
        return true;
    }
    
    console.log('[DEBUG] No exam type selected, no fix needed');
    return false;
}

// Make the debug function globally available
window.fixTimeslotDropdown = fixTimeslotDropdown;

// ============================================================================
// CURRICULUM CASCADING FUNCTIONALITY FOR COPY MODAL
// ============================================================================

// ============================================================================
// COMPREHENSIVE COPY MODAL CURRICULUM DATA INITIALIZATION - ENHANCED v4.0
// ============================================================================

// Global curriculum data storage with enhanced state management
window.CopyCurriculumData = null;
window.CopyCurriculumDataReady = false;
window.CopyCurriculumDataInitialized = false;
window.CopyCurriculumDataError = null;

// COMPREHENSIVE FIX: Initialize enhanced curriculum data from Django context
console.group('%cüîç COPY MODAL CURRICULUM DEBUG - TEMPLATE ANALYSIS', 'color: #ff6b35; font-size: 16px; font-weight: bold;');
console.log('%c[TEMPLATE_DEBUG] Template rendering started at:', 'color: #0066cc;', new Date().toISOString());
console.log('%c[TEMPLATE_DEBUG] Django template context evaluation:', 'color: #0066cc;');
console.log('  - curriculum_hierarchy_for_copy available: {{ curriculum_hierarchy_for_copy|yesno:"YES,NO" }}');
console.log('  - curriculum_levels_for_copy available: {{ curriculum_levels_for_copy|yesno:"YES,NO" }}');

{% if curriculum_hierarchy_for_copy %}
// Use ENHANCED structured hierarchy data from Django backend
console.log('%c[COPY_CURRICULUM_FIX] ‚úÖ curriculum_hierarchy_for_copy IS AVAILABLE from Django backend', 'color: #00aa00; font-weight: bold;');
console.log('[COPY_CURRICULUM_FIX] Loading ENHANCED hierarchical curriculum data from Django backend...');
// Note: The json_script tag is placed outside this script block to avoid rendering issues
const curriculumScriptElement = document.getElementById('copy-curriculum-hierarchy-data');
if (curriculumScriptElement) {
    try {
        const enhancedData = JSON.parse(curriculumScriptElement.textContent);
        
        // COMPREHENSIVE FIX: Handle enhanced data structure with validation
        console.group('[COPY_CURRICULUM_FIX] Processing Enhanced Curriculum Data');
        console.log('[COPY_CURRICULUM_FIX] Enhanced data structure loaded:', {
            hasData: !!enhancedData,
            hasCurriculumData: !!enhancedData.curriculum_data,
            hasMetadata: !!enhancedData.metadata,
            hasValidation: !!enhancedData.validation,
            version: enhancedData.metadata?.version
        });
        
        if (enhancedData.curriculum_data) {
            // Extract the actual curriculum data from the enhanced structure
            window.CopyCurriculumData = enhancedData.curriculum_data;
            window.CopyCurriculumDataReady = true;
            window.CopyCurriculumMetadata = enhancedData.metadata;
            window.CopyCurriculumValidation = enhancedData.validation;
            window.CopyCurriculumDebugInfo = enhancedData.debug_info;
            
            console.log('[COPY_CURRICULUM_FIX] ‚úÖ Successfully extracted curriculum data from enhanced structure');
            console.log('[COPY_CURRICULUM_FIX] Available programs:', Object.keys(window.CopyCurriculumData));
            console.log('[COPY_CURRICULUM_FIX] Total programs loaded:', Object.keys(window.CopyCurriculumData).length);
            console.log('[COPY_CURRICULUM_FIX] Data version:', enhancedData.metadata?.version);
            console.log('[COPY_CURRICULUM_FIX] Validation passed:', enhancedData.validation?.is_valid);
            console.log('[COPY_CURRICULUM_FIX] Total levels:', enhancedData.validation?.total_levels);
            
            // Detailed program structure validation
            console.log('[COPY_CURRICULUM_FIX] Program structure validation:');
            Object.keys(window.CopyCurriculumData).forEach(program => {
                const programData = window.CopyCurriculumData[program];
                const subprograms = Object.keys(programData.subprograms || {});
                const meta = programData.meta || {};
                console.log(`[COPY_CURRICULUM_FIX]   ${program}: ${subprograms.length} subprograms, ${meta.total_levels || 0} levels`);
                console.log(`[COPY_CURRICULUM_FIX]     Subprograms: ${subprograms.join(', ')}`);
            });
            
            // Test if data is valid for frontend use
            if (enhancedData.validation?.is_valid && Object.keys(window.CopyCurriculumData).length === 4) {
                console.log('[COPY_CURRICULUM_FIX] ‚úÖ‚úÖ‚úÖ ALL VALIDATIONS PASSED - DATA READY FOR FRONTEND');
            } else {
                console.warn('[COPY_CURRICULUM_FIX] ‚ö†Ô∏è Data validation concerns:', enhancedData.validation?.validation_errors);
            }
        } else {
            console.error('[COPY_CURRICULUM_FIX] ‚ùå Enhanced data missing curriculum_data property');
            console.log('[COPY_CURRICULUM_FIX] Available properties:', Object.keys(enhancedData));
        }
        
        console.groupEnd();
        
    } catch (parseError) {
        console.error('[COPY_CURRICULUM_FIX] ‚ùå JSON parsing failed:', parseError);
        console.log('[COPY_CURRICULUM_FIX] Raw content length:', curriculumScriptElement.textContent.length);
        console.log('[COPY_CURRICULUM_FIX] First 200 chars:', curriculumScriptElement.textContent.substring(0, 200));
    }
} else {
    console.error('[COPY_CURRICULUM_FIX] ‚ùå Script element #copy-curriculum-hierarchy-data not found in DOM');
    console.log('[COPY_CURRICULUM_FIX] Available script elements:', Array.from(document.querySelectorAll('script[type="application/json"]')).map(s => s.id));
}
{% elif curriculum_levels_for_copy %}
// Fallback: Build from individual level data (legacy support)
console.log('%c[TEMPLATE_DEBUG] ‚ö†Ô∏è Using FALLBACK curriculum_levels_for_copy', 'color: #ff9900; font-weight: bold;');
console.log('[COPY_CURRICULUM] Using fallback curriculum data construction...');
window.CopyCurriculumData = {};
{% for level_data in curriculum_levels_for_copy %}
    {% with program=level_data.program_name subprogram=level_data.subprogram_name level=level_data.level_number %}
        if (!window.CopyCurriculumData['{{ program }}']) {
            window.CopyCurriculumData['{{ program }}'] = { subprograms: {} };
        }
        if (!window.CopyCurriculumData['{{ program }}']['subprograms']['{{ subprogram }}']) {
            window.CopyCurriculumData['{{ program }}']['subprograms']['{{ subprogram }}'] = { levels: [] };
        }
        window.CopyCurriculumData['{{ program }}']['subprograms']['{{ subprogram }}']['levels'].push({
            id: {{ level_data.curriculum_level.id }},
            number: {{ level }}
        });
    {% endwith %}
{% endfor %}
window.CopyCurriculumDataReady = true;
console.log('[COPY_CURRICULUM] ‚ö†Ô∏è  Built curriculum data from individual levels (fallback)');
console.log('[COPY_CURRICULUM] Total programs loaded:', Object.keys(window.CopyCurriculumData).length);
{% else %}
console.error('%c[TEMPLATE_DEBUG] ‚ùå‚ùå‚ùå NO CURRICULUM DATA AVAILABLE FROM DJANGO CONTEXT!', 'color: #ff0000; font-size: 18px; font-weight: bold;');
console.error('[COPY_CURRICULUM] This means neither curriculum_hierarchy_for_copy nor curriculum_levels_for_copy were passed to template');
console.log('[COPY_CURRICULUM] Available context variables:', Object.keys({{ curriculum_hierarchy_for_copy|default:"{}"|safe }}));
{% endif %}

// Close the debug group and provide summary
console.log('%c[TEMPLATE_DEBUG] Django template processing completed', 'color: #0066cc;');
console.log('%c[TEMPLATE_DEBUG] Final curriculum data state:', 'color: #0066cc;');
console.log('  - window.CopyCurriculumData available:', !!window.CopyCurriculumData);
console.log('  - window.CopyCurriculumDataReady:', window.CopyCurriculumDataReady);
if (window.CopyCurriculumData) {
    console.log('  - Programs loaded:', Object.keys(window.CopyCurriculumData));
}
console.groupEnd();

// Try to populate dropdown immediately if DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('[COPY_CURRICULUM] DOM ready, attempting to populate dropdown...');
    if (typeof populateCopyProgramDropdown === 'function') {
        populateCopyProgramDropdown();
    }
});

function initializeCopyCurriculumCascading() {
    console.log('[COPY_CURRICULUM] Initializing curriculum cascading...');
    
    // Load curriculum data
    loadCopyCurriculumData().then(() => {
        setupCopyCurriculumEventListeners();
    });
}

async function loadCopyCurriculumData() {
    console.log('[COPY_CURRICULUM] Loading curriculum data...');
    
    try {
        // Check if Django context data is already available and ready
        if (window.CopyCurriculumData && window.CopyCurriculumDataReady) {
            console.log('[COPY_CURRICULUM] Using Django-provided curriculum data');
            console.log('[COPY_CURRICULUM] Available programs:', Object.keys(window.CopyCurriculumData));
            populateCopyProgramDropdown();
            return;
        }
        
        // Try legacy global variable for backward compatibility
        if (window.curriculumData) {
            window.CopyCurriculumData = window.curriculumData;
            console.log('[COPY_CURRICULUM] Using existing curriculum data');
            populateCopyProgramDropdown();
            return;
        }
        
        // If no global data, we need to construct it from the Django template
        // This is a fallback approach
        console.log('[COPY_CURRICULUM] Building curriculum data from template context...');
        
        // For now, we'll create a basic structure with the standard programs
        window.CopyCurriculumData = {
            'CORE': {
                subprograms: {
                    'Phonics': { levels: [{id: 1, number: 1}, {id: 2, number: 2}, {id: 3, number: 3}] },
                    'Sigma': { levels: [{id: 4, number: 1}, {id: 5, number: 2}, {id: 6, number: 3}] },
                    'Elite': { levels: [{id: 7, number: 1}, {id: 8, number: 2}, {id: 9, number: 3}] },
                    'Pro': { levels: [{id: 10, number: 1}, {id: 11, number: 2}, {id: 12, number: 3}] }
                }
            },
            'ASCENT': {
                subprograms: {
                    'Nova': { levels: [{id: 13, number: 1}, {id: 14, number: 2}, {id: 15, number: 3}] },
                    'Drive': { levels: [{id: 16, number: 1}, {id: 17, number: 2}, {id: 18, number: 3}] },
                    'Pro': { levels: [{id: 19, number: 1}, {id: 20, number: 2}, {id: 21, number: 3}] }
                }
            },
            'EDGE': {
                subprograms: {
                    'Spark': { levels: [{id: 22, number: 1}, {id: 23, number: 2}, {id: 24, number: 3}] },
                    'Rise': { levels: [{id: 25, number: 1}, {id: 26, number: 2}, {id: 27, number: 3}] },
                    'Pursuit': { levels: [{id: 28, number: 1}, {id: 29, number: 2}, {id: 30, number: 3}] },
                    'Pro': { levels: [{id: 31, number: 1}, {id: 32, number: 2}, {id: 33, number: 3}] }
                }
            },
            'PINNACLE': {
                subprograms: {
                    'Vision': { levels: [{id: 34, number: 1}, {id: 35, number: 2}] },
                    'Endeavor': { levels: [{id: 36, number: 1}, {id: 37, number: 2}] },
                    'Success': { levels: [{id: 38, number: 1}, {id: 39, number: 2}] },
                    'Pro': { levels: [{id: 40, number: 1}, {id: 41, number: 2}] }
                }
            }
        };
        
        // Don't auto-populate here, wait for modal open
        console.log('[COPY_CURRICULUM] Curriculum data loaded, ready for modal');
        
    } catch (error) {
        console.error('[COPY_CURRICULUM] Error loading curriculum data:', error);
    }
}

// Global flag to prevent multiple simultaneous population attempts
window.populateCopyProgramDropdownInProgress = false;
window.populateCopyProgramDropdownCompleted = false;

function populateCopyProgramDropdown(retryCount = 0) {
    // CRITICAL FIX: Allow re-population when modal reopens
    if (window.populateCopyProgramDropdownInProgress && retryCount > 0) {
        console.log('[COPY_CURRICULUM_FIX] ‚ö†Ô∏è Population already in progress, skipping duplicate call');
        return false;
    }
    
    // Reset completed flag when modal reopens (retryCount = 0)
    if (retryCount === 0) {
        window.populateCopyProgramDropdownCompleted = false;
        window.populateCopyProgramDropdownInProgress = false;
    }
    
    // Set in-progress flag
    window.populateCopyProgramDropdownInProgress = true;
    
    console.group('[COPY_CURRICULUM_FIX] populateCopyProgramDropdown() - COMPREHENSIVE FIX v4');
    
    const programSelect = document.getElementById('copyProgramSelect');
    
    // COMPREHENSIVE debugging information with enhanced data integration
    console.log('[COPY_CURRICULUM_FIX] Function called at:', new Date().toISOString());
    console.log('[COPY_CURRICULUM_FIX] Retry count:', retryCount);
    console.log('[COPY_CURRICULUM_FIX] Call stack:', new Error().stack.split('\n')[1].trim());
    console.log('[COPY_CURRICULUM_FIX] DOM ready state:', document.readyState);
    console.log('[COPY_CURRICULUM_FIX] programSelect element:', !!programSelect);
    console.log('[COPY_CURRICULUM_FIX] programSelect visible:', programSelect ? window.getComputedStyle(programSelect).display !== 'none' : 'N/A');
    console.log('[COPY_CURRICULUM_FIX] window.CopyCurriculumData exists:', !!window.CopyCurriculumData);
    console.log('[COPY_CURRICULUM_FIX] window.CopyCurriculumDataReady:', window.CopyCurriculumDataReady);
    
    // ENHANCED: Check for enhanced data structure metadata
    console.log('[COPY_CURRICULUM_FIX] Enhanced data structure check:');
    console.log('[COPY_CURRICULUM_FIX]   Metadata available:', !!window.CopyCurriculumMetadata);
    console.log('[COPY_CURRICULUM_FIX]   Validation available:', !!window.CopyCurriculumValidation);
    console.log('[COPY_CURRICULUM_FIX]   Debug info available:', !!window.CopyCurriculumDebugInfo);
    
    if (window.CopyCurriculumMetadata) {
        console.log('[COPY_CURRICULUM_FIX]   Data version:', window.CopyCurriculumMetadata.version);
        console.log('[COPY_CURRICULUM_FIX]   Generated at:', window.CopyCurriculumMetadata.generated_at);
        console.log('[COPY_CURRICULUM_FIX]   Frontend optimized:', window.CopyCurriculumMetadata.frontend_optimized);
    }
    
    if (window.CopyCurriculumValidation) {
        console.log('[COPY_CURRICULUM_FIX]   Validation passed:', window.CopyCurriculumValidation.is_valid);
        console.log('[COPY_CURRICULUM_FIX]   Total levels expected:', window.CopyCurriculumValidation.total_levels);
        console.log('[COPY_CURRICULUM_FIX]   Programs expected:', window.CopyCurriculumValidation.expected_programs);
    }
    
    // COMPREHENSIVE validation with enhanced error reporting
    if (!programSelect) {
        console.error('[COPY_CURRICULUM_FIX] ‚ùå copyProgramSelect element not found in DOM!');
        console.log('[COPY_CURRICULUM_FIX] Checking for similar elements...');
        const possibleElements = document.querySelectorAll('select[id*="Program"], select[id*="program"]');
        console.log('[COPY_CURRICULUM_FIX] Found similar elements:', Array.from(possibleElements).map(el => el.id));
        
        // ENHANCED: Check if Copy Exam modal is even open
        const copyModal = document.getElementById('copyExamModal');
        console.log('[COPY_CURRICULUM_FIX] Copy modal exists:', !!copyModal);
        console.log('[COPY_CURRICULUM_FIX] Copy modal visible:', copyModal ? window.getComputedStyle(copyModal).display !== 'none' : 'N/A');
        
        console.groupEnd();
        return false;
    }
    
    if (!window.CopyCurriculumData) {
        console.error('[COPY_CURRICULUM_FIX] ‚ùå No curriculum data available!');
        console.log('[COPY_CURRICULUM_FIX] Checking for alternative data sources...');
        console.log('[COPY_CURRICULUM_FIX] window.curriculumData exists:', !!window.curriculumData);
        console.log('[COPY_CURRICULUM_FIX] All window curriculum variables:', Object.keys(window).filter(key => key.toLowerCase().includes('curriculum')));
        
        // Retry logic - wait for data to load (with proper flag reset)
        if (retryCount < 5) {
            console.log(`[COPY_CURRICULUM_FIX] ‚è≥ Data not ready, retrying in 500ms (attempt ${retryCount + 1}/5)...`);
            // Reset in-progress flag before retry
            window.populateCopyProgramDropdownInProgress = false;
            setTimeout(() => {
                populateCopyProgramDropdown(retryCount + 1);
            }, 500);
            console.groupEnd();
            return false;
        }
        
        console.log('[COPY_CURRICULUM_FIX] Attempting fallback data construction...');
        
        // Try fallback construction
        if (typeof loadCopyCurriculumData === 'function') {
            console.log('[COPY_CURRICULUM_FIX] Calling loadCopyCurriculumData fallback...');
            loadCopyCurriculumData().then(() => {
                console.log('[COPY_CURRICULUM_FIX] Fallback completed, retrying population...');
                populateCopyProgramDropdown(0); // Reset retry count for fallback
            }).catch(error => {
                console.error('[COPY_CURRICULUM_FIX] Fallback failed:', error);
                // Reset flag on fallback failure
                window.populateCopyProgramDropdownInProgress = false;
            });
        } else {
            console.error('[COPY_CURRICULUM_FIX] ‚ùå No fallback available - loadCopyCurriculumData not found');
            // Reset flag when no fallback available
            window.populateCopyProgramDropdownInProgress = false;
        }
        console.groupEnd();
        return false;
    }
    
    console.log('[COPY_CURRICULUM] üîÑ Starting program dropdown population...');
    console.log('[COPY_CURRICULUM] Available programs:', Object.keys(window.CopyCurriculumData));
    console.log('[COPY_CURRICULUM] Data structure check:');
    
    // Validate data structure
    let structureValid = true;
    Object.keys(window.CopyCurriculumData).forEach(program => {
        if (!window.CopyCurriculumData[program].subprograms) {
            console.error(`[COPY_CURRICULUM] ‚ùå Invalid structure for program ${program}: missing subprograms`);
            structureValid = false;
        } else {
            const subprograms = Object.keys(window.CopyCurriculumData[program].subprograms);
            console.log(`[COPY_CURRICULUM]   ‚úÖ ${program}: ${subprograms.length} subprograms`);
        }
    });
    
    if (!structureValid) {
        console.error('[COPY_CURRICULUM] ‚ùå Data structure validation failed');
        console.groupEnd();
        return false;
    }
    
    // Clear existing options except the first
    const initialHTML = '<option value="">-- Select Program --</option>';
    programSelect.innerHTML = initialHTML;
    console.log('[COPY_CURRICULUM] Reset dropdown to initial state');
    
    // Add programs with enhanced error handling
    let optionsAdded = 0;
    try {
        // Define correct program order: CORE ‚Üí ASCENT ‚Üí EDGE ‚Üí PINNACLE
        const programOrder = ['CORE', 'ASCENT', 'EDGE', 'PINNACLE'];
        
        // Add programs in the correct hierarchical order
        programOrder.forEach(program => {
            // Check if this program exists in the data
            if (!window.CopyCurriculumData[program]) {
                console.warn(`[COPY_CURRICULUM] Program "${program}" not found in curriculum data, skipping`);
                return;
            }
            
            const option = document.createElement('option');
            option.value = program;
            option.textContent = program;
            
            // Additional attributes for debugging
            option.setAttribute('data-subprogram-count', Object.keys(window.CopyCurriculumData[program].subprograms).length);
            
            programSelect.appendChild(option);
            optionsAdded++;
            console.log(`[COPY_CURRICULUM] ‚ûï Added option: "${program}" (${Object.keys(window.CopyCurriculumData[program].subprograms).length} subprograms)`);
        });
        
        console.log('[COPY_CURRICULUM] ‚úÖ Successfully added', optionsAdded, 'program options');
        console.log('[COPY_CURRICULUM] Final options count:', programSelect.options.length);
        console.log('[COPY_CURRICULUM] Options array:', Array.from(programSelect.options).map(opt => opt.textContent));
        
        // Verify dropdown is interactive
        console.log('[COPY_CURRICULUM] Dropdown interactive check:');
        console.log('[COPY_CURRICULUM]   - disabled:', programSelect.disabled);
        console.log('[COPY_CURRICULUM]   - style.display:', programSelect.style.display);
        console.log('[COPY_CURRICULUM]   - computed visibility:', window.getComputedStyle(programSelect).visibility);
        
        console.log('[COPY_CURRICULUM] üéâ Program dropdown populated successfully');
        
        // Force trigger change event to update dependent dropdowns
        programSelect.dispatchEvent(new Event('change', { bubbles: true }));
        console.log('[COPY_CURRICULUM] Triggered change event on program dropdown');
        
        // Mark as completed and reset in-progress flag
        window.populateCopyProgramDropdownCompleted = true;
        window.populateCopyProgramDropdownInProgress = false;
        
        console.groupEnd();
        return true;
        
    } catch (error) {
        console.error('[COPY_CURRICULUM] ‚ùå Error during option creation:', error);
        console.error('[COPY_CURRICULUM] Stack trace:', error.stack);
        
        // Restore initial state on error
        programSelect.innerHTML = initialHTML;
        console.log('[COPY_CURRICULUM] Restored initial state after error');
        
        // Reset flags on error
        window.populateCopyProgramDropdownInProgress = false;
        
        console.groupEnd();
        return false;
    }
}

// Global debug function for testing
window.debugCopyModal = function() {
    console.log('=== COPY MODAL DEBUG ===');
    console.log('Modal element:', document.getElementById('copyExamModal'));
    console.log('Program select:', document.getElementById('copyProgramSelect'));
    console.log('Curriculum data available:', !!window.CopyCurriculumData);
    console.log('Curriculum data ready:', window.CopyCurriculumDataReady);
    if (window.CopyCurriculumData) {
        console.log('Available programs:', Object.keys(window.CopyCurriculumData));
    }
    
    console.log('\nForcing dropdown population...');
    populateCopyProgramDropdown(0);
};

console.log('[DEBUG] window.debugCopyModal() available for manual testing');

// ============================================================================
// ENHANCED v4.0: HELPER FUNCTIONS FOR ROBUST CURRICULUM DATA HANDLING
// ============================================================================

// Fallback curriculum initialization function
async function tryFallbackCurriculumInitialization() {
    console.log('[FALLBACK] Attempting fallback curriculum data initialization...');
    
    try {
        // Try to construct from individual curriculum levels (legacy support)
        if (!window.CopyCurriculumData || Object.keys(window.CopyCurriculumData).length === 0) {
            console.log('[FALLBACK] Building basic curriculum structure...');
            
            // Create basic structure with expected programs
            window.CopyCurriculumData = {
                'CORE': {
                    subprograms: {
                        'Phonics': { levels: [{id: 1, number: 1}, {id: 2, number: 2}, {id: 3, number: 3}] },
                        'Sigma': { levels: [{id: 4, number: 1}, {id: 5, number: 2}, {id: 6, number: 3}] },
                        'Elite': { levels: [{id: 7, number: 1}, {id: 8, number: 2}, {id: 9, number: 3}] },
                        'Pro': { levels: [{id: 10, number: 1}, {id: 11, number: 2}, {id: 12, number: 3}] }
                    }
                },
                'EDGE': {
                    subprograms: {
                        'Spark': { levels: [{id: 13, number: 1}, {id: 14, number: 2}, {id: 15, number: 3}] },
                        'Rise': { levels: [{id: 16, number: 1}, {id: 17, number: 2}, {id: 18, number: 3}] },
                        'Pursuit': { levels: [{id: 19, number: 1}, {id: 20, number: 2}, {id: 21, number: 3}] },
                        'Pro': { levels: [{id: 22, number: 1}, {id: 23, number: 2}, {id: 24, number: 3}] }
                    }
                },
                'ASCENT': {
                    subprograms: {
                        'Nova': { levels: [{id: 25, number: 1}, {id: 26, number: 2}, {id: 27, number: 3}] },
                        'Drive': { levels: [{id: 28, number: 1}, {id: 29, number: 2}, {id: 30, number: 3}] },
                        'Pro': { levels: [{id: 31, number: 1}, {id: 32, number: 2}, {id: 33, number: 3}] }
                    }
                },
                'PINNACLE': {
                    subprograms: {
                        'Vision': { levels: [{id: 34, number: 1}, {id: 35, number: 2}] },
                        'Endeavor': { levels: [{id: 36, number: 1}, {id: 37, number: 2}] },
                        'Success': { levels: [{id: 38, number: 1}, {id: 39, number: 2}] },
                        'Pro': { levels: [{id: 40, number: 1}, {id: 41, number: 2}] }
                    }
                }
            };
            
            window.CopyCurriculumDataReady = true;
            window.CopyCurriculumDataInitialized = true;
            window.CopyCurriculumDataError = null;
            
            console.log('[FALLBACK] ‚úÖ Fallback curriculum data constructed successfully');
            console.log('[FALLBACK] Programs available:', Object.keys(window.CopyCurriculumData));
        }
    } catch (error) {
        console.error('[FALLBACK] ‚ùå Fallback initialization failed:', error);
        window.CopyCurriculumDataError = { message: error.message, source: 'fallback' };
    }
}

// Show curriculum data error to user
function showCurriculumDataError() {
    console.error('[ERROR_DISPLAY] Showing curriculum data error to user');
    
    const dropdown = document.getElementById('copyProgramSelect');
    if (dropdown) {
        dropdown.innerHTML = '<option value="">‚ö†Ô∏è Curriculum data unavailable</option>';
        dropdown.style.backgroundColor = '#ffebee';
        dropdown.style.color = '#c62828';
    }
    
    // Could also show a more user-friendly message
    const errorMessage = document.createElement('div');
    errorMessage.style.cssText = 'color: #c62828; font-size: 12px; margin-top: 5px; padding: 8px; background: #ffebee; border-radius: 4px;';
    errorMessage.textContent = 'Unable to load curriculum data. Please refresh the page or contact support.';
    
    if (dropdown && dropdown.parentNode) {
        dropdown.parentNode.appendChild(errorMessage);
    }
}

// Enhanced diagnostic function
function runCurriculumDiagnostic() {
    console.group('%c[DIAGNOSTIC] COMPREHENSIVE CURRICULUM DATA DIAGNOSTIC', 'color: #ff6b35; font-size: 14px; font-weight: bold;');
    
    console.log('[DIAGNOSTIC] ==> GLOBAL VARIABLES:');
    console.log('  window.CopyCurriculumData:', !!window.CopyCurriculumData);
    console.log('  window.CopyCurriculumDataReady:', window.CopyCurriculumDataReady);
    console.log('  window.CopyCurriculumDataInitialized:', window.CopyCurriculumDataInitialized);
    console.log('  window.CopyCurriculumDataError:', window.CopyCurriculumDataError);
    
    if (window.CopyCurriculumData) {
        console.log('  Data keys:', Object.keys(window.CopyCurriculumData));
        console.log('  Data structure valid:', typeof window.CopyCurriculumData === 'object');
    }
    
    console.log('[DIAGNOSTIC] ==> DOM ELEMENTS:');
    const dropdown = document.getElementById('copyProgramSelect');
    console.log('  copyProgramSelect exists:', !!dropdown);
    if (dropdown) {
        console.log('  Options count:', dropdown.options.length);
        console.log('  Visible options:', Array.from(dropdown.options).map(opt => opt.textContent));
        console.log('  Dropdown disabled:', dropdown.disabled);
        console.log('  Dropdown visible:', window.getComputedStyle(dropdown).display !== 'none');
    }
    
    console.log('[DIAGNOSTIC] ==> FUNCTIONS:');
    console.log('  populateCopyProgramDropdown exists:', typeof populateCopyProgramDropdown === 'function');
    console.log('  tryFallbackCurriculumInitialization exists:', typeof tryFallbackCurriculumInitialization === 'function');
    
    console.log('[DIAGNOSTIC] ==> JSON SCRIPT ELEMENT:');
    const scriptElement = document.getElementById('copy-curriculum-hierarchy-data');
    console.log('  Script element exists:', !!scriptElement);
    if (scriptElement) {
        const content = scriptElement.textContent || '';
        console.log('  Content length:', content.length);
        console.log('  Content preview:', content.substring(0, 100) + (content.length > 100 ? '...' : ''));
        
        try {
            const parsed = JSON.parse(content);
            console.log('  JSON valid:', true);
            console.log('  JSON keys:', Object.keys(parsed));
        } catch (e) {
            console.log('  JSON valid:', false);
            console.log('  JSON error:', e.message);
        }
    }
    
    console.groupEnd();
}

function setupCopyCurriculumEventListeners() {
    const programSelect = document.getElementById('copyProgramSelect');
    const subprogramSelect = document.getElementById('copySubprogramSelect');
    const levelSelect = document.getElementById('copyLevelSelect');
    
    if (!programSelect || !subprogramSelect || !levelSelect) {
        console.error('[COPY_CURRICULUM] Missing curriculum dropdown elements');
        return;
    }
    
    // Program change handler
    programSelect.addEventListener('change', function() {
        const program = this.value;
        console.log('[COPY_CURRICULUM] Program changed to:', program);
        
        // Clear and disable dependent dropdowns
        subprogramSelect.innerHTML = '<option value="">-- Select SubProgram --</option>';
        levelSelect.innerHTML = '<option value="">-- Select Level --</option>';
        subprogramSelect.disabled = !program;
        levelSelect.disabled = true;
        document.getElementById('copyCurriculumLevel').value = '';
        
        if (program && window.CopyCurriculumData[program]) {
            const subprograms = window.CopyCurriculumData[program].subprograms;
            
            // Define correct subprogram order for each program
            const subprogramOrder = {
                'CORE': ['Phonics', 'Sigma', 'Elite', 'Pro'],
                'ASCENT': ['Nova', 'Drive', 'Pro'],
                'EDGE': ['Spark', 'Rise', 'Pursuit', 'Pro'],
                'PINNACLE': ['Vision', 'Endeavor', 'Success', 'Pro']
            };
            
            // Get the correct order for this program
            const orderForProgram = subprogramOrder[program];
            
            if (orderForProgram) {
                // Add subprograms in the defined correct order
                console.log('[COPY_CURRICULUM] Using predefined order for', program, ':', orderForProgram);
                orderForProgram.forEach(subprogram => {
                    // Check if this subprogram exists in the data
                    if (!subprograms[subprogram]) {
                        console.log('[COPY_CURRICULUM] Subprogram not found in data:', subprogram);
                        return; // Skip if not found
                    }
                    
                    const option = document.createElement('option');
                    option.value = subprogram;
                    option.textContent = subprogram;
                    subprogramSelect.appendChild(option);
                });
            } else {
                // Fallback: Use the order from the data (should already be correct from backend)
                console.log('[COPY_CURRICULUM] No predefined order for', program, ', using data order');
                Object.keys(subprograms).forEach(subprogram => {
                    const option = document.createElement('option');
                    option.value = subprogram;
                    option.textContent = subprogram;
                    subprogramSelect.appendChild(option);
                });
            }
        }
        
        updateCopyExamNamePreview();
    });
    
    // SubProgram change handler
    subprogramSelect.addEventListener('change', function() {
        const program = programSelect.value;
        const subprogram = this.value;
        console.log('[COPY_CURRICULUM] SubProgram changed to:', subprogram);
        
        // Clear and disable level dropdown
        levelSelect.innerHTML = '<option value="">-- Select Level --</option>';
        levelSelect.disabled = !subprogram;
        document.getElementById('copyCurriculumLevel').value = '';
        
        if (program && subprogram && window.CopyCurriculumData[program]?.subprograms[subprogram]) {
            const levels = window.CopyCurriculumData[program].subprograms[subprogram].levels;
            levels.forEach(level => {
                const option = document.createElement('option');
                option.value = level.id;
                option.textContent = `Level ${level.number}`;
                levelSelect.appendChild(option);
            });
        }
        
        updateCopyExamNamePreview();
    });
    
    // Level change handler
    levelSelect.addEventListener('change', function() {
        const levelId = this.value;
        console.log('[COPY_CURRICULUM] Level changed to:', levelId);
        
        // Store the curriculum level ID
        document.getElementById('copyCurriculumLevel').value = levelId;
        
        updateCopyExamNamePreview();
    });
    
    // Custom suffix change handler
    const customSuffixInput = document.getElementById('customSuffix');
    if (customSuffixInput) {
        customSuffixInput.addEventListener('input', function() {
            console.log('[COPY_CURRICULUM] Custom suffix changed to:', this.value);
            updateCopyExamNamePreview();
        });
    }
    
    console.log('[COPY_CURRICULUM] Event listeners set up');
}

// Initialize all copy exam functionality when DOM is ready
function initializeAllCopyExamFunctionality() {
    initializeCopyExamEventListeners();
    initializeCopyFormSubmission();
    console.log('All copy exam functionality initialized');
}

// Debug function to test modal directly
window.testCopyModal = function() {
    console.log('Testing copy modal...');
    const modal = document.getElementById('copyExamModal');
    if (modal) {
        console.log('Modal found. Current display:', window.getComputedStyle(modal).display);
        console.log('Modal has show class:', modal.classList.contains('show'));
        
        // Toggle the modal using the proper functions
        if (modal.classList.contains('show')) {
            console.log('Closing modal...');
            closeCopyModal();
        } else {
            console.log('Opening modal with test data...');
            openCopyModal('test-id-123', 'Test Exam Name');
        }
        
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
            console.log('Modal content found');
        } else {
            console.error('Modal content not found');
        }
        
        console.log('Modal should be visible now');
        console.log('Final display:', window.getComputedStyle(modal).display);
    } else {
        console.error('Modal not found in DOM');
        
        // Check if the modal HTML exists at all
        const allModals = document.querySelectorAll('.modal');
        console.log('Found modals:', allModals.length);
        allModals.forEach((m, i) => {
            console.log(`Modal ${i}:`, m.id, m.className);
        });
    }
};

// CRITICAL: Ensure openCopyModal is always available
(function() {
    // Create temporary placeholder functions that will be replaced by comprehensive fix
    if (typeof window.openCopyModal === 'undefined') {
        console.log('[PLACEHOLDER] Creating placeholder openCopyModal function');
        window.openCopyModal = function(examId, examName) {
            console.log('[PLACEHOLDER] openCopyModal called, waiting for comprehensive fix to load');
            console.log('Exam ID:', examId, 'Exam Name:', examName);
            
            // Try to load the modal after a short delay (in case script hasn't loaded yet)
            setTimeout(function() {
                if (window.openCopyModal !== arguments.callee) {
                    // Function has been replaced, call it again
                    window.openCopyModal(examId, examName);
                } else {
                    alert('Copy Exam feature is loading. Please try again in a moment.');
                }
            }, 500);
        };
    }
    
    if (typeof window.closeCopyModal === 'undefined') {
        console.log('[PLACEHOLDER] Creating placeholder closeCopyModal function');
        window.closeCopyModal = function() {
            const modal = document.getElementById('copyExamModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
        };
    }
    
    console.log('[FUNCTION_CHECK] openCopyModal type:', typeof window.openCopyModal);
    console.log('[FUNCTION_CHECK] closeCopyModal type:', typeof window.closeCopyModal);
})();

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initializeAllCopyExamFunctionality();
        console.log('Copy exam functionality initialized on DOMContentLoaded');
        
        // Verify functions are available after initialization
        console.log('[POST_INIT] openCopyModal available:', typeof window.openCopyModal === 'function');
        console.log('[POST_INIT] closeCopyModal available:', typeof window.closeCopyModal === 'function');
    });
} else {
    initializeAllCopyExamFunctionality();
    console.log('Copy exam functionality initialized immediately');
    
    // Verify functions are available after initialization
    console.log('[POST_INIT] openCopyModal available:', typeof window.openCopyModal === 'function');
    console.log('[POST_INIT] closeCopyModal available:', typeof window.closeCopyModal === 'function');
}

// ============================================================================
</script>

<!-- Place the curriculum data JSON script tag here to avoid rendering issues -->
{% if curriculum_hierarchy_for_copy %}
{{ curriculum_hierarchy_for_copy|json_script:"copy-curriculum-hierarchy-data" }}
{% endif %}

<!-- Load the fixed copy modal script -->
<script src="{% static 'js/routinetest/copy-exam-modal-fixed.js' %}?v={% now 'U' %}"></script>

<!-- Override conflicting functions -->
<script>
// Override the inline functions that conflict with our fixed version
window.initializeCopyCurriculumCascading = function() {
    console.log('[OVERRIDE] initializeCopyCurriculumCascading disabled - handled by copy-exam-modal-fixed.js');
};
window.initializeCopyExamEventListeners = function() {
    console.log('[OVERRIDE] initializeCopyExamEventListeners disabled - handled by copy-exam-modal-fixed.js');
};
// DO NOT OVERRIDE updateCopyExamNamePreview - it needs to work for the preview!
// The copy-exam-modal-fixed.js doesn't implement preview functionality
</script>

{% endblock %}