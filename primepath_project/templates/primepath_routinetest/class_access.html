{% extends "primepath_routinetest/routinetest_unified_base.html" %}
{% block base_font_size %}17px{% endblock %}
{% comment %}
Updated 2025-08-27: Using routinetest_unified_base.html for navigation
Original base template: routinetest_base.html
{% endcomment %}

{% load static %}

{% block title %}My Classes & Access - RoutineTest{% endblock %}

{% block extra_css %}
<!-- Desktop Layout Fix CSS with Cache Busting -->
<link rel="stylesheet" href="{% static 'css/desktop-layout-fix.css' %}?v=2.0&t={{ request.GET.timestamp|default:'fix' }}">

<!-- Cache Busting and Debug Info -->
<script>
    console.log('%c[CSS_LOADING] üìÅ', 'background: #9C27B0; color: white; padding: 3px;');
    console.log('Desktop layout fix CSS loading with cache bust...');
    console.log('CSS Version: 2.0');
    console.log('Viewport width:', window.innerWidth);
    console.log('User agent:', navigator.userAgent);
    
    // Force immediate style recalculation
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîÑ Forcing style recalculation...');
            document.body.style.display = 'none';
            document.body.offsetHeight; // Force reflow
            document.body.style.display = '';
        });
    }
</script>

<style>
    /* ULTRA-HIGH SPECIFICITY DESKTOP LAYOUT PROTECTION */
    /* VERSION: 2.0 - Maximum specificity to override any conflicts */
    @media only screen and (min-width: 768px) {
        /* Global max-width reset with ultra-high specificity */
        html body.routinetest-theme *, 
        html body *, 
        html body .access-container,
        html body .access-container *,
        html body .left-panel,
        html body .right-panel {
            max-width: none !important;
        }
        
        /* BULLETPROOF FLEXBOX LAYOUT - Ultra-high specificity */
        html body .container-fluid .access-container,
        html body .access-container {
            /* Force flexbox with all vendor prefixes */
            display: -webkit-box !important;
            display: -webkit-flex !important;
            display: -ms-flexbox !important;
            display: flex !important;
            
            /* Force row direction */
            -webkit-box-orient: horizontal !important;
            -webkit-box-direction: normal !important;
            -webkit-flex-direction: row !important;
            -ms-flex-direction: row !important;
            flex-direction: row !important;
            
            /* Layout properties */
            width: 100% !important;
            max-width: none !important;
            min-width: 0 !important;
            gap: 35px !important;
            
            /* Alignment */
            -webkit-box-align: start !important;
            -webkit-align-items: flex-start !important;
            -ms-flex-align: start !important;
            align-items: flex-start !important;
            
            /* Reset problematic styles */
            position: relative !important;
            float: none !important;
            clear: both !important;
            overflow: visible !important;
        }
        
        /* LEFT PANEL - Ultra-high specificity */
        html body .container-fluid .access-container .left-panel,
        html body .access-container .left-panel {
            /* Flex properties */
            -webkit-box-flex: 0 !important;
            -webkit-flex: 0 0 60% !important;
            -ms-flex: 0 0 60% !important;
            flex: 0 0 60% !important;
            
            /* Width constraints */
            width: 60% !important;
            max-width: 60% !important;
            min-width: 0 !important;
            
            /* Layout */
            position: relative !important;
            display: block !important;
            float: none !important;
            clear: none !important;
            overflow: visible !important;
            box-sizing: border-box !important;
            margin: 0 !important;
        }
        
        /* RIGHT PANEL - Ultra-high specificity */
        html body .container-fluid .access-container .right-panel,
        html body .access-container .right-panel {
            /* Flex properties */
            -webkit-box-flex: 0 !important;
            -webkit-flex: 0 0 38% !important;
            -ms-flex: 0 0 38% !important;
            flex: 0 0 38% !important;
            
            /* Width constraints */
            width: 38% !important;
            max-width: 38% !important;
            min-width: 0 !important;
            
            /* Layout */
            position: relative !important;
            display: block !important;
            float: none !important;
            clear: none !important;
            overflow: visible !important;
            box-sizing: border-box !important;
            margin: 0 !important;
        }
        
        /* EMERGENCY OVERRIDE - Absolute maximum specificity */
        html body[data-fix-applied="true"] .access-container {
            display: flex !important;
            flex-direction: row !important;
            width: 100% !important;
            max-width: none !important;
        }
        
        html body[data-fix-applied="true"] .access-container .left-panel {
            flex: 0 0 60% !important;
            width: 60% !important;
            max-width: 60% !important;
        }
        
        html body[data-fix-applied="true"] .access-container .right-panel {
            flex: 0 0 38% !important;
            width: 38% !important;
            max-width: 38% !important;
        }
    }
    /* Enhanced UI/UX Improvements - Distinct Visual Separation */
    
    /* Information Banner - Improved Design */
    .access-info-banner {
        background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%);
        border: 1px solid #81C784;
        border-radius: 10px;
        padding: 18px 24px;
        display: flex;
        align-items: center;
        gap: 18px;
        position: relative;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .access-info-banner:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.12);
    }
    
    .access-info-banner::before {
        content: '\f05a';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        color: #2E7D32;
        font-size: 1.4em;
        flex-shrink: 0;
    }
    
    .access-info-text {
        color: #1B5E20;
        font-size: 0.95rem;
        line-height: 1.6;
        letter-spacing: 0.01em;
    }
    
    /* Split View Layout with Enhanced Separation - FIXED */
    .access-container {
        display: flex !important;
        flex-direction: row !important;
        gap: 35px !important; /* Increased gap for better separation */
        margin-top: 20px;
        min-height: 600px;
        position: relative;
        width: 100% !important;
        max-width: none !important;
        align-items: flex-start !important;
        justify-content: space-between !important;
        /* Flexbox fallbacks for older browsers */
        display: -webkit-box !important;
        display: -ms-flexbox !important;
        -webkit-box-orient: horizontal !important;
        -webkit-box-direction: normal !important;
        -ms-flex-direction: row !important;
    }
    
    /* Visual Divider Line */
    .access-container::after {
        content: '';
        position: absolute;
        left: calc(60% + 17px);
        top: 0;
        bottom: 0;
        width: 1px;
        background: linear-gradient(180deg, 
            transparent 0%, 
            #dee2e6 10%, 
            #dee2e6 90%, 
            transparent 100%);
    }
    
    .left-panel {
        flex: 0 0 60% !important;
        -webkit-box-flex: 0 !important;
        -ms-flex: 0 0 60% !important;
        max-width: 60% !important;
        width: 60% !important;
        min-width: 0 !important;
        background: #ffffff; /* Pure white for current classes */
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        padding: 30px;
        border: 1px solid #e9ecef;
        position: relative !important;
        transition: box-shadow 0.3s ease;
        display: block !important;
        float: none !important;
        overflow: visible !important;
    }
    
    .left-panel:hover {
        box-shadow: 0 6px 25px rgba(0,0,0,0.08);
    }
    
    /* Left Panel Header Enhancement */
    .left-panel > h3 {
        color: #1B5E20;
        border-bottom: 2px solid #81C784;
        padding-bottom: 12px;
        margin-bottom: 25px;
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: -0.01em;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .left-panel > h3 i {
        font-size: 1.1rem;
        color: #2E7D32;
    }
    
    .right-panel {
        flex: 0 0 38% !important;
        -webkit-box-flex: 0 !important;
        -ms-flex: 0 0 38% !important;
        max-width: 38% !important;
        width: 38% !important;
        min-width: 0 !important;
        background: #F8FAFB; /* Subtle gray background for requests */
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        padding: 30px;
        border: 1px solid #dee2e6;
        position: relative !important;
        transition: box-shadow 0.3s ease;
        display: block !important;
        float: none !important;
        overflow: visible !important;
    }
    
    .right-panel:hover {
        box-shadow: 0 6px 25px rgba(0,0,0,0.07);
    }
    
    /* Right Panel Header Enhancement */
    .right-panel > h3 {
        color: #495057;
        font-size: 1.25rem;
        margin-bottom: 20px;
        font-weight: 600;
        letter-spacing: -0.01em;
        padding-bottom: 12px;
        border-bottom: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .right-panel > h3 i {
        font-size: 1.1rem;
        color: #6c757d;
    }
    
    /* Tab Navigation Improvements */
    .right-panel .tab-nav {
        background: white;
        padding: 8px;
        border-radius: 8px;
        margin: 0 0 20px 0;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    /* Empty State Styling */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .empty-state-icon {
        font-size: 3em;
        color: #dee2e6;
        margin-bottom: 15px;
    }
    
    .empty-state-title {
        font-size: 1.2em;
        font-weight: 600;
        color: #495057;
        margin-bottom: 10px;
    }
    
    .empty-state-text {
        color: #6c757d;
        font-size: 0.95em;
        line-height: 1.5;
    }
    
    .empty-state-arrow {
        color: #28a745;
        font-weight: bold;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    /* Class Cards - Enhanced Design */
    .class-card {
        background: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 18px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .class-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #81C784 0%, #66BB6A 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .class-card:hover {
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        transform: translateY(-3px);
        border-color: #81C784;
    }
    
    .class-card:hover::before {
        opacity: 1;
    }
    
    .class-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .class-name {
        font-size: 1.2em;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .class-stats {
        display: flex;
        gap: 20px;
        margin: 10px 0;
        color: #666;
    }
    
    .class-stat {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .access-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .access-full {
        background: #d4edda;
        color: #155724;
    }
    
    .access-view {
        background: #fff3cd;
        color: #856404;
    }
    
    .access-co-teacher {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    /* Request Section */
    .request-card {
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
    }
    
    .request-pending {
        border-left: 4px solid #ffc107;
        background: #fffdf5;
    }
    
    .request-approved {
        border-left: 4px solid #28a745;
        background: #f5fff5;
    }
    
    .request-denied {
        border-left: 4px solid #dc3545;
        background: #fff5f5;
    }
    
    /* Available Classes */
    .available-class {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .available-class:hover {
        background: #f8f9fa;
    }
    
    /* Tab Navigation - Modern Design */
    .tab-nav {
        display: flex;
        gap: 5px;
        margin-bottom: 20px;
        padding-bottom: 0;
    }
    
    .tab-btn {
        padding: 12px 20px;
        background: transparent;
        border: none;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.95rem;
        color: #6c757d;
        border-bottom: 3px solid transparent;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 8px 8px 0 0;
        position: relative;
    }
    
    .tab-btn:hover {
        background: rgba(0, 123, 255, 0.05);
        color: #495057;
    }
    
    .tab-btn.active {
        color: #007bff;
        background: rgba(0, 123, 255, 0.08);
        border-bottom-color: #007bff;
        font-weight: 600;
    }
    
    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -3px;
        left: 20px;
        right: 20px;
        height: 3px;
        background: #007bff;
        border-radius: 3px 3px 0 0;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* Admin Styles */
    .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .pending-badge {
        background: #ff6b6b;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        margin-left: 10px;
    }
    
    /* Quick Stats - Enhanced Design */
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 18px;
        margin-bottom: 25px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        padding: 18px;
        border-radius: 10px;
        text-align: center;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2E7D32;
        line-height: 1;
        margin-bottom: 8px;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        letter-spacing: 0.02em;
        text-transform: uppercase;
    }
    
    /* Enhanced Button Styles */
    .btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 500;
        letter-spacing: 0.01em;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn-sm {
        padding: 6px 14px;
        font-size: 0.875rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #2E7D32 0%, #388E3C 100%);
        border: none;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #388E3C 0%, #43A047 100%);
    }
</style>
{% endblock %}

{% block page_content %}
<div class="container-fluid" style="padding-top: 0;">
    <!-- Page Header with Better Spacing -->
    <div class="page-header-section" style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); padding: 25px 0 20px 0; margin: -20px -15px 0 -15px; border-bottom: 1px solid #dee2e6;">
        <div class="container-fluid">
            <h1 class="page-title" style="margin: 0; color: #1B5E20; font-size: 1.8rem; font-weight: 600;">
                <i class="fas fa-users-cog" style="color: #2E7D32;"></i> My Classes & Access
                {% if request.user.is_superuser %}
                <div style="float: right;">
                    {% if is_admin %}
                    <a href="?admin_view=false" class="btn btn-sm btn-outline-secondary" style="font-size: 0.85rem;">
                        <i class="fas fa-exchange-alt"></i> Switch to Teacher View
                    </a>
                    {% else %}
                    <a href="?admin_view=true" class="btn btn-sm btn-outline-info" style="font-size: 0.85rem;">
                        <i class="fas fa-exchange-alt"></i> Switch to Admin View
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </h1>
        </div>
    </div>
    
    <!-- Debug Info -->
    <script>
        console.log('[CLASS_ACCESS_PAGE] View Mode:', {
            is_admin: {{ is_admin|lower }},
            show_teacher_view: {{ show_teacher_view|default:"true"|lower }},
            user: '{{ request.user.username }}',
            is_superuser: {{ request.user.is_superuser|lower }}
        });
    </script>
    
    {% if is_admin %}
    <!-- Admin View -->
    
    <!-- Admin Dashboard Header with Better Design -->
    <div style="margin-top: 25px; margin-bottom: 20px;">
        <div class="admin-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);">
            <h3 style="margin: 0 0 8px 0; font-size: 1.5rem; font-weight: 600;">
                <i class="fas fa-shield-alt"></i> Admin Dashboard
            </h3>
            <p style="margin: 0; opacity: 0.95; font-size: 1rem;">Manage all teacher class assignments and access requests</p>
        </div>
    </div>
    
    <!-- Information Banner for Admin with Proper Spacing -->
    <div style="margin-bottom: 25px;">
        <div class="access-info-banner" style="margin: 0;">
            <div class="access-info-text">
                <strong style="font-size: 1.05em; color: #1B5E20;">Admin View:</strong> 
                <span style="display: inline-block; margin-left: 8px;">
                    Review teacher assignments on the left. Approve or deny pending access requests on the right. 
                    All changes are tracked in the audit log.
                </span>
            </div>
        </div>
    </div>
    
    <div class="access-container">
        <!-- Left Panel: All Teacher Assignments -->
        <div class="left-panel">
            <h3>
                <i class="fas fa-users"></i> 
                Teacher Assignments by Class
            </h3>
            
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-value">{{ assignments_by_class|length }}</div>
                    <div class="stat-label">Active Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ pending_count }}</div>
                    <div class="stat-label">Pending Requests</div>
                </div>
            </div>
            
            {% for class_code, class_info in assignments_by_class.items %}
            <div class="class-card">
                <div class="class-card-header">
                    <span class="class-name">{{ class_info.class_name }}</span>
                    <span class="text-muted">{{ class_info.student_count }} students</span>
                </div>
                
                <div class="teachers-list">
                    {% for teacher_info in class_info.teachers %}
                    <div style="padding: 5px 0; border-bottom: 1px solid #eee;">
                        <strong>{{ teacher_info.teacher.name }}</strong>
                        <span class="access-badge access-{{ teacher_info.access_level|lower|cut:' ' }}">
                            {{ teacher_info.access_level }}
                        </span>
                        <small class="text-muted">Since {{ teacher_info.assigned_date|date:"M d, Y" }}</small>
                        <button class="btn btn-sm btn-link float-right" 
                                onclick="revokeAccess('{{ teacher_info.assignment_id }}')">
                            <i class="fas fa-times"></i> Revoke
                        </button>
                    </div>
                    {% endfor %}
                </div>
                
                <button class="btn btn-sm btn-primary mt-2" 
                        onclick="showAssignTeacherModal('{{ class_code }}')">
                    <i class="fas fa-plus"></i> Assign Teacher
                </button>
            </div>
            {% empty %}
            <!-- Empty State for Admin Teacher Assignments -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-user-slash"></i>
                </div>
                <div class="empty-state-title">
                    No Active Assignments
                </div>
                <div class="empty-state-text">
                    No teachers are currently assigned to any classes.
                    <br>
                    Use the "Assign Teacher" button to create new assignments.
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Right Panel: Pending Requests -->
        <div class="right-panel">
            <h3>
                <i class="fas fa-clock"></i> 
                Pending Requests 
                {% if pending_count > 0 %}
                <span class="pending-badge" style="margin-left: 10px;">{{ pending_count }}</span>
                {% endif %}
            </h3>
            
            {% for request in pending_requests %}
            <div class="request-card request-pending">
                <div style="margin-bottom: 10px;">
                    <strong>{{ request.teacher.name }}</strong>
                    <i class="fas fa-arrow-right mx-2"></i>
                    <strong>{{ request.class_code }}</strong>
                </div>
                
                <div class="text-muted" style="font-size: 0.9em;">
                    <div><strong>Type:</strong> {{ request.get_request_type_display }}</div>
                    <div><strong>Reason:</strong> {{ request.reason_text|truncatewords:10 }}</div>
                    <div><strong>Requested:</strong> {{ request.requested_at|timesince }} ago</div>
                </div>
                
                <div class="mt-2">
                    <button class="btn btn-sm btn-success" 
                            onclick="approveRequest('{{ request.id }}')">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="btn btn-sm btn-danger" 
                            onclick="denyRequest('{{ request.id }}')">
                        <i class="fas fa-times"></i> Deny
                    </button>
                    <button class="btn btn-sm btn-info" 
                            onclick="viewRequestDetails('{{ request.id }}')">
                        <i class="fas fa-eye"></i> Details
                    </button>
                </div>
            </div>
            {% empty %}
            <!-- Empty State for Admin Pending Requests -->
            <div class="empty-state" style="padding: 30px 10px;">
                <div class="empty-state-icon">
                    <i class="fas fa-check-double"></i>
                </div>
                <div class="empty-state-title">
                    All Caught Up!
                </div>
                <div class="empty-state-text">
                    No pending requests at this time.
                    <br>
                    All teacher access requests have been processed.
                </div>
            </div>
            {% endfor %}
            
            {% if pending_requests|length > 1 %}
            <button class="btn btn-warning btn-block mt-3" onclick="bulkApproveAll()">
                <i class="fas fa-check-double"></i> Bulk Approve All
            </button>
            {% endif %}
        </div>
    </div>
    
    {% else %}
    <!-- Teacher View -->
    
    <!-- Information Banner with Proper Spacing -->
    <div style="margin-top: 25px; margin-bottom: 25px;">
        <div class="access-info-banner" style="margin: 0;">
            <div class="access-info-text">
                <strong style="font-size: 1.05em; color: #1B5E20;">How it works:</strong> 
                <span style="display: inline-block; margin-left: 8px;">
                    View your assigned classes on the left. Request access to additional classes on the right. 
                    Admin approval required for new class assignments.
                </span>
            </div>
        </div>
    </div>
    
    <div class="access-container">
        <!-- Left Panel: My Classes -->
        <div class="left-panel">
            <h3>
                <i class="fas fa-chalkboard-teacher"></i> 
                My Current Classes 
                <span style="font-size: 0.7em; color: #6c757d; font-weight: normal;">
                    {% if my_class_count > 0 %}({{ my_class_count }} assigned){% else %}(None assigned){% endif %}
                </span>
            </h3>
            <!-- MARKER: After H3, before IF -->
            {% if my_classes %}
            <!-- MARKER: Inside IF, before quick-stats -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-value">{{ my_class_count }}</div>
                    <div class="stat-label">Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-students-count">
                        0
                    </div>
                    <div class="stat-label">Total Students</div>
                </div>
            </div>
            
            <!-- Begin class cards -->
            {% for class in my_classes %}
            <div class="class-card">
                <div class="class-card-header">
                    <span class="class-name">{{ class.class_name }}</span>
                    <span class="access-badge access-{{ class.access_level|lower|cut:' ' }}">
                        {{ class.access_level }}
                    </span>
                </div>
                
                <div class="class-stats">
                    <div class="class-stat">
                        <i class="fas fa-users"></i>
                        <span>{{ class.student_count }} Students</span>
                    </div>
                    <div class="class-stat">
                        <i class="fas fa-file-alt"></i>
                        <span>{{ class.active_exams }} Active Tests</span>
                    </div>
                </div>
                
                <div class="text-muted" style="font-size: 0.9em;">
                    Since {{ class.assigned_date|date:"M d, Y" }}
                </div>
                
                {% if class.is_full_access %}
                <a href="{% url 'RoutineTest:create_exam' %}?class={{ class.class_code }}" 
                   class="btn btn-primary btn-sm mt-2">
                    <i class="fas fa-plus"></i> Create Exam
                </a>
                <a href="{% url 'RoutineTest:exam_list' %}?class={{ class.class_code }}" 
                   class="btn btn-outline-primary btn-sm mt-2">
                    <i class="fas fa-list"></i> View Exams
                </a>
                {% else %}
                <button class="btn btn-outline-secondary btn-sm mt-2" disabled>
                    <i class="fas fa-eye"></i> View Only Access
                </button>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <!-- Enhanced Empty State -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
                <div class="empty-state-title">
                    No Classes Assigned Yet
                </div>
                <div class="empty-state-text">
                    You haven't been assigned to any classes.
                    <br>
                    <span class="empty-state-arrow">‚Üí</span> 
                    Use the right panel to request access to available classes.
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Right Panel: Request Access -->
        <div class="right-panel">
            <h3>
                <i class="fas fa-plus-circle"></i> 
                Request New Access
            </h3>
            
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('available')">
                    Available Classes ({{ available_count }})
                </button>
                <button class="tab-btn" onclick="switchTab('requests')">
                    My Requests
                </button>
            </div>
            
            <!-- Available Classes Tab -->
            <div id="available-tab" class="tab-content active">
                <h4>Request Access to Classes</h4>
                
                {% for class in available_classes %}
                <div class="available-class">
                    <div>
                        <strong>{{ class.class_name }}</strong>
                        {% if class.teacher_count > 0 %}
                        <div class="text-muted" style="font-size: 0.9em;">
                            {{ class.teacher_count }} teacher(s) assigned
                        </div>
                        {% else %}
                        <div class="text-success" style="font-size: 0.9em;">
                            <i class="fas fa-star"></i> No teacher assigned
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if class.is_pending %}
                    <button class="btn btn-sm btn-warning" disabled>
                        <i class="fas fa-clock"></i> Pending
                    </button>
                    {% else %}
                    <button class="btn btn-sm btn-primary" 
                            onclick="requestAccess('{{ class.class_code }}')">
                        <i class="fas fa-plus"></i> Request
                    </button>
                    {% endif %}
                </div>
                {% empty %}
                <!-- Empty State for Available Classes -->
                <div class="empty-state" style="padding: 30px 10px;">
                    <div class="empty-state-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="empty-state-text">
                        All classes are currently assigned.
                        <br>
                        Check back later for new opportunities.
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- My Requests Tab -->
            <div id="requests-tab" class="tab-content">
                <h4>My Access Requests</h4>
                
                {% for request in my_requests %}
                <div class="request-card request-{{ request.status|lower }}">
                    <div style="margin-bottom: 5px;">
                        <strong>{{ request.class_code }}</strong>
                        <span class="badge badge-{{ request.status|lower }}">
                            {{ request.get_status_display }}
                        </span>
                    </div>
                    
                    <div class="text-muted" style="font-size: 0.85em;">
                        Requested {{ request.requested_at|timesince }} ago
                    </div>
                    
                    {% if request.status == 'PENDING' %}
                    <button class="btn btn-sm btn-outline-danger mt-2" 
                            onclick="withdrawRequest('{{ request.id }}')">
                        <i class="fas fa-times"></i> Withdraw
                    </button>
                    {% elif request.status == 'DENIED' %}
                    <div class="text-danger mt-2" style="font-size: 0.85em;">
                        <strong>Reason:</strong> {{ request.admin_notes|default:"No reason provided" }}
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <!-- Empty State for Requests -->
                <div class="empty-state" style="padding: 30px 10px;">
                    <div class="empty-state-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <div class="empty-state-text">
                        No access requests submitted yet.
                        <br>
                        Switch to "Available Classes" tab to make a request.
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Request Access Modal -->
<div class="modal fade" id="requestAccessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Class Access</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="requestAccessForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="request-class-code" name="class_code">
                    
                    <div class="form-group">
                        <label>Requesting Access to:</label>
                        <p class="font-weight-bold" id="request-class-name"></p>
                    </div>
                    
                    <div class="form-group">
                        <label>Request Type</label>
                        <select class="form-control" name="request_type" id="request-type">
                            <option value="PERMANENT">Permanent Assignment</option>
                            <option value="TEMPORARY">Temporary Coverage</option>
                            <option value="SUBSTITUTE">Substitute Teacher</option>
                            <option value="CO_TEACHING">Co-Teaching</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Reason</label>
                        <select class="form-control" name="reason_code">
                            <option value="NEW_ASSIGNMENT">New class assignment</option>
                            <option value="SUBSTITUTE">Substituting for another teacher</option>
                            <option value="CURRICULUM_EXPERTISE">Have expertise in curriculum</option>
                            <option value="SCHEDULE_OPTIMIZATION">Better schedule alignment</option>
                            <option value="OTHER">Other reason</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Additional Details</label>
                        <textarea class="form-control" name="reason_text" rows="3" required></textarea>
                    </div>
                    
                    <div id="temporary-dates" style="display: none;">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" class="form-control" name="duration_start">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" class="form-control" name="duration_end">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ========== BULLETPROOF LAYOUT ENFORCEMENT SYSTEM ==========
(function() {
    'use strict';
    
    console.group('%c[LAYOUT_ENFORCEMENT_V2] üõ°Ô∏è', 'background: #2E7D32; color: white; padding: 5px; font-weight: bold;');
    console.log('Initializing comprehensive layout protection system...');
    
    // Apply emergency data attribute for CSS targeting
    document.body.setAttribute('data-fix-applied', 'true');
    console.log('‚úÖ Emergency CSS targeting attribute applied');
    
    // FUNCTION: Force layout compliance
    function enforceLayoutCompliance() {
        console.group('%c[LAYOUT_ENFORCEMENT]', 'color: #1976D2; font-weight: bold;');
        
        const container = document.querySelector('.access-container');
        const leftPanel = document.querySelector('.left-panel');
        const rightPanel = document.querySelector('.right-panel');
        
        if (!container || !leftPanel || !rightPanel) {
            console.error('‚ùå Required layout elements not found');
            console.groupEnd();
            return false;
        }
        
        // Force container properties via JavaScript
        const containerStyles = {
            display: 'flex',
            flexDirection: 'row',
            width: '100%',
            maxWidth: 'none',
            minWidth: '0',
            gap: '35px',
            alignItems: 'flex-start',
            justifyContent: 'space-between',
            position: 'relative',
            float: 'none',
            clear: 'both',
            overflow: 'visible',
            boxSizing: 'border-box'
        };
        
        Object.assign(container.style, containerStyles);
        
        // Force left panel properties
        const leftPanelStyles = {
            flex: '0 0 60%',
            width: '60%',
            maxWidth: '60%',
            minWidth: '0',
            position: 'relative',
            display: 'block',
            float: 'none',
            clear: 'none',
            overflow: 'visible',
            boxSizing: 'border-box',
            margin: '0'
        };
        
        Object.assign(leftPanel.style, leftPanelStyles);
        
        // Force right panel properties
        const rightPanelStyles = {
            flex: '0 0 38%',
            width: '38%',
            maxWidth: '38%',
            minWidth: '0',
            position: 'relative',
            display: 'block',
            float: 'none',
            clear: 'none',
            overflow: 'visible',
            boxSizing: 'border-box',
            margin: '0'
        };
        
        Object.assign(rightPanel.style, rightPanelStyles);
        
        // Verify layout after applying styles
        setTimeout(() => {
            const verification = verifyLayoutIntegrity();
            if (verification.success) {
                console.log('‚úÖ JavaScript layout enforcement successful');
            } else {
                console.error('‚ùå JavaScript layout enforcement failed:', verification.issues);
            }
        }, 50);
        
        console.groupEnd();
        return true;
    }
    
    // FUNCTION: Verify layout integrity
    function verifyLayoutIntegrity() {
        const container = document.querySelector('.access-container');
        const leftPanel = document.querySelector('.left-panel');
        const rightPanel = document.querySelector('.right-panel');
        
        if (!container || !leftPanel || !rightPanel) {
            return { success: false, issues: ['Missing elements'] };
        }
        
        const leftRect = leftPanel.getBoundingClientRect();
        const rightRect = rightPanel.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        const issues = [];
        
        // Check for overlap
        if (leftRect.right > rightRect.left) {
            issues.push(`Panel overlap detected: ${leftRect.right - rightRect.left}px`);
        }
        
        // Check panel widths
        const leftWidthPercent = (leftRect.width / containerRect.width) * 100;
        const rightWidthPercent = (rightRect.width / containerRect.width) * 100;
        
        if (Math.abs(leftWidthPercent - 60) > 5) {
            issues.push(`Left panel width off: ${leftWidthPercent.toFixed(1)}% (expected ~60%)`);
        }
        
        if (Math.abs(rightWidthPercent - 38) > 5) {
            issues.push(`Right panel width off: ${rightWidthPercent.toFixed(1)}% (expected ~38%)`);
        }
        
        // Check container display
        const containerDisplay = window.getComputedStyle(container).display;
        if (containerDisplay !== 'flex') {
            issues.push(`Container display is ${containerDisplay}, expected flex`);
        }
        
        return {
            success: issues.length === 0,
            issues: issues,
            metrics: {
                leftWidth: leftWidthPercent,
                rightWidth: rightWidthPercent,
                gap: rightRect.left - leftRect.right,
                containerDisplay: containerDisplay
            }
        };
    }
    
    // FUNCTION: Continuous monitoring
    function startLayoutMonitoring() {
        let monitoringInterval;
        
        function checkLayout() {
            if (window.innerWidth >= 768) {
                const verification = verifyLayoutIntegrity();
                if (!verification.success) {
                    console.warn('‚ö†Ô∏è Layout integrity compromised, re-enforcing...');
                    enforceLayoutCompliance();
                }
            }
        }
        
        // Check every 2 seconds
        monitoringInterval = setInterval(checkLayout, 2000);
        
        // Check on resize
        window.addEventListener('resize', function() {
            clearTimeout(this.resizeTimeout);
            this.resizeTimeout = setTimeout(() => {
                if (window.innerWidth >= 768) {
                    console.log('üîÑ Window resized, re-checking layout...');
                    enforceLayoutCompliance();
                }
            }, 250);
        });
        
        console.log('üîÑ Continuous layout monitoring started');
        
        return monitoringInterval;
    }
    
    console.groupEnd();
    
    // Enhanced debugging for layout issues
    console.group('%c[CLASS_ACCESS_LAYOUT_DEBUG] üîß', 'background: #FF5722; color: white; padding: 5px; font-weight: bold;');
    
    // Check viewport and device info
    const viewportInfo = {
        width: window.innerWidth,
        height: window.innerHeight,
        devicePixelRatio: window.devicePixelRatio,
        orientation: window.innerWidth > window.innerHeight ? 'landscape' : 'portrait',
        userAgent: navigator.userAgent,
        isMobile: /Mobi|Android/i.test(navigator.userAgent),
        isTablet: /iPad|Tablet/i.test(navigator.userAgent),
        isDesktop: window.innerWidth >= 1025
    };
    console.log('üì± Viewport Info:', viewportInfo);
    
    // Check CSS files loaded
    const styleSheets = Array.from(document.styleSheets).map(sheet => {
        try {
            return {
                href: sheet.href || 'inline',
                rules: sheet.cssRules ? sheet.cssRules.length : 'N/A',
                disabled: sheet.disabled
            };
        } catch(e) {
            return { href: sheet.href || 'inline', error: 'CORS blocked' };
        }
    });
    console.log('üìÑ Loaded Stylesheets:', styleSheets);
    
    // Wait for DOM to be fully loaded
    // IMMEDIATE EXECUTION: Apply layout fixes as soon as possible
    if (window.innerWidth >= 768) {
        // Try immediate enforcement
        setTimeout(() => {
            console.log('üöÄ Attempting immediate layout enforcement...');
            enforceLayoutCompliance();
        }, 10);
    }
    
    window.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM Content Loaded - Starting comprehensive layout enforcement');
        
        // Apply layout enforcement on DOM ready
        if (window.innerWidth >= 768) {
            enforceLayoutCompliance();
            startLayoutMonitoring();
        }
        
        // Check layout container
        const container = document.querySelector('.access-container');
        const leftPanel = document.querySelector('.left-panel');
        const rightPanel = document.querySelector('.right-panel');
        
        if (container) {
            const containerStyles = window.getComputedStyle(container);
            const layoutDiagnostics = {
                container: {
                    display: containerStyles.display,
                    flexDirection: containerStyles.flexDirection,
                    gap: containerStyles.gap,
                    width: containerStyles.width,
                    maxWidth: containerStyles.maxWidth,
                    position: containerStyles.position,
                    alignItems: containerStyles.alignItems,
                    justifyContent: containerStyles.justifyContent,
                    actualWidth: container.offsetWidth + 'px',
                    actualHeight: container.offsetHeight + 'px'
                }
            };
            
            if (leftPanel) {
                const leftStyles = window.getComputedStyle(leftPanel);
                layoutDiagnostics.leftPanel = {
                    flex: leftStyles.flex,
                    width: leftStyles.width,
                    maxWidth: leftStyles.maxWidth,
                    minWidth: leftStyles.minWidth,
                    display: leftStyles.display,
                    position: leftStyles.position,
                    float: leftStyles.float,
                    actualWidth: leftPanel.offsetWidth + 'px',
                    actualHeight: leftPanel.offsetHeight + 'px',
                    backgroundColor: leftStyles.backgroundColor
                };
            }
            
            if (rightPanel) {
                const rightStyles = window.getComputedStyle(rightPanel);
                layoutDiagnostics.rightPanel = {
                    flex: rightStyles.flex,
                    width: rightStyles.width,
                    maxWidth: rightStyles.maxWidth,
                    minWidth: rightStyles.minWidth,
                    display: rightStyles.display,
                    position: rightStyles.position,
                    float: rightStyles.float,
                    actualWidth: rightPanel.offsetWidth + 'px',
                    actualHeight: rightPanel.offsetHeight + 'px',
                    backgroundColor: rightStyles.backgroundColor
                };
            }
            
            // Check for overlapping
            if (leftPanel && rightPanel) {
                const leftRect = leftPanel.getBoundingClientRect();
                const rightRect = rightPanel.getBoundingClientRect();
                
                layoutDiagnostics.overlap = {
                    leftPanelRight: leftRect.right,
                    rightPanelLeft: rightRect.left,
                    gap: rightRect.left - leftRect.right,
                    isOverlapping: leftRect.right > rightRect.left,
                    leftPanelTop: leftRect.top,
                    rightPanelTop: rightRect.top,
                    verticalAlignment: Math.abs(leftRect.top - rightRect.top) < 5 ? 'aligned' : 'misaligned'
                };
                
                // Visual warning if overlapping
                if (leftRect.right > rightRect.left) {
                    console.error('‚ùå PANELS ARE OVERLAPPING! Gap:', rightRect.left - leftRect.right + 'px');
                    // Add visual indicator
                    container.style.border = '3px solid red';
                    container.setAttribute('data-debug', 'true');
                } else {
                    console.log('‚úÖ Panels properly separated. Gap:', rightRect.left - leftRect.right + 'px');
                }
            }
            
            console.table(layoutDiagnostics);
            
            // Check for conflicting CSS rules
            const checkConflicts = () => {
                const allElements = document.querySelectorAll('*');
                const conflicts = [];
                
                allElements.forEach(el => {
                    const styles = window.getComputedStyle(el);
                    if (styles.maxWidth === '100vw' && !el.matches('@media (max-width: 767px) *')) {
                        conflicts.push({
                            element: el.tagName + (el.className ? '.' + el.className : ''),
                            maxWidth: styles.maxWidth,
                            width: styles.width
                        });
                    }
                });
                
                if (conflicts.length > 0) {
                    console.warn('‚ö†Ô∏è Elements with 100vw max-width (potential conflicts):', conflicts);
                }
            };
            
            // Run conflict check after a delay to ensure all CSS is applied
            setTimeout(checkConflicts, 100);
            
        } else {
            console.error('‚ùå .access-container not found!');
        }
        
        // Add resize observer for dynamic debugging
        if (window.ResizeObserver && container) {
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    console.log('üìê Container resized:', {
                        width: entry.contentRect.width,
                        height: entry.contentRect.height
                    });
                }
            });
            resizeObserver.observe(container);
        }
    });
    
    console.groupEnd();
})();

// ========== ENHANCED DEBUGGING & UI/UX IMPROVEMENTS ==========
// Comprehensive console logging for UI state tracking
console.group('%c[CLASS_ACCESS_UI_ENHANCED]', 'color: #00A65E; font-weight: bold;');
console.log('Page Initialization:', {
    timestamp: new Date().toISOString(),
    url: window.location.href,
    user: '{{ request.user.username }}',
    is_admin: {{ is_admin|lower }},
    template: 'class_access.html',
    ui_version: '3.0_fixed'
});

// Track UI panel states
console.log('UI Panel Configuration:', {
    left_panel: {
        type: 'current_classes',
        background: 'white',
        width: '60%',
        classes_count: {{ my_class_count|default:0 }}
    },
    right_panel: {
        type: 'request_access',
        background: '#F8FAFB',
        width: '38%',
        available_count: {{ available_count|default:0 }}
    },
    visual_separator: 'vertical_line_with_gradient',
    info_banner: 'displayed_at_top'
});

// Check for empty states
const hasClasses = {{ my_class_count|default:0 }} > 0;
const hasAvailable = {{ available_count|default:0 }} > 0;
console.log('Empty State Detection:', {
    has_assigned_classes: hasClasses,
    has_available_classes: hasAvailable,
    show_left_empty_state: !hasClasses,
    show_right_empty_state: !hasAvailable
});

console.groupEnd();

// Tab switching
function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName + '-tab').classList.add('active');
}

// Request Access
function requestAccess(classCode) {
    // Get class name from the page
    const className = event.target.closest('.available-class').querySelector('strong').textContent;
    
    document.getElementById('request-class-code').value = classCode;
    document.getElementById('request-class-name').textContent = className;
    
    $('#requestAccessModal').modal('show');
}

// Handle request type change
document.getElementById('request-type').addEventListener('change', function() {
    const temporaryDates = document.getElementById('temporary-dates');
    if (this.value === 'TEMPORARY') {
        temporaryDates.style.display = 'block';
    } else {
        temporaryDates.style.display = 'none';
    }
});

// Submit request form
document.getElementById('requestAccessForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch("{% url 'RoutineTest:request_access' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            $('#requestAccessModal').modal('hide');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('[REQUEST_ERROR]', error);
        alert('Failed to submit request');
    });
});

// Withdraw request
function withdrawRequest(requestId) {
    if (!confirm('Are you sure you want to withdraw this request?')) return;
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/RoutineTest/access/request/${requestId}/withdraw/`, {
        method: 'POST',
        body: formData
    })
    .then(() => location.reload())
    .catch(error => {
        console.error('[WITHDRAW_ERROR]', error);
        alert('Failed to withdraw request');
    });
}

// Admin functions
{% if is_admin %}
function approveRequest(requestId) {
    const notes = prompt('Add any notes (optional):');
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('admin_notes', notes || '');
    
    fetch(`/RoutineTest/access/admin/request/${requestId}/approve/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('[APPROVE_ERROR]', error);
        alert('Failed to approve request');
    });
}

function denyRequest(requestId) {
    const reason = prompt('Reason for denial:');
    if (!reason) return;
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('reason', reason);
    
    fetch(`/RoutineTest/access/admin/request/${requestId}/deny/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('[DENY_ERROR]', error);
        alert('Failed to deny request');
    });
}

function revokeAccess(assignmentId) {
    if (!confirm('Are you sure you want to revoke this access?')) return;
    
    const reason = prompt('Reason for revocation (optional):');
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('assignment_id', assignmentId);
    formData.append('reason', reason || '');
    
    fetch("{% url 'RoutineTest:admin_revoke_access' %}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('[REVOKE_ERROR]', error);
        alert('Failed to revoke access');
    });
}

function bulkApproveAll() {
    if (!confirm('Approve all pending requests?')) return;
    
    const requestIds = [];
    {% for request in pending_requests %}
    requestIds.push('{{ request.id }}');
    {% endfor %}
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    requestIds.forEach(id => formData.append('request_ids[]', id));
    
    fetch("{% url 'RoutineTest:bulk_approve' %}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('[BULK_APPROVE_ERROR]', error);
        alert('Failed to bulk approve');
    });
}
{% endif %}

// Final UI State Summary
console.group('%c[CLASS_ACCESS_UI_STATE]', 'color: #2E7D32; font-weight: bold;');
console.log('Page Load Complete:', {
    is_admin: {{ is_admin|lower }},
    {% if not is_admin %}
    my_classes: {{ my_class_count }},
    available_classes: {{ available_count }},
    ui_panels: {
        left: 'My Current Classes (white background)',
        right: 'Request Access (gray background #F8FAFB)',
        separator: 'Vertical gradient line'
    },
    {% else %}
    pending_requests: {{ pending_count }},
    admin_mode: 'Full dashboard view',
    {% endif %}
    timestamp: new Date().toISOString(),
    performance: {
        dom_ready: performance.now() + 'ms'
    }
});

// Verify UI elements rendered
setTimeout(() => {
    const leftPanel = document.querySelector('.left-panel');
    const rightPanel = document.querySelector('.right-panel');
    const infoBanner = document.querySelector('.access-info-banner');
    
    console.log('UI Elements Verification:', {
        left_panel_exists: !!leftPanel,
        right_panel_exists: !!rightPanel,
        info_banner_exists: !!infoBanner,
        left_panel_bg: leftPanel ? window.getComputedStyle(leftPanel).backgroundColor : 'N/A',
        right_panel_bg: rightPanel ? window.getComputedStyle(rightPanel).backgroundColor : 'N/A'
    });
}, 100);

console.groupEnd();

// Calculate total students count
document.addEventListener('DOMContentLoaded', function() {
    // Calculate total students from my_classes data
    {% if my_classes %}
    let totalStudents = 0;
    {% for class in my_classes %}
    totalStudents += {{ class.student_count|default:0 }};
    {% endfor %}
    
    const totalStudentsElement = document.getElementById('total-students-count');
    if (totalStudentsElement) {
        totalStudentsElement.textContent = totalStudents;
    }
    {% endif %}
});
</script>
{% endblock %}