{% extends "routinetest_base.html" %}
{% load static %}

{% block title %}Dashboard - RoutineTest{% endblock %}

{% block header %}Dashboard - Exam Management{% endblock %}

{% block content %}
<!-- Mode Toggle Fix - Inline JavaScript -->
<script>
(function() {
    console.log('[MODE_TOGGLE_FIX_INLINE] Starting inline fix for stats box toggle issue');
    
    // Function to fix any "function:" text
    function fixFunctionText() {
        // Get all text nodes in the document
        const walker = document.createTreeWalker(
            document.body,
            NodeFilter.SHOW_TEXT,
            null,
            false
        );
        
        let node;
        let fixedCount = 0;
        
        while (node = walker.nextNode()) {
            if (node.nodeValue && node.nodeValue.includes('function:')) {
                console.warn('[MODE_TOGGLE_FIX_INLINE] Found "function:" in text:', node.nodeValue);
                node.nodeValue = node.nodeValue.replace(/function\s*:\s*/gi, '');
                fixedCount++;
            }
        }
        
        if (fixedCount > 0) {
            console.log('[MODE_TOGGLE_FIX_INLINE] Fixed', fixedCount, 'instances of "function:" text');
        }
        
        // Also check for any toggle elements in stats areas
        const statsAreas = document.querySelectorAll('.class-stats, .class-stat, .stats-box, .stat-box, [class*="stat-"]');
        statsAreas.forEach(area => {
            const toggles = area.querySelectorAll('.mode-toggle-container, .mode-toggle-wrapper, .mode-toggle-btn, [class*="toggle"]');
            toggles.forEach(toggle => {
                console.warn('[MODE_TOGGLE_FIX_INLINE] Removing toggle from stats area:', toggle);
                toggle.remove();
            });
        });
    }
    
    // Run immediately
    fixFunctionText();
    
    // Run after DOM is fully loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fixFunctionText);
    }
    
    // Run after a short delay to catch any dynamic content
    setTimeout(fixFunctionText, 100);
    setTimeout(fixFunctionText, 500);
    setTimeout(fixFunctionText, 1000);
    
    // Monitor for changes
    const observer = new MutationObserver(() => {
        fixFunctionText();
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        characterData: true
    });
    
    console.log('[MODE_TOGGLE_FIX_INLINE] Inline fix initialized with monitoring');
})();
</script>

<!-- Navigation Verification Script -->
<script>
    // CRITICAL: Navigation Tab Verification
    console.group('%cðŸ” [NAVIGATION VERIFICATION] Dashboard Page', 'background: #4CAF50; color: white; padding: 5px 10px; border-radius: 3px;');
    
    // Check template information
    console.log('ðŸ“„ Template Info:', {
        currentTemplate: 'primepath_routinetest/index.html',
        extendsTemplate: 'routinetest_base.html',
        renderTime: new Date().toISOString(),
        djangoVersion: '{{ django.VERSION|default:"unknown" }}'
    });
    
    // Check user context
    console.log('ðŸ‘¤ User Context:', {
        isAuthenticated: {{ user.is_authenticated|lower }},
        username: '{{ user.username|default:"Anonymous" }}',
        isStaff: {{ user.is_staff|lower }},
        isTeacher: {{ is_teacher|default:"false"|lower }},
        isHeadTeacher: {{ is_head_teacher|default:"false"|lower }}
    });
    
    // Check dashboard stats
    console.log('ðŸ“Š Dashboard Stats:', {
        activeExams: {{ active_exams }},
        totalSessions: {{ total_sessions }},
        recentSessions: {{ recent_sessions|length }}
    });
    
    // Verify navigation tabs presence
    window.addEventListener('DOMContentLoaded', function() {
        console.group('ðŸŽ¯ Navigation Tabs Check');
        
        // Get all navigation tabs
        const navTabs = document.querySelectorAll('.nav-tabs a');
        console.log(`Found ${navTabs.length} navigation tabs`);
        
        // List all tabs
        const tabInfo = [];
        navTabs.forEach((tab, index) => {
            tabInfo.push({
                index: index + 1,
                text: tab.textContent.trim(),
                href: tab.getAttribute('href'),
                dataNav: tab.getAttribute('data-nav'),
                dataTabId: tab.getAttribute('data-tab-id'),
                isActive: tab.classList.contains('active'),
                isVisible: tab.offsetParent !== null,
                style: tab.getAttribute('style') || 'default'
            });
        });
        console.table(tabInfo);
        
        // CRITICAL: Check for Matrix Tab specifically
        const matrixTab = document.querySelector('[data-tab-id="exam-assignments-matrix"]');
        if (matrixTab) {
            console.log('%câœ… MATRIX TAB FOUND!', 'background: #FF9800; color: white; padding: 5px 10px; font-weight: bold;');
            console.log('Matrix Tab Details:', {
                text: matrixTab.textContent.trim(),
                href: matrixTab.getAttribute('href'),
                isVisible: matrixTab.offsetParent !== null,
                parentVisible: matrixTab.parentElement.offsetParent !== null,
                computedDisplay: window.getComputedStyle(matrixTab).display,
                computedVisibility: window.getComputedStyle(matrixTab).visibility
            });
        } else {
            console.error('%câŒ MATRIX TAB NOT FOUND!', 'background: #F44336; color: white; padding: 5px 10px; font-weight: bold;');
            console.log('Searching for any element with "matrix" in text or attributes...');
            const allElements = document.querySelectorAll('*');
            const matrixElements = Array.from(allElements).filter(el => {
                const text = el.textContent?.toLowerCase() || '';
                const href = el.getAttribute('href')?.toLowerCase() || '';
                const dataNav = el.getAttribute('data-nav')?.toLowerCase() || '';
                return text.includes('matrix') || href.includes('matrix') || dataNav.includes('matrix');
            });
            console.log(`Found ${matrixElements.length} elements with "matrix":`, matrixElements);
        }
        
        // Check navigation container
        const navContainer = document.querySelector('.nav-tabs');
        if (navContainer) {
            console.log('Navigation Container:', {
                id: navContainer.id,
                dataVersion: navContainer.getAttribute('data-version'),
                dataTimestamp: navContainer.getAttribute('data-timestamp'),
                childCount: navContainer.children.length,
                innerHTML: navContainer.innerHTML.substring(0, 200) + '...'
            });
        }
        
        console.groupEnd();
    });
    
    console.groupEnd();
</script>

<!-- Welcome Section -->
<div style="background: linear-gradient(135deg, #F1F8E9 0%, #E0E7DA 100%); border-left: 4px solid #2E7D32; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
    <h2 style="color: #1B5E20; margin-bottom: 10px;">Welcome to RoutineTest Dashboard</h2>
    <p style="color: #263238; font-size: 1.1rem;">Comprehensive exam management system for organizing and tracking assessments</p>
</div>

<!-- Quick Actions -->
<div style="margin-bottom: 30px;">
    <h3 style="color: #263238; margin-bottom: 15px;">Quick Actions</h3>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;" id="quick-actions-container">
        <a href="{% url 'RoutineTest:create_exam' %}" class="btn" onclick="console.log('[RoutineTest] Quick action: Upload Exam')">
            <i class="fas fa-upload"></i> Upload New Exam
        </a>
        <a href="{% url 'RoutineTest:exam_list' %}" class="btn btn-secondary" onclick="console.log('[RoutineTest] Quick action: Exam Library')">
            <i class="fas fa-book"></i> Exam Library
        </a>
        <a href="{% url 'RoutineTest:start_test' %}" class="btn" style="background-color: #66BB6A;" onclick="console.log('[RoutineTest] Quick action: Start Test')">
            <i class="fas fa-play"></i> Start Test Session
        </a>
        {% if user.is_authenticated %}
        <a href="{% url 'RoutineTest:my_classes' %}" 
           class="btn" 
           style="background-color: #FF9800; border: 2px solid #F57C00;" 
           id="my-classes-btn"
           onclick="console.log('[RoutineTest] Quick action: My Classes & Access clicked')">
            <i class="fas fa-users-cog"></i> My Classes & Access
        </a>
        {% endif %}
    </div>
</div>

<!-- Enhanced Button and Navigation Verification -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.group('%cðŸ”Ž [QUICK ACTIONS & NAV VERIFICATION]', 'background: #2196F3; color: white; padding: 5px;');
    
    // Check Quick Actions buttons
    const quickActionButtons = document.querySelectorAll('#quick-actions-container a.btn');
    console.log(`ðŸŽ¯ Quick Action Buttons: ${quickActionButtons.length}`);
    quickActionButtons.forEach(btn => {
        console.log(`  - ${btn.textContent.trim()}: ${btn.href}`);
    });
    
    // Check My Classes button specifically
    const myClassesBtn = document.getElementById('my-classes-btn');
    const navMyClasses = document.querySelector('a[data-nav="my-classes"]');
    
    if (myClassesBtn) {
        console.log('âœ… My Classes Quick Action button found');
    } else {
        console.warn('âš ï¸ My Classes Quick Action button not found');
    }
    
    if (navMyClasses) {
        console.log('âœ… My Classes nav tab found');
    } else {
        console.warn('âš ï¸ My Classes nav tab not found');
    }
    
    // CRITICAL: Force Matrix Tab visibility check
    const matrixTabItem = document.getElementById('matrix-tab-item');
    if (matrixTabItem) {
        console.log('%cðŸŽ† MATRIX TAB ITEM FOUND!', 'background: #FF5722; color: white; padding: 5px; font-weight: bold;');
        
        // Force visibility just in case
        matrixTabItem.style.display = 'flex !important';
        matrixTabItem.style.visibility = 'visible !important';
        matrixTabItem.style.opacity = '1 !important';
        
        const matrixLink = matrixTabItem.querySelector('a');
        if (matrixLink) {
            matrixLink.style.display = 'block !important';
            matrixLink.style.visibility = 'visible !important';
            console.log('Matrix tab forced visible with styles:', {
                display: matrixLink.style.display,
                visibility: matrixLink.style.visibility,
                href: matrixLink.href
            });
        }
    } else {
        console.error('%cðŸš« CRITICAL: Matrix tab item (#matrix-tab-item) not found in DOM!', 'background: red; color: white; padding: 5px; font-weight: bold;');
    }
    
    console.groupEnd();
});

// Additional diagnostic on window load
window.addEventListener('load', function() {
    console.group('%cðŸŽ¯ [FINAL NAV CHECK ON WINDOW LOAD]', 'background: #9C27B0; color: white; padding: 5px;');
    
    const allNavLinks = document.querySelectorAll('.nav-tabs a');
    const navSummary = {
        totalTabs: allNavLinks.length,
        tabNames: Array.from(allNavLinks).map(a => a.textContent.trim()),
        matrixTabExists: !!document.querySelector('[data-tab-id="exam-assignments-matrix"]'),
        matrixTabVisible: document.querySelector('[data-tab-id="exam-assignments-matrix"]')?.offsetParent !== null
    };
    
    console.table(navSummary);
    
    if (!navSummary.matrixTabExists) {
        console.error('ðŸ”´ CRITICAL ISSUE: Matrix tab is completely missing from DOM!');
        console.log('This suggests the template is not rendering correctly or being overridden.');
    } else if (!navSummary.matrixTabVisible) {
        console.error('ðŸŸ  WARNING: Matrix tab exists but is not visible!');
        console.log('This suggests CSS or JavaScript is hiding the tab.');
    } else {
        console.log('ðŸŸ¢ SUCCESS: Matrix tab exists and is visible!');
    }
    
    console.groupEnd();
});
</script>

<!-- Statistics Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <!-- Active Exams Card -->
    <div style="background: white; border: 1px solid #C3E6CB; border-radius: 8px; padding: 20px; text-align: center; transition: all 0.3s ease; cursor: pointer;"
         onmouseover="this.style.boxShadow='0 4px 8px rgba(0,166,94,0.2)'; this.style.transform='translateY(-2px)';"
         onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)';"
         onclick="console.log('[RoutineTest] Stat card clicked: Active Exams')">
        <h3 style="color: #388E3C; font-size: 3rem; margin: 0;">{{ active_exams }}</h3>
        <p style="color: #6c757d; font-size: 1.1rem; margin-top: 10px;">Active Exams</p>
        <div style="width: 50px; height: 3px; background: #388E3C; margin: 10px auto 0;"></div>
    </div>
    
    <!-- Total Sessions Card -->
    <div style="background: white; border: 1px solid #C3E6CB; border-radius: 8px; padding: 20px; text-align: center; transition: all 0.3s ease; cursor: pointer;"
         onmouseover="this.style.boxShadow='0 4px 8px rgba(0,166,94,0.2)'; this.style.transform='translateY(-2px)';"
         onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)';"
         onclick="console.log('[RoutineTest] Stat card clicked: Total Sessions')">
        <h3 style="color: #2E7D32; font-size: 3rem; margin: 0;">{{ total_sessions }}</h3>
        <p style="color: #6c757d; font-size: 1.1rem; margin-top: 10px;">Total Sessions</p>
        <div style="width: 50px; height: 3px; background: #2E7D32; margin: 10px auto 0;"></div>
    </div>
    
    <!-- Recent Tests Card -->
    <div style="background: white; border: 1px solid #C3E6CB; border-radius: 8px; padding: 20px; text-align: center; transition: all 0.3s ease; cursor: pointer;"
         onmouseover="this.style.boxShadow='0 4px 8px rgba(0,166,94,0.2)'; this.style.transform='translateY(-2px)';"
         onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)';"
         onclick="console.log('[RoutineTest] Stat card clicked: Recent Tests')">
        <h3 style="color: #66BB6A; font-size: 3rem; margin: 0;">{{ recent_sessions|length }}</h3>
        <p style="color: #6c757d; font-size: 1.1rem; margin-top: 10px;">Recent Tests</p>
        <div style="width: 50px; height: 3px; background: #66BB6A; margin: 10px auto 0;"></div>
    </div>
    
    <!-- Pending Grading Card (if teacher) -->
    {% if is_teacher %}
    <div style="background: white; border: 1px solid #C3E6CB; border-radius: 8px; padding: 20px; text-align: center; transition: all 0.3s ease; cursor: pointer;"
         onmouseover="this.style.boxShadow='0 4px 8px rgba(0,166,94,0.2)'; this.style.transform='translateY(-2px)';"
         onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)';"
         onclick="console.log('[RoutineTest] Stat card clicked: Pending Grading')">
        <h3 style="color: #FF9800; font-size: 3rem; margin: 0;">{{ pending_sessions|default:0 }}</h3>
        <p style="color: #6c757d; font-size: 1.1rem; margin-top: 10px;">Pending Grading</p>
        <div style="width: 50px; height: 3px; background: #FF9800; margin: 10px auto 0;"></div>
    </div>
    {% endif %}
</div>

<!-- Recent Activity Section -->
{% if recent_sessions %}
<div style="background: white; border: 1px solid #C3E6CB; border-radius: 8px; overflow: hidden;">
    <div style="background: linear-gradient(135deg, #388E3C 0%, #2E7D32 100%); color: white; padding: 15px 20px;">
        <h3 style="margin: 0;">Recent Test Sessions</h3>
    </div>
    <div style="padding: 0;">
        {% for session in recent_sessions %}
        <div style="padding: 15px 20px; border-bottom: 1px solid #E8F5E9; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s ease;"
             onmouseover="this.style.background='#F5FAF7'"
             onmouseout="this.style.background='white'"
             onclick="console.log('[RoutineTest] Session clicked:', '{{ session.id }}')">
            <div>
                <strong style="color: #2E7D32;">{{ session.student_name }}</strong>
                <span style="color: #6c757d; margin-left: 10px;">{{ session.exam.name }}</span>
            </div>
            <div style="text-align: right;">
                {% if session.score %}
                <span style="color: #388E3C; font-weight: bold;">{{ session.score }}%</span>
                {% else %}
                <span style="color: #FF9800;">In Progress</span>
                {% endif %}
                <div style="color: #999; font-size: 0.9rem;">{{ session.completed_at|date:"M d, H:i" }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div style="padding: 15px 20px; background: #F5FAF7; text-align: center;">
        <a href="{% url 'RoutineTest:session_list' %}" style="color: #388E3C; text-decoration: none; font-weight: 500;"
           onclick="console.log('[RoutineTest] View all sessions clicked')">
            View All Sessions â†’
        </a>
    </div>
</div>
{% endif %}

<!-- Info Section -->
<div style="margin-top: 30px; padding: 20px; background: #F5FAF7; border-radius: 8px; border: 1px solid #C3E6CB;">
    <h4 style="color: #2E7D32; margin-bottom: 15px;">ðŸ“š About RoutineTest Module</h4>
    <p style="color: #1B5E20; line-height: 1.6;">
        The RoutineTest module enables continuous assessment through Review Tests (monthly) and Quarterly Exams. 
        Track student progress, manage test schedules, and analyze performance trends throughout the academic year.
    </p>
    <ul style="color: #1B5E20; line-height: 1.8; margin-top: 10px;">
        <li><strong>Review Tests:</strong> Monthly assessments for continuous evaluation</li>
        <li><strong>Quarterly Exams:</strong> Comprehensive quarter-end assessments</li>
        <li><strong>Test Pools:</strong> Random exam assignment from pools to prevent cheating</li>
        <li><strong>Progress Tracking:</strong> Monitor individual and class performance trends</li>
    </ul>
</div>

<script>
    // Console logging for dashboard interactions
    document.addEventListener('DOMContentLoaded', function() {
        console.group('%c[RoutineTest Dashboard] Interaction Tracking Active', 'color: #00A65E;');
        console.log('Quick Actions: 3 buttons available');
        console.log('Statistics Cards: 4 cards displayed');
        console.log('Recent Sessions: {{ recent_sessions|length }} displayed');
        console.groupEnd();
        
        // Track time on dashboard
        const startTime = Date.now();
        window.addEventListener('beforeunload', function() {
            const timeSpent = (Date.now() - startTime) / 1000;
            console.log(`[RoutineTest Dashboard] Time spent: ${timeSpent.toFixed(1)}s`);
        });
    });
</script>
{% endblock %}