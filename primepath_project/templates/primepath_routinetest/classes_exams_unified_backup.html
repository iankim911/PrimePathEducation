{% extends "unified_base.html" %}
{% block module_name %}primepath_routinetest{% endblock %}
{% comment %}
Migrated to unified_base.html on 2025-08-26
Original base template: routinetest_base.html
{% endcomment %}

{% load static %}
{% load access_display %}

{% block title %}Classes & Exams - RoutineTest{% endblock %}

{% block extra_css %}
<!-- Unified Classes & Exams Styles with Cache Busting v2.1 -->
<style>
    /* Main Container */
    .unified-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Access Summary Section - NEW CLEAN MINIMAL DESIGN */
    .access-summary-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        color: #333;
    }
    
    .access-summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .access-title {
        margin: 0;
        font-size: 20px;
        font-weight: 500;
        color: #495057;
    }
    
    .access-date {
        font-size: 14px;
        color: #6c757d;
    }
    
    /* Admin Access Box - CLEAN MINIMAL DESIGN */
    .access-admin-box {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }
    
    .access-admin-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding: 10px 15px;
        background: #e8f5e9;
        border: 1px solid #2e7d32;
        border-radius: 8px;
        width: fit-content;
        color: #1b5e20;
    }
    
    .badge-icon {
        font-size: 24px;
    }
    
    .badge-text {
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 1px;
    }
    
    .access-admin-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .access-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: 600;
        color: #495057;
    }
    
    .stat-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 5px;
    }
    
    .access-admin-note {
        font-size: 14px;
        color: #6c757d;
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    /* NEW SIMPLIFIED TEACHER ACCESS SECTION - MINIMAL DESIGN */
    .teacher-access-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .global-access-badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
        margin-bottom: 20px;
    }
    
    .global-access-badge.full {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #4caf50;
    }
    
    .global-access-badge.view-only {
        background: #fff3e0;
        color: #f57c00;
        border: 1px solid #ff9800;
    }
    
    .assigned-classes-list {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }
    
    .assigned-classes-title {
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        margin-bottom: 10px;
    }
    
    .class-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .class-item {
        padding: 6px 12px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 13px;
        color: #495057;
    }
    
    /* NEW MINIMAL TEACHER STATS */
    .teacher-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .teacher-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        text-align: center;
    }
    
    .teacher-stat .stat-icon {
        font-size: 20px;
        margin-bottom: 8px;
        color: #6c757d;
    }
    
    .teacher-stat .stat-value {
        font-size: 20px;
        font-weight: 600;
        color: #495057;
        margin-bottom: 4px;
    }
    
    .teacher-stat .stat-label {
        font-size: 11px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .teacher-stat.pending .stat-value {
        color: #f57c00;
    }
    
    /* Classes Section */
    .classes-section {
        background: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 3px solid #2E7D32;
    }
    
    .section-title {
        font-size: 24px;
        font-weight: bold;
        color: #2E7D32;
    }
    
    /* Program-based Organization */
    .program-section {
        margin-bottom: 35px;
        background: white !important;
        border-radius: 12px;
        padding: 0;
        border: 1px solid #dee2e6;
        overflow: hidden;
    }
    
    /* Program headers with dark green background and white text */
    .program-header {
        background: linear-gradient(135deg, #1B5E20, #2E7D32) !important;
        color: white !important;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 24px;
        cursor: pointer;
        user-select: none;
        margin: 0;
        border: none;
    }
    
    /* STANDARDIZED PROGRAM HEADERS - All programs use PINNACLE styling (v2.1) */
    .program-header.core,
    .program-header.ascent, 
    .program-header.edge,
    .program-header.pinnacle,
    .programs-container .program-header.core,
    .programs-container .program-header.ascent,
    .programs-container .program-header.edge,
    .programs-container .program-header.pinnacle,
    body .program-header.core,
    body .program-header.ascent,
    body .program-header.edge,
    body .program-header.pinnacle {
        background: linear-gradient(135deg, #1B5E20 0%, #2E7D32 100%) !important;
        background-color: #1B5E20 !important;
        border: none !important;
        color: white !important;
        border-radius: 12px 12px 0 0 !important;
    }
    
    /* STANDARDIZED PROGRAM TITLES - Consistent white text */
    .program-title,
    .program-header .program-title,
    .programs-container .program-title {
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        color: white !important;
    }
    
    /* Force ALL text inside program headers to be white */
    .program-title *,
    .program-header *,
    .program-summary,
    .program-summary *,
    .program-toggle {
        color: white !important;
    }
    
    .program-title.core,
    .program-title.ascent,
    .program-title.edge,
    .program-title.pinnacle {
        color: white !important;
        background: transparent !important;
    }
    
    /* Ensure program text specifically is white */
    .program-header .program-title {
        color: white !important;
    }
    
    /* Program content area */
    .program-classes {
        padding: 20px;
        background-color: #f8f9fa !important;
    }
    
    .program-summary {
        display: flex;
        gap: 15px;
        align-items: center;
        font-size: 14px;
        color: white !important;
        opacity: 1 !important;
        font-weight: 600 !important;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8) !important;
    }
    
    .program-summary span {
        color: white !important;
        font-weight: 600 !important;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8) !important;
    }
    
    .program-toggle {
        font-size: 18px;
        transition: transform 0.3s;
        color: white;
    }
    
    .program-section.collapsed .program-toggle {
        transform: rotate(-90deg);
    }
    
    .program-section.collapsed .program-classes {
        display: none;
    }
    
    .program-classes {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.95); }
    }
    
    .class-card {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s ease;
        background: white;
        cursor: pointer;
        position: relative;
    }
    
    .class-card:hover {
        border-color: #2E7D32;
        box-shadow: 0 5px 15px rgba(46, 125, 50, 0.2);
        transform: translateY(-2px);
    }
    
    /* Removed colored borders from class cards for clean UI */
    
    .class-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .class-name {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
    
    .class-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        height: 32px;
    }
    
    .badge-full {
        background: #2E7D32;
        color: white;
    }
    
    .badge-limited {
        background: #1B5E20;
        color: white;
    }
    
    /* Delete Button Styling - Matches Full Access Badge */
    .btn-delete-class {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 32px;
        min-width: auto;
    }
    
    .btn-delete-class:hover {
        background: #bd2130 !important;
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(220, 53, 69, 0.3);
    }
    
    .btn-delete-class:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(220, 53, 69, 0.2);
    }
    
    /* Improve header alignment */
    .class-header > div:last-child {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-shrink: 0;
    }
    
    /* Class Summary Info */
    .class-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin: 15px 0;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .class-summary-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #495057;
    }
    
    .class-summary-item .icon {
        font-size: 18px;
    }
    
    .class-summary-item strong {
        color: #212529;
        margin: 0 3px;
    }
    
    .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .status-indicator.complete { background: #2E7D32; }
    .status-indicator.incomplete { background: #ff9800; }
    .status-indicator.not-started { background: #f44336; }
    
    /* Matrix Preview CSS removed - visual component eliminated */
    
    /* Exam count display */
    .exam-count {
        display: block;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 4px;
    }
    
    .exam-count.count-0 {
        color: #D32F2F;  /* Red for 0 */
    }
    
    .exam-count.count-1 {
        color: #388E3C;  /* Green for 1 */
    }
    
    .exam-count.count-multiple {
        color: #1B5E20;  /* Dark green for 2+ */
    }
    
    /* Legacy support */
    .has-exam {
        background: #E8F5E9;
    }
    
    /* Curriculum Mapping Column */
    .curriculum-mapping {
        padding: 6px;
        background: #F8F9FA;
        font-size: 11px;
        max-width: 140px;
        width: 140px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .curriculum-badge {
        display: inline-block;
        padding: 3px 6px;
        background: #E8F5E9;
        color: #1B5E20;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        white-space: nowrap;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .curriculum-badge.not-assigned {
        background: #FFF3E0;
        color: #E65100;
        font-style: italic;
    }
    
    /* Exam indicators container */
    .exam-indicators {
        display: flex;
        justify-content: center;
        gap: 4px;
        margin-top: 4px;
    }
    
    .exam-indicator {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
        color: white;
        margin: 2px;
    }
    
    .exam-indicator.exam-review {
        background: #2E7D32;
    }
    
    .exam-indicator.exam-quarterly {
        background: #388E3C;
    }
    
    .exam-review {
        background: #2E7D32;
        color: white;
    }
    
    .exam-quarterly {
        background: #388E3C;
        color: white;
    }
    
    /* Scroll indicator */
    .scroll-indicator {
        text-align: center;
        margin: 20px 0;
        animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-10px);
        }
        60% {
            transform: translateY(-5px);
        }
    }
    
    /* Loading states */
    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .class-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* ===== EXAM TYPE TAB TOGGLE STYLES ===== */
    .exam-type-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .exam-type-tab {
        flex: 1;
        padding: 12px 16px;
        text-align: center;
        cursor: pointer;
        background: #f8f9fa;
        border: none;
        color: #6c757d;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        outline: none;
    }
    
    .exam-type-tab:hover {
        background: #e9ecef;
        color: #495057;
    }
    
    .exam-type-tab.active {
        background: #2E7D32;
        color: white;
        font-weight: 600;
        box-shadow: inset 0 -3px 0 rgba(255, 255, 255, 0.3);
    }
    
    .exam-type-tab.active:hover {
        background: #1B5E20;
    }
    
    .tab-icon {
        font-size: 1rem;
    }
    
    .tab-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 600;
        min-width: 20px;
        text-align: center;
        background: rgba(0, 0, 0, 0.1);
    }
    
    .exam-type-tab.active .tab-badge {
        background: rgba(255, 255, 255, 0.2);
    }
    
    /* Matrix content CSS removed - visual component eliminated */
    
    /* Admin Section Styles - DARK GREEN THEME */
    .admin-section {
        background: #f8f9fa;
        border: 2px solid #1B5E20;
        border-radius: 15px;
        padding: 30px;
        margin-top: 40px;
        box-shadow: 0 5px 15px rgba(27, 94, 32, 0.1);
    }
    
    .admin-section .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #1B5E20;
    }
    
    .admin-section .section-title {
        font-size: 24px;
        font-weight: bold;
        color: #1B5E20;
    }
    
    .admin-section .section-subtitle {
        color: #2E7D32;
        font-size: 14px;
    }
    
    .admin-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .admin-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: visible;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        table-layout: fixed;
    }
    
    .admin-table thead {
        background: #1B5E20;
        color: white;
    }
    
    .admin-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: white;
    }
    
    .admin-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #F0F0F0;
        vertical-align: middle;
    }
    
    .admin-table tbody tr:hover {
        background: #E8F5E9;
    }
    
    /* ULTRA HIGH SPECIFICITY: Comprehensive dropdown styling */
    .admin-table .curriculum-select,
    .admin-table select.curriculum-select,
    .admin-classes-table .curriculum-select,
    .admin-classes-table select.curriculum-select,
    select[class*="curriculum"],
    .admin-section select {
        padding: 10px 15px !important; /* ULTRA: Maximum padding for readability */
        border: 2px solid #DDD !important; /* ULTRA: Thicker border */
        border-radius: 6px !important; /* ULTRA: Larger border radius */
        font-size: 14px !important; /* ULTRA: Larger font for readability */
        font-weight: 500 !important; /* ULTRA: Bolder font weight */
        min-width: 180px !important; /* ULTRA: Much wider minimum width */
        width: auto !important; /* ULTRA: Allow natural expansion */
        max-width: 250px !important; /* ULTRA: Set maximum width */
        background: #FFFFFF !important; /* ULTRA: Pure white background */
        color: #333333 !important; /* ULTRA: Dark text for contrast */
        height: auto !important; /* ULTRA: Allow natural height */
        box-sizing: border-box !important; /* ULTRA: Include padding in width */
        vertical-align: middle !important; /* ULTRA: Align with other elements */
        line-height: 1.5 !important; /* ULTRA: Better line spacing */
        appearance: none !important; /* ULTRA: Remove default styling */
        -webkit-appearance: none !important; /* ULTRA: Remove webkit styling */
        -moz-appearance: none !important; /* ULTRA: Remove moz styling */
        cursor: pointer !important; /* ULTRA: Show pointer cursor */
        transition: all 0.3s ease !important; /* ULTRA: Smooth transitions */
    }
    
    /* ULTRA: Enhanced hover and focus states */
    .admin-table .curriculum-select:hover,
    .admin-table .curriculum-select:focus,
    .admin-classes-table .curriculum-select:hover,
    .admin-classes-table .curriculum-select:focus,
    select[class*="curriculum"]:hover,
    select[class*="curriculum"]:focus,
    .admin-section select:hover,
    .admin-section select:focus {
        border-color: #1B5E20 !important; /* ULTRA: Green border on hover */
        box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1) !important; /* ULTRA: Focus ring */
        outline: none !important; /* ULTRA: Remove default outline */
    }
    
    /* Button Styling - FIXED: Consistent styling for all three buttons */
    /* HIGH SPECIFICITY BUTTON STYLING - OVERRIDES BASE.HTML */
    .admin-table .action-buttons .btn-save,
    .admin-table .action-buttons .btn-edit,
    .admin-table .action-buttons .btn-delete {
        border: none !important;
        padding: 8px 15px !important;
        border-radius: 5px !important;
        cursor: pointer !important;
        font-size: 13px !important;
        font-weight: 500 !important;
        white-space: nowrap !important;
        min-width: 85px !important; /* IMPROVED: Better minimum width */
        width: auto !important; /* FIXED: Allow natural sizing */
        transition: all 0.3s ease !important;
        display: inline-block !important;
        text-align: center !important;
        line-height: 1.4 !important;
        color: white !important;
        box-sizing: border-box !important;
        text-decoration: none !important; /* Override base.html .btn */
    }
    
    .admin-table .action-buttons .btn-save {
        background: #2E7D32 !important;
    }
    
    .admin-table .action-buttons .btn-save:hover {
        background: #1B5E20 !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }
    
    .admin-table .action-buttons .btn-edit {
        background: #1976D2 !important;
    }
    
    .admin-table .action-buttons .btn-edit:hover {
        background: #1565C0 !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }
    
    .admin-table .action-buttons .btn-delete {
        background: #D32F2F !important;
    }
    
    .admin-table .action-buttons .btn-delete:hover {
        background: #B71C1C !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* Actions column styling - CRITICAL FIX: More space for 3 buttons */
    .admin-table td:last-child {
        width: 280px !important; /* CRITICAL: Increased width for 3 buttons + spacing */
        min-width: 280px !important; /* CRITICAL: Enforce minimum width */
        max-width: 280px !important; /* CRITICAL: Prevent expansion */
        text-align: center !important; /* CRITICAL: Center alignment */
        vertical-align: middle !important; /* CRITICAL: Vertical center */
        padding: 8px 12px !important; /* CRITICAL: Optimized padding */
        white-space: nowrap !important; /* CRITICAL: Prevent wrapping */
        overflow: visible !important; /* CRITICAL: Allow button visibility */
    }
    
    .admin-table .action-buttons {
        display: flex;
        flex-direction: row;
        gap: 4px !important; /* CRITICAL: Reduced gap for more compact layout */
        align-items: center;
        justify-content: center;
        flex-wrap: nowrap;
        width: 100%;
        padding: 2px 0 !important; /* CRITICAL: Minimal padding for more space */
    }
    
    /* ULTIMATE SPECIFICITY: Override any potential conflicts - CRITICAL FIX */
    .admin-section .admin-classes-table .admin-table td select,
    .admin-section .admin-classes-table .admin-table td .curriculum-select,
    div.admin-section div.admin-classes-table table.admin-table td select,
    .admin-classes-table .admin-table .curriculum-select {
        min-width: 180px !important; /* ULTIMATE: Wide enough for full text */
        width: 180px !important; /* ULTIMATE: Fixed width for consistency */
        max-width: 200px !important; /* ULTIMATE: Generous max-width */
        padding: 8px 12px !important; /* ULTIMATE: Optimized padding for space */
        font-size: 13px !important; /* ULTIMATE: Readable font size */
        font-weight: 500 !important; /* ULTIMATE: Clear text weight */
        border: 2px solid #DDD !important;
        border-radius: 5px !important; /* ULTIMATE: Consistent border radius */
        background: white !important;
        color: #333 !important;
        box-sizing: border-box !important;
        height: auto !important;
        line-height: 1.3 !important;
        overflow: visible !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
    }
    
    /* ULTIMATE: Force table cell widths for optimal display */
    .admin-table td:nth-child(4), /* Program column */
    .admin-table td:nth-child(5)  /* Sub-Program column */ {
        min-width: 220px !important; /* ULTIMATE: Even wider for full dropdown visibility */
        width: 220px !important; /* ULTIMATE: Fixed width for consistency */
        padding: 6px 8px !important; /* ULTIMATE: Compact padding for more space */
        overflow: visible !important;
        vertical-align: middle !important;
    }
    
    /* ULTIMATE: Level column optimization */
    .admin-table td:nth-child(6) /* Level column */ {
        min-width: 120px !important; /* ULTIMATE: Sufficient for "Level X" display */
        width: 120px !important;
        padding: 6px 8px !important;
        text-align: center !important;
    }
    
    /* ULTRA: Ensure table respects column widths */
    .admin-table {
        table-layout: fixed !important;
        width: 100% !important;
        border-collapse: separate !important;
        border-spacing: 0 2px !important;
    }
    
    /* Matrix filter CSS removed - visual component eliminated */
    
    /* ===== OPTIMIZED CURRICULUM MANAGEMENT STYLES ===== */
    .optimized-curriculum-management {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }
    
    .enhanced-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 25px 30px;
        background: linear-gradient(135deg, #1B5E20 0%, #2E7D32 100%);
        color: white;
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .enhanced-header .section-title {
        font-size: 26px;
        font-weight: 600;
        color: white;
        margin-bottom: 5px;
    }
    
    .enhanced-header .section-subtitle {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.9);
        margin: 0;
    }
    
    .header-actions {
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: flex-end;
    }
    
    .search-filter-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .search-input {
        padding: 8px 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.15);
        color: white;
        font-size: 14px;
        width: 200px;
        backdrop-filter: blur(10px);
    }
    
    .search-input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }
    
    .search-input:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.6);
        background: rgba(255, 255, 255, 0.25);
    }
    
    .class-count-indicator {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 500;
    }
    
    .action-buttons-header {
        display: flex;
        gap: 10px;
    }
    
    .btn-create-class, .btn-refresh {
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
    }
    
    .btn-create-class {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .btn-create-class:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
    }
    
    .btn-refresh {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.25);
    }
    
    .btn-refresh:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-1px);
    }
    
    .btn-icon {
        font-size: 16px;
    }
    
    /* Bulk Actions Toolbar */
    .bulk-actions-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 25px;
        background: #fff3cd;
        border-bottom: 1px solid #ffeaa7;
        color: #856404;
    }
    
    .bulk-actions-left {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .bulk-actions-left input[type="checkbox"] {
        transform: scale(1.1);
    }
    
    .bulk-actions-left label {
        font-weight: 500;
        margin: 0;
    }
    
    .selected-count {
        color: #6c5b00;
        font-size: 13px;
    }
    
    .bulk-actions-right {
        display: flex;
        gap: 10px;
    }
    
    .btn-bulk-assign, .btn-bulk-delete {
        padding: 8px 14px;
        border: none;
        border-radius: 5px;
        font-weight: 500;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
    }
    
    .btn-bulk-assign {
        background: #28a745;
        color: white;
    }
    
    .btn-bulk-assign:hover {
        background: #218838;
        transform: translateY(-1px);
    }
    
    .btn-bulk-delete {
        background: #dc3545;
        color: white;
    }
    
    .btn-bulk-delete:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
    
    /* Optimized Table Styles */
    .admin-classes-table-container {
        overflow-x: auto;
        overflow-y: visible;
        max-height: 70vh;
        border-radius: 0 0 12px 12px;
    }
    
    .optimized-table {
        width: 100%;
        min-width: 900px;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
    }
    
    .optimized-table thead {
        background: #1B5E20;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .optimized-table th {
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: white;
        font-size: 14px;
        border-bottom: 2px solid #2E7D32;
    }
    
    .optimized-table tbody tr {
        background: white;
        transition: all 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .optimized-table tbody tr:nth-child(even) {
        background: #fafafa;
    }
    
    .optimized-table tbody tr:hover {
        background: #E8F5E9;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .optimized-table td {
        padding: 12px;
        vertical-align: middle;
        font-size: 14px;
    }
    
    /* Column-specific styles */
    .checkbox-column {
        width: 40px;
        text-align: center;
    }
    
    .class-code-column {
        width: 140px;
        font-weight: 600;
        color: #1B5E20;
        font-size: 16px;
        position: sticky;
        left: 0;
        background: inherit;
        z-index: 5;
        box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
    }
    
    .curriculum-status-column {
        width: 200px;
    }
    
    .program-column, .subprogram-column {
        width: 180px;
    }
    
    .level-column {
        width: 120px;
        text-align: center;
    }
    
    .actions-column {
        width: 180px;
        text-align: center;
    }
    
    /* Curriculum Status Badges */
    .curriculum-status-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        max-width: 180px;
    }
    
    .curriculum-status-badge.assigned {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .curriculum-status-badge.not-assigned {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        font-style: italic;
    }
    
    /* Enhanced Dropdown Styles */
    .optimized-table .curriculum-select {
        width: 100% !important;
        padding: 8px 12px !important;
        border: 2px solid #e9ecef !important;
        border-radius: 6px !important;
        font-size: 13px !important;
        font-weight: 500 !important;
        background: white !important;
        color: #495057 !important;
        box-sizing: border-box !important;
        transition: all 0.3s ease !important;
    }
    
    .optimized-table .curriculum-select:focus {
        outline: none !important;
        border-color: #1B5E20 !important;
        box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1) !important;
    }
    
    .optimized-table .curriculum-select:disabled {
        background-color: #f8f9fa !important;
        color: #6c757d !important;
        cursor: not-allowed !important;
    }
    
    /* Save-on-Change Indicator */
    .save-indicator {
        display: inline-flex;
        align-items: center;
        margin-left: 8px;
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 3px;
        transition: all 0.3s ease;
    }
    
    .save-indicator.saving {
        background: #fff3cd;
        color: #856404;
    }
    
    .save-indicator.saved {
        background: #d4edda;
        color: #155724;
    }
    
    .save-indicator.error {
        background: #f8d7da;
        color: #721c24;
    }
    
    /* Action Menu Styles */
    .action-menu {
        position: relative;
        display: inline-block;
    }
    
    .action-menu-trigger {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    
    .action-menu-trigger:hover {
        background: #545b62;
        transform: translateY(-1px);
    }
    
    .action-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 140px;
        display: none;
    }
    
    .action-menu-dropdown.show {
        display: block;
    }
    
    .action-menu-item {
        display: block;
        width: 100%;
        padding: 10px 15px;
        border: none;
        background: none;
        text-align: left;
        cursor: pointer;
        font-size: 13px;
        color: #495057;
        transition: all 0.2s ease;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .action-menu-item:last-child {
        border-bottom: none;
    }
    
    .action-menu-item:hover {
        background: #f8f9fa;
        color: #212529;
    }
    
    .action-menu-item.delete-item:hover {
        background: #f8d7da;
        color: #721c24;
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
        .admin-classes-table-container {
            overflow-x: scroll;
        }
        
        .optimized-table {
            min-width: 800px;
        }
        
        .enhanced-header {
            flex-direction: column;
            gap: 20px;
            align-items: stretch;
        }
        
        .header-actions {
            align-items: stretch;
        }
        
        .search-filter-container {
            justify-content: space-between;
        }
    }
    
    @media (max-width: 768px) {
        .bulk-actions-toolbar {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }
        
        .bulk-actions-right {
            justify-content: center;
        }
        
        .action-buttons-header {
            flex-direction: column;
        }
    }
    
    /* Animation Classes */
    .row-highlight {
        animation: highlightRow 0.6s ease;
    }
    
    @keyframes highlightRow {
        0% { background-color: #fff3cd; }
        100% { background-color: inherit; }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Bulk Assignment Modal Styles */
    .bulk-assign-modal .modal-dialog {
        max-width: 600px;
    }
    
    .bulk-description {
        background: #e3f2fd;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        color: #1976d2;
    }
    
    .bulk-curriculum-form .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
    }
    
    .bulk-curriculum-form .form-group label {
        font-weight: 500;
        margin-bottom: 8px;
        display: block;
        color: #495057;
    }
    
    /* ========== CARD-BASED CURRICULUM MANAGEMENT UI v2.0 ========== */
    .curriculum-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 20px;
        padding: 20px;
        animation: fadeIn 0.3s ease-in;
    }
    
    .curriculum-list {
        padding: 20px;
    }
    
    .curriculum-list-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .list-header, .list-row {
        display: grid;
        grid-template-columns: 40px 120px 100px 1fr 1fr 100px 120px;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .list-header {
        background: #1B5E20;
        color: white;
        font-weight: 600;
    }
    
    .list-row:hover {
        background: #f5f5f5;
    }
    
    .curriculum-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .curriculum-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .curriculum-card .card-header {
        padding: 15px 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .curriculum-card .class-code {
        font-size: 18px;
        font-weight: 700;
        color: #1B5E20;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-badge.status-assigned {
        background: #C8E6C9;
        color: #2E7D32;
    }
    
    .status-badge.status-unassigned {
        background: #FFCCBC;
        color: #D84315;
    }
    
    .curriculum-card .card-body {
        padding: 20px;
    }
    
    .curriculum-selectors {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .selector-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .selector-group label {
        font-size: 12px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .curriculum-card .curriculum-select {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .curriculum-card .curriculum-select:hover:not(:disabled) {
        border-color: #2E7D32;
    }
    
    .curriculum-card .curriculum-select:focus {
        outline: none;
        border-color: #1B5E20;
        box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1);
    }
    
    .curriculum-card .curriculum-select:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .curriculum-card .card-footer {
        padding: 15px 20px;
        background: #f8f9fa;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
    }
    
    .card-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .btn-save {
        background: #4CAF50;
        color: white;
    }
    
    .btn-save:hover {
        background: #45A049;
        transform: scale(1.05);
    }
    
    .btn-edit {
        background: #2196F3;
        color: white;
    }
    
    .btn-edit:hover {
        background: #1976D2;
    }
    
    .btn-delete {
        background: #f44336;
        color: white;
    }
    
    .btn-delete:hover {
        background: #da190b;
    }
    
    .view-toggle {
        position: relative;
        display: inline-block;
        width: 120px;
        height: 34px;
    }
    
    .view-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #ccc;
        border-radius: 34px;
        transition: .4s;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background: white;
        border-radius: 50%;
        transition: .4s;
    }
    
    .view-toggle input:checked + .toggle-slider {
        background: #2E7D32;
    }
    
    .view-toggle input:checked + .toggle-slider:before {
        transform: translateX(86px);
    }
    
    .toggle-label {
        position: absolute;
        top: 7px;
        font-size: 12px;
        font-weight: 600;
        color: white;
        user-select: none;
        pointer-events: none;
    }
    
    .toggle-label:first-of-type {
        left: 12px;
    }
    
    .toggle-label:last-of-type {
        right: 18px;
    }
    
    .view-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .status-filter {
        padding: 8px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
    }
    
    .status-filter:focus {
        outline: none;
        border-color: #2E7D32;
    }
    
    .class-counter {
        font-size: 13px;
        color: #666;
        margin-left: 10px;
    }
    
    @media (max-width: 1200px) {
        .curriculum-grid {
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        .curriculum-grid {
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 15px;
        }
        
        .header-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-filter-container {
            flex-direction: column;
            width: 100%;
        }
        
        .view-controls {
            justify-content: space-between;
            width: 100%;
        }
    }
    
    .card-based-ui .admin-classes-table-container {
        display: none;
    }
    
    .card-based-ui.optimized-curriculum-management {
        background: #f8f9fa;
        border: none;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
    }
    
    .card-based-ui .section-header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .curriculum-card.save-success {
        animation: successFlash 0.6s ease;
        border-color: #4CAF50;
    }
    
    @keyframes successFlash {
        0% { background-color: white; }
        50% { background-color: #E8F5E9; }
        100% { background-color: white; }
    }
    
    .curriculum-card.removing {
        animation: fadeOut 0.3s ease;
        opacity: 0;
    }
    
    .save-indicator {
        margin-left: 10px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .save-indicator.saving {
        color: #FFA726;
    }
    
    .save-indicator.saved {
        color: #66BB6A;
    }
    
    .save-indicator.error {
        color: #EF5350;
    }
</style>
{% endblock %}

{% block header %}Classes & Exams Management{% endblock %}

{% block content %}

<!-- Debug Console Logging -->
<script>
console.group('%c[UNIFIED_VIEW] Classes & Exams Page Loaded', 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 5px 10px; border-radius: 3px; font-weight: bold;');
console.log('üìä View Type: Unified (Classes & Exams)');
console.log('üë§ User:', '{{ user.username }}');
console.log('üéì Is Admin:', {{ is_admin|lower }});
console.log('üìÖ Academic Year:', {{ current_year }});
console.log('‚è±Ô∏è Render Time:', '{{ render_time }}');
console.log('üîÑ Cache Bust:', '{{ cache_bust }}');
console.log('üìã Total Classes:', {{ classes_info|length }});

console.groupEnd();

// Matrix debugging JavaScript removed - visual component eliminated
console.log('[MATRIX_REMOVAL] Matrix debugging and analysis code removed from template');
</script>


<div class="unified-container">
    {% if error %}
    <!-- Error State -->
    <div class="alert alert-danger">
        <h4>Error Loading Classes & Exams</h4>
        <p>{{ error_message }}</p>
        <a href="{% url 'RoutineTest:index' %}" class="btn btn-primary">Return to Dashboard</a>
    </div>
    {% else %}
    
    <!-- My Access Summary Section -->
    <div class="access-summary-section">
        <div class="access-summary-header">
            <h3 class="access-title">
                {% if is_admin %}
                    Administrator Access Overview
                {% else %}
                    My Access Overview
                {% endif %}
            </h3>
            <span class="access-date">{{ current_date|date:"F j, Y" }}</span>
        </div>
        
        <div class="access-summary-content">
            {% if is_admin %}
                <!-- Admin Summary -->
                <div class="access-admin-box">
                    <div class="access-admin-badge">
                        <span class="badge-icon">üîê</span>
                        <span class="badge-text">FULL ADMINISTRATOR</span>
                    </div>
                    <div class="access-admin-details">
                        <div class="access-stat">
                            <span class="stat-number">{{ total_classes|default:"0" }}</span>
                            <span class="stat-label">Total Classes</span>
                        </div>
                        <div class="access-stat">
                            <span class="stat-number">{{ total_students|default:"0" }}</span>
                            <span class="stat-label">Total Students</span>
                        </div>
                        <div class="access-stat">
                            <span class="stat-number">{{ total_exams|default:"0" }}</span>
                            <span class="stat-label">Total Exams</span>
                        </div>
                        <div class="access-stat">
                            <span class="stat-number">ALL</span>
                            <span class="stat-label">Access Level</span>
                        </div>
                    </div>
                    <div class="access-admin-note">
                        You have full administrative access to all classes, exams, and student data across all programs.
                    </div>
                    
                    <!-- Admin Notifications - Pending Requests -->
                    <div class="admin-notifications" style="margin-top: 20px; padding: 16px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; border-left: 4px solid #f39c12; display: {% if admin_pending_requests_count > 0 %}block{% else %}none{% endif %};">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 20px;">üîî</span>
                                <div>
                                    <div style="font-weight: 600; color: #856404; margin-bottom: 4px;" data-notification-text>
                                        {{ admin_pending_requests_count }} Class Access Request{{ admin_pending_requests_count|pluralize }} Pending
                                    </div>
                                    <div style="font-size: 13px; color: #6c5b00;">
                                        Teachers are requesting access to classes and need your approval.
                                    </div>
                                </div>
                            </div>
                            <a href="{% url 'RoutineTest:admin_pending_requests' %}" 
                               class="btn btn-warning" 
                               style="background: #f39c12; border: none; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 500; transition: background 0.2s;"
                               onmouseover="this.style.background='#e67e22'" 
                               onmouseout="this.style.background='#f39c12'">
                                Review Requests
                            </a>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- NEW SIMPLIFIED TEACHER ACCESS SECTION -->
                <div class="teacher-access-section">
                    <!-- Global Access Level Badge -->
                    <div class="global-access-badge {% if global_access_level == 'FULL' %}full{% else %}view-only{% endif %}">
                        {% if global_access_level == 'FULL' %}
                            <span>‚úÖ</span>
                            <span>Full Access - Can manage all assigned classes</span>
                        {% else %}
                            <span>üëÅÔ∏è</span>
                            <span>View Only - Can view but not edit assigned classes</span>
                        {% endif %}
                    </div>
                    
                    <!-- Global Access Message -->
                    {% if global_access_message %}
                    <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 14px; color: #1976d2;">
                        ‚ÑπÔ∏è {{ global_access_message }}
                    </div>
                    {% endif %}
                    
                    <!-- Teacher Stats Grid -->
                    <div class="teacher-stats-grid">
                        <div class="teacher-stat">
                            <span class="stat-icon">üìö</span>
                            <span class="stat-value">{{ total_assigned_classes|default:"0" }}</span>
                            <span class="stat-label">Assigned Classes</span>
                        </div>
                        <div class="teacher-stat">
                            <span class="stat-icon">üë•</span>
                            <span class="stat-value">{{ total_assigned_students|default:"0" }}</span>
                            <span class="stat-label">Students</span>
                        </div>
                        <div class="teacher-stat">
                            <span class="stat-icon">üìù</span>
                            <span class="stat-value">{{ total_assigned_exams|default:"0" }}</span>
                            <span class="stat-label">Active Exams</span>
                        </div>
                        {% if pending_requests_count > 0 %}
                        <div class="teacher-stat pending">
                            <span class="stat-icon">‚è≥</span>
                            <span class="stat-value">{{ pending_requests_count }}</span>
                            <span class="stat-label">Pending</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Assigned Classes List -->
                    {% if assigned_classes %}
                    <div class="assigned-classes-list">
                        <div class="assigned-classes-title">
                            Your Assigned Classes ({{ assigned_classes|length }})
                        </div>
                        <div class="class-list">
                            {% for class in assigned_classes %}
                            <div class="class-item">
                                {{ class.class_code }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Request Access Button for Teachers -->
                    {% if not is_admin %}
                    <div class="request-access-section" style="margin-top: 20px; text-align: center;">
                        <button type="button" class="btn btn-primary" id="requestAccessBtn" onclick="openRequestAccessModal()" style="background: #2E7D32; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 500; display: flex; align-items: center; gap: 8px; margin: 0 auto;">
                            <span>‚ûï</span>
                            <span>Request Access to Classes</span>
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            Need access to additional classes? Submit a request for admin approval.
                        </div>
                    </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Admin Badge (Simple) - Removed as it's now in the Access Summary -->
    {% comment %}
    {% if is_admin %}
    <div style="text-align: center; margin-bottom: 20px;">
        <span class="badge badge-full" style="font-size: 14px; padding: 8px 16px; background: #2E7D32; color: white; border-radius: 20px;">
            üëë ADMIN - Full Access to All Classes
        </span>
    </div>
    {% endif %}
    {% endcomment %}
    
    <!-- SECTION 1: Class Management (Program-based Organization) -->
    <div class="classes-section">
        <div class="section-header">
            <div class="section-title">üìö Class Management</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                {% if is_admin %}
                <span class="badge badge-full" style="background: #2E7D32;">Admin - All Classes</span>
                {% else %}
                <span style="color: #6c757d; font-size: 14px;">Showing your assigned classes</span>
                {% endif %}
                {% if not is_admin and pending_requests_count > 0 %}
                <span class="badge badge-warning">{{ pending_requests_count }} Pending Request{{ pending_requests_count|pluralize }}</span>
                {% endif %}
            </div>
        </div>
        
        <!-- Programs Container -->
        <div class="programs-container">
            {% for program in programs_data %}
            <div class="program-section" id="program-{{ program.name|lower }}">
                <div class="program-header {{ program.name|lower }}" onclick="toggleProgram('{{ program.name|lower }}')">
                    <div class="program-title {{ program.name|lower }}">
                        {% if program.name == 'CORE' %}üìó{% elif program.name == 'ASCENT' %}üìò{% elif program.name == 'EDGE' %}üìô{% else %}üìï{% endif %}
                        {{ program.name }} Program
                    </div>
                    <div class="program-summary">
                        <span>{{ program.classes|length }} Classes</span>
                        <span>‚Ä¢</span>
                        <span>{{ program.total_students }} Students</span>
                        <span>‚Ä¢</span>
                        <span>{{ program.total_exams }} Exams</span>
                        {% if program.incomplete_assignments > 0 %}
                        <span>‚Ä¢</span>
                        <span style="color: white;">‚ö†Ô∏è {{ program.incomplete_assignments }} Incomplete</span>
                        {% endif %}
                    </div>
                    <div class="program-toggle">‚ñº</div>
                </div>
                
                <div class="program-classes">
                    {% for class in program.classes %}
                    <div class="class-card {% if class.all_exams_assigned %}complete{% elif class.active_exams > 0 %}incomplete{% else %}not-started{% endif %}" 
                         onclick="viewClassDetails('{{ class.class_code }}')" 
                         title="Click to view class details">
                        
                        <div class="class-header">
                            <div class="class-name">{{ class.class_name }}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="class-badge badge-{{ class.access_level|access_level_class }}">
                                    {{ class.access_level|display_access_level }}
                                </div>
                                {% if is_admin %}
                                <button onclick="event.stopPropagation(); confirmDeleteClass('{{ class.class_code }}', '{{ class.class_name|escapejs }}', event); return false;" 
                                        class="btn-delete-class"
                                        title="Delete Class">
                                    Delete
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="class-summary">
                            <div class="class-summary-item">
                                <span class="icon">üë•</span>
                                <span><strong>{{ class.student_count }}</strong> Students</span>
                            </div>
                            <div class="class-summary-item">
                                {% if class.active_exams > 0 %}
                                <span class="icon">üìù</span>
                                <span><strong>{{ class.active_exams }}</strong> Exams Assigned</span>
                                {% else %}
                                <span class="icon" style="color: #dc3545;">üî¥</span>
                                <span style="color: #dc3545; font-weight: 600;">No Exams Assigned</span>
                                {% endif %}
                            </div>
                            <div class="class-summary-item">
                                <span class="icon">üìö</span>
                                <span><strong>{{ class.curriculum_full|default:class.curriculum_level|default:"Level 1" }}</strong></span>
                            </div>
                            <div class="class-summary-item">
                                <span class="icon">üîë</span>
                                <span><strong>{{ class.access_level }}</strong> Access</span>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div style="padding: 20px; text-align: center; color: #6c757d;">
                        No classes assigned in {{ program.name }} program
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% empty %}
            <div style="padding: 40px; text-align: center; color: #6c757d;">
                <p>No classes available to display.</p>
                {% if not is_admin %}
                <p>Please contact your administrator to be assigned to classes.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- SECTION 2: Teachers Management (Admin Only) - IMPROVED LAYOUT -->
    {% if is_admin %}
    <div class="admin-section" style="margin: 40px 0; padding: 30px; background: white; border: 1px solid #dee2e6; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div class="section-header" style="margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #dee2e6;">
            <div class="section-title" style="font-size: 24px; font-weight: 600; color: #1B5E20; display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 28px;">üéì</span>
                Teachers Management
            </div>
            <div style="color: #6c757d; font-size: 14px; margin-top: 8px;">
                Comprehensive teacher access control and class assignment management
            </div>
        </div>
        
        <!-- Quick Stats - Clean Minimal Design -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="color: #1B5E20; font-size: 32px; font-weight: 700; margin-bottom: 5px;" data-stat="pending-requests">{{ admin_pending_requests_count|default:"0" }}</div>
                <div style="color: #6c757d; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Pending Requests</div>
            </div>
            <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="color: #1B5E20; font-size: 32px; font-weight: 700; margin-bottom: 5px;">{{ total_teachers|default:"16" }}</div>
                <div style="color: #6c757d; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Active Teachers</div>
            </div>
            <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 20px; border-radius: 8px; text-align: center;">
                <div style="color: #1B5E20; font-size: 32px; font-weight: 700; margin-bottom: 5px;">{{ total_assignments|default:"24" }}</div>
                <div style="color: #6c757d; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Class Assignments</div>
            </div>
        </div>
        
        <!-- Management Actions - Style matching Classes & Curriculum Configuration -->
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Teacher Access Management -->
            <a href="{% url 'RoutineTest:admin_teacher_management_dashboard' %}" 
               style="background: white; border: 1px solid #1B5E20; color: #1B5E20; padding: 20px; border-radius: 8px; text-decoration: none; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s ease; hover:background: #f8f9fa;"
               onmouseover="this.style.background='#f8f9fa'" 
               onmouseout="this.style.background='white'">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 24px; color: #1B5E20;">üë•</span>
                    <div>
                        <div style="font-weight: 600; font-size: 16px; color: #1B5E20;">Teacher Access Dashboard</div>
                        <div style="font-size: 14px; color: #6c757d; margin-top: 2px;">Manage teacher-class assignments and multi-teacher support</div>
                    </div>
                </div>
                <span style="font-size: 18px; color: #1B5E20;">‚Üí</span>
            </a>
            
            <!-- Classes & Curriculum Configuration Link Removed -->
            <script>
                console.log('[CURRICULUM_REMOVAL] Navigation link to Classes & Curriculum Configuration removed');
                console.log('[CURRICULUM_REMOVAL] Previous link URL was: admin_classes_teachers');
            </script>
            
            <!-- Pending Requests Alert - Special Notification -->
            <a href="{% url 'RoutineTest:admin_pending_requests' %}" 
               class="admin-notifications-container"
               style="background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 20px; border-radius: 8px; text-decoration: none; display: {% if admin_pending_requests_count > 0 %}flex{% else %}none{% endif %}; align-items: center; justify-content: space-between; transition: all 0.2s ease;"
               onmouseover="this.style.background='#ffeaa7'" 
               onmouseout="this.style.background='#fff3cd'">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 24px; animation: pulse 2s infinite;">üîî</span>
                    <div>
                        <div style="font-weight: 600; font-size: 16px; color: #856404;" data-pending-count>{{ admin_pending_requests_count }}</div>
                        <div style="font-size: 14px; color: #6c5f00; margin-top: 2px;">Teachers are waiting for your approval</div>
                    </div>
                </div>
                <span style="font-size: 18px; color: #856404;">‚Üí</span>
            </a>
        </div>
    </div>
    
    <!-- Add pulse animation for notification bell -->
    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
    {% endif %}
    
    <!-- 
    MATRIX COMPONENT REMOVED (COMPREHENSIVE REMOVAL):
    The Exam Assignments Matrix visual display has been completely removed as requested.
    
    Removed components:
    - Matrix preview table showing class √ó timeslot grid
    - Exam type toggle tabs (Review/Quarterly/All Exams)
    - Matrix legend and visual indicators
    - Interactive matrix cell functionality
    
    IMPORTANT: The underlying exam assignment functionality via ExamScheduleMatrix model
    remains intact for API operations (copying, deleting, assigning exams).
    Only the visual matrix display has been removed.
    
    Console logging added for removal tracking.
    -->
    <script>
    console.log('[MATRIX_REMOVAL] Exam Assignments Matrix display has been removed from UI');
    console.log('[MATRIX_REMOVAL] Underlying exam functionality preserved for API operations');
    console.log('[MATRIX_REMOVAL] Timestamp:', new Date().toISOString());
    </script>
    
    {% endif %}
    
    <!-- Curriculum Management Section Removed as per request -->
    <!-- Console debug logging for curriculum removal -->
    <script>
        console.log('[CURRICULUM_REMOVAL] ====================================');
        console.log('[CURRICULUM_REMOVAL] Classes & Curriculum Configuration section has been successfully removed');
        console.log('[CURRICULUM_REMOVAL] Timestamp:', new Date().toISOString());
        console.log('[CURRICULUM_REMOVAL] Page:', window.location.pathname);
        console.log('[CURRICULUM_REMOVAL] User is superuser:', {{ user.is_superuser|yesno:"true,false" }});
        console.log('[CURRICULUM_REMOVAL] Section previously located after line 1866');
        console.log('[CURRICULUM_REMOVAL] ====================================');
    </script>
    
    <!-- Admin-Only: Curriculum Management Section -->
    {% if user.is_superuser %}
    <div class="curriculum-management-section" style="margin-top: 40px; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 5px solid #1B5E20;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #E8F5E8;">
            <div>
                <h2 style="color: #1B5E20; font-size: 24px; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 28px;">üîê</span>
                    Admin: Curriculum Management
                </h2>
                <p style="color: #666; margin: 8px 0 0 0; font-size: 14px;">Direct assignment of curriculum configurations to class codes</p>
            </div>
            <div class="header-actions" style="display: flex; gap: 12px; align-items: center;">
                <div class="year-selector" style="position: relative;">
                    <select id="academicYearSelect" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                        <option value="2025" {% if current_year == '2025' %}selected{% endif %}>2025</option>
                        <option value="2026" {% if current_year == '2026' %}selected{% endif %}>2026</option>
                        <option value="2027" {% if current_year == '2027' %}selected{% endif %}>2027</option>
                    </select>
                </div>
                <button class="btn-create-class" onclick="showCreateClassModal()" style="padding: 10px 20px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(76,175,80,0.3);">
                    <span style="margin-right: 6px;">‚ûï</span>
                    Create New Class
                </button>
            </div>
        </div>
        
        <div class="curriculum-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card" style="background: linear-gradient(135deg, #E3F2FD, #BBDEFB); padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 28px; font-weight: bold; color: #1976D2;">{{ classes_info|length }}</div>
                <div style="color: #1976D2; font-weight: 500; margin-top: 5px;">Total Classes</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #E8F5E8, #C8E6C9); padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 28px; font-weight: bold; color: #388E3C;" id="mappedClassesCount">0</div>
                <div style="color: #388E3C; font-weight: 500; margin-top: 5px;">Configured Classes</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #FFF3E0, #FFE0B2); padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 28px; font-weight: bold; color: #F57C00;" id="unmappedClassesCount">{{ classes_info|length }}</div>
                <div style="color: #F57C00; font-weight: 500; margin-top: 5px;">Pending Classes</div>
            </div>
        </div>
        
        <!-- Class Configuration Cards Grid -->
        <div class="curriculum-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px;" id="curriculumGrid">
            {% for class in classes_info %}
            <div class="class-curriculum-card" data-class-code="{{ class.class_code }}" style="background: white; border: 2px solid #E0E0E0; border-radius: 12px; padding: 20px; transition: all 0.3s ease; position: relative; overflow: hidden;">
                <!-- Card Header -->
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div class="class-info">
                        <h3 style="margin: 0; color: #1B5E20; font-size: 18px; font-weight: 600;">{{ class.class_code }}</h3>
                        <p style="margin: 4px 0 0 0; color: #666; font-size: 13px;">{{ class.class_name|truncatechars:30 }}</p>
                    </div>
                    <div class="card-actions" style="display: flex; gap: 8px;">
                        <button class="btn-edit-class" onclick="editClassCurriculum('{{ class.class_code }}')" style="padding: 6px 10px; background: #2196F3; color: white; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; opacity: 0; transition: opacity 0.3s ease;" title="Edit">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn-delete-class" onclick="deleteClassCurriculum('{{ class.class_code }}')" style="padding: 6px 10px; background: #F44336; color: white; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; opacity: 0; transition: opacity 0.3s ease;" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
                
                <!-- Curriculum Assignment Form -->
                <div class="curriculum-form">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label style="display: block; color: #555; font-weight: 500; font-size: 13px; margin-bottom: 6px;">Program</label>
                        <select class="program-select" data-class="{{ class.class_code }}" onchange="updateSubPrograms(this)" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                            <option value="">-- Select Program --</option>
                            <option value="CORE">PRIME CORE</option>
                            <option value="ASCENT">PRIME ASCENT</option>
                            <option value="EDGE">PRIME EDGE</option>
                            <option value="PINNACLE">PRIME PINNACLE</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label style="display: block; color: #555; font-weight: 500; font-size: 13px; margin-bottom: 6px;">Sub-Program</label>
                        <select class="subprogram-select" data-class="{{ class.class_code }}" onchange="updateLevels(this)" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white;" disabled>
                            <option value="">-- Select Sub-Program --</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label style="display: block; color: #555; font-weight: 500; font-size: 13px; margin-bottom: 6px;">Level</label>
                        <select class="level-select" data-class="{{ class.class_code }}" onchange="markCardChanged(this)" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white;" disabled>
                            <option value="">-- Select Level --</option>
                        </select>
                    </div>
                    
                    <!-- Save Button (appears when changes made) -->
                    <button class="btn-save-curriculum" onclick="saveCurriculumMapping('{{ class.class_code }}')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; opacity: 0; transition: all 0.3s ease; transform: translateY(10px);">
                        <span class="save-text">üíæ Save Configuration</span>
                        <span class="save-loader" style="display: none;">
                            <span style="display: inline-block; width: 16px; height: 16px; border: 2px solid #ffffff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span>
                            Saving...
                        </span>
                    </button>
                </div>
                
                <!-- Current Assignment Display -->
                <div class="current-assignment" style="margin-top: 16px; padding: 12px; background: #F5F5F5; border-radius: 6px; font-size: 13px; border-left: 4px solid #4CAF50; display: none;">
                    <div style="color: #388E3C; font-weight: 500; margin-bottom: 4px;">‚úÖ Currently Assigned:</div>
                    <div class="assignment-details" style="color: #666;"></div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Bulk Actions -->
        <div class="bulk-actions" style="background: #F8F9FA; padding: 20px; border-radius: 10px; border: 2px dashed #ddd;">
            <div style="display: flex; justify-content: between; align-items: center; gap: 15px;">
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 8px 0; color: #1B5E20; font-size: 16px;">Bulk Operations</h4>
                    <p style="margin: 0; color: #666; font-size: 13px;">Apply curriculum settings to multiple classes at once</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-bulk-assign" onclick="showBulkAssignModal()" style="padding: 10px 16px; background: #FF9800; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                        üìã Bulk Assign
                    </button>
                    <button class="btn-export-config" onclick="exportConfiguration()" style="padding: 10px 16px; background: #607D8B; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                        üì§ Export Config
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
</div>

<!-- Create/Edit Class Modal -->
<div id="classManagementModal" class="modal" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="classModalTitle">Create New Class</h4>
                <button type="button" class="close-modal" onclick="closeClassModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="classForm">
                    <div class="form-group">
                        <label>Class Code:</label>
                        <select id="classCode" class="form-control" required>
                            <option value="">-- Select Class Code --</option>
                            <option value="PS1">PS1 (Preschool 1)</option>
                            <option value="P1">P1 (Primary 1)</option>
                            <option value="P2">P2 (Primary 2)</option>
                            <option value="A2">A2 (A-Track Grade 2)</option>
                            <option value="B2">B2 (B-Track Grade 2)</option>
                            <option value="B3">B3 (B-Track Grade 3)</option>
                            <option value="B4">B4 (B-Track Grade 4)</option>
                            <option value="B5">B5 (B-Track Grade 5)</option>
                            <option value="S2">S2 (S-Track Grade 2)</option>
                            <option value="H1">H1 (H-Track Grade 6)</option>
                            <option value="H2">H2 (H-Track Grade 7)</option>
                            <option value="H4">H4 (H-Track Grade 8)</option>
                            <option value="C2">C2 (C-Track Grade 6)</option>
                            <option value="C3">C3 (C-Track Grade 7)</option>
                            <option value="C4">C4 (C-Track Grade 8)</option>
                            <option value="C5">C5 (C-Track Grade 9)</option>
                            <option value="Young-cho2">Young-cho2</option>
                            <option value="Young-choM">Young-choM</option>
                            <option value="Chung-choM">Chung-choM</option>
                            <option value="Chung-cho1">Chung-cho1</option>
                            <option value="SejongM">SejongM</option>
                            <option value="MAS">MAS</option>
                            <option value="TaejoG">TaejoG</option>
                            <option value="TaejoD">TaejoD</option>
                            <option value="TaejoDC">TaejoDC</option>
                            <option value="SungjongM">SungjongM</option>
                            <option value="Sungjong2">Sungjong2</option>
                            <option value="Sungjong3">Sungjong3</option>
                            <option value="SungjongC">SungjongC</option>
                            <option value="D2">D2 (Development Grade 2)</option>
                            <option value="D3">D3 (Development Grade 3)</option>
                            <option value="D4">D4 (Development Grade 4)</option>
                            <option value="High1_SaiSun_3-5">High1 SaiSun 3-5</option>
                            <option value="High1_SaiSun_5-7">High1 SaiSun 5-7</option>
                            <option value="High1V2_SaiSun_11-1">High1V2 SaiSun 11-1</option>
                            <option value="High1V2_SaiSun_1-3">High1V2 SaiSun 1-3</option>
                        </select>
                        <small class="form-text text-muted">Select from predefined class codes</small>
                    </div>
                    
                    <hr>
                    <h5>Curriculum Mapping</h5>
                    
                    <div class="form-group">
                        <label>Program:</label>
                        <select id="programSelect" class="form-control" onchange="loadSubPrograms()">
                            <option value="">-- Select Program --</option>
                            <option value="CORE">CORE</option>
                            <option value="ASCENT">ASCENT</option>
                            <option value="EDGE">EDGE</option>
                            <option value="PINNACLE">PINNACLE</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Sub-Program:</label>
                        <select id="subProgramSelect" class="form-control" onchange="loadLevels()" disabled>
                            <option value="">-- Select Sub-Program --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Level:</label>
                        <select id="levelSelect" class="form-control" disabled>
                            <option value="">-- Select Level --</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeClassModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveClass()">Save Class</button>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic Updates Script -->
<script>
// Program toggle function
function toggleProgram(programName) {
    const programSection = document.getElementById('program-' + programName);
    if (programSection) {
        programSection.classList.toggle('collapsed');
        console.log('[CLASS_MANAGEMENT] Toggled program:', programName);
    }
}

// View class details function
function viewClassDetails(classCode) {
    console.log('[CLASS_MANAGEMENT] Navigating to class details:', classCode);
    // Navigate to the new class details page with Student Management and Exam Schedule
    window.location.href = '/RoutineTest/class/' + classCode + '/details/';
}

// Function to refresh pending requests count
function refreshPendingRequestsCount() {
    console.log('[NOTIFICATION_REFRESH] Checking for pending requests updates...');
    
    fetch('{% url "RoutineTest:api_pending_requests_count" %}', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updatePendingNotifications(data.pending_count);
            console.log('[NOTIFICATION_REFRESH] Updated pending count:', data.pending_count);
        } else {
            console.error('[NOTIFICATION_REFRESH] Error:', data.error);
        }
    })
    .catch(error => {
        console.error('[NOTIFICATION_REFRESH] Fetch error:', error);
    });
}

// Function to update the notification UI elements
function updatePendingNotifications(pendingCount) {
    // Update the notification badge in the header
    const notificationElements = document.querySelectorAll('[data-pending-count]');
    notificationElements.forEach(element => {
        element.textContent = pendingCount;
        element.setAttribute('data-pending-count', pendingCount);
    });
    
    // Show/hide notification sections based on count
    const blockNotifications = document.querySelectorAll('.admin-notifications');
    blockNotifications.forEach(section => {
        if (pendingCount > 0) {
            section.style.display = 'block';
        } else {
            section.style.display = 'none';
        }
    });
    
    const flexNotifications = document.querySelectorAll('.admin-notifications-container');
    flexNotifications.forEach(section => {
        if (pendingCount > 0) {
            section.style.display = 'flex';
        } else {
            section.style.display = 'none';
        }
    });
    
    // Update quick stats number
    const statsElements = document.querySelectorAll('[data-stat="pending-requests"]');
    statsElements.forEach(element => {
        element.textContent = pendingCount || '0';
    });
    
    // Update notification text (singular/plural)
    const notificationTextElements = document.querySelectorAll('[data-notification-text]');
    notificationTextElements.forEach(element => {
        const baseText = pendingCount === 1 ? 'Class Access Request Pending' : 'Class Access Requests Pending';
        element.textContent = `${pendingCount} ${baseText}`;
    });
}

// Class deletion confirmation
function confirmDeleteClass(classCode, className, event) {
    // Stop event propagation to prevent card click
    if (event) {
        event.stopPropagation();
    }
    
    if (confirm(`Are you sure you want to delete class "${className}"?\n\nThis will:\n‚Ä¢ Remove the class from the system\n‚Ä¢ Delete all associated assignments\n‚Ä¢ Remove student enrollments\n\nThis action cannot be undone.`)) {
        deleteClass(classCode);
    }
    return false;
}

async function deleteClass(classCode) {
    try {
        const deleteUrl = `/RoutineTest/class/${classCode}/delete/`;
        
        const response = await fetch(deleteUrl, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                // Remove the class card from DOM
                const classCard = document.querySelector(`[onclick*="${classCode}"]`);
                if (classCard) {
                    classCard.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => {
                        classCard.remove();
                    }, 300);
                }
                
                // Show success message
                alert(`Class "${classCode}" has been deleted successfully.`);
                
                // Optionally reload the page to refresh the data
                setTimeout(() => {
                    location.reload();
                }, 500);
            } else {
                alert('Error deleting class: ' + (result.error || 'Unknown error'));
            }
        } else {
            alert('Error deleting class. Please try again.');
        }
    } catch (error) {
        console.error('Error deleting class:', error);
        alert('Error deleting class. Please check your connection and try again.');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('[UNIFIED_VIEW] DOM loaded, initializing dynamic features...');
    
    // ===== EXAM TYPE TAB TOGGLE SYSTEM =====
    // Matrix tab toggle JavaScript removed - visual component eliminated
    console.log('[MATRIX_REMOVAL] Matrix tab toggle functionality removed from template');
    
    // Auto-refresh pending requests count every 30 seconds for admins
    {% if is_admin %}
    setInterval(function() {
        refreshPendingRequestsCount();
    }, 30000); // 30 seconds
    
    // Initial refresh after 5 seconds (to catch any recently processed requests)
    setTimeout(function() {
        refreshPendingRequestsCount();
    }, 5000);
    {% endif %}
    
    // Smooth scroll to sections
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            }
        });
    });
    
    // Add loading states for async operations
    document.querySelectorAll('.class-card').forEach(card => {
        card.addEventListener('click', function() {
            console.log('[UNIFIED_VIEW] Class card clicked:', this.querySelector('.class-name').textContent);
        });
    });
    
    console.log('[UNIFIED_VIEW] Initialization complete');
});
</script>

<!-- Include Exam Management Modal -->
{% include 'primepath_routinetest/includes/exam_management_modal.html' %}

<!-- Debug Script for Modal Issues -->
<script>
// Global error handler for debugging modal issues
window.addEventListener('error', function(e) {
    console.error('[GLOBAL_ERROR] JavaScript error detected:', {
        message: e.message,
        filename: e.filename,
        lineno: e.lineno,
        colno: e.colno,
        error: e.error
    });
    
    // Check if this is related to exam modal
    if (e.message && (e.message.includes('openExamModal') || e.message.includes('exam'))) {
        console.error('[EXAM_MODAL_ERROR] This error is related to exam modal functionality');
    }
});

// Debug function to check modal elements
function debugModalElements() {
    console.group('[MODAL_DEBUG] Checking Modal Elements');
    
    const requiredElements = [
        'examManagementModal',
        'modalClassCode',
        'modalTimeslot',
        'overviewClassCode',
        'overviewCurriculum',
        'overviewPeriod',
        'overviewAccessLevel',
        'currentExamsList',
        'examTableBody',
        'totalStudents',
        'activeStudents',
        'studentTableBody'
    ];
    
    requiredElements.forEach(id => {
        const element = document.getElementById(id);
        console.log(`${id}: ${element ? '‚úÖ Found' : '‚ùå Missing'}`);
    });
    
    console.groupEnd();
}

// Check modal elements on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('[MODAL_DEBUG] Page loaded, checking modal elements...');
    setTimeout(debugModalElements, 100); // Give time for elements to load
});

// Test function to verify modal functionality
function testExamModal() {
    console.log('[MODAL_TEST] Testing exam modal functionality...');
    
    // Find first class card to test with
    const firstClassCard = document.querySelector('.class-card');
    if (firstClassCard) {
        const className = firstClassCard.querySelector('.class-name')?.textContent || 'TEST_CLASS';
        console.log(`[MODAL_TEST] Testing with class: ${className}`);
        
        // Try to open modal
        try {
            openExamModal(className, 'overview', 'FULL');
            console.log('[MODAL_TEST] Modal opened successfully');
            
            // Close modal after 2 seconds
            setTimeout(() => {
                closeExamModal();
                console.log('[MODAL_TEST] Modal closed successfully');
            }, 2000);
        } catch (error) {
            console.error('[MODAL_TEST] Error opening modal:', error);
        }
    } else {
        console.warn('[MODAL_TEST] No class cards found to test with');
    }
}

// Add test button to console
console.log('[MODAL_DEBUG] To test the modal, run: testExamModal()');
</script>

<!-- Request Access Modal -->
<div id="requestAccessModal" class="modal fade" tabindex="-1" role="dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1050;">
    <div class="modal-dialog modal-lg" role="document" style="position: relative; max-width: 600px; margin: 30px auto; pointer-events: none;">
        <div class="modal-content" style="position: relative; background-color: white; border: 1px solid rgba(0,0,0,0.2); border-radius: 6px; box-shadow: 0 3px 9px rgba(0,0,0,0.5); pointer-events: auto;">
            <div class="modal-header" style="background: #2E7D32; color: white; border-bottom: 1px solid #dee2e6; padding: 20px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title" style="color: white; font-weight: 600; margin: 0; font-size: 18px;">
                    <span style="margin-right: 8px;">‚ûï</span>
                    Request Access to Classes
                </h5>
                <button type="button" class="close" onclick="closeRequestAccessModal()" style="background: none; border: none; font-size: 28px; color: white; cursor: pointer; opacity: 0.8; line-height: 1;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form id="requestAccessForm">
                    {% csrf_token %}
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="requestedClass" style="font-weight: 500; color: #2c3e50; margin-bottom: 8px; display: block;">Class Code *</label>
                        <select id="requestedClass" name="class_code" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;">
                            <option value="">-- Select a class --</option>
                            {% if available_classes %}
                                {% comment %} DEBUG: Template-level debugging for class dropdown {% endcomment %}
                                {% for class in available_classes %}
                                    {% if "Curriculum Level" in class.class_name or "Curriculum level" in class.class_name %}
                                        <!-- CRITICAL FIX: Filtering out placeholder text, showing class code only -->
                                        <option value="{{ class.class_code }}">{{ class.class_code }}</option>
                                    {% else %}
                                        <option value="{{ class.class_code }}">{{ class.class_name }}</option>
                                    {% endif %}
                                {% endfor %}
                                {% comment %} DEBUG: Log available classes count {% endcomment %}
                                <!-- DEBUG: {{ available_classes|length }} classes available for request -->
                            {% else %}
                                <!-- Fallback if no dynamic classes available -->
                                <optgroup label="CORE Program">
                                    <option value="PS1">PS1 - CORE Phonics Level 1</option>
                                    <option value="P2">P2 - CORE Phonics Level 3</option>
                                    <option value="A2">A2 - CORE Sigma Level 1</option>
                                    <option value="B2">B2 - CORE Sigma Level 2</option>
                                    <option value="B3">B3 - CORE Sigma Level 3</option>
                                    <option value="B4">B4 - CORE Elite Level 1</option>
                                    <option value="B5">B5 - CORE Elite Level 2</option>
                                    <option value="S2">S2 - CORE Elite Level 3</option>
                                </optgroup>
                                <optgroup label="EDGE Program">
                                    <option value="Young-cho2">Young-cho2 - EDGE Rise Level 1</option>
                                    <option value="Chung-cho4">Chung-cho4 - EDGE Rise Level 2</option>
                                    <option value="Chung-cho1">Chung-cho1 - EDGE Rise Level 3</option>
                                    <option value="SejongM">SejongM - EDGE Pursuit Level 3</option>
                                    <option value="MAS">MAS - EDGE Pro Level 1</option>
                                </optgroup>
                                <optgroup label="ASCENT Program">
                                    <option value="TaejoC">TaejoC - ASCENT Drive Level 1</option>
                                    <option value="TaejoD">TaejoD - ASCENT Drive Level 2</option>
                                    <option value="TaejoE">TaejoE - ASCENT Drive Level 3</option>
                                    <option value="SungjongM">SungjongM - ASCENT Pro Level 1</option>
                                    <option value="D2">D2 - ASCENT Nova Level 1</option>
                                </optgroup>
                                <optgroup label="PINNACLE Program">
                                    <option value="High1.SatSun.3-5">High1.SatSun.3-5 - PINNACLE Vision Level 1</option>
                                    <option value="High1/2.SatSun.11-1">High1/2.SatSun.11-1 - PINNACLE Endeavor Level 2</option>
                                </optgroup>
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- Access level hidden since only Full Access is available for requests -->
                    <input type="hidden" name="requested_access_level" value="FULL">
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="requestReason" style="font-weight: 500; color: #2c3e50; margin-bottom: 8px; display: block;">Reason for Request *</label>
                        <select id="requestReason" name="reason" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;">
                            <option value="">-- Select reason --</option>
                            <option value="NEW_ASSIGNMENT">New class assignment</option>
                            <option value="SUBSTITUTE">Substituting for another teacher</option>
                            <option value="CO_TEACHING">Co-teaching arrangement</option>
                            <option value="CURRICULUM_EXPERTISE">Have expertise in curriculum</option>
                            <option value="SCHEDULE_OPTIMIZATION">Better schedule alignment</option>
                            <option value="OTHER">Other reason</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="requestNotes" style="font-weight: 500; color: #2c3e50; margin-bottom: 8px; display: block;">Additional Notes</label>
                        <textarea id="requestNotes" name="notes" rows="3" placeholder="Please provide any additional context for your request..." style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="background: #f8f9fa; border-top: 1px solid #dee2e6; padding: 20px; display: flex; justify-content: flex-end; gap: 12px; border-radius: 0 0 6px 6px;">
                <button type="button" class="btn btn-secondary" onclick="closeRequestAccessModal()" style="background: #6c757d; border: none; color: white; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: 500;">
                    Cancel
                </button>
                <button type="button" class="btn btn-success" onclick="submitAccessRequest()" id="submitRequestBtn" style="background: #2E7D32; border: none; color: white; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: 500;">
                    <span id="submitBtnText">Submit Request</span>
                    <span id="submitBtnLoader" style="display: none;">
                        <span style="display: inline-block; width: 12px; height: 12px; border: 2px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: spin 1s ease-in-out infinite;"></span>
                        Submitting...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Request Access Modal Functions
function openRequestAccessModal() {
    console.log('[REQUEST_ACCESS] Opening modal...');
    
    // DEBUG: Log dropdown options to verify class codes
    const classDropdown = document.getElementById('requestedClass');
    if (classDropdown) {
        console.log('[CLASS_DROPDOWN_DEBUG] === FRONTEND DROPDOWN OPTIONS ===');
        console.log('[CLASS_DROPDOWN_DEBUG] Total options:', classDropdown.options.length);
        
        for (let i = 0; i < Math.min(classDropdown.options.length, 15); i++) {
            const option = classDropdown.options[i];
            console.log(`[CLASS_DROPDOWN_DEBUG] ${i}. Value: "${option.value}" | Text: "${option.text}"`);
        }
        
        if (classDropdown.options.length > 15) {
            console.log(`[CLASS_DROPDOWN_DEBUG] ... and ${classDropdown.options.length - 15} more options`);
        }
        console.log('[CLASS_DROPDOWN_DEBUG] === END FRONTEND DEBUG ===');
    } else {
        console.error('[CLASS_DROPDOWN_DEBUG] ERROR: requestedClass dropdown not found!');
    }
    
    document.getElementById('requestAccessModal').style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeRequestAccessModal() {
    console.log('[REQUEST_ACCESS] Closing modal...');
    document.getElementById('requestAccessModal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
    
    // Reset form
    document.getElementById('requestAccessForm').reset();
    
    // Reset button state
    document.getElementById('submitBtnText').style.display = 'inline';
    document.getElementById('submitBtnLoader').style.display = 'none';
    document.getElementById('submitRequestBtn').disabled = false;
}

function submitAccessRequest() {
    console.log('[REQUEST_ACCESS] Submitting request...');
    
    const form = document.getElementById('requestAccessForm');
    const formData = new FormData(form);
    
    // Validate form
    const classCode = formData.get('class_code');
    const accessLevel = formData.get('requested_access_level');
    const reason = formData.get('reason');
    
    if (!classCode || !accessLevel || !reason) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Show loading state
    document.getElementById('submitBtnText').style.display = 'none';
    document.getElementById('submitBtnLoader').style.display = 'inline';
    document.getElementById('submitRequestBtn').disabled = true;
    
    // Submit request via AJAX
    fetch('{% url "RoutineTest:request_access" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Access request submitted successfully! Admin will review and respond.');
            closeRequestAccessModal();
            
            // Optionally refresh page to show updated pending count
            if (data.refresh_page) {
                location.reload();
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to submit request'));
        }
    })
    .catch(error => {
        console.error('[REQUEST_ACCESS] Error:', error);
        alert('An error occurred while submitting your request. Please try again.');
    })
    .finally(() => {
        // Reset button state
        document.getElementById('submitBtnText').style.display = 'inline';
        document.getElementById('submitBtnLoader').style.display = 'none';
        document.getElementById('submitRequestBtn').disabled = false;
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('requestAccessModal');
    if (event.target === modal) {
        closeRequestAccessModal();
    }
});

// Loading spinner CSS animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>

<!-- Exam Management Script -->
<script src="{% static 'js/routinetest/exam-management.js' %}?v={{ cache_bust }}"></script>

<!-- Curriculum Management JavaScript -->
<script>
console.log('[CURRICULUM_MANAGEMENT] Initializing curriculum management system...');

// Curriculum data structure
const curriculumData = {
    'CORE': {
        'CORE Phonics': [1, 2, 3],
        'CORE Sigma': [1, 2, 3], 
        'CORE Elite': [1, 2, 3],
        'CORE Pro': [1, 2, 3]
    },
    'ASCENT': {
        'ASCENT Nova': [1, 2, 3],
        'ASCENT Drive': [1, 2, 3],
        'ASCENT Pro': [1, 2, 3]
    },
    'EDGE': {
        'EDGE Spark': [1, 2, 3],
        'EDGE Rise': [1, 2, 3],
        'EDGE Pursuit': [1, 2, 3],
        'EDGE Pro': [1, 2, 3]
    },
    'PINNACLE': {
        'PINNACLE Vision': [1, 2],
        'PINNACLE Endeavor': [1, 2],
        'PINNACLE Success': [1, 2],
        'PINNACLE Pro': [1, 2]
    }
};

// Track current mappings
let currentMappings = {};

// Initialize curriculum management on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('[CURRICULUM_MANAGEMENT] DOM loaded, initializing...');
    
    // Load existing mappings
    loadExistingMappings();
    
    // Add hover effects to cards
    setupCardHoverEffects();
    
    // Initialize year selector
    setupYearSelector();
    
    console.log('[CURRICULUM_MANAGEMENT] Initialization complete');
});

// Update Sub-Programs based on selected Program
function updateSubPrograms(selectElement) {
    const program = selectElement.value;
    const classCode = selectElement.dataset.class;
    const subprogramSelect = document.querySelector(`.subprogram-select[data-class="${classCode}"]`);
    const levelSelect = document.querySelector(`.level-select[data-class="${classCode}"]`);
    
    console.log(`[CURRICULUM_MANAGEMENT] Updating sub-programs for ${classCode}, program: ${program}`);
    
    // Clear sub-program and level selects
    subprogramSelect.innerHTML = '<option value="">-- Select Sub-Program --</option>';
    levelSelect.innerHTML = '<option value="">-- Select Level --</option>';
    levelSelect.disabled = true;
    
    if (program && curriculumData[program]) {
        // Enable sub-program select
        subprogramSelect.disabled = false;
        
        // Populate sub-programs
        Object.keys(curriculumData[program]).forEach(subProgram => {
            const option = document.createElement('option');
            option.value = subProgram;
            option.textContent = subProgram;
            subprogramSelect.appendChild(option);
        });
        
        console.log(`[CURRICULUM_MANAGEMENT] Added ${Object.keys(curriculumData[program]).length} sub-programs for ${program}`);
    } else {
        subprogramSelect.disabled = true;
    }
    
    markCardChanged(selectElement);
}

// Update Levels based on selected Sub-Program
function updateLevels(selectElement) {
    const subProgram = selectElement.value;
    const classCode = selectElement.dataset.class;
    const programSelect = document.querySelector(`.program-select[data-class="${classCode}"]`);
    const program = programSelect.value;
    const levelSelect = document.querySelector(`.level-select[data-class="${classCode}"]`);
    
    console.log(`[CURRICULUM_MANAGEMENT] Updating levels for ${classCode}, sub-program: ${subProgram}`);
    
    // Clear level select
    levelSelect.innerHTML = '<option value="">-- Select Level --</option>';
    
    if (program && subProgram && curriculumData[program] && curriculumData[program][subProgram]) {
        // Enable level select
        levelSelect.disabled = false;
        
        // Populate levels
        curriculumData[program][subProgram].forEach(level => {
            const option = document.createElement('option');
            option.value = level;
            option.textContent = `Level ${level}`;
            levelSelect.appendChild(option);
        });
        
        console.log(`[CURRICULUM_MANAGEMENT] Added ${curriculumData[program][subProgram].length} levels for ${subProgram}`);
    } else {
        levelSelect.disabled = true;
    }
    
    markCardChanged(selectElement);
}

// Mark card as changed and show save button
function markCardChanged(selectElement) {
    const classCode = selectElement.dataset.class;
    const card = document.querySelector(`[data-class-code="${classCode}"]`);
    const saveButton = card.querySelector('.btn-save-curriculum');
    
    // Check if all fields are selected
    const program = card.querySelector('.program-select').value;
    const subProgram = card.querySelector('.subprogram-select').value;
    const level = card.querySelector('.level-select').value;
    
    if (program && subProgram && level) {
        // Show save button with animation
        saveButton.style.opacity = '1';
        saveButton.style.transform = 'translateY(0)';
        
        // Add border animation to indicate change
        card.style.borderColor = '#4CAF50';
        card.style.boxShadow = '0 4px 16px rgba(76,175,80,0.2)';
        
        console.log(`[CURRICULUM_MANAGEMENT] Card ${classCode} ready to save: ${program} > ${subProgram} > Level ${level}`);
    } else {
        // Hide save button
        saveButton.style.opacity = '0';
        saveButton.style.transform = 'translateY(10px)';
        
        // Reset card appearance
        card.style.borderColor = '#E0E0E0';
        card.style.boxShadow = 'none';
    }
}

// Save curriculum mapping
async function saveCurriculumMapping(classCode) {
    const card = document.querySelector(`[data-class-code="${classCode}"]`);
    const saveButton = card.querySelector('.btn-save-curriculum');
    const saveText = saveButton.querySelector('.save-text');
    const saveLoader = saveButton.querySelector('.save-loader');
    
    // Get selected values
    const program = card.querySelector('.program-select').value;
    const subProgram = card.querySelector('.subprogram-select').value;
    const level = card.querySelector('.level-select').value;
    const academicYear = document.getElementById('academicYearSelect').value;
    
    if (!program || !subProgram || !level) {
        alert('Please select Program, Sub-Program, and Level before saving.');
        return;
    }
    
    console.log(`[CURRICULUM_MANAGEMENT] Saving mapping for ${classCode}: ${program} > ${subProgram} > Level ${level} (${academicYear})`);
    
    // Show loading state
    saveText.style.display = 'none';
    saveLoader.style.display = 'inline-flex';
    saveButton.disabled = true;
    
    try {
        // Find the curriculum level ID (this would normally come from the backend)
        const curriculumLevelId = await getCurriculumLevelId(program, subProgram, level);
        
        // Make API call to save mapping
        const response = await fetch('/RoutineTest/curriculum-mapping/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                class_code: classCode,
                curriculum_level_id: curriculumLevelId,
                academic_year: academicYear,
                priority: 1
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Success animation
            card.style.borderColor = '#4CAF50';
            card.style.background = 'linear-gradient(135deg, #E8F5E8, #F1F8E9)';
            
            // Show current assignment
            showCurrentAssignment(card, program, subProgram, level);
            
            // Hide save button
            saveButton.style.opacity = '0';
            saveButton.style.transform = 'translateY(10px)';
            
            // Update stats
            updateStats();
            
            console.log(`[CURRICULUM_MANAGEMENT] Successfully saved mapping for ${classCode}`);
            
            // Store mapping
            currentMappings[classCode] = {
                program: program,
                subProgram: subProgram,
                level: level,
                academicYear: academicYear
            };
            
            // Show success notification
            showNotification(`‚úÖ Successfully configured ${classCode}`, 'success');
            
        } else {
            throw new Error(data.error || 'Failed to save mapping');
        }
        
    } catch (error) {
        console.error(`[CURRICULUM_MANAGEMENT] Error saving mapping for ${classCode}:`, error);
        
        // Error animation
        card.style.borderColor = '#F44336';
        card.style.boxShadow = '0 4px 16px rgba(244,67,54,0.2)';
        
        // Show error notification
        showNotification(`‚ùå Failed to save ${classCode}: ${error.message}`, 'error');
        
    } finally {
        // Reset button state
        saveText.style.display = 'inline';
        saveLoader.style.display = 'none';
        saveButton.disabled = false;
    }
}

// Show current assignment display
function showCurrentAssignment(card, program, subProgram, level) {
    const assignmentDiv = card.querySelector('.current-assignment');
    const detailsDiv = assignmentDiv.querySelector('.assignment-details');
    
    detailsDiv.textContent = `${program} ${subProgram} - Level ${level}`;
    assignmentDiv.style.display = 'block';
}

// Setup card hover effects
function setupCardHoverEffects() {
    document.querySelectorAll('.class-curriculum-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            const editBtn = this.querySelector('.btn-edit-class');
            const deleteBtn = this.querySelector('.btn-delete-class');
            editBtn.style.opacity = '1';
            deleteBtn.style.opacity = '1';
        });
        
        card.addEventListener('mouseleave', function() {
            const editBtn = this.querySelector('.btn-edit-class');
            const deleteBtn = this.querySelector('.btn-delete-class');
            editBtn.style.opacity = '0';
            deleteBtn.style.opacity = '0';
        });
    });
}

// Setup year selector
function setupYearSelector() {
    const yearSelect = document.getElementById('academicYearSelect');
    if (yearSelect) {
        yearSelect.addEventListener('change', function() {
            console.log('[CURRICULUM_MANAGEMENT] Academic year changed to:', this.value);
            loadExistingMappings();
        });
    }
}

// Load existing mappings from backend
async function loadExistingMappings() {
    console.log('[CURRICULUM_MANAGEMENT] Loading existing mappings...');
    
    try {
        // This would call the existing curriculum mapping view
        const academicYear = document.getElementById('academicYearSelect').value;
        const response = await fetch(`/RoutineTest/curriculum-mapping/?year=${academicYear}`);
        
        if (response.ok) {
            // In a real implementation, this would parse the response and populate the forms
            console.log('[CURRICULUM_MANAGEMENT] Successfully loaded existing mappings');
        }
    } catch (error) {
        console.error('[CURRICULUM_MANAGEMENT] Error loading existing mappings:', error);
    }
    
    updateStats();
}

// Update statistics
function updateStats() {
    const totalClasses = document.querySelectorAll('.class-curriculum-card').length;
    const mappedClasses = Object.keys(currentMappings).length;
    const unmappedClasses = totalClasses - mappedClasses;
    
    document.getElementById('mappedClassesCount').textContent = mappedClasses;
    document.getElementById('unmappedClassesCount').textContent = unmappedClasses;
    
    console.log(`[CURRICULUM_MANAGEMENT] Stats updated: ${mappedClasses}/${totalClasses} classes configured`);
}

// Show notification
function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        transform: translateX(100%);
    `;
    
    if (type === 'success') {
        notification.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
    } else {
        notification.style.background = 'linear-gradient(135deg, #F44336, #C62828)';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Animate out and remove
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Helper function to get curriculum level ID (mock implementation)
async function getCurriculumLevelId(program, subProgram, level) {
    // In a real implementation, this would query the backend
    // For now, return a mock ID
    return `${program}_${subProgram.replace(/ /g, '_')}_${level}`;
}

// Additional functions for modals and advanced features
function showCreateClassModal() {
    console.log('[CURRICULUM_MANAGEMENT] Opening create class modal...');
    // This would integrate with existing class creation modal
    alert('Create New Class modal would open here');
}

function editClassCurriculum(classCode) {
    console.log(`[CURRICULUM_MANAGEMENT] Editing curriculum for class: ${classCode}`);
    // Focus on the card and highlight it
    const card = document.querySelector(`[data-class-code="${classCode}"]`);
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    card.style.borderColor = '#2196F3';
    card.style.boxShadow = '0 4px 16px rgba(33,150,243,0.3)';
}

function deleteClassCurriculum(classCode) {
    console.log(`[CURRICULUM_MANAGEMENT] Deleting curriculum for class: ${classCode}`);
    if (confirm(`Are you sure you want to remove the curriculum configuration for ${classCode}?`)) {
        // Call delete API
        deleteCurriculumMapping(classCode);
    }
}

async function deleteCurriculumMapping(classCode) {
    console.log(`[CURRICULUM_MANAGEMENT] Deleting mapping for ${classCode}`);
    
    try {
        // In real implementation, call the remove endpoint
        const response = await fetch('/RoutineTest/curriculum-mapping/remove/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                class_code: classCode
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Reset the card
            const card = document.querySelector(`[data-class-code="${classCode}"]`);
            card.querySelector('.program-select').value = '';
            card.querySelector('.subprogram-select').innerHTML = '<option value="">-- Select Sub-Program --</option>';
            card.querySelector('.level-select').innerHTML = '<option value="">-- Select Level --</option>';
            card.querySelector('.current-assignment').style.display = 'none';
            card.style.borderColor = '#E0E0E0';
            card.style.background = 'white';
            card.style.boxShadow = 'none';
            
            // Remove from currentMappings
            delete currentMappings[classCode];
            
            // Update stats
            updateStats();
            
            showNotification(`‚úÖ Removed curriculum configuration for ${classCode}`, 'success');
        } else {
            throw new Error(data.error || 'Failed to delete mapping');
        }
        
    } catch (error) {
        console.error('[CURRICULUM_MANAGEMENT] Error deleting mapping:', error);
        showNotification(`‚ùå Failed to delete ${classCode}: ${error.message}`, 'error');
    }
}

function showBulkAssignModal() {
    console.log('[CURRICULUM_MANAGEMENT] Opening bulk assign modal...');
    alert('Bulk Assign modal would open here - allow selecting multiple classes and assigning same curriculum');
}

function exportConfiguration() {
    console.log('[CURRICULUM_MANAGEMENT] Exporting configuration...');
    // Create CSV or JSON export of current mappings
    const exportData = Object.entries(currentMappings).map(([classCode, mapping]) => ({
        classCode,
        program: mapping.program,
        subProgram: mapping.subProgram,
        level: mapping.level,
        academicYear: mapping.academicYear
    }));
    
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Class Code,Program,Sub-Program,Level,Academic Year\n"
        + exportData.map(row => `${row.classCode},${row.program},${row.subProgram},${row.level},${row.academicYear}`).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `curriculum_configuration_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('‚úÖ Configuration exported successfully', 'success');
}

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .class-curriculum-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
    }
    
    .btn-save-curriculum:hover {
        background: linear-gradient(135deg, #66BB6A, #43A047) !important;
        box-shadow: 0 4px 12px rgba(76,175,80,0.4);
    }
    
    .btn-create-class:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(76,175,80,0.4) !important;
    }
`;
document.head.appendChild(style);

console.log('[CURRICULUM_MANAGEMENT] JavaScript loaded successfully');
</script>

{% endblock %}