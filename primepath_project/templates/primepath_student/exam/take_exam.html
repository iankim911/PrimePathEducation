{% extends 'unified_base.html' %}
{% comment %}
Phase 3: Template Migration
Migrated from student_base.html to unified_base.html
Date: August 27, 2025
{% endcomment %}
{% load static %}

{% block title %}{{ exam.name }} - Exam{% endblock %}
{% block module_name %}primepath_student{% endblock %}
{% block data_module %}primepath_student{% endblock %}
{% block header_bg_color %}#1B5E20{% endblock %}

{% block extra_styles %}
<style>
    /* Exam Container */
    .exam-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Timer Style */
    .exam-timer {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        font-size: 18px;
        font-weight: bold;
    }
    
    .exam-timer.warning {
        background: #FFF3CD;
        color: #856404;
    }
    
    .exam-timer.danger {
        background: #F8D7DA;
        color: #721C24;
    }
    
    /* Question Navigation */
    .question-nav {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .question-nav-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }
    
    .question-nav-btn {
        padding: 10px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s;
    }
    
    .question-nav-btn:hover {
        background: #f0f0f0;
    }
    
    .question-nav-btn.current {
        background: #1565C0;
        color: white;
        border-color: #1565C0;
    }
    
    .question-nav-btn.answered {
        background: #4CAF50;
        color: white;
        border-color: #4CAF50;
    }
    
    /* Question Display */
    .question-display {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        min-height: 400px;
    }
    
    .question-number {
        font-size: 18px;
        font-weight: bold;
        color: #1565C0;
        margin-bottom: 20px;
    }
    
    .question-text {
        font-size: 18px;
        line-height: 1.6;
        margin-bottom: 30px;
    }
    
    .answer-options {
        list-style: none;
        padding: 0;
    }
    
    .answer-option {
        margin-bottom: 15px;
    }
    
    .answer-option label {
        display: flex;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .answer-option label:hover {
        background: #e9ecef;
        border-color: #1565C0;
    }
    
    .answer-option input[type="radio"] {
        margin-right: 15px;
        width: 20px;
        height: 20px;
    }
    
    .answer-option input[type="radio"]:checked + span {
        font-weight: bold;
    }
    
    .answer-option label.selected {
        background: #E3F2FD;
        border-color: #1565C0;
    }
    
    /* Navigation Buttons */
    .navigation-controls {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }
    
    .nav-btn {
        padding: 12px 30px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
    }
    
    .nav-btn.prev {
        background: #6c757d;
        color: white;
    }
    
    .nav-btn.prev:hover:not(:disabled) {
        background: #5a6268;
    }
    
    .nav-btn.next {
        background: #1565C0;
        color: white;
    }
    
    .nav-btn.next:hover {
        background: #1976D2;
    }
    
    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Submit Button */
    .submit-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .btn-submit {
        background: #43A047;
        color: white;
        padding: 15px 40px;
        border: none;
        border-radius: 4px;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-submit:hover {
        background: #4CAF50;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    /* Auto-save indicator */
    .auto-save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 15px;
        background: #C8E6C9;
        color: #2E7D32;
        border-radius: 4px;
        display: none;
    }
    
    .auto-save-indicator.show {
        display: block;
    }
</style>
{% endblock %}

{% block main %}
<div class="exam-container">
    <!-- Timer -->
    <div class="exam-timer" id="examTimer">
        Time Remaining: <span id="timeDisplay">--:--</span>
    </div>
    
    <!-- Question Navigation -->
    <div class="question-nav">
        <h3>Question Navigation</h3>
        <div class="question-nav-grid" id="questionNav">
            {% for q in questions %}
            <button class="question-nav-btn {% if forloop.first %}current{% endif %}" 
                    data-question="{{ q.question_number }}"
                    onclick="goToQuestion({{ q.question_number }})">
                {{ q.question_number }}
            </button>
            {% endfor %}
        </div>
    </div>
    
    {% if exam.pdf_url %}
    <!-- PDF Viewer -->
    <div class="pdf-section">
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px; color: #1565C0;">Exam Questions</h3>
            <div class="pdf-viewer">
                <iframe src="{{ exam.pdf_url }}" 
                        width="100%" 
                        height="600" 
                        style="border: 1px solid #ddd; border-radius: 8px;">
                    <p>Your browser does not support PDFs. 
                       <a href="{{ exam.pdf_url }}" target="_blank">Download the PDF</a>
                    </p>
                </iframe>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Answer Input Section -->
    <div class="question-display" id="questionDisplay">
        <h3 style="margin-bottom: 20px; color: #1565C0;">Your Answers</h3>
        <!-- Questions will be loaded here -->
    </div>
    
    <!-- Submit Section -->
    <div class="submit-section">
        <p>Review your answers before submitting. Once submitted, you cannot make changes.</p>
        <button class="btn-submit" onclick="submitExam()">Submit Exam</button>
    </div>
    
    <!-- Auto-save indicator -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        âœ“ Answers auto-saved
    </div>
</div>

<!-- Secure data injection -->
<script id="exam-data" type="application/json">{{ exam|escapejs }}</script>
<script id="session-data" type="application/json">{{ session_data|escapejs }}</script>
<script id="questions-data" type="application/json">{{ questions|escapejs }}</script>

<script>
// Secure data loading with validation
let examData, sessionData, questions;

try {
    examData = JSON.parse(document.getElementById('exam-data').textContent);
    sessionData = JSON.parse(document.getElementById('session-data').textContent);
    questions = JSON.parse(document.getElementById('questions-data').textContent);
    
    // Validate essential data
    if (!examData?.id || !sessionData?.id || !Array.isArray(questions)) {
        throw new Error('Invalid exam data structure');
    }
} catch (error) {
    console.error('Failed to load exam data:', error);
    alert('Failed to load exam data. Please refresh the page.');
    throw error;
}

let currentQuestionIndex = 0;
let answers = sessionData.answers || {};
let autoSaveTimer = null;

// Initialize timer
function initTimer() {
    if (!sessionData.expires_at) return;
    
    const updateTimer = () => {
        const now = new Date();
        const expires = new Date(sessionData.expires_at);
        const remaining = Math.max(0, Math.floor((expires - now) / 1000));
        
        if (remaining === 0) {
            clearInterval(timerInterval);
            autoSubmit();
            return;
        }
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('timeDisplay').textContent = display;
        
        const timerEl = document.getElementById('examTimer');
        if (remaining < 300) { // Less than 5 minutes
            timerEl.classList.add('danger');
        } else if (remaining < 600) { // Less than 10 minutes
            timerEl.classList.add('warning');
        }
    };
    
    updateTimer();
    const timerInterval = setInterval(updateTimer, 1000);
}

// Display all questions for answer input
function displayAllQuestions() {
    const questionDisplay = document.getElementById('questionDisplay');
    
    let allQuestionsHtml = '';
    
    questions.forEach(question => {
        const savedAnswer = answers[question.question_number];
        
        let answerInputHtml = '';
        if (question.question_type === 'multiple_choice') {
            answerInputHtml = `
                <div class="answer-options" style="display: flex; gap: 15px; flex-wrap: wrap;">
                    ${['A', 'B', 'C', 'D'].map(letter => {
                        const isChecked = savedAnswer === letter ? 'checked' : '';
                        return `
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 15px; border: 2px solid ${isChecked ? '#1565C0' : '#ddd'}; border-radius: 4px; transition: all 0.3s;">
                                <input type="radio" 
                                       name="question_${question.question_number}" 
                                       value="${letter}"
                                       ${isChecked}
                                       onchange="saveAnswer(${question.question_number}, '${letter}'); updateAnswerVisual(this)">
                                <span style="font-weight: bold; color: ${isChecked ? '#1565C0' : '#333'};">${letter}</span>
                            </label>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            answerInputHtml = `
                <textarea 
                    class="form-control" 
                    rows="3" 
                    placeholder="Type your answer here..."
                    onchange="saveAnswer(${question.question_number}, this.value)"
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">${savedAnswer || ''}</textarea>
            `;
        }
        
        allQuestionsHtml += `
            <div id="question-${question.question_number}" class="question-item" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #1565C0;">
                <div class="question-header" style="font-weight: bold; margin-bottom: 10px; color: #1565C0;">
                    Question ${question.question_number}
                </div>
                <div class="answer-input">
                    ${answerInputHtml}
                </div>
            </div>
        `;
    });
    
    questionDisplay.innerHTML = allQuestionsHtml;
}

// Update answer visual feedback
function updateAnswerVisual(radioInput) {
    // Update the question navigation button
    const questionNumber = radioInput.name.split('_')[1];
    const navBtn = document.querySelector(`.question-nav-btn[data-question="${questionNumber}"]`);
    if (navBtn) {
        navBtn.classList.add('answered');
    }
    
    // Update radio button styling
    const allLabels = radioInput.closest('.answer-options').querySelectorAll('label');
    allLabels.forEach(label => {
        label.style.borderColor = '#ddd';
        label.querySelector('span').style.color = '#333';
    });
    
    const selectedLabel = radioInput.closest('label');
    selectedLabel.style.borderColor = '#1565C0';
    selectedLabel.querySelector('span').style.color = '#1565C0';
}

// Save answer
function saveAnswer(questionNumber, answer) {
    answers[questionNumber] = answer;
    
    // Update navigation button
    const navBtn = document.querySelector(`.question-nav-btn[data-question="${questionNumber}"]`);
    if (navBtn && answer) {
        navBtn.classList.add('answered');
    }
    
    // Clear existing timer
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    
    // Set new timer for auto-save (2 seconds after last change)
    autoSaveTimer = setTimeout(autoSave, 2000);
}

// Auto-save function
function autoSave() {
    fetch(`/student/exam/${sessionData.id}/auto-save/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ answers: answers })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAutoSaveIndicator();
        }
        if (data.expired) {
            autoSubmit();
        }
    });
}

// Show auto-save indicator
function showAutoSaveIndicator() {
    const indicator = document.getElementById('autoSaveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 3000);
}

// Navigation functions
function goToQuestion(questionNumber) {
    currentQuestionIndex = questions.findIndex(q => q.question_number === questionNumber);
    displayQuestion(currentQuestionIndex);
}

function nextQuestion() {
    if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        displayQuestion(currentQuestionIndex);
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion(currentQuestionIndex);
    }
}

function updateNavigation(currentQuestion) {
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
        btn.classList.remove('current');
        if (parseInt(btn.dataset.question) === currentQuestion) {
            btn.classList.add('current');
        }
    });
}

// Submit exam
function submitExam() {
    const unanswered = questions.filter(q => !answers[q.question_number]);
    
    let confirmMessage = 'Are you sure you want to submit your exam?';
    if (unanswered.length > 0) {
        confirmMessage = `You have ${unanswered.length} unanswered questions. Are you sure you want to submit?`;
    }
    
    if (confirm(confirmMessage)) {
        // Save final answers and submit
        fetch(`/student/exam/${sessionData.id}/submit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ answers: answers })
        })
        .then(() => {
            window.location.href = `/student/exam/${sessionData.id}/result/`;
        });
    }
}

// Auto-submit when time expires
function autoSubmit() {
    alert('Your exam time has expired. Submitting your answers...');
    submitExam();
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Scroll to question
function goToQuestion(questionNumber) {
    const questionItem = document.querySelector(`#question-${questionNumber}`);
    if (questionItem) {
        questionItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initTimer();
    displayAllQuestions();
    
    // Mark already answered questions in navigation
    Object.keys(answers).forEach(qNum => {
        const navBtn = document.querySelector(`.question-nav-btn[data-question="${qNum}"]`);
        if (navBtn) {
            navBtn.classList.add('answered');
        }
    });
    
    // Auto-save every 2 minutes
    setInterval(autoSave, 120000);
});
</script>
{% endblock %}