{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{{ exam.name }} - Placement Test</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}">
    
    <!-- Modular CSS with cache busting -->
    {% load cache %}
    {% now "U" as current_timestamp %}
    <link rel="stylesheet" href="{% static 'css/pages/student-test.css' %}?v={{ current_timestamp }}">
    <link rel="stylesheet" href="{% static 'css/components/difficulty-modal.css' %}?v={{ current_timestamp }}">
    <!-- Mobile Responsive CSS - Only affects mobile viewports -->
    <link rel="stylesheet" href="{% static 'css/mobile-responsive.css' %}?v={{ current_timestamp }}">
    
    <style>
        /* Difficulty Adjustment Buttons */
        .difficulty-adjustment-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn-difficulty-adjust {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-difficulty-adjust:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-difficulty-adjust:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #6c757d;
        }
        
        .btn-difficulty-adjust[data-direction="down"] {
            background: linear-gradient(135deg, #667eea 0%, #4facfe 100%);
        }
        
        .btn-difficulty-adjust[data-direction="up"] {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        @media (max-width: 768px) {
            .test-header > div {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .difficulty-adjustment-buttons {
                margin-top: 10px;
                width: 100%;
            }
            
            .btn-difficulty-adjust {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="test-container">
            <!-- Test Header -->
            <div class="test-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>{{ exam.name }}</h1>
                    {% comment %}
                    TIMER COMPONENT: Only render if timer_seconds exists and is not None
                    This prevents null/empty data-timer-seconds attributes
                    {% endcomment %}
                    {% if timer_seconds is not None and timer_seconds >= 0 %}
                        {% include 'components/placement_test/timer.html' with timer_seconds=timer_seconds %}
                    {% else %}
                        <!-- No timer for this exam -->
                        <div class="timer-placeholder" style="color: #6c757d; font-size: 14px;">
                            <span>‚è±Ô∏è Untimed Exam</span>
                        </div>
                    {% endif %}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <div id="answer-progress" style="color: #6c757d;">
                        0 / {{ questions|length }} answered
                    </div>
                    <!-- Difficulty Adjustment Buttons -->
                    <div class="difficulty-adjustment-buttons" style="display: flex; gap: 10px;">
                        <button type="button" 
                                id="decrease-difficulty-btn"
                                class="btn-difficulty-adjust"
                                data-direction="down"
                                title="Switch to an easier exam">
                            üìâ Easier Exam
                        </button>
                        <button type="button" 
                                id="increase-difficulty-btn"
                                class="btn-difficulty-adjust"
                                data-direction="up"
                                title="Switch to a harder exam">
                            üìà Harder Exam
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Question Navigation -->
            {% include 'components/placement_test/question_nav.html' with questions=questions %}
            
            <!-- Main Content Area -->
            <div class="question-container">
                <!-- PDF Section -->
                {% if exam.pdf_file %}
                    {% include 'components/placement_test/pdf_viewer.html' with pdf_url=exam.pdf_file.url enable_navigation=True enable_zoom=True %}
                {% else %}
                    {% include 'components/placement_test/pdf_viewer.html' with pdf_url=None enable_navigation=True enable_zoom=True %}
                {% endif %}
                
                <!-- Question Section with Integrated Submit Button -->
                <div class="question-section">
                    <form id="test-form" method="post">
                        {% csrf_token %}
                        {% for question in questions %}
                            {% include 'components/placement_test/question_panel.html' with question=question questions=questions %}
                        {% endfor %}
                    </form>
                    
                    <!-- Submit Button - Now inside question section to prevent overlap -->
                    <div class="submit-container" id="submit-container">
                        <button type="button" 
                                id="submit-test-btn"
                                class="submit-test-btn"
                                data-action="submit-test"
                                aria-label="Submit Test">
                            <span class="btn-text">Submit Test</span>
                            <span class="btn-icon" style="display: none;">‚úì</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Include Difficulty Choice Modal -->
    {% include 'components/placement_test/difficulty_choice_modal.html' %}
    
    <!-- Modal State Monitoring (Debug Mode Only) -->
    <script>
        (function() {
            // Only run modal debugging if debug is enabled for modals
            if (window.PrimePathDebug && window.PrimePathDebug.shouldLog('modal', 3)) {
                const modal = document.getElementById('difficulty-choice-modal');
                if (modal) {
                    const logger = window.PrimePathDebug.createLogger('ModalState');
                    logger.debug('Modal found, initial display:', modal.style.display || 'none');
                    
                    // Only add observer in TRACE mode
                    if (window.PrimePathDebug.shouldLog('modal', 4)) {
                        const observer = new MutationObserver(function(mutations) {
                            mutations.forEach(function(mutation) {
                                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                                    // Log only the display change, not the entire element
                                    logger.trace('Modal display changed to:', modal.style.display);
                                }
                            });
                        });
                        
                        observer.observe(modal, {
                            attributes: true,
                            attributeFilter: ['style']
                        });
                        
                        logger.trace('MutationObserver attached to modal');
                    }
                } else if (window.PrimePathDebug.shouldLog('modal', 1)) {
                    const logger = window.PrimePathDebug.createLogger('ModalState');
                    logger.warn('Difficulty choice modal element not found in DOM');
                }
            }
        })();
    </script>
    
    <!-- Load PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Store Django configuration data safely using json_script -->
    {{ js_config|json_script:"django-js-config" }}
    
    <!-- Initialize APP_CONFIG BEFORE loading modules -->
    <script>
    // Initialize configuration with error handling - MUST be before modules load
    (function() {
        let djangoConfig = {};
        
        try {
            // Safely parse JSON configuration from Django
            const configElement = document.getElementById('django-js-config');
            if (configElement && configElement.textContent) {
                djangoConfig = JSON.parse(configElement.textContent);
                console.log('Django config loaded successfully');
            } else {
                console.error('Django config element not found');
            }
        } catch (error) {
            console.error('Error parsing Django config:', error);
            djangoConfig = {};
        }
        
        // Build complete configuration object with defensive checks
        window.APP_CONFIG = {
            csrf: '{{ csrf_token }}',
            session: djangoConfig.session || {},
            exam: djangoConfig.exam || {},
            urls: {
                saveAnswer: '{% url "PlacementTest:submit_answer" session.id %}',
                completeTest: '{% url "PlacementTest:complete_test" session.id %}',
                getAudio: '{% url "PlacementTest:get_audio" 0 %}'.replace('0', '{id}'),
                adjustDifficulty: '{% url "PlacementTest:manual_adjust_difficulty" session.id %}'
            },
            questions: djangoConfig.questions || [],
            audioFiles: djangoConfig.audioFiles || [],
            studentAnswers: djangoConfig.studentAnswers || {}
        };
        
        // Validate required data
        if (!APP_CONFIG.session.id) {
            console.error('Session ID is missing from configuration');
        }
        if (!APP_CONFIG.exam.id) {
            console.error('Exam ID is missing from configuration');
        }
        
        // Make session ID globally available for backward compatibility
        window.sessionId = APP_CONFIG.session.id;
    })();
    
    // CRITICAL FIX: Clear stale timer states from localStorage to prevent session conflicts
    (function() {
        try {
            console.log('[TIMER_CLEANUP] Clearing stale timer states from localStorage...');
            
            const currentSessionId = APP_CONFIG.session.id;
            const currentPersistKey = `exam-timer-session-${currentSessionId}`;
            
            // Get all localStorage keys
            const localStorageKeys = Object.keys(localStorage);
            console.log('[TIMER_CLEANUP] Found localStorage keys:', localStorageKeys);
            
            let clearedCount = 0;
            for (const key of localStorageKeys) {
                // Remove old global timer state (legacy format)
                if (key === 'exam-timer') {
                    console.log('[TIMER_CLEANUP] Removing legacy global timer state');
                    localStorage.removeItem(key);
                    clearedCount++;
                }
                // Remove timer states from other sessions (but keep current session if valid)
                else if (key.startsWith('exam-timer-session-') && key !== currentPersistKey) {
                    console.log('[TIMER_CLEANUP] Removing timer state from different session:', key);
                    localStorage.removeItem(key);
                    clearedCount++;
                }
            }
            
            console.log(`[TIMER_CLEANUP] Cleared ${clearedCount} stale timer states`);
            console.log(`[TIMER_CLEANUP] Current session will use persistence key: ${currentPersistKey}`);
            
        } catch (error) {
            console.warn('[TIMER_CLEANUP] Error during timer cleanup:', error);
        }
    })();
    </script>
    
    <!-- CRITICAL: Load bootstrap FIRST to ensure namespaces exist -->
    <script src="{% static 'js/bootstrap.js' %}?v={{ current_timestamp }}"></script>
    
    <!-- Load debug configuration BEFORE other modules -->
    <script src="{% static 'js/config/debug-config.js' %}?v={{ current_timestamp }}"></script>
    
    <!-- Load core utilities and config -->
    <script src="{% static 'js/config/app-config.js' %}?v={{ current_timestamp }}"></script>
    <script src="{% static 'js/utils/module-loader.js' %}?v={{ current_timestamp }}"></script>
    <script src="{% static 'js/utils/event-delegation.js' %}?v={{ current_timestamp }}"></script>
    
    <!-- Base module and helper -->
    <script src="{% static 'js/modules/base-module.js' %}?v={{ current_timestamp }}"></script>
    <script src="{% static 'js/modules/module-init-helper.js' %}?v={{ current_timestamp }}"></script>
    <script src="{% static 'js/modules/pdf-viewer.js' %}?v={{ current_timestamp }}"></script>
    <script src="{% static 'js/modules/audio-player.js' %}?v={{ current_timestamp }}"></script>
    <script src="{% static 'js/modules/timer.js' %}?v={{ current_timestamp }}"></script>
    <script src="{% static 'js/modules/answer-manager.js' %}?v={{ current_timestamp }}"></script>
    <script src="{% static 'js/modules/navigation.js' %}?v={{ current_timestamp }}"></script>
    
    <!-- Mobile Handler for touch events and responsive behavior -->
    <script src="{% static 'js/modules/mobile-handler.js' %}?v={{ current_timestamp }}"></script>
    
    <script>
    // Enhanced module initialization with comprehensive error handling
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('===== PRIMEPATH INITIALIZATION STARTING =====');
        console.log('[INIT] Page loaded at:', new Date().toISOString());
        console.log('[INIT] Current URL:', window.location.href);
        console.log('[INIT] User Agent:', navigator.userAgent);
        
        // Step 1: Verify bootstrap loaded correctly
        console.group('[INIT] Step 1: Verifying bootstrap initialization');
        
        if (window.PrimePath && window.PrimePath.state && window.PrimePath.state.bootstrapComplete) {
            console.log('  ‚úÖ Bootstrap loaded successfully');
            const health = window.PrimePath.healthCheck();
            console.log(`  ‚úÖ Health Score: ${health.score}%`);
            console.log(`  ‚úÖ Status: ${health.status}`);
        } else {
            console.error('  ‚ùå Bootstrap not loaded properly!');
            console.log('  Creating emergency namespaces...');
            // Emergency namespace creation
            window.PrimePath = window.PrimePath || {};
            window.PrimePath.utils = window.PrimePath.utils || {};
            window.PrimePath.modules = window.PrimePath.modules || {};
            window.PrimePath.state = window.PrimePath.state || {};
        }
        
        const namespaceChecks = [
            { path: 'window.PrimePath', exists: !!window.PrimePath },
            { path: 'window.PrimePath.utils', exists: !!(window.PrimePath && window.PrimePath.utils) },
            { path: 'window.PrimePath.modules', exists: !!(window.PrimePath && window.PrimePath.modules) },
            { path: 'window.APP_CONFIG', exists: !!window.APP_CONFIG }
        ];
        
        namespaceChecks.forEach(check => {
            console.log(`  ${check.exists ? '‚úÖ' : '‚ùå'} ${check.path}`);
        });
        console.groupEnd();
        
        // Step 2: Initialize Event Delegation
        console.group('[INIT] Step 2: Initializing Event Delegation');
        try {
            if (window.PrimePath.utils.EventDelegation) {
                window.PrimePath.utils.EventDelegation.init();
                console.log('  ‚úÖ EventDelegation initialized successfully');
            } else {
                console.error('  ‚ùå EventDelegation not found, creating fallback');
                // Create a minimal fallback
                window.PrimePath.utils.EventDelegation = {
                    init: function() { console.warn('Using EventDelegation fallback'); },
                    onClick: function(selector, handler) {
                        document.addEventListener('click', function(e) {
                            const el = e.target.closest(selector);
                            if (el) handler.call(el, e);
                        });
                    },
                    onChange: function(selector, handler) {
                        document.addEventListener('change', function(e) {
                            const el = e.target.closest(selector);
                            if (el) handler.call(el, e);
                        });
                    }
                };
                window.PrimePath.utils.EventDelegation.init();
            }
        } catch (error) {
            console.error('  ‚ùå EventDelegation initialization failed:', error);
        }
        console.groupEnd();
        
        // Step 3: Initialize PDF viewer with error handling
        console.group('[INIT] Step 3: Initializing PDF Viewer');
        let pdfViewer = null;
        try {
            if (window.PrimePath.modules.PDFViewer) {
                pdfViewer = new PrimePath.modules.PDFViewer({
                    enableCache: true
                });
                
                // Get PDF URL from multiple sources
                const pdfViewerElement = document.querySelector('#pdf-viewer');
                let pdfUrl = null;
                
                if (pdfViewerElement && pdfViewerElement.dataset.pdfUrl) {
                    pdfUrl = pdfViewerElement.dataset.pdfUrl;
                } else if (APP_CONFIG && APP_CONFIG.exam && APP_CONFIG.exam.pdfUrl) {
                    pdfUrl = APP_CONFIG.exam.pdfUrl;
                }
                
                if (pdfUrl) {
                    pdfViewer.init('#pdf-viewer', pdfUrl);
                    console.log('  ‚úÖ PDF Viewer initialized with URL:', pdfUrl);
                } else {
                    console.warn('  ‚ö†Ô∏è PDF URL not found, viewer inactive');
                }
            } else {
                console.error('  ‚ùå PDFViewer module not found');
            }
        } catch (error) {
            console.error('  ‚ùå PDF Viewer initialization failed:', error);
        }
        console.groupEnd();
        
        // Step 4: Initialize Timer with error handling
        console.group('[INIT] Step 4: Initializing Timer');
        let timer = null;
        try {
            if (window.PrimePath.modules.Timer) {
                // CRITICAL FIX: Use session-specific persistence key to prevent timer state conflicts
                const sessionId = (APP_CONFIG && APP_CONFIG.session && APP_CONFIG.session.id) || '{{ session.id }}' || 'unknown';
                const sessionSpecificPersistKey = `exam-timer-session-${sessionId}`;
                
                console.log('[Timer] Creating timer with session-specific persistence key:', sessionSpecificPersistKey);
                
                timer = new PrimePath.modules.Timer({
                    warnings: [
                        { time: 300, message: '5 minutes remaining', class: 'warning' },
                        { time: 60, message: '1 minute remaining', class: 'danger' }
                    ],
                    onExpire: function() {
                        console.warn('[Timer] Timer expired - beginning comprehensive cleanup and submission');
                        console.log('[Timer] Session ID:', sessionId);
                        console.log('[Timer] Current timestamp:', new Date().toISOString());
                        
                        // CRITICAL ENHANCEMENT: Check for open difficulty modal and handle cleanup
                        const difficultyModal = document.getElementById('difficulty-choice-modal');
                        if (difficultyModal && difficultyModal.style.display !== 'none') {
                            console.warn('[Timer] Difficulty choice modal is open during timer expiry - initiating modal cleanup');
                            
                            // Clear any timer monitoring interval on the modal
                            const intervalId = difficultyModal.dataset.timerCheckInterval;
                            if (intervalId) {
                                console.log('[Timer] Clearing modal timer monitoring interval:', intervalId);
                                clearInterval(parseInt(intervalId));
                                delete difficultyModal.dataset.timerCheckInterval;
                            }
                            
                            // Hide modal immediately
                            difficultyModal.style.display = 'none';
                            console.log('[Timer] Difficulty modal closed due to timer expiry');
                            
                            // Show user-friendly message about timer expiry
                            setTimeout(() => {
                                alert('Test time has expired. Your test will be submitted automatically.');
                            }, 100); // Small delay to ensure modal is hidden first
                        } else {
                            console.log('[Timer] No open modals detected during timer expiry');
                        }
                        
                        // Enhanced debugging for timer state
                        console.group('[Timer] Timer State Cleanup');
                        console.log('Timer persistence key:', sessionSpecificPersistKey);
                        console.log('Timer clearState available:', !!(timer && timer.clearState));
                        console.log('Answer manager available:', !!window.answerManager);
                        
                        // Clear this session's timer state when expired
                        if (timer && timer.clearState) {
                            timer.clearState();
                            console.log('[Timer] Session-specific timer state cleared');
                        } else {
                            console.warn('[Timer] Could not clear timer state - clearState method not available');
                        }
                        console.groupEnd();
                        
                        // Enhanced debugging for test submission
                        console.group('[Timer] Initiating Test Submission');
                        if (window.answerManager) {
                            console.log('[Timer] Calling answerManager.submitTest(true, true) - force=true, isTimerExpiry=true');
                            
                            // Add additional debugging for submission process
                            const originalLog = window.answerManager.log;
                            window.answerManager.log = function(level, message, data) {
                                console.log(`[Timer-Submission-${level.toUpperCase()}]`, message, data || '');
                                if (originalLog) {
                                    originalLog.call(this, level, message, data);
                                }
                            };
                            
                            window.answerManager.submitTest(true, true);
                        } else {
                            console.error('[Timer] CRITICAL ERROR: answerManager not available for test submission');
                            console.log('[Timer] Available window objects:', Object.keys(window).filter(key => key.includes('answer') || key.includes('test') || key.includes('manager')));
                            
                            // Fallback submission mechanism
                            console.warn('[Timer] Attempting fallback submission mechanism');
                            try {
                                const sessionId = (APP_CONFIG && APP_CONFIG.session && APP_CONFIG.session.id) || '{{ session.id }}';
                                const csrfToken = '{{ csrf_token }}';
                                
                                fetch(`/PlacementTest/session/${sessionId}/complete/`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': csrfToken
                                    },
                                    body: JSON.stringify({
                                        timer_expired: true,
                                        unsaved_count: 0,
                                        fallback_submission: true
                                    })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    console.log('[Timer] Fallback submission successful:', data);
                                    if (data.success && data.redirect_url) {
                                        window.location.href = data.redirect_url;
                                    }
                                })
                                .catch(error => {
                                    console.error('[Timer] Fallback submission failed:', error);
                                    alert('Test time expired but there was an issue submitting. Please contact support.');
                                });
                            } catch (error) {
                                console.error('[Timer] Fallback mechanism failed:', error);
                            }
                        }
                        console.groupEnd();
                        
                        console.log('[Timer] onExpire function completed');
                    },
                    // CRITICAL: Use session-specific persistence key
                    persistKey: sessionSpecificPersistKey,
                    enablePersistence: true
                });
                
                // COMPREHENSIVE TIMER INITIALIZATION WITH NULL SAFETY
                console.log('[TIMER_INIT] Looking for timer element...');
                const timerElement = document.querySelector('[data-timer-seconds]');
                
                if (timerElement) {
                    console.log('[TIMER_INIT] Timer element found, checking data attributes...');
                    
                    // Safely get timer seconds with multiple checks
                    const timerSecondsRaw = timerElement.dataset.timerSeconds;
                    console.log('[TIMER_INIT] Raw timer seconds value:', timerSecondsRaw);
                    console.log('[TIMER_INIT] Timer seconds type:', typeof timerSecondsRaw);
                    console.log('[TIMER_INIT] Timer seconds truthy:', !!timerSecondsRaw);
                    
                    // Check if the value exists and is not empty
                    if (timerSecondsRaw !== undefined && timerSecondsRaw !== null && timerSecondsRaw !== '') {
                        const timerSeconds = parseInt(timerSecondsRaw);
                        console.log('[TIMER_INIT] Parsed timer seconds:', timerSeconds);
                        
                        if (!isNaN(timerSeconds) && timerSeconds > 0) {
                            console.log('[TIMER_INIT] Valid timer value, initializing timer...');
                            
                            // COMPREHENSIVE TIMER STATE LOGGING
                            console.group('[TIMER_STATE] Pre-initialization logging');
                            console.log('Backend calculated timer_seconds:', {{ timer_seconds|default:"null" }});
                            console.log('Template timer_seconds variable:', '{{ timer_seconds }}');
                            console.log('DOM data-timer-seconds value:', timerSecondsRaw);
                            console.log('Parsed timer seconds:', timerSeconds);
                            console.log('Session ID:', sessionId);
                            console.log('Persistence key:', sessionSpecificPersistKey);
                            
                            // Check for any existing timer state that might interfere
                            try {
                                const existingState = localStorage.getItem(sessionSpecificPersistKey);
                                if (existingState) {
                                    console.log('Existing localStorage state:', existingState);
                                } else {
                                    console.log('No existing localStorage state found');
                                }
                                
                                // Also check for old global timer state that should be cleared
                                const oldGlobalState = localStorage.getItem('exam-timer');
                                if (oldGlobalState) {
                                    console.warn('Found old global timer state, clearing it:', oldGlobalState);
                                    localStorage.removeItem('exam-timer');
                                }
                            } catch (e) {
                                console.warn('Error checking localStorage:', e);
                            }
                            console.groupEnd();
                            
                            timer.init(timerSeconds, '#timer');
                            timer.start();
                            console.log('  ‚úÖ Timer initialized with', timerSeconds, 'seconds');
                            
                            // Verify timer state after initialization
                            const stats = timer.getStats();
                            console.log('[TIMER_VERIFICATION] Post-init timer stats:', stats);
                            
                        } else if (timerSeconds === 0) {
                            console.log('  ‚ÑπÔ∏è Timer set to 0 - no countdown needed');
                            // Still initialize timer but don't start it
                            timer.init(0, '#timer');
                            console.log('[TIMER_INIT] Timer initialized but not started (0 seconds)');
                        } else {
                            console.log('  ‚ö†Ô∏è Invalid timer value after parsing:', timerSeconds);
                            console.log('[TIMER_INIT] This exam appears to have no timer');
                        }
                    } else {
                        console.log('  ‚ÑπÔ∏è Timer attribute is empty or undefined - no timer for this exam');
                        console.log('[TIMER_INIT] Timer element exists but has no valid timer value');
                        console.log('[TIMER_INIT] This is normal for untimed exams');
                    }
                } else {
                    console.log('  ‚ÑπÔ∏è Timer element not found in DOM');
                    console.log('[TIMER_INIT] This may indicate the timer component was not rendered');
                }
            } else {
                console.error('  ‚ùå Timer module not found');
            }
        } catch (error) {
            console.error('  ‚ùå Timer initialization failed:', error);
        }
        console.groupEnd();
        
        // Step 5: Initialize Audio Player
        console.group('[INIT] Step 5: Initializing Audio Player');
        let audioPlayer = null;
        try {
            if (window.PrimePath.modules.AudioPlayer) {
                audioPlayer = new PrimePath.modules.AudioPlayer({
                    allowMultiple: false
                });
                audioPlayer.init();
                console.log('  ‚úÖ Audio Player initialized');
            } else {
                console.error('  ‚ùå AudioPlayer module not found');
            }
        } catch (error) {
            console.error('  ‚ùå Audio Player initialization failed:', error);
        }
        console.groupEnd();
        
        // Step 6: Initialize Answer Manager (CRITICAL MODULE)
        console.group('[INIT] Step 6: Initializing Answer Manager');
        let answerManager = null;
        
        try {
            // Check module availability
            if (!window.PrimePath.modules.AnswerManager) {
                console.error('  ‚ùå AnswerManager module not found');
                console.log('  Available modules:', Object.keys(window.PrimePath.modules || {}));
            } else {
                // Extract session and exam IDs with multiple fallbacks
                const sessionId = (APP_CONFIG && APP_CONFIG.session && APP_CONFIG.session.id) || 
                                  window.sessionId || 
                                  '{{ session.id }}' || 
                                  null;
                
                const examId = (APP_CONFIG && APP_CONFIG.exam && APP_CONFIG.exam.id) || 
                               window.examId || 
                               '{{ exam.id }}' || 
                               null;
                
                console.log('  Session ID:', sessionId);
                console.log('  Exam ID:', examId);
                
                if (sessionId && examId) {
                    try {
                        answerManager = new PrimePath.modules.AnswerManager({
                            session: APP_CONFIG && APP_CONFIG.session,
                            sessionId: sessionId,
                            examId: examId,
                            autoSave: true,
                            autoSaveInterval: 30000,
                            saveEndpoint: (APP_CONFIG && APP_CONFIG.urls && APP_CONFIG.urls.saveAnswer) || 
                                          '{% url "PlacementTest:submit_answer" session.id %}',
                            submitEndpoint: (APP_CONFIG && APP_CONFIG.urls && APP_CONFIG.urls.completeTest) || 
                                            '{% url "PlacementTest:complete_test" session.id %}'
                        });
                        
                        answerManager.init(sessionId);
                        console.log('  ‚úÖ Answer Manager initialized successfully');
                        
                    } catch (error) {
                        console.error('  ‚ùå Answer Manager initialization error:', error);
                        answerManager = null;
                    }
                } else {
                    console.error('  ‚ùå Cannot initialize: Missing session or exam ID');
                    console.log('  APP_CONFIG:', APP_CONFIG);
                }
            }
        } catch (error) {
            console.error('  ‚ùå Answer Manager setup failed:', error);
        }
        console.groupEnd();
        
        // Step 7: Make instances globally available
        console.group('[INIT] Step 7: Registering global instances');
        window.pdfViewer = pdfViewer;
        window.audioPlayer = audioPlayer;
        window.examTimer = timer;
        window.answerManager = answerManager;
        console.log('  Global instances registered:');
        console.log('    pdfViewer:', !!window.pdfViewer);
        console.log('    audioPlayer:', !!window.audioPlayer);
        console.log('    examTimer:', !!window.examTimer);
        console.log('    answerManager:', !!window.answerManager);
        console.groupEnd();
        
        // Step 8: Initialize Navigation Module
        console.group('[INIT] Step 8: Initializing Navigation');
        let navigation = null;
        try {
            if (window.PrimePath.modules.NavigationModule) {
                navigation = new PrimePath.modules.NavigationModule({
                    enableKeyboard: true,
                    enableUrlState: false,
                    autoSaveOnNavigate: true,
                    focusOnNavigate: true,
                    onBeforeNavigate: async function(from, to) {
                        return true;
                    },
                    onAfterNavigate: function(to, from) {
                        console.log(`[Navigation] Question ${from} ‚Üí ${to}`);
                    }
                });
                
                navigation.init();
                window.navigation = navigation;
                console.log('  ‚úÖ Navigation module initialized');
            } else {
                console.error('  ‚ùå NavigationModule not found');
            }
        } catch (error) {
            console.error('  ‚ùå Navigation initialization failed:', error);
        }
        console.groupEnd();
        
        // Step 9: Setup Event Handlers
        console.group('[INIT] Step 9: Setting up event handlers');
        const delegation = window.PrimePath.utils.EventDelegation;
        
        if (!delegation) {
            console.error('  ‚ùå EventDelegation not available');
        } else {
            console.log('  Setting up submit handler...');
            
            // ENHANCED: Submit button positioning manager to prevent overlap
            const submitButtonManager = {
                container: null,
                button: null,
                initialized: false,
                
                init() {
                    console.log('[SubmitButtonManager] Initializing...');
                    this.container = document.getElementById('submit-container');
                    this.button = document.getElementById('submit-test-btn');
                    
                    if (!this.container || !this.button) {
                        console.warn('[SubmitButtonManager] Submit container or button not found');
                        return false;
                    }
                    
                    this.setupResponsivePositioning();
                    this.addDebugLogging();
                    this.initialized = true;
                    console.log('[SubmitButtonManager] Initialization complete');
                    return true;
                },
                
                setupResponsivePositioning() {
                    // Check viewport width and adjust positioning
                    const checkViewport = () => {
                        const width = window.innerWidth;
                        console.log(`[SubmitButtonManager] Viewport width: ${width}px`);
                        
                        // Ultra-wide screens (1600px+) can use fixed positioning if no overlap detected
                        if (width >= 1600 && !this.detectPotentialOverlap()) {
                            this.container.classList.add('use-fixed-position');
                            console.log('[SubmitButtonManager] Using fixed positioning (ultra-wide screen)');
                        } else {
                            this.container.classList.remove('use-fixed-position');
                            console.log('[SubmitButtonManager] Using sticky footer positioning');
                        }
                    };
                    
                    // Initial check
                    checkViewport();
                    
                    // Re-check on resize with debounce
                    let resizeTimer;
                    window.addEventListener('resize', () => {
                        clearTimeout(resizeTimer);
                        resizeTimer = setTimeout(checkViewport, 250);
                    });
                },
                
                detectPotentialOverlap() {
                    // Check if there are navigation buttons that might overlap
                    const navButtons = document.querySelector('.question-nav-buttons');
                    if (!navButtons) return false;
                    
                    const navRect = navButtons.getBoundingClientRect();
                    const submitRect = this.button.getBoundingClientRect();
                    
                    // Check for vertical overlap
                    const verticalOverlap = !(navRect.bottom < submitRect.top || submitRect.bottom < navRect.top);
                    // Check for horizontal overlap
                    const horizontalOverlap = !(navRect.right < submitRect.left || submitRect.right < navRect.left);
                    
                    const hasOverlap = verticalOverlap && horizontalOverlap;
                    
                    if (hasOverlap) {
                        console.warn('[SubmitButtonManager] Potential overlap detected with navigation buttons');
                    }
                    
                    return hasOverlap;
                },
                
                addDebugLogging() {
                    // Log button interactions
                    this.button.addEventListener('mouseenter', () => {
                        console.log('[SubmitButtonManager] Mouse entered submit button');
                    });
                    
                    this.button.addEventListener('focus', () => {
                        console.log('[SubmitButtonManager] Submit button focused');
                    });
                    
                    // Monitor visibility changes
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                console.log('[SubmitButtonManager] Submit button is visible (visibility: ' + Math.round(entry.intersectionRatio * 100) + '%)');
                            } else {
                                console.log('[SubmitButtonManager] Submit button is not visible');
                            }
                        });
                    }, { threshold: [0, 0.5, 1.0] });
                    
                    observer.observe(this.button);
                }
            };
            
            // Initialize submit button manager
            submitButtonManager.init();
            window.PrimePath.submitButtonManager = submitButtonManager; // Make it globally accessible for debugging
            
            // Submit test with enhanced error handling and debugging
            delegation.onClick('[data-action="submit-test"]', function(event) {
                console.log('[Submit] Submit button clicked');
                console.log('[Submit] Event target:', event.target);
                console.log('[Submit] Current button state:', {
                    disabled: event.target.disabled,
                    classList: event.target.classList.toString()
                });
            if (!answerManager) {
                console.error('Answer manager not initialized, attempting fallback submission...');
                
                // Try to create a minimal answer manager just for submission
                const sessionId = (APP_CONFIG && APP_CONFIG.session && APP_CONFIG.session.id) || 
                                  '{{ session.id }}';
                
                if (sessionId) {
                    // Direct submission without answer manager as fallback
                    if (confirm('There was an issue with the test system. Do you want to submit your test anyway?')) {
                        const csrfToken = '{{ csrf_token }}';
                        fetch(`/api/PlacementTest/session/${sessionId}/complete/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                alert('Error submitting test. Please contact support.');
                            }
                        })
                        .catch(error => {
                            console.error('Submission error:', error);
                            alert('Unable to submit test. Please contact support.');
                        });
                    }
                } else {
                    alert('Unable to submit test: Session information is missing. Please refresh the page and try again.');
                }
                return;
            }
            
            // Normal submission path with answer manager
            try {
                const stats = answerManager.getStats();
                
                if (stats.unansweredCount > 0) {
                    const message = `You have ${stats.unansweredCount} unanswered question(s).\\n\\nAre you sure you want to submit?`;
                    if (!confirm(message)) return;
                }
                
                answerManager.submitTest();
            } catch (error) {
                console.error('Error during submission:', error);
                if (confirm('There was an error preparing your submission. Do you want to try again?')) {
                    answerManager.submitTest(true); // Force submission
                }
            }
            });
            
            // Handle answer input changes
            console.log('  Setting up answer change handler...');
            delegation.onChange('.answer-input', function(e) {
                const questionPanel = this.closest('.question-panel');
                if (questionPanel && answerManager) {
                    const questionNum = parseInt(questionPanel.dataset.questionNumber);
                    answerManager.saveAnswer(questionNum);
                    console.log(`[AnswerManager] Answer saved for question ${questionNum}`);
                }
            });
            
            // Listen to answer manager events
            if (answerManager) {
                console.log('  Setting up answer manager event listeners...');
                answerManager.on('questionAnswered', function(data) {
                    const navBtn = document.querySelector(`.question-nav-btn[data-question="${data.questionNum}"]`);
                    if (navBtn) {
                        navBtn.classList.add('answered');
                    }
                    
                    // Update progress
                    const stats = answerManager.getStats();
                    const progressEl = document.getElementById('answer-progress');
                    if (progressEl) {
                        progressEl.textContent = `${stats.answeredCount} / ${stats.totalQuestions} answered`;
                    }
                });
            }
            
            console.log('  ‚úÖ Event handlers configured');
        }
        console.groupEnd();
        
        // Navigation module handles initial question display
        // Note: All instances already made globally available above before navigation init
        
        // Difficulty Adjustment Feature
        const difficultyButtons = document.querySelectorAll('.btn-difficulty-adjust');
        
        difficultyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const direction = this.dataset.direction;
                const isIncreasing = direction === 'up';
                
                // Create warning message
                const warningTitle = isIncreasing ? '‚ö†Ô∏è Increase Test Difficulty?' : '‚ö†Ô∏è Decrease Test Difficulty?';
                const warningMessage = `
                    This will:
                    ‚Ä¢ Load a ${isIncreasing ? 'more challenging' : 'easier'} exam
                    ‚Ä¢ RESET all your current answers
                    ‚Ä¢ Restart the timer
                    ‚Ä¢ You'll lose all progress on this exam
                    
                    Are you sure you want a ${isIncreasing ? 'harder' : 'easier'} test?`;
                
                // Show confirmation dialog
                if (!confirm(warningTitle + warningMessage)) {
                    return;
                }
                
                // Disable buttons during request
                difficultyButtons.forEach(btn => btn.disabled = true);
                
                // Send request to adjust difficulty
                fetch(APP_CONFIG.urls.adjustDifficulty, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': APP_CONFIG.csrf
                    },
                    body: JSON.stringify({
                        direction: direction
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        alert(`‚úÖ Success!\n\nExam adjusted to: ${data.new_level}\n\nThe page will now reload with your new exam.`);
                        
                        // Reload the page to get the new exam
                        window.location.reload();
                    } else {
                        // Handle boundary cases or errors
                        if (data.at_boundary) {
                            alert(data.error);
                        } else {
                            alert('‚ùå Error: ' + (data.error || 'Unable to adjust difficulty'));
                        }
                        
                        // Re-enable buttons
                        difficultyButtons.forEach(btn => btn.disabled = false);
                    }
                })
                .catch(error => {
                    console.error('Error adjusting difficulty:', error);
                    alert('‚ùå An error occurred while adjusting difficulty. Please try again.');
                    
                    // Re-enable buttons
                    difficultyButtons.forEach(btn => btn.disabled = false);
                });
            });
        });
        
        // Step 10: Final Initialization Summary
        console.group('[INIT] Step 10: Initialization Summary');
        const initStatus = {
            core: {
                'APP_CONFIG': !!window.APP_CONFIG,
                'PrimePath namespace': !!window.PrimePath,
                'EventDelegation': !!window.PrimePath.utils.EventDelegation
            },
            modules: {
                'PDFViewer': !!pdfViewer,
                'Timer': !!timer,
                'AudioPlayer': !!audioPlayer,
                'AnswerManager': !!answerManager,
                'Navigation': !!navigation
            },
            critical: {
                'Session ID': !!(APP_CONFIG && APP_CONFIG.session && APP_CONFIG.session.id),
                'Exam ID': !!(APP_CONFIG && APP_CONFIG.exam && APP_CONFIG.exam.id),
                'Submit URL': !!(APP_CONFIG && APP_CONFIG.urls && APP_CONFIG.urls.completeTest)
            }
        };
        
        // Check overall health
        let successCount = 0;
        let totalCount = 0;
        
        Object.keys(initStatus).forEach(category => {
            console.group(`  ${category}:`);
            Object.keys(initStatus[category]).forEach(item => {
                const status = initStatus[category][item];
                console.log(`    ${status ? '‚úÖ' : '‚ùå'} ${item}`);
                totalCount++;
                if (status) successCount++;
            });
            console.groupEnd();
        });
        
        const successRate = Math.round((successCount / totalCount) * 100);
        console.log(`\n  Overall Success Rate: ${successRate}% (${successCount}/${totalCount})`);
        
        if (successRate < 50) {
            console.error('  ‚ö†Ô∏è CRITICAL: Less than 50% of modules initialized successfully');
            console.error('  The test interface may not function properly');
        } else if (successRate < 80) {
            console.warn('  ‚ö†Ô∏è WARNING: Some modules failed to initialize');
            console.warn('  Some features may not be available');
        } else {
            console.log('  ‚úÖ Initialization completed successfully');
        }
        
        console.groupEnd();
        console.log('===== PRIMEPATH INITIALIZATION COMPLETE =====\n\n');
    });
    </script>
</body>
</html>