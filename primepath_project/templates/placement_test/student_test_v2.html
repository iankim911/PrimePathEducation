{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ exam.name }} - Placement Test</title>
    
    <!-- Modular CSS -->
    <link rel="stylesheet" href="{% static 'css/pages/student-test.css' %}">
</head>
<body>
    <div class="page-wrapper">
        <div class="test-container">
            <!-- Test Header -->
            <div class="test-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>{{ exam.name }}</h1>
                    {% include 'components/placement_test/timer.html' with timer_seconds=timer_seconds %}
                </div>
                <div id="answer-progress" style="margin-top: 10px; color: #6c757d;">
                    0 / {{ questions|length }} answered
                </div>
            </div>
            
            <!-- Question Navigation -->
            {% include 'components/placement_test/question_nav.html' with questions=questions %}
            
            <!-- Main Content Area -->
            <div class="question-container">
                <!-- PDF Section -->
                {% include 'components/placement_test/pdf_viewer.html' with pdf_url=exam.pdf_file.url %}
                
                <!-- Question Section -->
                <div class="question-section">
                    <form id="test-form" method="post">
                        {% csrf_token %}
                        {% for question in questions %}
                            {% include 'components/placement_test/question_panel.html' with question=question questions=questions %}
                        {% endfor %}
                    </form>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="submit-container">
                <button type="button" 
                        id="submit-test-btn"
                        class="submit-test-btn"
                        data-action="submit-test">
                    Submit Test
                </button>
            </div>
        </div>
    </div>
    
    <!-- Load PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Load modular JavaScript -->
    <script src="{% static 'js/config/app-config.js' %}"></script>
    <script src="{% static 'js/utils/event-delegation.js' %}"></script>
    <script src="{% static 'js/modules/base-module.js' %}"></script>
    <script src="{% static 'js/modules/pdf-viewer.js' %}"></script>
    <script src="{% static 'js/modules/audio-player.js' %}"></script>
    <script src="{% static 'js/modules/timer.js' %}"></script>
    <script src="{% static 'js/modules/answer-manager.js' %}"></script>
    <script src="{% static 'js/modules/navigation.js' %}"></script>
    
    <!-- Store Django configuration data safely using json_script -->
    {{ js_config|json_script:"django-js-config" }}
    
    <script>
    // Initialize configuration with error handling
    (function() {
        let djangoConfig = {};
        
        try {
            // Safely parse JSON configuration from Django
            const configElement = document.getElementById('django-js-config');
            if (configElement && configElement.textContent) {
                djangoConfig = JSON.parse(configElement.textContent);
                console.log('Django config loaded successfully:', djangoConfig);
            } else {
                console.error('Django config element not found');
            }
        } catch (error) {
            console.error('Error parsing Django config:', error);
            djangoConfig = {};
        }
        
        // Build complete configuration object with defensive checks
        window.APP_CONFIG = {
            csrf: '{{ csrf_token }}',
            session: djangoConfig.session || {},
            exam: djangoConfig.exam || {},
            urls: {
                saveAnswer: '{% url "placement_test:submit_answer" session.id %}',
                completeTest: '{% url "placement_test:complete_test" session.id %}',
                getAudio: '{% url "placement_test:get_audio" 0 %}'.replace('0', '{id}')
            }
        };
        
        // Validate required data
        if (!APP_CONFIG.session.id) {
            console.error('Session ID is missing from configuration');
        }
        if (!APP_CONFIG.exam.id) {
            console.error('Exam ID is missing from configuration');
        }
    })();
    
    // Initialize modules
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize PDF viewer
        const pdfViewer = new PrimePath.modules.PDFViewer({
            scale: 1.5,
            enableCache: true
        });
        
        // Get PDF URL from multiple sources for robustness
        const pdfViewerElement = document.querySelector('#pdf-viewer');
        let pdfUrl = null;
        
        // Try to get from data attribute first (most reliable)
        if (pdfViewerElement && pdfViewerElement.dataset.pdfUrl) {
            pdfUrl = pdfViewerElement.dataset.pdfUrl;
        }
        // Fallback to APP_CONFIG
        else if (APP_CONFIG && APP_CONFIG.exam && APP_CONFIG.exam.pdfUrl) {
            pdfUrl = APP_CONFIG.exam.pdfUrl;
        }
        
        if (pdfUrl) {
            pdfViewer.init('#pdf-viewer', pdfUrl);
        } else {
            console.error('PDF URL not found in either data attribute or APP_CONFIG');
            // Show error message to user
            const errorDiv = document.querySelector('.pdf-error');
            if (errorDiv) {
                errorDiv.style.display = 'block';
            }
        }
        
        // Initialize timer
        const timer = new PrimePath.modules.Timer({
            warnings: [
                { time: 300, message: '5 minutes remaining', class: 'warning' },
                { time: 60, message: '1 minute remaining', class: 'danger' }
            ],
            onExpire: function() {
                if (window.answerManager) {
                    window.answerManager.submitTest(true);
                }
            }
        });
        
        const timerElement = document.querySelector('[data-timer-seconds]');
        if (timerElement) {
            const timerSeconds = parseInt(timerElement.dataset.timerSeconds);
            timer.init(timerSeconds, '#timer');
            timer.start();
        }
        
        // Initialize audio player
        const audioPlayer = new PrimePath.modules.AudioPlayer({
            allowMultiple: false
        });
        audioPlayer.init();
        
        // Initialize answer manager with defensive checks
        let answerManager = null;
        if (APP_CONFIG && APP_CONFIG.session && APP_CONFIG.session.id && APP_CONFIG.exam && APP_CONFIG.exam.id) {
            answerManager = new PrimePath.modules.AnswerManager({
                sessionId: APP_CONFIG.session.id,
                examId: APP_CONFIG.exam.id,
                autoSave: true,
                autoSaveInterval: 30000,
                saveEndpoint: APP_CONFIG.urls.saveAnswer,
                submitEndpoint: APP_CONFIG.urls.completeTest
            });
            answerManager.init();
            console.log('Answer manager initialized successfully');
        } else {
            console.error('Cannot initialize answer manager: missing session or exam ID');
            console.log('APP_CONFIG:', APP_CONFIG);
        }
        
        // Make instances globally available BEFORE navigation init
        window.pdfViewer = pdfViewer;
        window.audioPlayer = audioPlayer;
        window.examTimer = timer;
        window.answerManager = answerManager;
        
        // Initialize navigation module AFTER other modules are available
        const navigation = new PrimePath.modules.NavigationModule({
            enableKeyboard: true,
            enableUrlState: false,  // Disable URL state for exam security
            autoSaveOnNavigate: true,
            focusOnNavigate: true,
            onBeforeNavigate: async function(from, to) {
                // Optional: Add confirmation for unsaved changes
                return true;
            },
            onAfterNavigate: function(to, from) {
                // Optional: Track navigation for analytics
                console.log(`Navigated from question ${from} to ${to}`);
            }
        });
        
        // Initialize navigation after dependencies are available
        navigation.init();
        window.navigation = navigation;
        
        // Setup event delegation for proper event handling
        const delegation = window.PrimePath.utils.EventDelegation;
        
        // NOTE: Navigation module handles these events internally
        // We don't need to set them up here to avoid duplicate handlers
        // The navigation.init() call already sets up all navigation event handlers
        
        // Submit test
        delegation.onClick('[data-action="submit-test"]', function() {
            if (!answerManager) {
                alert('Unable to submit test: Answer manager not initialized. Please refresh the page.');
                return;
            }
            
            const stats = answerManager.getStats();
            
            if (stats.unansweredCount > 0) {
                const message = `You have ${stats.unansweredCount} unanswered question(s).\\n\\nAre you sure you want to submit?`;
                if (!confirm(message)) return;
            }
            
            answerManager.submitTest();
        });
        
        // Handle answer input changes (covers all input types: radio, checkbox, text)
        delegation.onChange('.answer-input', function(e) {
            const questionPanel = this.closest('.question-panel');
            if (questionPanel && answerManager) {
                const questionNum = parseInt(questionPanel.dataset.questionNumber);
                answerManager.saveAnswer(questionNum);
                console.log(`Answer saved for question ${questionNum}`);
            }
        });
        
        // Listen to answer manager events
        if (answerManager) {
            answerManager.on('questionAnswered', function(data) {
            const navBtn = document.querySelector(`.question-nav-btn[data-question="${data.questionNum}"]`);
            if (navBtn) {
                navBtn.classList.add('answered');
            }
            
            // Update progress
            const stats = answerManager.getStats();
            const progressEl = document.getElementById('answer-progress');
            if (progressEl) {
                progressEl.textContent = `${stats.answeredCount} / ${stats.totalQuestions} answered`;
            }
            });
        }
        
        // Navigation module handles initial question display
        // Note: All instances already made globally available above before navigation init
    });
    </script>
</body>
</html>