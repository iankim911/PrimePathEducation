{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ exam.name }} - Placement Test</title>
    
    <!-- Modular CSS -->
    <link rel="stylesheet" href="{% static 'css/pages/student-test.css' %}">
    
    <style>
        /* Difficulty Adjustment Buttons */
        .difficulty-adjustment-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn-difficulty-adjust {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-difficulty-adjust:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-difficulty-adjust:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #6c757d;
        }
        
        .btn-difficulty-adjust[data-direction="down"] {
            background: linear-gradient(135deg, #667eea 0%, #4facfe 100%);
        }
        
        .btn-difficulty-adjust[data-direction="up"] {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        @media (max-width: 768px) {
            .test-header > div {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .difficulty-adjustment-buttons {
                margin-top: 10px;
                width: 100%;
            }
            
            .btn-difficulty-adjust {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="test-container">
            <!-- Test Header -->
            <div class="test-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>{{ exam.name }}</h1>
                    {% include 'components/placement_test/timer.html' with timer_seconds=timer_seconds %}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <div id="answer-progress" style="color: #6c757d;">
                        0 / {{ questions|length }} answered
                    </div>
                    <!-- Difficulty Adjustment Buttons -->
                    <div class="difficulty-adjustment-buttons" style="display: flex; gap: 10px;">
                        <button type="button" 
                                id="decrease-difficulty-btn"
                                class="btn-difficulty-adjust"
                                data-direction="down"
                                title="Switch to an easier exam">
                            ðŸ“‰ Easier Exam
                        </button>
                        <button type="button" 
                                id="increase-difficulty-btn"
                                class="btn-difficulty-adjust"
                                data-direction="up"
                                title="Switch to a harder exam">
                            ðŸ“ˆ Harder Exam
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Question Navigation -->
            {% include 'components/placement_test/question_nav.html' with questions=questions %}
            
            <!-- Main Content Area -->
            <div class="question-container">
                <!-- PDF Section -->
                {% include 'components/placement_test/pdf_viewer.html' with pdf_url=exam.pdf_file.url %}
                
                <!-- Question Section -->
                <div class="question-section">
                    <form id="test-form" method="post">
                        {% csrf_token %}
                        {% for question in questions %}
                            {% include 'components/placement_test/question_panel.html' with question=question questions=questions %}
                        {% endfor %}
                    </form>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="submit-container">
                <button type="button" 
                        id="submit-test-btn"
                        class="submit-test-btn"
                        data-action="submit-test">
                    Submit Test
                </button>
            </div>
        </div>
    </div>
    
    <!-- Load PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Load modular JavaScript -->
    <script src="{% static 'js/config/app-config.js' %}"></script>
    <script src="{% static 'js/utils/event-delegation.js' %}"></script>
    <script src="{% static 'js/modules/base-module.js' %}"></script>
    <script src="{% static 'js/modules/pdf-viewer.js' %}"></script>
    <script src="{% static 'js/modules/audio-player.js' %}"></script>
    <script src="{% static 'js/modules/timer.js' %}"></script>
    <script src="{% static 'js/modules/answer-manager.js' %}"></script>
    <script src="{% static 'js/modules/navigation.js' %}"></script>
    
    <!-- Store Django configuration data safely using json_script -->
    {{ js_config|json_script:"django-js-config" }}
    
    <script>
    // Initialize configuration with error handling
    (function() {
        let djangoConfig = {};
        
        try {
            // Safely parse JSON configuration from Django
            const configElement = document.getElementById('django-js-config');
            if (configElement && configElement.textContent) {
                djangoConfig = JSON.parse(configElement.textContent);
                console.log('Django config loaded successfully:', djangoConfig);
            } else {
                console.error('Django config element not found');
            }
        } catch (error) {
            console.error('Error parsing Django config:', error);
            djangoConfig = {};
        }
        
        // Build complete configuration object with defensive checks
        window.APP_CONFIG = {
            csrf: '{{ csrf_token }}',
            session: djangoConfig.session || {},
            exam: djangoConfig.exam || {},
            urls: {
                saveAnswer: '{% url "placement_test:submit_answer" session.id %}',
                completeTest: '{% url "placement_test:complete_test" session.id %}',
                getAudio: '{% url "placement_test:get_audio" 0 %}'.replace('0', '{id}'),
                adjustDifficulty: '{% url "placement_test:manual_adjust_difficulty" session.id %}'
            }
        };
        
        // Validate required data
        if (!APP_CONFIG.session.id) {
            console.error('Session ID is missing from configuration');
        }
        if (!APP_CONFIG.exam.id) {
            console.error('Exam ID is missing from configuration');
        }
    })();
    
    // Initialize modules
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize event delegation first
        if (window.PrimePath && window.PrimePath.utils && window.PrimePath.utils.EventDelegation) {
            window.PrimePath.utils.EventDelegation.init();
        } else {
            console.error('EventDelegation not loaded');
        }
        
        // Initialize PDF viewer
        const pdfViewer = new PrimePath.modules.PDFViewer({
            scale: 1.5,
            enableCache: true
        });
        
        // Get PDF URL from multiple sources for robustness
        const pdfViewerElement = document.querySelector('#pdf-viewer');
        let pdfUrl = null;
        
        // Try to get from data attribute first (most reliable)
        if (pdfViewerElement && pdfViewerElement.dataset.pdfUrl) {
            pdfUrl = pdfViewerElement.dataset.pdfUrl;
        }
        // Fallback to APP_CONFIG
        else if (APP_CONFIG && APP_CONFIG.exam && APP_CONFIG.exam.pdfUrl) {
            pdfUrl = APP_CONFIG.exam.pdfUrl;
        }
        
        if (pdfUrl) {
            pdfViewer.init('#pdf-viewer', pdfUrl);
        } else {
            console.error('PDF URL not found in either data attribute or APP_CONFIG');
            // Show error message to user
            const errorDiv = document.querySelector('.pdf-error');
            if (errorDiv) {
                errorDiv.style.display = 'block';
            }
        }
        
        // Initialize timer
        const timer = new PrimePath.modules.Timer({
            warnings: [
                { time: 300, message: '5 minutes remaining', class: 'warning' },
                { time: 60, message: '1 minute remaining', class: 'danger' }
            ],
            onExpire: function() {
                if (window.answerManager) {
                    window.answerManager.submitTest(true);
                }
            }
        });
        
        const timerElement = document.querySelector('[data-timer-seconds]');
        if (timerElement) {
            const timerSeconds = parseInt(timerElement.dataset.timerSeconds);
            timer.init(timerSeconds, '#timer');
            timer.start();
        }
        
        // Initialize audio player
        const audioPlayer = new PrimePath.modules.AudioPlayer({
            allowMultiple: false
        });
        audioPlayer.init();
        
        // Initialize answer manager with enhanced defensive checks and fallbacks
        let answerManager = null;
        
        // Ensure AnswerManager class is available
        if (!window.PrimePath || !window.PrimePath.modules || !window.PrimePath.modules.AnswerManager) {
            console.error('AnswerManager module not loaded');
        } else {
            // Try to initialize with multiple fallback sources
            const sessionId = (APP_CONFIG && APP_CONFIG.session && APP_CONFIG.session.id) || 
                              window.sessionId || 
                              '{{ session.id }}' || 
                              null;
            
            const examId = (APP_CONFIG && APP_CONFIG.exam && APP_CONFIG.exam.id) || 
                           window.examId || 
                           '{{ exam.id }}' || 
                           null;
            
            if (sessionId && examId) {
                try {
                    answerManager = new PrimePath.modules.AnswerManager({
                        session: APP_CONFIG && APP_CONFIG.session,  // Pass full session object for compatibility
                        sessionId: sessionId,
                        examId: examId,
                        autoSave: true,
                        autoSaveInterval: 30000,
                        saveEndpoint: (APP_CONFIG && APP_CONFIG.urls && APP_CONFIG.urls.saveAnswer) || 
                                      '{% url "placement_test:submit_answer" session.id %}',
                        submitEndpoint: (APP_CONFIG && APP_CONFIG.urls && APP_CONFIG.urls.completeTest) || 
                                        '{% url "placement_test:complete_test" session.id %}'
                    });
                    answerManager.init();
                    console.log('Answer manager initialized successfully with session:', sessionId);
                } catch (error) {
                    console.error('Error initializing answer manager:', error);
                    answerManager = null;
                }
            } else {
                console.error('Cannot initialize answer manager: missing session or exam ID');
                console.log('Session ID:', sessionId, 'Exam ID:', examId);
                console.log('APP_CONFIG:', APP_CONFIG);
            }
        }
        
        // Make instances globally available BEFORE navigation init
        window.pdfViewer = pdfViewer;
        window.audioPlayer = audioPlayer;
        window.examTimer = timer;
        window.answerManager = answerManager;
        
        // Initialize navigation module AFTER other modules are available
        const navigation = new PrimePath.modules.NavigationModule({
            enableKeyboard: true,
            enableUrlState: false,  // Disable URL state for exam security
            autoSaveOnNavigate: true,
            focusOnNavigate: true,
            onBeforeNavigate: async function(from, to) {
                // Optional: Add confirmation for unsaved changes
                return true;
            },
            onAfterNavigate: function(to, from) {
                // Optional: Track navigation for analytics
                console.log(`Navigated from question ${from} to ${to}`);
            }
        });
        
        // Initialize navigation after dependencies are available
        navigation.init();
        window.navigation = navigation;
        
        // Setup event delegation for proper event handling
        const delegation = window.PrimePath.utils.EventDelegation;
        
        // NOTE: Navigation module handles these events internally
        // We don't need to set them up here to avoid duplicate handlers
        // The navigation.init() call already sets up all navigation event handlers
        
        // Submit test with enhanced error handling and fallback
        delegation.onClick('[data-action="submit-test"]', function() {
            if (!answerManager) {
                console.error('Answer manager not initialized, attempting fallback submission...');
                
                // Try to create a minimal answer manager just for submission
                const sessionId = (APP_CONFIG && APP_CONFIG.session && APP_CONFIG.session.id) || 
                                  '{{ session.id }}';
                
                if (sessionId) {
                    // Direct submission without answer manager as fallback
                    if (confirm('There was an issue with the test system. Do you want to submit your test anyway?')) {
                        const csrfToken = '{{ csrf_token }}';
                        fetch(`/api/placement/session/${sessionId}/complete/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                alert('Error submitting test. Please contact support.');
                            }
                        })
                        .catch(error => {
                            console.error('Submission error:', error);
                            alert('Unable to submit test. Please contact support.');
                        });
                    }
                } else {
                    alert('Unable to submit test: Session information is missing. Please refresh the page and try again.');
                }
                return;
            }
            
            // Normal submission path with answer manager
            try {
                const stats = answerManager.getStats();
                
                if (stats.unansweredCount > 0) {
                    const message = `You have ${stats.unansweredCount} unanswered question(s).\\n\\nAre you sure you want to submit?`;
                    if (!confirm(message)) return;
                }
                
                answerManager.submitTest();
            } catch (error) {
                console.error('Error during submission:', error);
                if (confirm('There was an error preparing your submission. Do you want to try again?')) {
                    answerManager.submitTest(true); // Force submission
                }
            }
        });
        
        // Handle answer input changes (covers all input types: radio, checkbox, text)
        delegation.onChange('.answer-input', function(e) {
            const questionPanel = this.closest('.question-panel');
            if (questionPanel && answerManager) {
                const questionNum = parseInt(questionPanel.dataset.questionNumber);
                answerManager.saveAnswer(questionNum);
                console.log(`Answer saved for question ${questionNum}`);
            }
        });
        
        // Listen to answer manager events
        if (answerManager) {
            answerManager.on('questionAnswered', function(data) {
            const navBtn = document.querySelector(`.question-nav-btn[data-question="${data.questionNum}"]`);
            if (navBtn) {
                navBtn.classList.add('answered');
            }
            
            // Update progress
            const stats = answerManager.getStats();
            const progressEl = document.getElementById('answer-progress');
            if (progressEl) {
                progressEl.textContent = `${stats.answeredCount} / ${stats.totalQuestions} answered`;
            }
            });
        }
        
        // Navigation module handles initial question display
        // Note: All instances already made globally available above before navigation init
        
        // Difficulty Adjustment Feature
        const difficultyButtons = document.querySelectorAll('.btn-difficulty-adjust');
        
        difficultyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const direction = this.dataset.direction;
                const isIncreasing = direction === 'up';
                
                // Create warning message
                const warningTitle = isIncreasing ? 'âš ï¸ Increase Test Difficulty?' : 'âš ï¸ Decrease Test Difficulty?';
                const warningMessage = `
                    This will:
                    â€¢ Load a ${isIncreasing ? 'more challenging' : 'easier'} exam
                    â€¢ RESET all your current answers
                    â€¢ Restart the timer
                    â€¢ You'll lose all progress on this exam
                    
                    Are you sure you want a ${isIncreasing ? 'harder' : 'easier'} test?`;
                
                // Show confirmation dialog
                if (!confirm(warningTitle + warningMessage)) {
                    return;
                }
                
                // Disable buttons during request
                difficultyButtons.forEach(btn => btn.disabled = true);
                
                // Send request to adjust difficulty
                fetch(APP_CONFIG.urls.adjustDifficulty, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': APP_CONFIG.csrf
                    },
                    body: JSON.stringify({
                        direction: direction
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        alert(`âœ… Success!\n\nExam adjusted to: ${data.new_level}\n\nThe page will now reload with your new exam.`);
                        
                        // Reload the page to get the new exam
                        window.location.reload();
                    } else {
                        // Handle boundary cases or errors
                        if (data.at_boundary) {
                            alert(data.error);
                        } else {
                            alert('âŒ Error: ' + (data.error || 'Unable to adjust difficulty'));
                        }
                        
                        // Re-enable buttons
                        difficultyButtons.forEach(btn => btn.disabled = false);
                    }
                })
                .catch(error => {
                    console.error('Error adjusting difficulty:', error);
                    alert('âŒ An error occurred while adjusting difficulty. Please try again.');
                    
                    // Re-enable buttons
                    difficultyButtons.forEach(btn => btn.disabled = false);
                });
            });
        });
    });
    </script>
</body>
</html>