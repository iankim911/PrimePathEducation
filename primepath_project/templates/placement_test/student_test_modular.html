{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ exam.name }} - Placement Test</title>
    
    <!-- Keep existing styles from original template -->
    <link rel="stylesheet" href="{% static 'css/student_test.css' %}">
    
    <style>
        /* Core styles - extracted from original */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .test-header {
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 8px;
            margin-bottom: 3px;
        }
        
        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc3545;
        }
        
        /* Audio module styles */
        .question-audio-module {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .audio-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .audio-play-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .audio-play-btn:hover {
            background: #0056b3;
        }
        
        .audio-play-btn.playing {
            background: #28a745;
        }
        
        .audio-progress-track {
            height: 4px;
            background: #dee2e6;
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .audio-progress-fill {
            height: 100%;
            background: #007bff;
            width: 0;
            transition: width 0.1s;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="test-container">
            <!-- Test Header -->
            <div class="test-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>{{ exam.name }}</h1>
                    <div class="timer-container">
                        <span>Time Remaining: </span>
                        <span id="timer" class="timer-display">--:--</span>
                    </div>
                </div>
                <div id="answer-progress" style="margin-top: 10px; color: #6c757d;">
                    0 / {{ questions|length }} answered
                </div>
            </div>
            
            <!-- Question Navigation -->
            <div class="question-nav">
                {% for question in questions %}
                <button type="button" 
                        class="question-nav-btn" 
                        data-question="{{ question.question_number }}"
                        data-action="navigate-question">
                    {{ question.question_number }}
                </button>
                {% endfor %}
            </div>
            
            <!-- Main Content Area -->
            <div class="question-container">
                <!-- PDF Section -->
                <div class="pdf-section">
                    <div id="pdf-viewer">
                        <canvas id="pdf-canvas"></canvas>
                    </div>
                    
                    <!-- PDF Navigation -->
                    <div class="pdf-controls" style="padding: 10px; text-align: center;">
                        <button data-pdf-action="prev" class="btn">Previous</button>
                        <span id="page-info" style="margin: 0 10px;">
                            Page <span id="current-page">1</span> of <span id="total-pages">0</span>
                        </span>
                        <button data-pdf-action="next" class="btn">Next</button>
                    </div>
                </div>
                
                <!-- Question Panels -->
                <div class="question-section">
                    {% for question in questions %}
                    <div id="question-{{ question.question_number }}" 
                         class="question-panel {% if question.question_number != 1 %}hidden{% endif %}"
                         data-question-id="{{ question.id }}"
                         data-question-number="{{ question.question_number }}">
                        
                        <h3>Question {{ question.question_number }}</h3>
                        
                        <!-- Audio Section (if applicable) -->
                        {% if question.audio_file %}
                        <div class="question-audio-module">
                            <div class="audio-header">
                                <span class="audio-header-icon">üéµ</span>
                                <span class="audio-header-text">{{ question.audio_file.name }}</span>
                            </div>
                            <div class="audio-clips-container">
                                <div class="audio-clip-item">
                                    <button type="button" 
                                            class="audio-play-btn" 
                                            id="audio-play-{{ question.audio_file.id }}"
                                            data-audio-play="{{ question.audio_file.id }}">
                                        <span id="audio-icon-{{ question.audio_file.id }}">‚ñ∂</span>
                                        <span>Play Audio</span>
                                    </button>
                                    <div class="audio-info-text">Listen carefully before answering</div>
                                    <audio id="audio-element-{{ question.audio_file.id }}" 
                                           preload="none">
                                        <source src="{% url 'placement_test:get_audio' question.audio_file.id %}" type="audio/mpeg">
                                    </audio>
                                    <div class="audio-progress-track" id="progress-track-{{ question.audio_file.id }}">
                                        <div class="audio-progress-fill" id="progress-fill-{{ question.audio_file.id }}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Points Display -->
                        <div class="points-display" style="margin: 15px 0; padding: 10px; background: #e8f5e8; border-left: 4px solid #28a745; border-radius: 4px;">
                            <span style="color: #155724; font-weight: 500;">
                                Worth {{ question.points }} point{% if question.points != 1 %}s{% endif %}
                            </span>
                        </div>
                        
                        <!-- Answer Options -->
                        <div class="answer-options">
                            {% if question.question_type == 'MCQ' and ',' not in question.correct_answer %}
                                <!-- Single Choice (Radio Buttons) -->
                                {% with letters="ABCDEFGHIJ"|slice:question.options_count %}
                                {% for letter in letters %}
                                <div style="margin-bottom: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" 
                                               name="q_{{ question.id }}" 
                                               value="{{ letter }}"
                                               data-question-num="{{ question.question_number }}">
                                        <span style="margin-left: 10px; font-weight: bold;">{{ letter }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                                {% endwith %}
                                
                            {% elif question.question_type == 'MCQ' and ',' in question.correct_answer or question.question_type == 'CHECKBOX' %}
                                <!-- Multiple Choice (Checkboxes) -->
                                {% with letters="ABCDEFGHIJ"|slice:question.options_count %}
                                {% for letter in letters %}
                                <div style="margin-bottom: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" 
                                               name="q_{{ question.id }}_{{ letter }}" 
                                               value="{{ letter }}"
                                               data-question-num="{{ question.question_number }}">
                                        <span style="margin-left: 10px; font-weight: bold;">{{ letter }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                                {% endwith %}
                                
                            {% elif question.question_type == 'SHORT' %}
                                <!-- Short Answer -->
                                <input type="text" 
                                       name="q_{{ question.id }}"
                                       class="form-control"
                                       placeholder="Type your answer here"
                                       data-question-num="{{ question.question_number }}"
                                       style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                       
                            {% elif question.question_type == 'LONG' %}
                                <!-- Long Answer -->
                                <textarea name="q_{{ question.id }}"
                                          class="form-control"
                                          rows="5"
                                          placeholder="Type your answer here"
                                          data-question-num="{{ question.question_number }}"
                                          style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"></textarea>
                            {% endif %}
                        </div>
                        
                        <!-- Navigation Buttons -->
                        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                            {% if question.question_number > 1 %}
                            <button type="button" 
                                    class="btn btn-secondary"
                                    data-action="prev-question"
                                    data-target="{{ question.question_number|add:-1 }}">
                                ‚Üê Previous
                            </button>
                            {% else %}
                            <div></div>
                            {% endif %}
                            
                            {% if question.question_number < questions|length %}
                            <button type="button" 
                                    class="btn btn-primary"
                                    data-action="next-question"
                                    data-target="{{ question.question_number|add:1 }}">
                                Next ‚Üí
                            </button>
                            {% else %}
                            <button type="button" 
                                    class="btn btn-success"
                                    data-action="review-test">
                                Review & Submit
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="submit-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
                <button type="button" 
                        id="submit-test-btn"
                        class="btn btn-success btn-lg"
                        data-action="submit-test"
                        style="padding: 12px 24px; font-size: 1.1rem;">
                    Submit Test
                </button>
            </div>
        </div>
    </div>
    
    <!-- Load PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Load modular JavaScript -->
    <script src="{% static 'js/config/app-config.js' %}"></script>
    <script src="{% static 'js/utils/event-delegation.js' %}"></script>
    <script src="{% static 'js/modules/base-module.js' %}"></script>
    <script src="{% static 'js/modules/pdf-viewer.js' %}"></script>
    <script src="{% static 'js/modules/audio-player.js' %}"></script>
    <script src="{% static 'js/modules/timer.js' %}"></script>
    <script src="{% static 'js/modules/answer-manager.js' %}"></script>
    
    <script>
    // Inject configuration from Django
    window.APP_CONFIG = {
        csrf: '{{ csrf_token }}',
        session: {
            id: '{{ session.id }}',
            examId: {{ exam.id }},
            timerSeconds: {{ timer_seconds }}
        },
        exam: {
            id: {{ exam.id }},
            name: '{{ exam.name|escapejs }}',
            pdfUrl: '{{ exam.pdf_file.url }}'
        },
        urls: {
            saveAnswer: '{% url "placement_test:submit_answer" session.id %}',
            completeTest: '/api/placement/session/{{ session.id }}/complete/',
            getAudio: '{% url "placement_test:get_audio" 0 %}'.replace('0', '{id}')
        }
    };
    
    // Initialize modules
    document.addEventListener('DOMContentLoaded', function() {
        const config = new PrimePath.config.AppConfig();
        
        // Initialize PDF viewer
        const pdfViewer = new PrimePath.modules.PDFViewer({
            virtualPages: true, // Enable split view for 2-column PDFs
            scale: 1.5,
            enableCache: true
        });
        pdfViewer.init('#pdf-viewer', APP_CONFIG.exam.pdfUrl);
        
        // Initialize audio player
        const audioPlayer = new PrimePath.modules.AudioPlayer({
            allowMultiple: false,
            enableKeyboard: true
        });
        audioPlayer.init();
        audioPlayer.migrateInlineHandlers(); // Convert existing onclick handlers
        
        // Initialize timer
        const timer = new PrimePath.modules.Timer({
            warnings: [
                { time: 300, message: '5 minutes remaining', class: 'warning' },
                { time: 60, message: '1 minute remaining', class: 'danger' },
                { time: 30, message: '30 seconds remaining', class: 'critical' }
            ],
            onExpire: function() {
                // Auto-submit when time expires
                answerManager.submitTest(true);
            },
            enablePersistence: true,
            persistKey: `exam-timer-${APP_CONFIG.session.id}`
        });
        timer.init(APP_CONFIG.session.timerSeconds, '#timer');
        timer.start();
        
        // Initialize answer manager
        const answerManager = new PrimePath.modules.AnswerManager({
            sessionId: APP_CONFIG.session.id,
            examId: APP_CONFIG.exam.id,
            autoSave: true,
            autoSaveInterval: 30000, // 30 seconds
            saveEndpoint: APP_CONFIG.urls.saveAnswer,
            submitEndpoint: APP_CONFIG.urls.completeTest,
            requireAllAnswers: false
        });
        answerManager.init();
        
        // Question navigation
        let currentQuestion = 1;
        
        function showQuestion(num) {
            // Hide all questions
            document.querySelectorAll('.question-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            // Show target question
            const targetPanel = document.getElementById(`question-${num}`);
            if (targetPanel) {
                targetPanel.classList.remove('hidden');
                currentQuestion = num;
                
                // Update navigation buttons
                document.querySelectorAll('.question-nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const activeBtn = document.querySelector(`.question-nav-btn[data-question="${num}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                // Stop any playing audio
                audioPlayer.stopAll();
            }
        }
        
        // Setup event delegation for navigation
        const delegation = window.PrimePath.utils.EventDelegation;
        
        // Question navigation buttons
        delegation.onClick('[data-action="navigate-question"]', function(e) {
            const questionNum = parseInt(e.currentTarget.dataset.question);
            showQuestion(questionNum);
        });
        
        // Next/Previous buttons
        delegation.onClick('[data-action="next-question"]', function(e) {
            const target = parseInt(e.currentTarget.dataset.target);
            showQuestion(target);
        });
        
        delegation.onClick('[data-action="prev-question"]', function(e) {
            const target = parseInt(e.currentTarget.dataset.target);
            showQuestion(target);
        });
        
        // Review test
        delegation.onClick('[data-action="review-test"]', function() {
            const stats = answerManager.getStats();
            const unanswered = stats.unansweredQuestions;
            
            if (unanswered.length > 0) {
                const message = `You have ${unanswered.length} unanswered question(s): ${unanswered.join(', ')}.\n\nDo you want to review them?`;
                if (confirm(message)) {
                    showQuestion(unanswered[0]);
                    return;
                }
            }
            
            if (confirm('Are you ready to submit your test?')) {
                answerManager.submitTest();
            }
        });
        
        // Submit test
        delegation.onClick('[data-action="submit-test"]', function() {
            const stats = answerManager.getStats();
            
            if (stats.unansweredCount > 0) {
                const message = `You have ${stats.unansweredCount} unanswered question(s).\n\nAre you sure you want to submit?`;
                if (!confirm(message)) return;
            }
            
            answerManager.submitTest();
        });
        
        // Listen to answer manager events
        answerManager.on('questionAnswered', function(data) {
            const navBtn = document.querySelector(`.question-nav-btn[data-question="${data.questionNum}"]`);
            if (navBtn) {
                navBtn.classList.add('answered');
            }
            
            // Update progress
            const stats = answerManager.getStats();
            const progressEl = document.getElementById('answer-progress');
            if (progressEl) {
                progressEl.textContent = `${stats.answeredCount} / ${stats.totalQuestions} answered`;
            }
        });
        
        answerManager.on('testSubmitted', function(data) {
            // Timer will stop automatically
            timer.stop();
        });
        
        // Make instances globally available for debugging
        window.pdfViewer = pdfViewer;
        window.audioPlayer = audioPlayer;
        window.examTimer = timer;
        window.answerManager = answerManager;
        
        // Show first question
        showQuestion(1);
    });
    </script>
</body>
</html>