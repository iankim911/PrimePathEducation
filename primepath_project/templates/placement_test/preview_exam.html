{% extends 'base.html' %}

{% block title %}Preview Exam - {{ exam.name }} - PrimePath{% endblock %}

{% block header %}Preview: {{ exam.name }}{% endblock %}

{% block extra_css %}
<style>
    .preview-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .exam-info {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .info-item {
        padding: 10px;
        background: white;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }
    
    .info-label {
        font-weight: bold;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .info-value {
        color: #212529;
        font-size: 1.1rem;
    }
    
    .pdf-preview {
        margin-top: 30px;
    }
    
    .pdf-controls {
        text-align: center;
        margin-bottom: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    .pdf-viewer {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        height: 800px;
        overflow: auto;
        text-align: center;
        background-color: #f5f5f5;
    }
    
    .action-buttons {
        margin-top: 30px;
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    
    .audio-section {
        margin-top: 30px;
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }
    
    .audio-list {
        margin-top: 15px;
    }
    
    .audio-item {
        background: white;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Move scripts to bottom of content block instead -->
{% endblock %}

{% block content %}
<div class="preview-container">
    <!-- Exam Information -->
    <div class="exam-info">
        <h2>Exam Information</h2>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Exam Name</div>
                <div class="info-value">{{ exam.name }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Duration</div>
                <div class="info-value">{{ exam.timer_minutes }} minutes</div>
            </div>
            <div class="info-item">
                <div class="info-label">Total Questions</div>
                <div class="info-value">{{ exam.total_questions }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Status</div>
                <div class="info-value">
                    {% if exam.is_active %}
                        <span style="color: #28a745;">Active</span>
                    {% else %}
                        <span style="color: #dc3545;">Inactive</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">Created</div>
                <div class="info-value">{{ exam.created_at|date:"M d, Y" }}</div>
            </div>
        </div>
    </div>
    
    <!-- Audio Files Section -->
    {% if exam.audio_files.exists %}
    <div class="audio-section">
        <h3>Audio Files ({{ exam.audio_files.count }})</h3>
        <div class="audio-list">
            {% for audio in exam.audio_files.all %}
            <div class="audio-item">
                <strong>Audio {{ forloop.counter }}:</strong> 
                Questions {{ audio.start_question }}-{{ audio.end_question }}
                <audio controls style="margin-left: 20px;">
                    <source src="{% url 'placement_test:get_audio' audio_id=audio.id %}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- PDF Preview -->
    <div class="pdf-preview">
        <h3>Exam PDF Preview</h3>
        <div class="pdf-controls">
            <button type="button" id="pdf-prev" class="btn btn-secondary btn-sm" disabled>
                ← Previous
            </button>
            <span id="pdf-page-info" style="margin: 0 20px;">Page 1 of 1</span>
            <button type="button" id="pdf-next" class="btn btn-secondary btn-sm">
                Next →
            </button>
            <span style="margin-left: 30px;">
                <button type="button" id="pdf-zoom-out" class="btn btn-secondary btn-sm">Zoom Out</button>
                <span id="pdf-zoom-level" style="margin: 0 10px;">100%</span>
                <button type="button" id="pdf-zoom-in" class="btn btn-secondary btn-sm">Zoom In</button>
            </span>
        </div>
        <div class="pdf-viewer" id="pdf-viewer">
            <div id="pdf-loading" style="padding: 50px;">
                <p>Loading PDF...</p>
            </div>
            <canvas id="pdf-canvas" style="display: none;"></canvas>
            <div id="pdf-error" style="display: none; padding: 50px; color: #dc3545;">
                <p>Error loading PDF. Please try refreshing the page.</p>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{% url 'placement_test:exam_list' %}" class="btn btn-secondary">Back to Exam List</a>
        <a href="{{ exam.pdf_file.url }}" class="btn btn-primary" download>Download PDF</a>
    </div>
</div>

<!-- Load PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
// Set worker source
if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
} else {
    console.error('PDF.js library failed to load');
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // PDF preview variables
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let currentScale = 1.0;

    // Check if PDF.js is loaded
    if (typeof pdfjsLib === 'undefined') {
        document.getElementById('pdf-loading').style.display = 'none';
        document.getElementById('pdf-error').style.display = 'block';
        console.error('PDF.js library not loaded');
    } else {
        // Load PDF
        const pdfUrl = "{{ exam.pdf_file.url }}";
        pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
            pdfDoc = pdf;
            totalPages = pdf.numPages;
            document.getElementById('pdf-page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            updateNavigationButtons();
            
            // Hide loading, show canvas
            document.getElementById('pdf-loading').style.display = 'none';
            document.getElementById('pdf-canvas').style.display = 'block';
            
            renderPage(currentPage);
        }).catch(function(error) {
            console.error('Error loading PDF:', error);
            document.getElementById('pdf-loading').style.display = 'none';
            document.getElementById('pdf-error').style.display = 'block';
        });
    }

    // Render PDF page
    function renderPage(pageNum) {
        if (!pdfDoc) return;
    
        pdfDoc.getPage(pageNum).then(function(page) {
            const canvas = document.getElementById('pdf-canvas');
            const ctx = canvas.getContext('2d');
            
            const viewport = page.getViewport({ scale: currentScale });
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            page.render(renderContext);
        });
    }

    // Update navigation buttons
    function updateNavigationButtons() {
        document.getElementById('pdf-prev').disabled = currentPage <= 1;
        document.getElementById('pdf-next').disabled = currentPage >= totalPages;
    }

    // Previous page
    document.getElementById('pdf-prev').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            document.getElementById('pdf-page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            renderPage(currentPage);
            updateNavigationButtons();
        }
    });

    // Next page
    document.getElementById('pdf-next').addEventListener('click', function() {
        if (currentPage < totalPages) {
            currentPage++;
            document.getElementById('pdf-page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            renderPage(currentPage);
            updateNavigationButtons();
        }
    });

    // Zoom controls
    document.getElementById('pdf-zoom-in').addEventListener('click', function() {
        currentScale = Math.min(currentScale * 1.2, 3.0);
        document.getElementById('pdf-zoom-level').textContent = Math.round(currentScale * 100) + '%';
        renderPage(currentPage);
    });

    document.getElementById('pdf-zoom-out').addEventListener('click', function() {
        currentScale = Math.max(currentScale / 1.2, 0.5);
        document.getElementById('pdf-zoom-level').textContent = Math.round(currentScale * 100) + '%';
        renderPage(currentPage);
    });

}); // End DOMContentLoaded
</script>
{% endblock %}