{% extends "unified_base.html" %}
{% block module_name %}core{% endblock %}{% comment %}
Migrated to unified_base.html on 2025-08-26
Original base template: base.html
{% endcomment %}

{% load static %}

{% block title %}Contact Information - Step 3{% endblock %}

{% block extra_css %}
<style>
    .registration-container {
        max-width: 600px;
        margin: 50px auto;
        padding: 30px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .progress-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        position: relative;
    }
    
    .progress-bar::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e0e0e0;
        z-index: -1;
    }
    
    .progress-step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e0e0e0;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        position: relative;
        background: white;
        border: 2px solid #e0e0e0;
    }
    
    .progress-step.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .progress-step.completed {
        background: #28a745;
        color: white;
        border-color: #28a745;
    }
    
    .step-label {
        position: absolute;
        top: 50px;
        width: 100px;
        text-align: center;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        color: #666;
    }
    
    .form-section {
        margin-bottom: 30px;
    }
    
    .form-section h3 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.3rem;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }
    
    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }
    
    .form-group label .required {
        color: #dc3545;
        margin-left: 3px;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 15px;
        transition: border-color 0.3s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .form-control.is-invalid {
        border-color: #dc3545;
    }
    
    .invalid-feedback {
        display: none;
        color: #dc3545;
        font-size: 13px;
        margin-top: 5px;
    }
    
    .form-control.is-invalid ~ .invalid-feedback {
        display: block;
    }
    
    .help-text {
        font-size: 13px;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .phone-input-group {
        display: flex;
        gap: 10px;
    }
    
    .phone-country-code {
        width: 100px;
    }
    
    .verification-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    .verification-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
    }
    
    .verification-code-input {
        flex: 1;
        max-width: 200px;
    }
    
    .btn-verify {
        padding: 10px 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.3s;
    }
    
    .btn-verify:hover {
        background: #218838;
    }
    
    .btn-send-code {
        padding: 10px 20px;
        background: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.3s;
    }
    
    .btn-send-code:hover {
        background: #138496;
    }
    
    .btn-send-code:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .verification-status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 10px;
    }
    
    .verification-status.verified {
        background: #d4edda;
        color: #155724;
    }
    
    .verification-status.pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid #e0e0e0;
    }
    
    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
    }
    
    .address-input textarea {
        min-height: 80px;
        resize: vertical;
    }
    
    .postal-code-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .btn-find-address {
        padding: 10px 20px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
    }
    
    .btn-find-address:hover {
        background: #545b62;
    }
    
    .timer-display {
        font-size: 14px;
        color: #dc3545;
        margin-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="registration-container">
    <h2 style="text-align: center; color: #333; margin-bottom: 30px;">Contact Information</h2>
    
    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-step completed">
            ✓
            <span class="step-label">Basic Info</span>
        </div>
        <div class="progress-step completed">
            ✓
            <span class="step-label">Personal</span>
        </div>
        <div class="progress-step active">
            3
            <span class="step-label">Contact</span>
        </div>
        <div class="progress-step">
            4
            <span class="step-label">Academic</span>
        </div>
        <div class="progress-step">
            5
            <span class="step-label">Parent Info</span>
        </div>
        <div class="progress-step">
            6
            <span class="step-label">Additional</span>
        </div>
    </div>
    
    <form method="post" id="contactInfoForm">
        {% csrf_token %}
        
        <div class="form-section">
            <h3>Phone Number</h3>
            
            <div class="form-group">
                <label for="phone_number">
                    Primary Phone Number
                    <span class="required">*</span>
                </label>
                <div class="phone-input-group">
                    <select class="form-control phone-country-code" id="phone_country_code" name="phone_country_code">
                        <option value="+82">+82 (KR)</option>
                        <option value="+1">+1 (US)</option>
                        <option value="+86">+86 (CN)</option>
                        <option value="+81">+81 (JP)</option>
                        <option value="+84">+84 (VN)</option>
                        <option value="+63">+63 (PH)</option>
                        <option value="+66">+66 (TH)</option>
                        <option value="+65">+65 (SG)</option>
                        <option value="+60">+60 (MY)</option>
                    </select>
                    <input type="tel" 
                           class="form-control" 
                           id="phone_number" 
                           name="phone_number" 
                           required
                           placeholder="010-1234-5678"
                           pattern="[0-9-]+"
                           value="{{ form.phone_number.value|default:'' }}">
                </div>
                <div class="invalid-feedback">Please enter a valid phone number.</div>
                <div class="help-text">Enter number without country code</div>
            </div>
            
            <div class="verification-section" id="phoneVerification" style="display: none;">
                <p style="margin-bottom: 10px; font-weight: 500;">Phone Verification</p>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                    We'll send you a 6-digit code to verify your phone number.
                </p>
                <button type="button" class="btn-send-code" id="sendPhoneCode">
                    Send Verification Code
                </button>
                <span class="timer-display" id="phoneTimer" style="display: none;"></span>
                
                <div class="verification-input-group" id="phoneCodeInput" style="display: none; margin-top: 15px;">
                    <input type="text" 
                           class="form-control verification-code-input" 
                           id="phone_verification_code" 
                           name="phone_verification_code"
                           placeholder="Enter 6-digit code"
                           maxlength="6"
                           pattern="[0-9]{6}">
                    <button type="button" class="btn-verify" id="verifyPhoneCode">
                        Verify
                    </button>
                    <span class="verification-status pending" id="phoneStatus" style="display: none;">
                        Pending
                    </span>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="secondary_phone">
                    Secondary Phone Number
                </label>
                <input type="tel" 
                       class="form-control" 
                       id="secondary_phone" 
                       name="secondary_phone" 
                       placeholder="Optional secondary number"
                       value="{{ form.secondary_phone.value|default:'' }}">
            </div>
        </div>
        
        <div class="form-section">
            <h3>Address</h3>
            
            <div class="form-group">
                <label for="postal_code">
                    Postal Code
                    <span class="required">*</span>
                </label>
                <div class="postal-code-group">
                    <input type="text" 
                           class="form-control" 
                           id="postal_code" 
                           name="postal_code" 
                           required
                           placeholder="12345"
                           maxlength="5"
                           pattern="[0-9]{5}"
                           value="{{ form.postal_code.value|default:'' }}">
                    <button type="button" class="btn-find-address" id="findAddressBtn">
                        Find Address
                    </button>
                </div>
                <div class="help-text">Enter 5-digit postal code (Korean zip code)</div>
            </div>
            
            <div class="form-group">
                <label for="address_line1">
                    Address Line 1
                    <span class="required">*</span>
                </label>
                <input type="text" 
                       class="form-control" 
                       id="address_line1" 
                       name="address_line1" 
                       required
                       placeholder="Street address or P.O. box"
                       value="{{ form.address_line1.value|default:'' }}">
                <div class="invalid-feedback">Address is required.</div>
            </div>
            
            <div class="form-group">
                <label for="address_line2">
                    Address Line 2
                </label>
                <input type="text" 
                       class="form-control" 
                       id="address_line2" 
                       name="address_line2" 
                       placeholder="Apartment, suite, unit, building, floor, etc."
                       value="{{ form.address_line2.value|default:'' }}">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="city">
                        City
                        <span class="required">*</span>
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="city" 
                           name="city" 
                           required
                           placeholder="City"
                           value="{{ form.city.value|default:'' }}">
                </div>
                
                <div class="form-group">
                    <label for="state_province">
                        State/Province
                        <span class="required">*</span>
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="state_province" 
                           name="state_province" 
                           required
                           placeholder="State or Province"
                           value="{{ form.state_province.value|default:'' }}">
                </div>
            </div>
            
            <div class="form-group">
                <label for="country">
                    Country
                    <span class="required">*</span>
                </label>
                <select class="form-control" id="country" name="country" required>
                    <option value="">Select country</option>
                    <option value="KR" selected>South Korea</option>
                    <option value="US">United States</option>
                    <option value="CN">China</option>
                    <option value="JP">Japan</option>
                    <option value="VN">Vietnam</option>
                    <option value="PH">Philippines</option>
                    <option value="TH">Thailand</option>
                    <option value="ID">Indonesia</option>
                    <option value="MY">Malaysia</option>
                    <option value="SG">Singapore</option>
                    <option value="IN">India</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Emergency Contact</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="emergency_contact_name">
                        Contact Name
                        <span class="required">*</span>
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="emergency_contact_name" 
                           name="emergency_contact_name" 
                           required
                           placeholder="Emergency contact person's name"
                           value="{{ form.emergency_contact_name.value|default:'' }}">
                </div>
                
                <div class="form-group">
                    <label for="emergency_contact_relationship">
                        Relationship
                        <span class="required">*</span>
                    </label>
                    <select class="form-control" id="emergency_contact_relationship" name="emergency_contact_relationship" required>
                        <option value="">Select relationship</option>
                        <option value="parent">Parent</option>
                        <option value="guardian">Guardian</option>
                        <option value="spouse">Spouse</option>
                        <option value="sibling">Sibling</option>
                        <option value="relative">Other Relative</option>
                        <option value="friend">Friend</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="emergency_contact_phone">
                    Emergency Contact Phone
                    <span class="required">*</span>
                </label>
                <input type="tel" 
                       class="form-control" 
                       id="emergency_contact_phone" 
                       name="emergency_contact_phone" 
                       required
                       placeholder="Emergency contact phone number"
                       value="{{ form.emergency_contact_phone.value|default:'' }}">
            </div>
        </div>
        
        <!-- Error messages -->
        {% if form.errors %}
        <div class="alert alert-danger">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="form-actions">
            <a href="{% url 'registration:step' 'personal' %}" class="btn btn-secondary">
                ← Back to Step 2
            </a>
            <button type="submit" class="btn btn-primary">
                Continue to Step 4 →
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Phone number formatting
    const phoneInput = document.getElementById('phone_number');
    const phoneVerificationSection = document.getElementById('phoneVerification');
    const sendPhoneCodeBtn = document.getElementById('sendPhoneCode');
    const phoneCodeInputGroup = document.getElementById('phoneCodeInput');
    const verifyPhoneBtn = document.getElementById('verifyPhoneCode');
    const phoneTimer = document.getElementById('phoneTimer');
    const phoneStatus = document.getElementById('phoneStatus');
    
    // Show verification section when phone number is entered
    phoneInput.addEventListener('input', function() {
        const phoneValue = this.value.replace(/[^0-9]/g, '');
        if (phoneValue.length >= 10) {
            phoneVerificationSection.style.display = 'block';
        } else {
            phoneVerificationSection.style.display = 'none';
        }
        
        // Format phone number
        if (phoneValue.length === 10) {
            this.value = phoneValue.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
        } else if (phoneValue.length === 11) {
            this.value = phoneValue.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
        }
    });
    
    // Send verification code
    let countdownInterval;
    sendPhoneCodeBtn.addEventListener('click', function() {
        this.disabled = true;
        phoneCodeInputGroup.style.display = 'flex';
        phoneTimer.style.display = 'inline';
        
        // Start countdown timer
        let timeLeft = 180; // 3 minutes
        phoneTimer.textContent = formatTime(timeLeft);
        
        countdownInterval = setInterval(() => {
            timeLeft--;
            phoneTimer.textContent = formatTime(timeLeft);
            
            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                sendPhoneCodeBtn.disabled = false;
                sendPhoneCodeBtn.textContent = 'Resend Code';
                phoneTimer.style.display = 'none';
            }
        }, 1000);
        
        // Simulate sending code (in real app, make AJAX request)
        console.log('Sending verification code to:', phoneInput.value);
    });
    
    // Verify code
    verifyPhoneBtn.addEventListener('click', function() {
        const code = document.getElementById('phone_verification_code').value;
        if (code.length === 6) {
            // Simulate verification (in real app, make AJAX request)
            phoneStatus.style.display = 'inline-block';
            phoneStatus.textContent = 'Verified';
            phoneStatus.className = 'verification-status verified';
            
            // Disable verification inputs
            document.getElementById('phone_verification_code').disabled = true;
            verifyPhoneBtn.disabled = true;
            sendPhoneCodeBtn.disabled = true;
            
            clearInterval(countdownInterval);
            phoneTimer.style.display = 'none';
        }
    });
    
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Find address button (Korean postal code lookup)
    document.getElementById('findAddressBtn').addEventListener('click', function() {
        const postalCode = document.getElementById('postal_code').value;
        if (postalCode.length === 5) {
            // In a real app, this would call a Korean address API
            // For now, we'll just show an alert
            alert('Address lookup would be performed here using postal code: ' + postalCode);
            
            // Example of auto-filling address fields
            // document.getElementById('address_line1').value = 'Example Street Address';
            // document.getElementById('city').value = 'Seoul';
            // document.getElementById('state_province').value = 'Seoul';
        } else {
            alert('Please enter a valid 5-digit postal code');
        }
    });
    
    // Form validation
    document.getElementById('contactInfoForm').addEventListener('submit', function(e) {
        let isValid = true;
        
        // Validate phone number
        const phone = document.getElementById('phone_number').value;
        const phoneRegex = /^[0-9]{3}-[0-9]{3,4}-[0-9]{4}$/;
        if (!phoneRegex.test(phone)) {
            document.getElementById('phone_number').classList.add('is-invalid');
            isValid = false;
        }
        
        // Validate postal code
        const postalCode = document.getElementById('postal_code').value;
        if (!/^[0-9]{5}$/.test(postalCode)) {
            document.getElementById('postal_code').classList.add('is-invalid');
            isValid = false;
        }
        
        // Validate required fields
        const requiredFields = [
            'address_line1', 'city', 'state_province', 'country',
            'emergency_contact_name', 'emergency_contact_relationship', 
            'emergency_contact_phone'
        ];
        
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}