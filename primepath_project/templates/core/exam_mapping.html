{% extends "unified_base.html" %}
{% comment %}
Migrated to unified_base.html on 2025-08-26
Original base template: base.html
{% endcomment %}

{% load static %}
{% load grade_tags %}

{% block title %}Level Exams - Curriculum to Exam Configuration{% endblock %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
{% csrf_token %}
<style>
    .mapping-container {
        max-width: 1800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Login Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 400px;
        border-radius: 8px;
        text-align: center;
    }
    
    .login-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    
    .login-form input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    
    .login-form button {
        padding: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    
    .login-form button:hover {
        background-color: #0056b3;
    }
    
    .login-form button[type="button"] {
        background-color: #6c757d;
    }
    
    .login-form button[type="button"]:hover {
        background-color: #5a6268;
    }
    
    .error-message {
        color: #dc3545;
        margin-top: 10px;
    }
    
    .mapping-header {
        text-align: center;
        margin-bottom: 40px;
    }
    
    .mapping-header h1 {
        font-size: 2.5rem;
        color: #2c3e50;
        margin-bottom: 10px;
    }
    
    .mapping-header p {
        font-size: 1.1rem;
        color: #666;
    }
    
    .info-box {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        margin-bottom: 30px;
        border-radius: 4px;
    }
    
    .info-box h4 {
        margin: 0 0 10px 0;
        color: #2e7d32;
    }
    
    .program-mapping-section {
        margin-bottom: 50px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 25px;
    }
    
    .program-header {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 3px solid;
    }
    
    .program-header.core {
        color: #3498db;
        border-color: #3498db;
    }
    
    .program-header.ascent {
        color: #e74c3c;
        border-color: #e74c3c;
    }
    
    .program-header.edge {
        color: #f39c12;
        border-color: #f39c12;
    }
    
    .program-header.pinnacle {
        color: #9b59b6;
        border-color: #9b59b6;
    }
    
    .mapping-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .mapping-table th,
    .mapping-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
        vertical-align: top;
    }
    
    .mapping-table th {
        background-color: #f5f5f5;
        font-weight: 600;
        position: sticky;
        top: 0;
    }
    
    .mapping-table tr:hover {
        background-color: #f9f9f9;
    }
    
    .subprogram-name {
        font-weight: 600;
        color: #555;
    }
    
    .level-name {
        margin-left: 20px;
    }
    
    .exam-mapping-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .exam-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .exam-number {
        min-width: 25px;
        font-weight: 600;
        color: #666;
    }
    
    .exam-select {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.95rem;
    }
    
    .exam-select:disabled {
        background-color: #f5f5f5;
        cursor: not-allowed;
    }
    
    .remove-exam-btn {
        padding: 6px 12px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        min-width: 70px;
    }
    
    .remove-exam-btn:hover {
        background-color: #c82333;
    }
    
    .remove-exam-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    
    .add-exam-btn {
        padding: 6px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        margin-top: 5px;
    }
    
    .add-exam-btn:hover {
        background-color: #0056b3;
    }
    
    .add-exam-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    
    .save-button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 12px 40px;
        border-radius: 4px;
        font-size: 18px;
        cursor: pointer;
        float: right;
        margin-top: 20px;
    }
    
    .save-button:hover {
        background-color: #218838;
    }
    
    .stats-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: inline-block;
    }
    
    .stats-box span {
        font-weight: bold;
        color: #28a745;
    }
    
    .no-exams-msg {
        color: #999;
        font-style: italic;
        padding: 10px;
        text-align: center;
    }
    
    /* Style for unselected dropdowns */
    .exam-select option[value=""] {
        color: #999 !important;
        font-style: italic !important;
    }
    
    /* Style for exams without PDFs */
    .exam-select option.no-pdf {
        color: #dc3545 !important;
        font-style: italic !important;
    }
    
    .level-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }
    
    .save-level-btn {
        padding: 6px 16px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
    }
    
    .save-level-btn:hover {
        background-color: #218838;
    }
    
    .delete-mapping-btn {
        padding: 4px 8px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.75rem;
        margin-left: 5px;
    }
    
    .delete-mapping-btn:hover {
        background-color: #c82333;
    }
    
    /* Fixed Global Save Button */
    .global-save-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 999;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }
    
    .global-save-button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 16px 40px;
        border-radius: 50px;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .global-save-button:hover {
        background-color: #218838;
        transform: scale(1.05);
    }
    
    .global-save-button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        transform: scale(1);
    }
    
    .global-save-button.saving {
        background-color: #ffc107;
    }
    
    .global-save-button .spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 3px solid #ffffff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    .global-save-button.saving .spinner {
        display: inline-block;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Top Save Bar */
    .top-save-bar {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 15px 30px;
        position: sticky;
        top: 0;
        z-index: 998;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .top-save-bar .info-text {
        font-size: 16px;
        color: #495057;
    }
    
    .top-save-bar .save-button-top {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .top-save-bar .save-button-top:hover {
        background-color: #218838;
    }
    
    .top-save-bar .save-button-top:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }
    
    /* Success/Error Messages */
    .save-message {
        position: fixed;
        top: 80px;
        right: 30px;
        padding: 15px 25px;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    }
    
    .save-message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .save-message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

<!-- Login Modal -->
<div id="loginModal" class="modal">
    <div class="modal-content">
        <h2>Admin Login Required</h2>
        <p>Please login to edit exam mappings</p>
        <form class="login-form" onsubmit="return window.ExamMapping.handleLogin(event)">
            <input type="text" id="adminId" placeholder="Admin ID" required>
            <input type="password" id="adminPassword" placeholder="Password" required>
            <button type="submit">Login</button>
            <button type="button" onclick="window.location.href='{% url 'core:teacher_dashboard' %}'" style="background-color: #6c757d;">
                Exit
            </button>
            <div id="loginError" class="error-message" style="display: none;"></div>
        </form>
    </div>
</div>

<div class="mapping-container">
    <noscript>
        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
            JavaScript is required for this page to function properly. Please enable JavaScript and refresh the page.
        </div>
    </noscript>
    
    <!-- Top Save Bar -->
    <div class="top-save-bar">
        <span class="info-text">Remember to save your changes!</span>
        <button type="button" class="save-button-top" onclick="window.ExamMapping.saveAllMappingsWithFeedback()">Save All Mappings</button>
    </div>
    
    <div class="mapping-header">
        <h1>Level Exams Configuration</h1>
        <p>Map curriculum levels to exam versions. Each level can have up to 5 different exam versions.</p>
        <!-- Template updated: {% now "Y-m-d H:i:s" %} -->
    </div>
    
    <div class="info-box">
        <h4>What are Level Exams?</h4>
        <p>This is the second step in the placement process. After a student is assigned to a curriculum level (based on Student Levels configuration), the system needs to know which exam papers are available for that level.</p>
        
        <p><strong>How it works:</strong></p>
        <ul style="margin: 0; padding-left: 20px;">
            <li>Each curriculum level can have multiple exam versions (e.g., [PlacementTest] PRIME CORE PHONICS - Level 1_v_a, _v_b, etc.)</li>
            <li>When a student is placed in a level, the system will randomly select one of the mapped exams</li>
            <li>You can map up to 5 different exam versions per curriculum level</li>
            <li><strong>The same exam can be mapped to multiple curriculum levels</strong> (e.g., Exam C can be used for both Core Phonics Level 1 and Core Phonics Level 2)</li>
            <li>Use the "+" button to add more exam slots and "-" button to remove exams</li>
        </ul>
        
        <div style="background: #f5f5f5; padding: 15px; border-radius: 4px; margin-top: 15px;">
            <strong>Example:</strong> If PRIME CORE PHONICS - Level 1 has three exam versions (a, b, c) mapped to it, then students placed in this level will randomly receive one of these three exams.
        </div>
    </div>
    
    <!-- PRIME CORE Section -->
    <div class="program-mapping-section">
        <h2 class="program-header core">PRIME CORE</h2>
        <div class="stats-box">
            <span id="core-mapped">0</span> of <span id="core-total">{{ core_levels|length }}</span> levels have exams mapped
        </div>
        <table class="mapping-table">
            <thead>
                <tr>
                    <th width="30%">Curriculum Level</th>
                    <th width="15%">Difficulty Tier</th>
                    <th width="55%">Mapped Exams (Max 5)</th>
                </tr>
            </thead>
            <tbody>
                {% for level in core_levels %}
                {% comment %}
                EMERGENCY FIX: Skip any test subprograms that somehow made it through
                {% endcomment %}
                {% if "INACTIVE" in level.subprogram.name or "Test" in level.subprogram.name %}
                    <!-- SKIPPED TEST SUBPROGRAM: {{ level.subprogram.name }} -->
                {% else %}
                <tr>
                    <td>
                        <div class="subprogram-name">{{ level.display_data.subprogram_display|default:level.subprogram.name }}</div>
                        <div class="level-name">Level {{ level.level_number }}</div>
                    </td>
                    <td>
                        <input type="number" 
                               class="difficulty-input" 
                               data-level-id="{{ level.id }}" 
                               value="{{ level.internal_difficulty_value|default:'' }}" 
                               min="1" 
                               placeholder="-"
                               title="Internal difficulty tier (1=easiest, higher=harder)"
                               style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td>
                        <div class="exam-mapping-container" id="mapping-{{ level.id }}" data-level-id="{{ level.id }}">
                            {% if level.existing_mappings %}
                                {% for mapping in level.existing_mappings %}
                                <div class="exam-row">
                                    <span class="exam-number">{{ mapping.slot }}.</span>
                                    <select class="exam-select" data-level-id="{{ level.id }}" data-program="core" data-slot="{{ mapping.slot }}" onchange="window.ExamMapping.updateStats()">
                                        <option value="" style="color: #999; font-style: italic;">Select</option>
                                        {% for exam in level.available_exams %}
                                        <option value="{{ exam.id }}" 
                                            {% if exam.id == mapping.exam_id %}selected{% endif %}
                                            {% if not exam.has_pdf %}style="color: #dc3545; font-style: italic;"{% endif %}>
                                            {{ exam.display_name }}{% if not exam.has_pdf %} (No PDF){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if forloop.first and forloop.last %}
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.clearExamSlot({{ level.id }}, {{ mapping.slot }})">Clear</button>
                                    {% else %}
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.removeExamSlot({{ level.id }}, {{ mapping.slot }})">Remove</button>
                                    {% endif %}
                                    <button class="delete-mapping-btn" onclick="window.ExamMapping.deleteExamMapping({{ level.id }}, {{ mapping.slot }})" title="Delete this mapping">Ã—</button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="exam-row">
                                    <span class="exam-number">1.</span>
                                    <select class="exam-select" data-level-id="{{ level.id }}" data-program="core" data-slot="1" onchange="window.ExamMapping.updateStats()">
                                        <option value="" style="color: #999; font-style: italic;">Select</option>
                                        {% for exam in level.available_exams %}
                                        <option value="{{ exam.id }}" {% if not exam.has_pdf %}style="color: #dc3545; font-style: italic;"{% endif %}>
                                            {{ exam.display_name }}{% if not exam.has_pdf %} (No PDF){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.clearExamSlot({{ level.id }}, 1)" disabled>Clear</button>
                                    <button class="delete-mapping-btn" onclick="window.ExamMapping.deleteExamMapping({{ level.id }}, 1)" title="Delete this mapping">Ã—</button>
                                </div>
                            {% endif %}
                        </div>
                        <div class="level-actions">
                            <button class="add-exam-btn" onclick="window.ExamMapping.addExamSlot({{ level.id }}, 'core')" id="add-btn-{{ level.id }}">
                                + Add Another Exam
                            </button>
                            <button class="save-level-btn" onclick="window.ExamMapping.saveLevelMappings({{ level.id }})">
                                Save
                            </button>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% empty %}
                <tr>
                    <td colspan="2" class="no-exams-msg">No curriculum levels found for PRIME CORE</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- PRIME ASCENT Section -->
    <div class="program-mapping-section">
        <h2 class="program-header ascent">PRIME ASCENT</h2>
        <div class="stats-box">
            <span id="ascent-mapped">0</span> of <span id="ascent-total">{{ ascent_levels|length }}</span> levels have exams mapped
        </div>
        <table class="mapping-table">
            <thead>
                <tr>
                    <th width="30%">Curriculum Level</th>
                    <th width="15%">Difficulty Tier</th>
                    <th width="55%">Mapped Exams (Max 5)</th>
                </tr>
            </thead>
            <tbody>
                {% for level in ascent_levels %}
                {% if "INACTIVE" in level.subprogram.name or "Test" in level.subprogram.name %}
                    <!-- SKIPPED TEST SUBPROGRAM: {{ level.subprogram.name }} -->
                {% else %}
                <tr>
                    <td>
                        <div class="subprogram-name">{{ level.display_data.subprogram_display|default:level.subprogram.name }}</div>
                        <div class="level-name">Level {{ level.level_number }}</div>
                    </td>
                    <td>
                        <input type="number" 
                               class="difficulty-input" 
                               data-level-id="{{ level.id }}" 
                               value="{{ level.internal_difficulty_value|default:'' }}" 
                               min="1" 
                               placeholder="-"
                               title="Internal difficulty tier (1=easiest, higher=harder)"
                               style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td>
                        <div class="exam-mapping-container" id="mapping-{{ level.id }}" data-level-id="{{ level.id }}">
                            {% if level.existing_mappings %}
                                {% for mapping in level.existing_mappings %}
                                <div class="exam-row">
                                    <span class="exam-number">{{ mapping.slot }}.</span>
                                    <select class="exam-select" data-level-id="{{ level.id }}" data-program="ascent" data-slot="{{ mapping.slot }}" onchange="window.ExamMapping.updateStats()">
                                        <option value="" style="color: #999; font-style: italic;">Select</option>
                                        {% for exam in level.available_exams %}
                                        <option value="{{ exam.id }}" 
                                            {% if exam.id == mapping.exam_id %}selected{% endif %}
                                            {% if not exam.has_pdf %}style="color: #dc3545; font-style: italic;"{% endif %}>
                                            {{ exam.display_name }}{% if not exam.has_pdf %} (No PDF){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if forloop.first and forloop.last %}
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.clearExamSlot({{ level.id }}, {{ mapping.slot }})">Clear</button>
                                    {% else %}
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.removeExamSlot({{ level.id }}, {{ mapping.slot }})">Remove</button>
                                    {% endif %}
                                    <button class="delete-mapping-btn" onclick="window.ExamMapping.deleteExamMapping({{ level.id }}, {{ mapping.slot }})" title="Delete this mapping">Ã—</button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="exam-row">
                                    <span class="exam-number">1.</span>
                                    <select class="exam-select" data-level-id="{{ level.id }}" data-program="ascent" data-slot="1" onchange="window.ExamMapping.updateStats()">
                                        <option value="" style="color: #999; font-style: italic;">Select</option>
                                        {% for exam in level.available_exams %}
                                        <option value="{{ exam.id }}" {% if not exam.has_pdf %}style="color: #dc3545; font-style: italic;"{% endif %}>
                                            {{ exam.display_name }}{% if not exam.has_pdf %} (No PDF){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.clearExamSlot({{ level.id }}, 1)" disabled>Clear</button>
                                    <button class="delete-mapping-btn" onclick="window.ExamMapping.deleteExamMapping({{ level.id }}, 1)" title="Delete this mapping">Ã—</button>
                                </div>
                            {% endif %}
                        </div>
                        <div class="level-actions">
                            <button class="add-exam-btn" onclick="window.ExamMapping.addExamSlot({{ level.id }}, 'ascent')" id="add-btn-{{ level.id }}">
                                + Add Another Exam
                            </button>
                            <button class="save-level-btn" onclick="window.ExamMapping.saveLevelMappings({{ level.id }})">
                                Save
                            </button>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% empty %}
                <tr>
                    <td colspan="2" class="no-exams-msg">No curriculum levels found for PRIME ASCENT</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- PRIME EDGE Section -->
    <div class="program-mapping-section">
        <h2 class="program-header edge">PRIME EDGE</h2>
        <div class="stats-box">
            <span id="edge-mapped">0</span> of <span id="edge-total">{{ edge_levels|length }}</span> levels have exams mapped
        </div>
        <table class="mapping-table">
            <thead>
                <tr>
                    <th width="30%">Curriculum Level</th>
                    <th width="15%">Difficulty Tier</th>
                    <th width="55%">Mapped Exams (Max 5)</th>
                </tr>
            </thead>
            <tbody>
                {% for level in edge_levels %}
                {% if "INACTIVE" in level.subprogram.name or "Test" in level.subprogram.name %}
                    <!-- SKIPPED TEST SUBPROGRAM: {{ level.subprogram.name }} -->
                {% else %}
                <tr>
                    <td>
                        <div class="subprogram-name">{{ level.display_data.subprogram_display|default:level.subprogram.name }}</div>
                        <div class="level-name">Level {{ level.level_number }}</div>
                    </td>
                    <td>
                        <input type="number" 
                               class="difficulty-input" 
                               data-level-id="{{ level.id }}" 
                               value="{{ level.internal_difficulty_value|default:'' }}" 
                               min="1" 
                               placeholder="-"
                               title="Internal difficulty tier (1=easiest, higher=harder)"
                               style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td>
                        <div class="exam-mapping-container" id="mapping-{{ level.id }}" data-level-id="{{ level.id }}">
                            {% if level.existing_mappings %}
                                {% for mapping in level.existing_mappings %}
                                <div class="exam-row">
                                    <span class="exam-number">{{ mapping.slot }}.</span>
                                    <select class="exam-select" data-level-id="{{ level.id }}" data-program="edge" data-slot="{{ mapping.slot }}" onchange="window.ExamMapping.updateStats()">
                                        <option value="" style="color: #999; font-style: italic;">Select</option>
                                        {% for exam in level.available_exams %}
                                        <option value="{{ exam.id }}" 
                                            {% if exam.id == mapping.exam_id %}selected{% endif %}
                                            {% if not exam.has_pdf %}style="color: #dc3545; font-style: italic;"{% endif %}>
                                            {{ exam.display_name }}{% if not exam.has_pdf %} (No PDF){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if forloop.first and forloop.last %}
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.clearExamSlot({{ level.id }}, {{ mapping.slot }})">Clear</button>
                                    {% else %}
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.removeExamSlot({{ level.id }}, {{ mapping.slot }})">Remove</button>
                                    {% endif %}
                                    <button class="delete-mapping-btn" onclick="window.ExamMapping.deleteExamMapping({{ level.id }}, {{ mapping.slot }})" title="Delete this mapping">Ã—</button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="exam-row">
                                    <span class="exam-number">1.</span>
                                    <select class="exam-select" data-level-id="{{ level.id }}" data-program="edge" data-slot="1" onchange="window.ExamMapping.updateStats()">
                                        <option value="" style="color: #999; font-style: italic;">Select</option>
                                        {% for exam in level.available_exams %}
                                        <option value="{{ exam.id }}" {% if not exam.has_pdf %}style="color: #dc3545; font-style: italic;"{% endif %}>
                                            {{ exam.display_name }}{% if not exam.has_pdf %} (No PDF){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.clearExamSlot({{ level.id }}, 1)" disabled>Clear</button>
                                    <button class="delete-mapping-btn" onclick="window.ExamMapping.deleteExamMapping({{ level.id }}, 1)" title="Delete this mapping">Ã—</button>
                                </div>
                            {% endif %}
                        </div>
                        <div class="level-actions">
                            <button class="add-exam-btn" onclick="window.ExamMapping.addExamSlot({{ level.id }}, 'edge')" id="add-btn-{{ level.id }}">
                                + Add Another Exam
                            </button>
                            <button class="save-level-btn" onclick="window.ExamMapping.saveLevelMappings({{ level.id }})">
                                Save
                            </button>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% empty %}
                <tr>
                    <td colspan="2" class="no-exams-msg">No curriculum levels found for PRIME EDGE</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- PRIME PINNACLE Section -->
    <div class="program-mapping-section">
        <h2 class="program-header pinnacle">PRIME PINNACLE</h2>
        <div class="stats-box">
            <span id="pinnacle-mapped">0</span> of <span id="pinnacle-total">{{ pinnacle_levels|length }}</span> levels have exams mapped
        </div>
        <table class="mapping-table">
            <thead>
                <tr>
                    <th width="30%">Curriculum Level</th>
                    <th width="15%">Difficulty Tier</th>
                    <th width="55%">Mapped Exams (Max 5)</th>
                </tr>
            </thead>
            <tbody>
                {% for level in pinnacle_levels %}
                {% if "INACTIVE" in level.subprogram.name or "Test" in level.subprogram.name %}
                    <!-- SKIPPED TEST SUBPROGRAM: {{ level.subprogram.name }} -->
                {% else %}
                <tr>
                    <td>
                        <div class="subprogram-name">{{ level.display_data.subprogram_display|default:level.subprogram.name }}</div>
                        <div class="level-name">Level {{ level.level_number }}</div>
                    </td>
                    <td>
                        <input type="number" 
                               class="difficulty-input" 
                               data-level-id="{{ level.id }}" 
                               value="{{ level.internal_difficulty_value|default:'' }}" 
                               min="1" 
                               placeholder="-"
                               title="Internal difficulty tier (1=easiest, higher=harder)"
                               style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td>
                        <div class="exam-mapping-container" id="mapping-{{ level.id }}" data-level-id="{{ level.id }}">
                            {% if level.existing_mappings %}
                                {% for mapping in level.existing_mappings %}
                                <div class="exam-row">
                                    <span class="exam-number">{{ mapping.slot }}.</span>
                                    <select class="exam-select" data-level-id="{{ level.id }}" data-program="pinnacle" data-slot="{{ mapping.slot }}" onchange="window.ExamMapping.updateStats()">
                                        <option value="" style="color: #999; font-style: italic;">Select</option>
                                        {% for exam in level.available_exams %}
                                        <option value="{{ exam.id }}" 
                                            {% if exam.id == mapping.exam_id %}selected{% endif %}
                                            {% if not exam.has_pdf %}style="color: #dc3545; font-style: italic;"{% endif %}>
                                            {{ exam.display_name }}{% if not exam.has_pdf %} (No PDF){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if forloop.first and forloop.last %}
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.clearExamSlot({{ level.id }}, {{ mapping.slot }})">Clear</button>
                                    {% else %}
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.removeExamSlot({{ level.id }}, {{ mapping.slot }})">Remove</button>
                                    {% endif %}
                                    <button class="delete-mapping-btn" onclick="window.ExamMapping.deleteExamMapping({{ level.id }}, {{ mapping.slot }})" title="Delete this mapping">Ã—</button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="exam-row">
                                    <span class="exam-number">1.</span>
                                    <select class="exam-select" data-level-id="{{ level.id }}" data-program="pinnacle" data-slot="1" onchange="window.ExamMapping.updateStats()">
                                        <option value="" style="color: #999; font-style: italic;">Select</option>
                                        {% for exam in level.available_exams %}
                                        <option value="{{ exam.id }}" {% if not exam.has_pdf %}style="color: #dc3545; font-style: italic;"{% endif %}>
                                            {{ exam.display_name }}{% if not exam.has_pdf %} (No PDF){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button class="remove-exam-btn" onclick="window.ExamMapping.clearExamSlot({{ level.id }}, 1)" disabled>Clear</button>
                                    <button class="delete-mapping-btn" onclick="window.ExamMapping.deleteExamMapping({{ level.id }}, 1)" title="Delete this mapping">Ã—</button>
                                </div>
                            {% endif %}
                        </div>
                        <div class="level-actions">
                            <button class="add-exam-btn" onclick="window.ExamMapping.addExamSlot({{ level.id }}, 'pinnacle')" id="add-btn-{{ level.id }}">
                                + Add Another Exam
                            </button>
                            <button class="save-level-btn" onclick="window.ExamMapping.saveLevelMappings({{ level.id }})">
                                Save
                            </button>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% empty %}
                <tr>
                    <td colspan="2" class="no-exams-msg">No curriculum levels found for PRIME PINNACLE</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div style="clear: both;"></div>
</div>

<!-- Fixed Global Save Button -->
<div class="global-save-container">
    <button type="button" class="global-save-button" id="globalSaveBtn" onclick="window.ExamMapping.saveAllMappingsWithFeedback()">
        <span class="spinner"></span>
        <span id="saveButtonText">Save All Mappings</span>
    </button>
</div>

<!-- Success/Error Message Container -->
<div id="saveMessage" class="save-message" style="display: none;"></div>

<script>
// ========================================
// CURRICULUM DISPLAY DEBUGGING
// ========================================
console.group('ðŸ“š Curriculum Structure Display Check');

// Log CORE levels
console.group('PRIME CORE Levels (Expected: 4 subprograms Ã— 3 levels = 12)');
{% for level in core_levels %}
console.log('Level {{ level.id }}:', {
    raw_subprogram: '{{ level.subprogram.name }}',
    display_subprogram: '{{ level.display_data.subprogram_display|default:"NOT SET" }}',
    full_display: '{{ level.display_data.full_display|default:"NOT SET" }}',
    level_number: {{ level.level_number }}
});
{% endfor %}
console.log('Total CORE levels:', {{ core_levels|length }});
console.groupEnd();

// Log ASCENT levels
console.group('PRIME ASCENT Levels (Expected: 4 subprograms Ã— 3 levels = 12)');
{% for level in ascent_levels %}
console.log('Level {{ level.id }}:', {
    raw_subprogram: '{{ level.subprogram.name }}',
    display_subprogram: '{{ level.display_data.subprogram_display|default:"NOT SET" }}',
    full_display: '{{ level.display_data.full_display|default:"NOT SET" }}',
    level_number: {{ level.level_number }}
});
{% endfor %}
console.log('Total ASCENT levels:', {{ ascent_levels|length }});
console.groupEnd();

// Log EDGE levels
console.group('PRIME EDGE Levels (Expected: 4 subprograms Ã— 3 levels = 12)');
{% for level in edge_levels %}
console.log('Level {{ level.id }}:', {
    raw_subprogram: '{{ level.subprogram.name }}',
    display_subprogram: '{{ level.display_data.subprogram_display|default:"NOT SET" }}',
    full_display: '{{ level.display_data.full_display|default:"NOT SET" }}',
    level_number: {{ level.level_number }}
});
{% endfor %}
console.log('Total EDGE levels:', {{ edge_levels|length }});
console.groupEnd();

// Log PINNACLE levels
console.group('PRIME PINNACLE Levels (Expected: 4 subprograms Ã— 2 levels = 8)');
{% for level in pinnacle_levels %}
console.log('Level {{ level.id }}:', {
    raw_subprogram: '{{ level.subprogram.name }}',
    display_subprogram: '{{ level.display_data.subprogram_display|default:"NOT SET" }}',
    full_display: '{{ level.display_data.full_display|default:"NOT SET" }}',
    level_number: {{ level.level_number }},
    WARNING: {{ level.level_number }} > 2 ? 'âš ï¸ Should only have levels 1-2!' : 'OK'
});
{% endfor %}
console.log('Total PINNACLE levels:', {{ pinnacle_levels|length }});
console.groupEnd();

// Summary with validation
const expectedTotal = 12 + 12 + 12 + 8; // 44 total levels
const actualTotal = {{ core_levels|length }} + {{ ascent_levels|length }} + {{ edge_levels|length }} + {{ pinnacle_levels|length }};

console.group('ðŸ“Š Curriculum Structure Summary');
console.table({
    'PRIME CORE': { Expected: 12, Actual: {{ core_levels|length }}, Status: {{ core_levels|length }} === 12 ? 'âœ…' : 'âŒ' },
    'PRIME ASCENT': { Expected: 12, Actual: {{ ascent_levels|length }}, Status: {{ ascent_levels|length }} === 12 ? 'âœ…' : 'âŒ' },
    'PRIME EDGE': { Expected: 12, Actual: {{ edge_levels|length }}, Status: {{ edge_levels|length }} === 12 ? 'âœ…' : 'âŒ' },
    'PRIME PINNACLE': { Expected: 8, Actual: {{ pinnacle_levels|length }}, Status: {{ pinnacle_levels|length }} === 8 ? 'âœ…' : 'âŒ' },
    'TOTAL': { Expected: expectedTotal, Actual: actualTotal, Status: actualTotal === expectedTotal ? 'âœ…' : 'âŒ' }
});
console.groupEnd();

console.groupEnd(); // End main curriculum group

// ========================================
// ORIGINAL EXAM MAPPING CODE
// ========================================
(function() {
    'use strict';
    
    // Check authentication on page load
    let isAuthenticated = false;
    
    // Store all functions in a global object to ensure availability
    window.ExamMapping = {};

    window.ExamMapping.handleLogin = function(event) {
    event.preventDefault();
    
    const adminId = document.getElementById('adminId').value;
    const password = document.getElementById('adminPassword').value;
    
    // Check credentials
    if (adminId === 'admin' && password === 'admin123') {
        isAuthenticated = true;
        document.getElementById('loginModal').style.display = 'none';
        window.ExamMapping.enableAllInputs();
        
        // Initialize after authentication
        setTimeout(() => {
                window.ExamMapping.updateStats();
                window.ExamMapping.updateAllClearButtons();
        }, 100);
    } else {
        document.getElementById('loginError').style.display = 'block';
        document.getElementById('loginError').textContent = 'Invalid credentials. Please try again.';
    }
    
    return false;
}

    window.ExamMapping.disableAllInputs = function() {
    document.querySelectorAll('select, button').forEach(element => {
        if (!element.closest('#loginModal')) {
            element.disabled = true;
        }
    });
}

    window.ExamMapping.enableAllInputs = function() {
    document.querySelectorAll('select, button').forEach(element => {
        element.disabled = false;
    });
        window.ExamMapping.updateAllClearButtons();
        // Also enable the global save buttons
        const globalBtn = document.getElementById('globalSaveBtn');
        const topBtn = document.querySelector('.save-button-top');
        if (globalBtn) globalBtn.disabled = false;
        if (topBtn) topBtn.disabled = false;
}

// Store available exams for each level
const availableExams = {};

// Initialize available exams from server data
{% for level in core_levels %}
{% if "[INACTIVE]" not in level.subprogram.name and "Test" not in level.subprogram.name and "test" not in level.subprogram.name %}
{% if level.id %}
availableExams['{{ level.id }}'] = [
    {% for exam in level.available_exams %}{% if exam.id %}
    { 
        id: '{{ exam.id }}', 
        name: '{{ exam.name|escapejs }}',
        display_name: '{{ exam.display_name|escapejs }}',
        has_pdf: {% if exam.has_pdf %}true{% else %}false{% endif %}
    },
    {% endif %}{% endfor %}
].filter(x => x); // Remove any undefined entries
{% endif %}
{% endif %}
{% endfor %}

{% for level in ascent_levels %}
{% if level.id %}
availableExams['{{ level.id }}'] = [
    {% for exam in level.available_exams %}{% if exam.id %}
    { 
        id: '{{ exam.id }}', 
        name: '{{ exam.name|escapejs }}',
        display_name: '{{ exam.display_name|escapejs }}',
        has_pdf: {% if exam.has_pdf %}true{% else %}false{% endif %}
    },
    {% endif %}{% endfor %}
].filter(x => x); // Remove any undefined entries
{% endif %}
{% endfor %}

{% for level in edge_levels %}
{% if level.id %}
availableExams['{{ level.id }}'] = [
    {% for exam in level.available_exams %}{% if exam.id %}
    { 
        id: '{{ exam.id }}', 
        name: '{{ exam.name|escapejs }}',
        display_name: '{{ exam.display_name|escapejs }}',
        has_pdf: {% if exam.has_pdf %}true{% else %}false{% endif %}
    },
    {% endif %}{% endfor %}
].filter(x => x); // Remove any undefined entries
{% endif %}
{% endfor %}

{% for level in pinnacle_levels %}
{% if level.id %}
availableExams['{{ level.id }}'] = [
    {% for exam in level.available_exams %}{% if exam.id %}
    { 
        id: '{{ exam.id }}', 
        name: '{{ exam.name|escapejs }}',
        display_name: '{{ exam.display_name|escapejs }}',
        has_pdf: {% if exam.has_pdf %}true{% else %}false{% endif %}
    },
    {% endif %}{% endfor %}
].filter(x => x); // Remove any undefined entries
{% endif %}
{% endfor %}

// Exams loaded and ready for use

// Initialize exam mapping functionality
window.ExamMapping = window.ExamMapping || {};

window.ExamMapping.addExamSlot = function(levelId, program) {
    const container = document.getElementById(`mapping-${levelId}`);
    const existingRows = container.querySelectorAll('.exam-row').length;
    
    if (existingRows >= 5) {
        alert('Maximum 5 exams per curriculum level');
        return;
    }
    
    const newSlot = existingRows + 1;
    const exams = availableExams[levelId] || [];
    
    const newRow = document.createElement('div');
    newRow.className = 'exam-row';
    newRow.innerHTML = `
        <span class="exam-number">${newSlot}.</span>
        <select class="exam-select" data-level-id="${levelId}" data-program="${program}" data-slot="${newSlot}" onchange="window.ExamMapping.updateStats()">
            <option value="" style="color: #999; font-style: italic;">Select</option>
            ${exams.map(exam => {
                const style = !exam.has_pdf ? 'style="color: #dc3545; font-style: italic;"' : '';
                const suffix = !exam.has_pdf ? ' (No PDF)' : '';
                return `<option value="${exam.id}" ${style}>${exam.display_name}${suffix}</option>`;
            }).join('')}
        </select>
        <button class="remove-exam-btn" onclick="window.ExamMapping.removeExamSlot(${levelId}, ${newSlot})">Remove</button>
        <button class="delete-mapping-btn" onclick="window.ExamMapping.deleteExamMapping(${levelId}, ${newSlot})" title="Delete this mapping">Ã—</button>
    `;
    
    container.appendChild(newRow);
    
    // Update add button state
    if (existingRows + 1 >= 5) {
        document.getElementById(`add-btn-${levelId}`).disabled = true;
    }
    
        window.ExamMapping.updateStats();
}

    window.ExamMapping.removeExamSlot = function(levelId, slot) {
    const container = document.getElementById(`mapping-${levelId}`);
    const rows = container.querySelectorAll('.exam-row');
    
    // Remove the specific slot
    rows[slot - 1].remove();
    
    // Renumber remaining slots with defensive programming
    const remainingRows = container.querySelectorAll('.exam-row');
    
    try {
        remainingRows.forEach((row, index) => {
            try {
                // DEFENSIVE: Validate row exists and is element
                if (!row || typeof row.querySelector !== 'function') {
                    console.warn(`[RENUMBER_SLOTS] Invalid row at index ${index}:`, row);
                    return;
                }
                
                const examNumber = row.querySelector('.exam-number');
                const examSelect = row.querySelector('.exam-select');
                const removeBtn = row.querySelector('.remove-exam-btn');
                
                if (examNumber) {
                    examNumber.textContent = `${index + 1}.`;
                }
                
                if (examSelect) {
                    examSelect.dataset.slot = index + 1;
                }
                
                if (removeBtn) {
                    if (index === 0 && remainingRows.length === 1) {
                        removeBtn.textContent = 'Clear';
                        removeBtn.onclick = () => window.ExamMapping.clearExamSlot(levelId, 1);
                    } else {
                        removeBtn.textContent = 'Remove';
                        removeBtn.onclick = () => window.ExamMapping.removeExamSlot(levelId, index + 1);
                    }
                }
            } catch (rowError) {
                console.error(`[RENUMBER_SLOTS] Error processing row ${index}:`, rowError);
                // Continue with other rows
            }
        });
    } catch (forEachError) {
        console.error('[RENUMBER_SLOTS] Error in remainingRows forEach:', forEachError);
    }
    
    // Enable add button
    document.getElementById(`add-btn-${levelId}`).disabled = false;
    
        window.ExamMapping.updateStats();
}

    window.ExamMapping.clearExamSlot = function(levelId, slot) {
    const container = document.getElementById(`mapping-${levelId}`);
    const select = container.querySelector(`.exam-select[data-slot="${slot}"]`);
    if (select) {
        select.value = '';
            window.ExamMapping.updateStats();
        window.ExamMapping.updateClearButton(levelId, slot);
    }
}

    window.ExamMapping.updateClearButton = function(levelId, slot) {
    const container = document.getElementById(`mapping-${levelId}`);
    const row = container.querySelectorAll('.exam-row')[slot - 1];
    if (row) {
        const select = row.querySelector('.exam-select');
        const button = row.querySelector('.remove-exam-btn');
        
        if (container.querySelectorAll('.exam-row').length === 1) {
            button.disabled = !select.value;
        }
    }
}

    window.ExamMapping.updateAllClearButtons = function() {
    document.querySelectorAll('.exam-mapping-container').forEach(container => {
        const levelId = container.id.replace('mapping-', '');
        const rows = container.querySelectorAll('.exam-row');
        
        // DEFENSIVE: Process rows with error handling
        try {
            rows.forEach((row, index) => {
                try {
                    if (!row) {
                        console.warn(`[STATS_UPDATE] Invalid row at index ${index}`);
                        return;
                    }
                    
                    if (rows.length === 1) {
                        window.ExamMapping.updateClearButton(levelId, index + 1);
                    }
                } catch (rowError) {
                    console.error(`[STATS_UPDATE] Error processing row ${index}:`, rowError);
                    // Continue with other rows
                }
            });
        } catch (forEachError) {
            console.error('[STATS_UPDATE] Error in rows forEach:', forEachError);
        }
    });
}

    window.ExamMapping.updateStats = function() {
    const programs = ['core', 'ascent', 'edge', 'pinnacle'];
    
    programs.forEach(program => {
        const selects = document.querySelectorAll(`.exam-select[data-program="${program}"]`);
        const levelIds = new Set();
        
        selects.forEach(select => {
            if (select.value) {
                levelIds.add(select.dataset.levelId);
            }
        });
        
        document.getElementById(`${program}-mapped`).textContent = levelIds.size;
    });
    
    // Update clear buttons
    document.querySelectorAll('.exam-select').forEach(select => {
        select.addEventListener('change', function() {
            window.ExamMapping.updateClearButton(this.dataset.levelId, this.dataset.slot);
        });
    });
}


    window.ExamMapping.getCookie = function(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    // Fallback: try to get CSRF token from the input field
    if (!cookieValue && name === 'csrftoken') {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            cookieValue = csrfInput.value;
        }
    }
    
    return cookieValue;
}

    window.ExamMapping.deleteExamMapping = function(levelId, slot) {
    const container = document.getElementById(`mapping-${levelId}`);
    const select = container.querySelector(`.exam-select[data-slot="${slot}"]`);
    if (select) {
        select.value = '';
            window.ExamMapping.updateStats();
    }
}

    window.ExamMapping.saveLevelMappings = function(levelId) {
        // ========================================
        // ROBUST SAVE LEVEL MAPPINGS - ERROR-PROOF VERSION
        // ========================================
        
        console.group('[SAVE_LEVEL] Starting save for level:', levelId);
        
        try {
            const mappings = [];
            const container = document.getElementById(`mapping-${levelId}`);
            
            if (!container) {
                console.error('[SAVE_LEVEL] âŒ Container not found for level:', levelId);
                console.groupEnd();
                alert('Error: Cannot find mapping container for this level. Please refresh the page and try again.');
                return;
            }
            
            console.log('[SAVE_LEVEL] âœ… Container found:', container);
            
            // DEFENSIVE: Get all exam selects with validation
            const examSelects = container.querySelectorAll('.exam-select');
            console.log('[SAVE_LEVEL] Found exam selects:', examSelects.length);
            
            if (examSelects.length === 0) {
                console.warn('[SAVE_LEVEL] âš ï¸ No exam selects found in container');
                console.groupEnd();
                alert('No exam selections found for this level.');
                return;
            }
            
            // Process each select with robust error handling
            examSelects.forEach((select, index) => {
                try {
                    console.log(`[SAVE_LEVEL] Processing select ${index + 1}:`, {
                        value: select.value,
                        levelId: select.dataset.levelId,
                        slot: select.dataset.slot
                    });
                    
                    if (select.value && select.value.trim()) {
                        const mapping = {
                            curriculum_level_id: parseInt(levelId),
                            exam_id: select.value.trim(),  // Keep as string UUID
                            slot: parseInt(select.dataset.slot)
                        };
                        
                        // Validate mapping data
                        if (isNaN(mapping.curriculum_level_id)) {
                            console.error('[SAVE_LEVEL] Invalid level ID:', levelId);
                            return;
                        }
                        
                        if (isNaN(mapping.slot)) {
                            console.error('[SAVE_LEVEL] Invalid slot:', select.dataset.slot);
                            return;
                        }
                        
                        mappings.push(mapping);
                        console.log(`[SAVE_LEVEL] âœ… Added mapping:`, mapping);
                    }
                } catch (selectError) {
                    console.error(`[SAVE_LEVEL] Error processing select ${index + 1}:`, selectError);
                    // Continue with other selects
                }
            });
            
            console.log('[SAVE_LEVEL] Final mappings to save:', mappings);
    
            if (mappings.length === 0) {
                console.warn('[SAVE_LEVEL] No mappings to save');
                console.groupEnd();
                alert('No exam mappings selected for this level.');
                return;
            }
            
            // Get CSRF token with validation
            const csrfToken = window.ExamMapping.getCookie('csrftoken');
            if (!csrfToken) {
                console.error('[SAVE_LEVEL] âŒ CSRF token not found');
                console.groupEnd();
                alert('Error: Security token not found. Please refresh the page and try again.');
                return;
            }
            
            console.log('[SAVE_LEVEL] Sending request to save mappings...');
            
            // Send save request with comprehensive error handling
            fetch('{% url "core:save_exam_mappings" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ 
                    mappings: mappings,
                    level_id: levelId,
                    debug_info: {
                        timestamp: new Date().toISOString(),
                        user_agent: navigator.userAgent,
                        mappings_count: mappings.length
                    }
                })
            })
            .then(response => {
                console.log('[SAVE_LEVEL] Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('[SAVE_LEVEL] Response data:', data);
                
                if (data.success) {
                    console.log('[SAVE_LEVEL] âœ… Save successful');
                    console.groupEnd();
                    alert(`Mappings saved successfully for this level! (${mappings.length} mappings)`);
                } else {
                    console.error('[SAVE_LEVEL] âŒ Save failed:', data.error);
                    console.groupEnd();
                    alert('Error saving mappings: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('[SAVE_LEVEL] âŒ Network/fetch error:', error);
                console.groupEnd();
                alert('An error occurred while saving mappings: ' + error.message);
            });
            
        } catch (error) {
            console.error('[SAVE_LEVEL] âŒ Unexpected error in saveLevelMappings:', error);
            console.groupEnd();
            alert('An unexpected error occurred. Please try again or refresh the page.');
        }
    };
}

    window.ExamMapping.saveAllMappings = function() {
    const mappings = [];
    
    document.querySelectorAll('.exam-select').forEach(select => {
        if (select.value) {
            mappings.push({
                curriculum_level_id: parseInt(select.dataset.levelId),
                exam_id: select.value,  // Keep as string - it's a UUID
                slot: parseInt(select.dataset.slot)
            });
        }
    });
    
    if (mappings.length === 0) {
        alert('No mappings to save. Please select at least one exam.');
        return;
    }
    
    const csrfToken = window.ExamMapping.getCookie('csrftoken');
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('Error: Security token not found. Please refresh the page and try again.');
        return;
    }
    
    fetch('{% url "core:save_exam_mappings" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ mappings: mappings })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('All exam mappings saved successfully!');
        } else {
            alert('Error saving exam mappings: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving exam mappings: ' + error.message);
    });
}

    window.ExamMapping.showMessage = function(message, type) {
        const messageDiv = document.getElementById('saveMessage');
        messageDiv.textContent = message;
        messageDiv.className = `save-message ${type}`;
        messageDiv.style.display = 'block';
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }

    window.ExamMapping.saveAllMappingsWithFeedback = function() {
        // ========================================
        // ROBUST SAVE ALL MAPPINGS - ERROR-PROOF VERSION
        // ========================================
        
        console.group('[SAVE_ALL] Starting Save All Mappings');
        console.log('ðŸ“ Initiating comprehensive save for all Level Exams mappings');
        
        try {
            // Get UI elements with validation
            const globalBtn = document.getElementById('globalSaveBtn');
            const topBtn = document.querySelector('.save-button-top');
            const btnText = document.getElementById('saveButtonText');
            
            if (!globalBtn) {
                console.error('[SAVE_ALL] âŒ Global save button not found');
                alert('Error: Save button not found. Please refresh the page.');
                return;
            }
            
            // Disable buttons and show loading state
            globalBtn.disabled = true;
            globalBtn.classList.add('saving');
            if (topBtn) {
                topBtn.disabled = true;
                topBtn.textContent = 'Saving...';
            }
            if (btnText) {
                btnText.textContent = 'Saving...';
            }
            
            console.log('[SAVE_ALL] UI buttons disabled, starting data collection...');
            
            const mappings = [];
            const difficultyUpdates = [];
            const errors = [];
            
            // DEFENSIVE: Collect exam mappings with robust error handling
            try {
                const examSelects = document.querySelectorAll('.exam-select');
                console.log(`[SAVE_ALL] Found ${examSelects.length} exam selects`);
                
                examSelects.forEach((select, index) => {
                    try {
                        if (select.value && select.value.trim()) {
                            const levelId = select.dataset.levelId;
                            const slot = select.dataset.slot;
                            
                            if (!levelId || !slot) {
                                console.warn(`[SAVE_ALL] âš ï¸ Select ${index + 1} missing data attributes:`, {
                                    levelId: levelId,
                                    slot: slot
                                });
                                return;
                            }
                            
                            const mapping = {
                                curriculum_level_id: parseInt(levelId),
                                exam_id: select.value.trim(),
                                slot: parseInt(slot)
                            };
                            
                            // Validate mapping
                            if (isNaN(mapping.curriculum_level_id) || isNaN(mapping.slot)) {
                                console.error(`[SAVE_ALL] Invalid mapping data at select ${index + 1}:`, mapping);
                                errors.push(`Invalid data for exam select ${index + 1}`);
                                return;
                            }
                            
                            mappings.push(mapping);
                        }
                    } catch (selectError) {
                        console.error(`[SAVE_ALL] Error processing select ${index + 1}:`, selectError);
                        errors.push(`Error processing exam select ${index + 1}: ${selectError.message}`);
                    }
                });
                
                console.log(`[SAVE_ALL] Collected ${mappings.length} valid mappings`);
                
            } catch (mappingError) {
                console.error('[SAVE_ALL] Error collecting mappings:', mappingError);
                errors.push('Error collecting exam mappings');
            }
            
            // DEFENSIVE: Collect difficulty levels with robust error handling
            try {
                const difficultyInputs = document.querySelectorAll('.difficulty-input');
                console.log(`[SAVE_ALL] Found ${difficultyInputs.length} difficulty inputs`);
                
                difficultyInputs.forEach((input, index) => {
                    try {
                        const levelId = input.dataset.levelId;
                        if (levelId) {
                            const difficulty = input.value ? parseInt(input.value) : null;
                            const update = {
                                level_id: parseInt(levelId),
                                difficulty: difficulty
                            };
                            
                            if (isNaN(update.level_id)) {
                                console.warn(`[SAVE_ALL] Invalid level ID at difficulty input ${index + 1}:`, levelId);
                                return;
                            }
                            
                            difficultyUpdates.push(update);
                        }
                    } catch (difficultyError) {
                        console.error(`[SAVE_ALL] Error processing difficulty input ${index + 1}:`, difficultyError);
                        errors.push(`Error processing difficulty input ${index + 1}`);
                    }
                });
                
                console.log(`[SAVE_ALL] Collected ${difficultyUpdates.length} difficulty updates`);
                
            } catch (difficultyCollectionError) {
                console.error('[SAVE_ALL] Error collecting difficulty updates:', difficultyCollectionError);
                errors.push('Error collecting difficulty levels');
            }
            
            // Check for collection errors
            if (errors.length > 0) {
                console.error('[SAVE_ALL] Collection errors:', errors);
                // Re-enable buttons
                globalBtn.disabled = false;
                globalBtn.classList.remove('saving');
                if (topBtn) {
                    topBtn.disabled = false;
                    topBtn.textContent = 'Save All Mappings';
                }
                if (btnText) {
                    btnText.textContent = 'Save All Mappings';
                }
                alert('Errors occurred while collecting data:\n' + errors.join('\n') + '\n\nPlease check the console and try again.');
                console.groupEnd();
                return;
            }
        
            // Validate we have something to save
            if (mappings.length === 0 && difficultyUpdates.length === 0) {
                console.warn('[SAVE_ALL] No data to save');
                // Re-enable buttons
                globalBtn.disabled = false;
                globalBtn.classList.remove('saving');
                if (topBtn) {
                    topBtn.disabled = false;
                    topBtn.textContent = 'Save All Mappings';
                }
                if (btnText) {
                    btnText.textContent = 'Save All Mappings';
                }
                alert('No changes found to save.');
                console.groupEnd();
                return;
            }
            
            console.log('[SAVE_ALL] Summary of data to save:', {
                mappings: mappings.length,
                difficultyUpdates: difficultyUpdates.length
            });
            
            // Get CSRF token
            const csrfToken = window.ExamMapping.getCookie('csrftoken');
            if (!csrfToken) {
                console.error('[SAVE_ALL] âŒ CSRF token not found');
                // Re-enable buttons
                globalBtn.disabled = false;
                globalBtn.classList.remove('saving');
                if (topBtn) {
                    topBtn.disabled = false;
                    topBtn.textContent = 'Save All Mappings';
                }
                if (btnText) {
                    btnText.textContent = 'Save All Mappings';
                }
                alert('Error: Security token not found. Please refresh the page and try again.');
                console.groupEnd();
                return;
            }
            
            console.log('[SAVE_ALL] Starting save process...');
            
            // Save mappings first with enhanced error handling
            fetch('{% url "core:save_exam_mappings" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ 
                    mappings: mappings,
                    debug_info: {
                        source: 'save_all',
                        timestamp: new Date().toISOString(),
                        mappings_count: mappings.length,
                        user_agent: navigator.userAgent
                    }
                })
            })
            .then(response => {
                console.log('[SAVE_ALL] Mappings response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('[SAVE_ALL] Mappings response data:', data);
                
                if (data.success) {
                    console.log('[SAVE_ALL] âœ… Mappings saved successfully');
                    
                    // Now save difficulty levels if we have any
                    if (difficultyUpdates.length > 0) {
                        console.log('[SAVE_ALL] Saving difficulty levels...');
                        return fetch('{% url "core:save_difficulty_levels" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ 
                                difficulty_updates: difficultyUpdates,
                                debug_info: {
                                    source: 'save_all',
                                    timestamp: new Date().toISOString(),
                                    updates_count: difficultyUpdates.length
                                }
                            })
                        });
                    } else {
                        console.log('[SAVE_ALL] No difficulty updates to save');
                        return { success: true, message: 'No difficulty updates' };
                    }
                } else {
                    throw new Error(data.error || 'Failed to save mappings');
                }
            })
            .then(response => {
                if (difficultyUpdates.length > 0) {
                    console.log('[SAVE_ALL] Difficulty response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error on difficulty save! status: ${response.status}`);
                    }
                    return response.json();
                } else {
                    // Return the response as-is if it's just a success object
                    return response;
                }
            })
            .then(data => {
                console.log('[SAVE_ALL] Final response data:', data);
                
                // Re-enable buttons
                globalBtn.disabled = false;
                globalBtn.classList.remove('saving');
                if (topBtn) {
                    topBtn.disabled = false;
                    topBtn.textContent = 'Save All Mappings';
                }
                if (btnText) {
                    btnText.textContent = 'Save All Mappings';
                }
                
                if (data.success) {
                    console.log('[SAVE_ALL] âœ… All operations completed successfully');
                    console.log('[SAVE_ALL] Summary:', {
                        mappings_saved: mappings.length,
                        difficulties_saved: difficultyUpdates.length
                    });
                    console.groupEnd();
                    
                    const successMsg = `All changes saved successfully! (${mappings.length} mappings, ${difficultyUpdates.length} difficulty updates)`;
                    window.ExamMapping.showMessage(successMsg, 'success');
                    
                    // Flash the button green
                    try {
                        globalBtn.style.backgroundColor = '#28a745';
                        setTimeout(() => {
                            globalBtn.style.backgroundColor = '';
                        }, 1000);
                    } catch (styleError) {
                        console.warn('[SAVE_ALL] Could not flash button color:', styleError);
                        // Non-critical error, continue
                    }
                } else {
                    console.error('[SAVE_ALL] âŒ Save operation failed:', data.error);
                    console.groupEnd();
                    window.ExamMapping.showMessage('Error saving changes: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('[SAVE_ALL] âŒ Save operation error:', error);
                console.groupEnd();
                
                // Re-enable buttons
                globalBtn.disabled = false;
                globalBtn.classList.remove('saving');
                if (topBtn) {
                    topBtn.disabled = false;
                    topBtn.textContent = 'Save All Mappings';
                }
                if (btnText) {
                    btnText.textContent = 'Save All Mappings';
                }
                
                const errorMsg = `Network error while saving: ${error.message}. Please check your connection and try again.`;
                window.ExamMapping.showMessage(errorMsg, 'error');
                alert('Save failed: ' + error.message);
            });
            
        } catch (outerError) {
            console.error('[SAVE_ALL] âŒ Unexpected error in saveAllMappingsWithFeedback:', outerError);
            console.groupEnd();
            
            // Try to re-enable buttons even if we can't find them
            try {
                const btn = document.getElementById('globalSaveBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('saving');
                }
                const text = document.getElementById('saveButtonText');
                if (text) {
                    text.textContent = 'Save All Mappings';
                }
            } catch (btnError) {
                console.error('[SAVE_ALL] Could not re-enable buttons:', btnError);
            }
            
            alert('An unexpected error occurred. Please refresh the page and try again.');
        }
    }

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Comprehensive console logging for Level Exams page
    console.group('[LEVEL_EXAMS] Page Initialization');
    console.log('ðŸ“š Level Exams Configuration page loaded');
    console.log('ðŸ”„ New naming: "Level Exams" (previously "Exam-to-Level Mapping")');
    console.log('Page URL:', window.location.pathname);
    console.log('User:', '{{ user.username }}');
    console.groupEnd();
    
    // Enhanced DOM monitoring
    try {
        // Count exam selects and difficulty inputs for validation
        const examSelects = document.querySelectorAll('.exam-select');
        const difficultyInputs = document.querySelectorAll('.difficulty-input');
        const examRows = document.querySelectorAll('.exam-row');
        
        console.group('[DOM_STATS] Page Element Statistics');
        console.log('DOM element counts:', {
            exam_selects: examSelects.length,
            difficulty_inputs: difficultyInputs.length,
            exam_rows: examRows.length,
            containers: document.querySelectorAll('[id^="mapping-"]').length
        });
        console.groupEnd();
        
        // Validate ExamMapping namespace
        console.group('[NAMESPACE_VALIDATION] ExamMapping Functions Check');
        const requiredFunctions = [
            'saveLevelMappings',
            'saveAllMappingsWithFeedback', 
            'addExamSlot',
            'removeExamSlot',
            'updateStats',
            'getCookie',
            'showMessage'
        ];
        
        requiredFunctions.forEach(funcName => {
            if (window.ExamMapping && typeof window.ExamMapping[funcName] === 'function') {
                console.log(`âœ… ${funcName}: Available`);
            } else {
                console.error(`âŒ ${funcName}: Missing or not a function`);
            }
        });
        console.groupEnd();
        
    } catch (statsError) {
        console.error('[DOM_STATS] Error collecting DOM statistics:', statsError);
    }
    
    // Remove automatic disabling of inputs
    // window.ExamMapping.disableAllInputs();
    
    // Mark as authenticated by default for now
    isAuthenticated = true;
    
    // Update stats based on existing mappings with error handling
    console.log('[LEVEL_EXAMS] Updating statistics for existing mappings...');
    try {
        if (window.ExamMapping && typeof window.ExamMapping.updateStats === 'function') {
            window.ExamMapping.updateStats();
            console.log('[LEVEL_EXAMS] âœ… Stats updated successfully');
        } else {
            console.error('[LEVEL_EXAMS] updateStats function not available');
        }
    } catch (statsError) {
        console.error('[LEVEL_EXAMS] Error calling updateStats:', statsError);
    }
    
    // Update button states for existing mappings
    document.querySelectorAll('.exam-mapping-container').forEach(container => {
        const levelId = container.dataset.levelId;
        const rows = container.querySelectorAll('.exam-row');
        const addBtn = document.getElementById(`add-btn-${levelId}`);
        
        // Disable add button if we have 5 mappings
        if (addBtn && rows.length >= 5) {
            addBtn.disabled = true;
        }
        
        // Update clear/remove button states with defensive programming
        try {
            rows.forEach((row, index) => {
                try {
                    // DEFENSIVE: Validate row exists and is element
                    if (!row || typeof row.querySelector !== 'function') {
                        console.warn(`[DOM_UPDATE] Invalid row at index ${index}:`, row);
                        return;
                    }
                    
                    const select = row.querySelector('.exam-select');
                    const removeBtn = row.querySelector('.remove-exam-btn');
                    
                    if (select && select.value && removeBtn) {
                        removeBtn.disabled = false;
                    }
                } catch (rowError) {
                    console.error(`[DOM_UPDATE] Error processing row ${index}:`, rowError);
                    // Continue with other rows
                }
            });
        } catch (forEachError) {
            console.error('[DOM_UPDATE] Error in rows forEach:', forEachError);
        }
    });
});

})();

// Add safe function wrappers for inline event handlers
function safeCall(funcName, ...args) {
    try {
        if (typeof window[funcName] === 'function') {
            return window[funcName](...args);
        } else {
            console.error(`Function ${funcName} is not defined`);
        }
    } catch (error) {
        console.error(`Error calling ${funcName}:`, error);
    }
}
</script>
{% endblock %}