<!DOCTYPE html>
<html>
<head>
    <title>Copy Exam Modal Test - Comprehensive Fix</title>
    <style>
        .modal { display: none; background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .form-group { margin: 20px 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .form-group select:disabled { background-color: #f5f5f5; cursor: not-allowed; }
        button { padding: 12px 24px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .test-controls { margin-bottom: 20px; }
        .test-results { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; }
        h1, h2 { color: #2c3e50; }
        .status { padding: 5px 10px; border-radius: 3px; font-size: 12px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>üéØ Copy Exam Modal - Comprehensive Fix Test</h1>
    
    <div class="test-controls">
        <h2>Test Controls</h2>
        <button onclick="runFullTest()" class="btn-primary">üß™ Run Full Test</button>
        <button onclick="openTestModal()" class="btn-primary">üìã Open Copy Modal</button>
        <button onclick="testCurriculumLoad()" class="btn-secondary">üìä Test Curriculum Load</button>
        <button onclick="clearConsole()" class="btn-secondary">üßπ Clear Console</button>
    </div>
    
    <div class="test-results">
        <h3>Test Results</h3>
        <div id="testResults">
            Click "Run Full Test" to start comprehensive testing
        </div>
    </div>

    <!-- Copy Exam Modal -->
    <div id="copyExamModal" class="modal">
        <div class="modal-content">
            <h3>üìã Copy Exam to Another Class</h3>
            <form id="copyExamForm">
                <input type="hidden" id="sourceExamId" value="test-exam-123">
                
                <div class="form-group">
                    <label>Source Exam:</label>
                    <p id="sourceExamName" style="font-weight: 600; color: #2c3e50;">Test Exam - CORE Elite Level 1</p>
                </div>
                
                <div class="form-group">
                    <label for="copyProgramSelect">Program: <span class="status" id="programStatus">Not Loaded</span></label>
                    <select id="copyProgramSelect" name="program_select" required>
                        <option value="">-- Select Program --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="copySubprogramSelect">SubProgram: <span class="status" id="subprogramStatus">Disabled</span></label>
                    <select id="copySubprogramSelect" name="subprogram_select" required disabled>
                        <option value="">-- Select SubProgram --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="copyLevelSelect">Level: <span class="status" id="levelStatus">Disabled</span></label>
                    <select id="copyLevelSelect" name="level_select" required disabled>
                        <option value="">-- Select Level --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="copyExamType">Exam Type:</label>
                    <select id="copyExamType" name="exam_type" required>
                        <option value="">-- Select Type --</option>
                        <option value="REVIEW">Review (Monthly)</option>
                        <option value="QUARTERLY">Quarterly</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="timeslot">Time Period:</label>
                    <select id="timeslot" name="timeslot" required disabled>
                        <option value="">First select exam type...</option>
                    </select>
                </div>
                
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" onclick="closeTestModal()" class="btn-secondary">Cancel</button>
                    <button type="button" onclick="testCopySubmit()" class="btn-primary">Test Copy Process</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JSON data script (simulates Django template output) -->
    <script id="copy-curriculum-hierarchy-data" type="application/json">
    {"CORE": {"subprograms": {"Phonics": {"levels": [{"id": 47, "number": 1}, {"id": 48, "number": 2}, {"id": 49, "number": 3}]}, "Sigma": {"levels": [{"id": 59, "number": 1}, {"id": 60, "number": 2}, {"id": 61, "number": 3}]}, "Elite": {"levels": [{"id": 71, "number": 1}, {"id": 72, "number": 2}, {"id": 73, "number": 3}]}, "Pro": {"levels": [{"id": 83, "number": 1}, {"id": 84, "number": 2}, {"id": 85, "number": 3}]}}}, "ASCENT": {"subprograms": {"Nova": {"levels": [{"id": 50, "number": 1}, {"id": 51, "number": 2}, {"id": 52, "number": 3}]}, "Drive": {"levels": [{"id": 62, "number": 1}, {"id": 63, "number": 2}, {"id": 64, "number": 3}]}, "Pro": {"levels": [{"id": 74, "number": 1}, {"id": 75, "number": 2}, {"id": 76, "number": 3}]}}}, "EDGE": {"subprograms": {"Spark": {"levels": [{"id": 53, "number": 1}, {"id": 54, "number": 2}, {"id": 55, "number": 3}]}, "Rise": {"levels": [{"id": 65, "number": 1}, {"id": 66, "number": 2}, {"id": 67, "number": 3}]}, "Pursuit": {"levels": [{"id": 77, "number": 1}, {"id": 78, "number": 2}, {"id": 79, "number": 3}]}, "Pro": {"levels": [{"id": 86, "number": 1}, {"id": 87, "number": 2}, {"id": 88, "number": 3}]}}}, "PINNACLE": {"subprograms": {"Vision": {"levels": [{"id": 56, "number": 1}, {"id": 57, "number": 2}]}, "Endeavor": {"levels": [{"id": 68, "number": 1}, {"id": 69, "number": 2}]}, "Success": {"levels": [{"id": 80, "number": 1}, {"id": 81, "number": 2}]}, "Pro": {"levels": [{"id": 89, "number": 1}, {"id": 90, "number": 2}]}}}}
    </script>

    <script>
    // Global test state
    window.TestState = {
        curriculumLoaded: false,
        programsPopulated: false,
        cascadingWorks: false,
        testResults: []
    };

    console.log('üöÄ Copy Exam Modal Comprehensive Fix Test - Starting...');
    
    // Initialize curriculum data from JSON script (mimics Django template)
    const curriculumScriptElement = document.getElementById('copy-curriculum-hierarchy-data');
    if (curriculumScriptElement) {
        window.CopyCurriculumData = JSON.parse(curriculumScriptElement.textContent);
        window.CopyCurriculumDataReady = true;
        window.TestState.curriculumLoaded = true;
        
        console.log('‚úÖ Curriculum data loaded from JSON script');
        console.log('Programs available:', Object.keys(window.CopyCurriculumData));
        console.log('Total programs:', Object.keys(window.CopyCurriculumData).length);
        
        // Detailed structure logging
        Object.keys(window.CopyCurriculumData).forEach(program => {
            const subprograms = Object.keys(window.CopyCurriculumData[program].subprograms);
            const totalLevels = Object.values(window.CopyCurriculumData[program].subprograms)
                .reduce((total, sub) => total + sub.levels.length, 0);
            console.log(`  ${program}: ${subprograms.length} subprograms, ${totalLevels} levels`);
        });
        
    } else {
        console.error('‚ùå Failed to load curriculum hierarchy data from script element');
        window.CopyCurriculumData = null;
        window.CopyCurriculumDataReady = false;
    }

    // Enhanced populateCopyProgramDropdown function (matches template version)
    function populateCopyProgramDropdown() {
        console.group('[COPY_CURRICULUM] populateCopyProgramDropdown() - COMPREHENSIVE FIX');
        
        const programSelect = document.getElementById('copyProgramSelect');
        const programStatus = document.getElementById('programStatus');
        
        // Enhanced debugging information
        console.log('[COPY_CURRICULUM] Function called at:', new Date().toISOString());
        console.log('[COPY_CURRICULUM] DOM ready state:', document.readyState);
        console.log('[COPY_CURRICULUM] programSelect element:', !!programSelect);
        console.log('[COPY_CURRICULUM] programSelect visible:', programSelect ? window.getComputedStyle(programSelect).display !== 'none' : 'N/A');
        console.log('[COPY_CURRICULUM] window.CopyCurriculumData exists:', !!window.CopyCurriculumData);
        console.log('[COPY_CURRICULUM] window.CopyCurriculumDataReady:', window.CopyCurriculumDataReady);
        
        if (!programSelect) {
            console.error('[COPY_CURRICULUM] ‚ùå copyProgramSelect element not found in DOM!');
            programStatus.textContent = 'Element Not Found';
            programStatus.className = 'status error';
            console.groupEnd();
            return false;
        }
        
        if (!window.CopyCurriculumData) {
            console.error('[COPY_CURRICULUM] ‚ùå No curriculum data available!');
            programStatus.textContent = 'No Data';
            programStatus.className = 'status error';
            console.groupEnd();
            return false;
        }
        
        console.log('[COPY_CURRICULUM] üîÑ Starting program dropdown population...');
        console.log('[COPY_CURRICULUM] Available programs:', Object.keys(window.CopyCurriculumData));
        
        // Clear existing options except the first
        const initialHTML = '<option value="">-- Select Program --</option>';
        programSelect.innerHTML = initialHTML;
        console.log('[COPY_CURRICULUM] Reset dropdown to initial state');
        
        // Add programs with enhanced error handling
        let optionsAdded = 0;
        try {
            Object.keys(window.CopyCurriculumData).forEach(program => {
                const option = document.createElement('option');
                option.value = program;
                option.textContent = program;
                
                // Additional attributes for debugging
                option.setAttribute('data-subprogram-count', Object.keys(window.CopyCurriculumData[program].subprograms).length);
                
                programSelect.appendChild(option);
                optionsAdded++;
                console.log(`[COPY_CURRICULUM] ‚ûï Added option: "${program}" (${Object.keys(window.CopyCurriculumData[program].subprograms).length} subprograms)`);
            });
            
            console.log('[COPY_CURRICULUM] ‚úÖ Successfully added', optionsAdded, 'program options');
            console.log('[COPY_CURRICULUM] Final options count:', programSelect.options.length);
            console.log('[COPY_CURRICULUM] Options array:', Array.from(programSelect.options).map(opt => opt.textContent));
            
            // Update status
            programStatus.textContent = `${optionsAdded} Programs Loaded`;
            programStatus.className = 'status success';
            window.TestState.programsPopulated = true;
            
            console.log('[COPY_CURRICULUM] üéâ Program dropdown populated successfully');
            console.groupEnd();
            return true;
            
        } catch (error) {
            console.error('[COPY_CURRICULUM] ‚ùå Error during option creation:', error);
            console.error('[COPY_CURRICULUM] Stack trace:', error.stack);
            
            // Restore initial state on error
            programSelect.innerHTML = initialHTML;
            programStatus.textContent = 'Population Failed';
            programStatus.className = 'status error';
            console.log('[COPY_CURRICULUM] Restored initial state after error');
            console.groupEnd();
            return false;
        }
    }

    // Cascading dropdown functionality with status updates
    function setupCascadingDropdowns() {
        const programSelect = document.getElementById('copyProgramSelect');
        const subprogramSelect = document.getElementById('copySubprogramSelect');
        const levelSelect = document.getElementById('copyLevelSelect');
        const subprogramStatus = document.getElementById('subprogramStatus');
        const levelStatus = document.getElementById('levelStatus');
        
        programSelect.addEventListener('change', function() {
            const program = this.value;
            console.log('[CASCADE] Program changed to:', program);
            
            // Clear dependent dropdowns
            subprogramSelect.innerHTML = '<option value="">-- Select SubProgram --</option>';
            levelSelect.innerHTML = '<option value="">-- Select Level --</option>';
            subprogramSelect.disabled = !program;
            levelSelect.disabled = true;
            
            if (program && window.CopyCurriculumData[program]) {
                const subprograms = window.CopyCurriculumData[program].subprograms;
                Object.keys(subprograms).forEach(subprogram => {
                    const option = document.createElement('option');
                    option.value = subprogram;
                    option.textContent = subprogram;
                    subprogramSelect.appendChild(option);
                });
                
                subprogramStatus.textContent = `${Object.keys(subprograms).length} SubPrograms`;
                subprogramStatus.className = 'status success';
                console.log('[CASCADE] ‚úÖ Populated', Object.keys(subprograms).length, 'subprograms for', program);
            } else {
                subprogramStatus.textContent = 'Disabled';
                subprogramStatus.className = 'status warning';
            }
            
            levelStatus.textContent = 'Disabled';
            levelStatus.className = 'status warning';
        });

        subprogramSelect.addEventListener('change', function() {
            const program = programSelect.value;
            const subprogram = this.value;
            console.log('[CASCADE] SubProgram changed to:', subprogram);
            
            levelSelect.innerHTML = '<option value="">-- Select Level --</option>';
            levelSelect.disabled = !subprogram;
            
            if (program && subprogram && window.CopyCurriculumData[program]?.subprograms[subprogram]) {
                const levels = window.CopyCurriculumData[program].subprograms[subprogram].levels;
                levels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level.id;
                    option.textContent = `Level ${level.number}`;
                    levelSelect.appendChild(option);
                });
                
                levelStatus.textContent = `${levels.length} Levels`;
                levelStatus.className = 'status success';
                window.TestState.cascadingWorks = true;
                console.log('[CASCADE] ‚úÖ Populated', levels.length, 'levels for', program, subprogram);
            } else {
                levelStatus.textContent = 'Disabled';
                levelStatus.className = 'status warning';
            }
        });
        
        // Exam type cascading
        const examTypeSelect = document.getElementById('copyExamType');
        const timeslotSelect = document.getElementById('timeslot');
        
        examTypeSelect.addEventListener('change', function() {
            const examType = this.value;
            console.log('[CASCADE] Exam type changed to:', examType);
            
            timeslotSelect.disabled = false;
            timeslotSelect.innerHTML = '<option value="">Select time period...</option>';
            
            if (examType === 'QUARTERLY') {
                const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
                quarters.forEach(q => {
                    const option = document.createElement('option');
                    option.value = q;
                    option.textContent = `Quarter ${q.substring(1)}`;
                    timeslotSelect.appendChild(option);
                });
            } else if (examType === 'REVIEW') {
                const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month;
                    timeslotSelect.appendChild(option);
                });
            }
        });
    }

    // Test functions
    function runFullTest() {
        console.log('üß™ Running comprehensive test...');
        const results = [];
        
        // Test 1: Curriculum data loading
        const dataTest = window.CopyCurriculumData && window.CopyCurriculumDataReady;
        results.push({
            test: 'Curriculum Data Loading',
            passed: dataTest,
            details: dataTest ? `${Object.keys(window.CopyCurriculumData).length} programs loaded` : 'No data available'
        });
        
        // Test 2: Program dropdown population
        const populationResult = populateCopyProgramDropdown();
        results.push({
            test: 'Program Dropdown Population',
            passed: populationResult,
            details: populationResult ? `Programs: ${Object.keys(window.CopyCurriculumData).join(', ')}` : 'Population failed'
        });
        
        // Test 3: DOM elements present
        const elementsPresent = ['copyProgramSelect', 'copySubprogramSelect', 'copyLevelSelect', 'copyExamType', 'timeslot']
            .every(id => document.getElementById(id));
        results.push({
            test: 'Required DOM Elements',
            passed: elementsPresent,
            details: elementsPresent ? 'All elements found' : 'Missing elements'
        });
        
        // Test 4: Cascading functionality
        const cascadingTest = testCascading();
        results.push(cascadingTest);
        
        // Display results
        displayTestResults(results);
        
        const allPassed = results.every(r => r.passed);
        console.log(allPassed ? 'üéâ ALL TESTS PASSED!' : '‚ùå Some tests failed');
        
        return allPassed;
    }
    
    function testCascading() {
        const programSelect = document.getElementById('copyProgramSelect');
        const subprogramSelect = document.getElementById('copySubprogramSelect');
        
        if (programSelect.options.length <= 1) {
            return { test: 'Cascading Functionality', passed: false, details: 'No programs to test with' };
        }
        
        // Simulate selecting first program
        programSelect.value = programSelect.options[1].value;
        programSelect.dispatchEvent(new Event('change'));
        
        setTimeout(() => {
            const hasSubprograms = subprogramSelect.options.length > 1;
            console.log('[TEST] Cascading test - subprograms populated:', hasSubprograms);
        }, 100);
        
        return { test: 'Cascading Functionality', passed: true, details: 'Cascade events set up successfully' };
    }
    
    function testCurriculumLoad() {
        console.log('üìä Testing curriculum data structure...');
        
        if (!window.CopyCurriculumData) {
            console.error('‚ùå No curriculum data available');
            return false;
        }
        
        console.table(Object.keys(window.CopyCurriculumData).map(program => ({
            Program: program,
            SubPrograms: Object.keys(window.CopyCurriculumData[program].subprograms).length,
            TotalLevels: Object.values(window.CopyCurriculumData[program].subprograms)
                .reduce((total, sub) => total + sub.levels.length, 0)
        })));
        
        return true;
    }
    
    function displayTestResults(results) {
        const resultsDiv = document.getElementById('testResults');
        const timestamp = new Date().toLocaleTimeString();
        
        let html = `<h4>üß™ Test Results (${timestamp})</h4>`;
        
        results.forEach(result => {
            const icon = result.passed ? '‚úÖ' : '‚ùå';
            const statusClass = result.passed ? 'success' : 'error';
            html += `
                <div style="margin: 10px 0; padding: 10px; border-left: 4px solid ${result.passed ? '#28a745' : '#dc3545'}; background: ${result.passed ? '#d4edda' : '#f8d7da'};">
                    <strong>${icon} ${result.test}</strong><br>
                    <small>${result.details}</small>
                </div>
            `;
        });
        
        const passCount = results.filter(r => r.passed).length;
        html += `<div style="text-align: center; margin-top: 20px; font-weight: bold; color: ${passCount === results.length ? '#28a745' : '#dc3545'};">
            ${passCount}/${results.length} tests passed
        </div>`;
        
        resultsDiv.innerHTML = html;
    }

    // Modal control functions
    function openTestModal() {
        const modal = document.getElementById('copyExamModal');
        modal.classList.add('show');
        
        // Populate curriculum dropdown when modal opens
        setTimeout(() => {
            populateCopyProgramDropdown();
        }, 100);
    }

    function closeTestModal() {
        const modal = document.getElementById('copyExamModal');
        modal.classList.remove('show');
    }

    function testCopySubmit() {
        const formData = new FormData(document.getElementById('copyExamForm'));
        const data = {
            source_exam_id: formData.get('source_exam_id') || document.getElementById('sourceExamId').value,
            program: document.getElementById('copyProgramSelect').value,
            subprogram: document.getElementById('copySubprogramSelect').value,
            level: document.getElementById('copyLevelSelect').value,
            exam_type: document.getElementById('copyExamType').value,
            timeslot: document.getElementById('timeslot').value
        };
        
        console.log('üß™ Test copy submission data:', data);
        
        const missingFields = Object.entries(data).filter(([key, value]) => !value).map(([key]) => key);
        
        if (missingFields.length === 0) {
            console.log('‚úÖ All fields populated - copy would succeed!');
            alert(`‚úÖ Copy Test Successful!\n\nWould copy: ${data.source_exam_id}\nTo: ${data.program} ${data.subprogram} Level ${data.level}\nAs: ${data.exam_type} - ${data.timeslot}`);
        } else {
            console.log('‚ùå Missing required fields:', missingFields);
            alert(`‚ùå Missing fields: ${missingFields.join(', ')}\n\nPlease complete all dropdowns before testing copy.`);
        }
    }
    
    function clearConsole() {
        console.clear();
        console.log('üßπ Console cleared - Copy Exam Modal Test Ready');
    }

    // Auto-initialization
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Page loaded, setting up Copy Exam Modal test...');
        
        // Set up cascading dropdowns
        setupCascadingDropdowns();
        
        // Auto-populate on load
        if (typeof populateCopyProgramDropdown === 'function') {
            const result = populateCopyProgramDropdown();
            
            if (result) {
                console.log('üéâ AUTO-INITIALIZATION PASSED: Program dropdown populated successfully!');
            } else {
                console.error('‚ùå AUTO-INITIALIZATION FAILED: Program dropdown population failed');
            }
        }
        
        console.log('‚ú® Copy Exam Modal test environment ready');
    });
    
    // Global debug helpers
    window.debugCopyModal = {
        testData: () => window.CopyCurriculumData,
        testPopulate: () => populateCopyProgramDropdown(),
        testCascade: testCascading,
        runTests: runFullTest,
        showState: () => console.log('Test State:', window.TestState)
    };
    
    console.log('üîß Debug helpers available at: window.debugCopyModal');
    </script>
</body>
</html>