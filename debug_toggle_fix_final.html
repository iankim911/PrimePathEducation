

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Library - RoutineTest</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="shortcut icon" href="/static/favicon.ico">
    
    <!-- Mobile Responsive CSS -->
    <link rel="stylesheet" href="/static/css/mobile-responsive.css">
    
    <!-- PrimePath Brand Design System -->
    <link rel="stylesheet" href="/static/css/primepath_brand.css">
    
    <!-- Unified Design System - UI Harmonization -->
    <link rel="stylesheet" href="/static/css/unified-design-system.css?v=2.0">
    
    
    <!-- Console Debugging for RoutineTest -->
    <script>
        console.log('%c[RoutineTest] Page Loading...', 'color: #00A65E; font-weight: bold;');
        console.log('[RoutineTest] Navigation: Tab-based horizontal layout');
        console.log('[RoutineTest] Theme: BCG Green (#00A65E)');
        console.log('[RoutineTest] Module: Continuous Assessment Platform');
        window.ROUTINETEST_DEBUG = true;
        window.MATRIX_TAB_VERSION = '3.0';
        window.NAVIGATION_TIMESTAMP = new Date().toISOString();
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* Header Section - BCG Forest Green Theme */
        .header {
            background-color: #1B5E20;  /* Darker, more muted green */
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .header h1 {
            text-align: center;
            font-size: 2rem;
            color: white; /* Ensure header text is white for readability */
        }
        
        .header {
            position: relative; /* For mode toggle positioning */
        }
        
        /* Navigation Tabs - Using Unified Design System */
        .nav-tabs {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-green-dark) 100%);
            padding: 0;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            overflow-x: auto;  /* Allow horizontal scroll for many tabs */
            -webkit-overflow-scrolling: touch;  /* Smooth scrolling on mobile */
            border-bottom: 2px solid var(--primary-green-border);  /* Visual separation */
        }
        
        /* Custom scrollbar for nav tabs */
        .nav-tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .nav-tabs::-webkit-scrollbar-track {
            background: #0A3D15;
        }
        
        .nav-tabs::-webkit-scrollbar-thumb {
            background: #2E7D32;
            border-radius: 2px;
        }
        
        /* Removed Matrix tab styles - no longer part of V8 navigation */
        
        .nav-tabs * {
            box-sizing: border-box;
        }
        
        .nav-tabs ul {
            list-style: none;
            display: flex;
            margin: 0 auto;
            max-width: none;  /* Remove width restriction */
            padding: 0 10px;  /* Minimal padding */
            overflow-x: auto;  /* Allow scroll if needed for 6+ tabs */
            width: 100%;
            flex-wrap: nowrap;  /* Keep tabs in single row */
        }
        
        .nav-tabs li {
            margin: 0;
            padding: 0;
            display: flex;
        }
        
        .nav-tabs a {
            display: block;
            padding: 16px 20px;  /* Bigger padding for larger tabs */
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: bold;  /* Make fonts bold */
            position: relative;
            height: 100%;
            white-space: nowrap;
            font-size: 20px;  /* Much bigger font size (~2 sizes bigger) */
            min-width: fit-content;  /* Ensure tabs can accommodate content */
            flex-shrink: 0;  /* Prevent tabs from shrinking too much */
        }
        
        .nav-tabs a:hover {
            background-color: #1B5E20;  /* Darker muted green on hover */
            color: white;
        }
        
        /* WCAG AAA Compliant - High Contrast Active Tab */
        .nav-tabs a.active {
            background-color: #E8F5E9 !important;  /* Light green background */
            color: #0D4F1F !important;  /* Very dark green text - contrast ratio > 7:1 */
            font-weight: 700;
            box-shadow: inset 0 -3px 0 #2E7D32;
            border-top: 2px solid #2E7D32;  /* Green accent for better visibility */
            position: relative;
        }
        
        /* Focus styles for keyboard navigation */
        .nav-tabs a:focus {
            outline: 2px solid #2E7D32;
            outline-offset: 2px;
            background-color: #1B5E20;
        }
        
        .nav-tabs a.active:focus {
            outline: 2px solid #2E7D32;
            outline-offset: 2px;
        }
        
        /* Profile Link Styling */
        .nav-tabs .profile-link {
            display: flex !important;
            align-items: center;
            white-space: nowrap !important;
            min-width: fit-content;
        }
        
        .nav-tabs .profile-link span {
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Logout Button - Red with WHITE text */
        #logout-link,
        a[href="/logout/"],
        a[href*="logout"],
        .nav-tabs a[href="/logout/"],
        .nav-tabs a[style*="background: #e74c3c"] {
            background-color: #e74c3c !important;
            color: white !important;
            color: #FFFFFF !important;
            text-decoration: none !important;
        }
        
        #logout-link:hover,
        a[href="/logout/"]:hover,
        a[href*="logout"]:hover,
        .nav-tabs a[href="/logout/"]:hover,
        .nav-tabs a[style*="background: #e74c3c"]:hover {
            background-color: #c0392b !important;
            color: white !important;
            color: #FFFFFF !important;
            text-decoration: none !important;
        }
        
        /* Container - Full width for navigation */
        .container {
            max-width: 100%;  /* Full width */
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Content container with max width */
        .content-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Content Area */
        .content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }
        
        /* Messages/Alerts - BCG Green Theme */
        .messages {
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 4px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .alert-success {
            background-color: #F1F8E9;
            border: 1px solid #689F38;  /* Muted olive green border */
            color: #33691E;  /* Dark olive green text */
        }
        
        .alert-info {
            background-color: #E0F2F1;
            border: 1px solid #00ACC1;
            color: #004D40;
        }
        
        .alert-warning {
            background-color: #FFF3E0;
            border: 1px solid #FF9800;
            color: #E65100;
        }
        
        .alert-danger {
            background-color: #FFEBEE;
            border: 1px solid #F44336;
            color: #B71C1C;
        }
        
        .close-alert {
            float: right;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: inherit;
            margin-left: 20px;
        }
        
        /* Buttons - PrimePath Navy Theme */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primepath-navy) 0%, var(--primepath-navy-dark) 100%);
            color: white;
            text-decoration: none;
            border-radius: var(--border-radius-pill);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--brand-shadow-sm);
        }
        
        .btn:hover {
            background: linear-gradient(135deg, var(--primepath-navy-light) 0%, var(--primepath-navy) 100%);
            transform: translateY(-2px);
            box-shadow: var(--brand-shadow-md);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--brand-dark-gray) 0%, #495057 100%);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #495057 0%, var(--brand-dark-gray) 100%);
        }
        
        /* Danger button - MUST stay red for destructive actions */
        .btn-danger,
        button.btn-danger,
        .btn.btn-danger,
        button[onclick*="confirmDelete"] {
            background-color: #dc3545 !important;
            background-image: none !important;
            border-color: #dc3545 !important;
            color: white !important;
        }
        
        .btn-danger:hover,
        button.btn-danger:hover,
        .btn.btn-danger:hover,
        button[onclick*="confirmDelete"]:hover {
            background-color: #c82333 !important;
            background-image: none !important;
            border-color: #bd2130 !important;
            transform: translateY(-2px) !important;
        }
        
        /* NUCLEAR OVERRIDE - Ensure delete buttons are NEVER green */
        .routinetest-theme .btn-danger,
        .routinetest-theme button.btn-danger,
        .routinetest-theme .btn.btn-danger,
        .routinetest-theme button[onclick*="confirmDelete"],
        body.routinetest-theme .btn-danger,
        body.routinetest-theme button.btn-danger,
        body.routinetest-theme button[onclick*="confirmDelete"] {
            background-color: #dc3545 !important;
            background-image: none !important;
            border-color: #dc3545 !important;
            color: white !important;
        }
        
        /* Form Controls - PrimePath Brand Theme */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--brand-gray);
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primepath-navy);
            box-shadow: 0 0 0 0.2rem rgba(27, 41, 81, 0.1);
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--primepath-navy);
        }
    </style>
    
    
<!-- PrimePath Brand Override CSS -->
<link rel="stylesheet" href="/static/css/routinetest-brand-override.css?v=1756041114">

    
</head>
<body class="routinetest-theme">
    <!-- Immediate theme application -->
    <script>
        // Apply theme class immediately to prevent FOUC
        document.documentElement.classList.add('routinetest-theme');
        if (document.body) {
            document.body.classList.add('routinetest-theme');
        }
    </script>
    <!-- Debug Console Logger -->
    <script>
        console.group('%cðŸŽ¨ RoutineTest Navigation Loaded', 'background: #1B2951; color: white; padding: 5px; border-radius: 3px;');
        console.log('Theme: PrimePath Navy (#1B2951)');
        console.log('Navigation: Horizontal Tab Layout');
        console.log('Module: Exam Management System');
        console.log('User: admin');
        console.groupEnd();
    </script>
    
    <!-- Header Section -->
    <div class="header">
        <div class="container">
            <h1>Exam Library</h1>
        </div>
    </div>
    
    <!-- Navigation Tabs - Version 8.0 with Complete Cache Busting -->
    <!-- UNIFIED CLASSES & EXAMS ONLY - NO OLD TABS -->
    <!-- RoutineTest Navigation - VERSION 8.0 UNIFIED COMPLETE -->
<!-- Cache Bust: 1756041114 -->
<!-- NO OLD TABS - UNIFIED CLASSES & EXAMS ONLY -->
<!-- SUPPORTS UP TO 6 TABS: 4 main tabs + 2 additional tabs with overflow scrolling -->
<nav class="nav-tabs" id="routinetest-nav-v8-762" data-version="8.0" data-timestamp="2025-08-24T22:11:54.964251+09:00">
    <ul style="display: flex; justify-content: flex-start; width: 100%; gap: 5px;">
        <div style="display: flex; flex: 1; gap: 5px;">
            <!-- Dashboard -->
            <li>
                <a href="/RoutineTest/" 
                   data-nav="dashboard"
                   class="">
                   Dashboard
                </a>
            </li>
            
            <!-- Upload Exam -->
            <li>
                <a href="/RoutineTest/exams/create/" 
                   data-nav="upload"
                   class="">
                   Upload Exam
                </a>
            </li>
            
            <!-- Exam Library -->
            <li>
                <a href="/RoutineTest/exams/" 
                   data-nav="keys"
                   class="active">
                   Exam Library
                </a>
            </li>
            
            <!-- UNIFIED CLASSES & EXAMS TAB (VERSION 8) -->
            <li id="unified-tab-v8">
                <a href="/RoutineTest/classes-exams/" 
                   data-nav="classes-exams"
                   class="">
                   Classes & Exams
                </a>
            </li>
            
            <!-- Admin Only: Curriculum Mapping - Only show in Admin mode -->
            
        </div>
        
        <!-- User Section -->
        <div style="display: flex; margin-left: auto;">
            
                <li><a href="#" class="profile-link"><span class="nav-icon">ðŸ‘¤</span> admin</a></li>
                <li><a href="/logout/" style="background: #e74c3c; color: white !important; display: flex; align-items: center; justify-content: center; text-align: center;">Logout</a></li>
            
        </div>
    </ul>
</nav>

<!-- Aggressive Cache Busting and Verification Script -->
<script>
(function() {
    const navVersion = 8.0;
    const timestamp = new Date().getTime();
    const userId = '762';
    
    console.group('%c[NAV_V8_UNIFIED] RoutineTest Navigation Version 8.0', 
        'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border-radius: 5px; font-weight: bold;');
    
    console.log('ðŸ“Œ Version:', navVersion);
    console.log('â±ï¸ Timestamp:', new Date(timestamp).toISOString());
    console.log('ðŸ‘¤ User:', userId);
    console.log('ðŸ”„ Cache Bust ID:', timestamp);
    
    // Log URL resolution from Django templates
    console.group('ðŸ”— URL Resolution from Django:');
    console.log('Dashboard URL: /RoutineTest/');
    console.log('Create Exam URL: /RoutineTest/exams/create/');
    console.log('Exam List URL: /RoutineTest/exams/');
    console.log('Classes & Exams URL: /RoutineTest/classes-exams/');
    console.log('Session List URL: /RoutineTest/sessions/');
    
    console.log('Curriculum Mapping URL: /RoutineTest/curriculum-mapping/');
    
    console.groupEnd();
    
    // Verify navigation structure
    const nav = document.getElementById('routinetest-nav-v8-' + userId);
    if (nav) {
        console.log('âœ… Navigation V8 element found');
        
        // Count and log all tabs
        const allTabs = nav.querySelectorAll('a[data-nav]');
        console.log('ðŸ“Š Total navigation tabs:', allTabs.length);
        
        const tabStructure = [];
        allTabs.forEach((tab, index) => {
            const text = tab.textContent.trim();
            const dataNav = tab.getAttribute('data-nav');
            const href = tab.getAttribute('href');
            
            tabStructure.push({
                index: index + 1,
                text: text,
                dataNav: dataNav,
                href: href
            });
            
            // Log each tab
            const isUnified = dataNav === 'classes-exams';
            const marker = isUnified ? 'ðŸŽ¯' : '  ';
            console.log(`${marker} Tab ${index + 1}: "${text}" [${dataNav}] â†’ ${href}`);
        });
        
        // Check for unified tab
        const unifiedTab = nav.querySelector('a[data-nav="classes-exams"]');
        if (unifiedTab) {
            console.log('âœ… UNIFIED TAB FOUND:', unifiedTab.textContent.trim());
            
            // Force visibility
            const unifiedLi = document.getElementById('unified-tab-v8');
            if (unifiedLi) {
                unifiedLi.style.display = 'flex';
                unifiedLi.style.visibility = 'visible';
                unifiedLi.style.opacity = '1';
                console.log('âœ… Unified tab visibility enforced (consistent styling applied)');
            }
        } else {
            console.error('âŒ UNIFIED TAB NOT FOUND!');
        }
        
        // Check for OLD tabs (should not exist)
        const oldTabsCheck = Array.from(allTabs).filter(tab => {
            const text = tab.textContent;
            const dataNav = tab.getAttribute('data-nav');
            return (text.includes('My Classes') && text.includes('Access')) || 
                   text.includes('Exam Assignments') ||
                   dataNav === 'my-classes' ||
                   dataNav === 'exam-assignments';
        });
        
        if (oldTabsCheck.length > 0) {
            console.error('âŒ OLD TABS DETECTED:', oldTabsCheck.map(t => t.textContent.trim()));
            console.error('These tabs should be removed!');
            
            // Remove old tabs dynamically
            oldTabsCheck.forEach(tab => {
                const li = tab.closest('li');
                if (li) {
                    li.style.display = 'none';
                    console.log('ðŸ—‘ï¸ Hiding old tab:', tab.textContent.trim());
                }
            });
        } else {
            console.log('âœ… No old tabs found - navigation is clean');
        }
        
        // Store navigation state
        window.ROUTINETEST_NAV_V8 = {
            version: navVersion,
            timestamp: timestamp,
            tabs: tabStructure,
            unified: unifiedTab ? true : false
        };
        
    } else {
        console.error('âŒ Navigation V8 element not found!');
    }
    
    console.groupEnd();
    
    // Track any URL modifications
    const originalUrls = {};
    document.querySelectorAll('.nav-tabs a').forEach(link => {
        const dataNav = link.getAttribute('data-nav');
        if (dataNav) {
            originalUrls[dataNav] = link.href;
        }
    });
    
    // Periodic check to ensure navigation stays correct and URLs aren't modified
    let checkCount = 0;
    const checkInterval = setInterval(function() {
        checkCount++;
        
        const tabs = document.querySelectorAll('.nav-tabs a[data-nav]');
        
        // Check for URL modifications
        tabs.forEach(tab => {
            const dataNav = tab.getAttribute('data-nav');
            if (dataNav && originalUrls[dataNav] && tab.href !== originalUrls[dataNav]) {
                console.error(`[URL_MODIFIED] ${dataNav}: ${originalUrls[dataNav]} â†’ ${tab.href}`);
            }
        });
        
        const hasOldTabs = Array.from(tabs).some(tab => 
            tab.getAttribute('data-nav') === 'my-classes' || 
            tab.getAttribute('data-nav') === 'exam-assignments'
        );
        
        if (hasOldTabs) {
            console.warn(`[NAV_V8_CHECK_${checkCount}] Old tabs detected at ${new Date().toISOString()}`);
            // Hide them
            tabs.forEach(tab => {
                if (tab.getAttribute('data-nav') === 'my-classes' || 
                    tab.getAttribute('data-nav') === 'exam-assignments') {
                    tab.closest('li').style.display = 'none';
                }
            });
        }
        
        if (checkCount >= 5) {
            clearInterval(checkInterval);
            console.log('[NAV_V8_MONITORING] Completed 5 checks, navigation stable');
        }
    }, 1000);
})();

// Simple navigation debouncing to prevent rapid clicking
(function() {
    let lastClickTime = 0;
    const clickDelay = 300; // 300ms debounce
    
    document.addEventListener('click', function(e) {
        const navLink = e.target.closest('.nav-tabs a');
        if (navLink) {
            const now = Date.now();
            if (now - lastClickTime < clickDelay) {
                e.preventDefault();
                return false;
            }
            lastClickTime = now;
        }
    });
})();
</script>

<style>
/* Navigation V8 Specific Styles */
#routinetest-nav-v8-762 {
    position: relative;
    z-index: 1000;
}

#unified-tab-v8 {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Navigation Icon Styling - Ensures emojis display properly */
.nav-icon {
    display: inline-block;
    font-size: 1.1em;
    margin-right: 6px;
    vertical-align: middle;
    font-family: "Apple Color Emoji", "Segoe UI Emoji", "NotoColorEmoji", "Noto Color Emoji", "Segoe UI Symbol", "Android Emoji", "EmojiSymbols" !important;
    line-height: 1;
}

/* Hide any old tabs if they somehow appear */
li:has(a[data-nav="my-classes"]),
li:has(a[data-nav="exam-assignments"]) {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
}
</style>
    
    
    <!-- Additional Navigation Verification -->
    <script>
        console.log('[ROUTINETEST_BASE] Loading Navigation V8 at', new Date().toISOString());
        console.log('[ROUTINETEST_BASE] User: admin');
        console.log('[ROUTINETEST_BASE] Cache Bust: 1756041114');
    </script>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Messages/Alerts -->
        
        
        <!-- Page Content -->
        <div class="content">
            
<!-- CSRF Token for AJAX requests -->
<input type="hidden" name="csrfmiddlewaretoken" value="oiWKaBAqJZ1OE85Q2wr3vC38hWjAeM8NShaHqh4EypS4ijCFiRR7yKZXgghxIPlk">

<!-- ============================================================================ -->
<!-- CRITICAL: Global Functions - MUST load before any buttons are rendered      -->
<!-- ============================================================================ -->
<!-- CRITICAL FUNCTIONS - Must be loaded IMMEDIATELY in global scope -->
<!-- This script MUST be included right after <body> tag or in <head> -->
<script>
(function() {
    'use strict';
    
    console.log('%c[CRITICAL_FUNCTIONS] Initializing global exam functions...', 'color: #FF6B6B; font-weight: bold');
    
    // ============================================================================
    // GLOBAL FUNCTION DEFINITIONS - MUST BE AVAILABLE BEFORE ANY ONCLICK
    // ============================================================================
    
    // Track initialization
    window.EXAM_FUNCTIONS_READY = false;
    window.EXAM_FUNCTIONS_INIT_TIME = Date.now();
    
    // Track deletion state to prevent multiple requests
    window.DELETION_IN_PROGRESS = {};
    
    // Delete functionality
    window.confirmDelete = function(examId, examName) {
        console.log('%c[DELETE] confirmDelete called', 'color: #e74c3c; font-weight: bold', {
            examId: examId,
            examName: examName,
            timestamp: new Date().toISOString()
        });
        
        if (!examId) {
            console.warn('[DELETE] No exam ID provided');
            alert('Error: No exam ID provided for deletion');
            return;
        }
        
        // Check if deletion is already in progress for this exam
        if (window.DELETION_IN_PROGRESS[examId]) {
            console.warn('[DELETE] Deletion already in progress for exam:', examId);
            return;
        }
        
        const confirmMessage = `Are you sure you want to delete "${examName || 'this exam'}"?\n\nThis action cannot be undone.`;
        
        if (confirm(confirmMessage)) {
            console.log('[DELETE] User confirmed deletion');
            window.deleteExam(examId);
        } else {
            console.log('[DELETE] User cancelled deletion');
        }
    };
    
    window.deleteExam = async function(examId) {
        // ENHANCED COMPREHENSIVE DEBUGGING
        const deleteDebugInfo = {
            examId: examId,
            timestamp: new Date().toISOString(),
            user: document.querySelector('meta[name="user-name"]')?.content || 'Unknown',
            userId: document.querySelector('meta[name="user-id"]')?.content || 'Unknown',
            isAdmin: document.querySelector('meta[name="user-is-admin"]')?.content === 'true',
            currentUrl: window.location.href,
            examCard: document.querySelector(`[data-exam-id="${examId}"]`) ? 'Found' : 'Not Found'
        };
        
        console.log('%c[DELETE] ðŸš¨ Starting exam deletion', 'color: #e74c3c; font-weight: bold', deleteDebugInfo);
        
        // Prevent multiple simultaneous deletions
        if (window.DELETION_IN_PROGRESS[examId]) {
            console.warn('[DELETE] âš ï¸ Already processing deletion for exam:', examId);
            return;
        }
        
        // Mark as in progress
        window.DELETION_IN_PROGRESS[examId] = true;
        
        // Disable all delete buttons temporarily
        const deleteButtons = document.querySelectorAll('button[onclick*="confirmDelete"]');
        deleteButtons.forEach(btn => {
            if (btn.onclick && btn.onclick.toString().includes(examId)) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        });
        
        // Track if this is a permission denial
        let isPermissionDenied = false;
        let result = null;  // Initialize result variable in outer scope
        
        console.log('[DELETE] Starting deletion process for exam:', examId);
        
        try {
            const deleteUrl = `/RoutineTest/exams/${examId}/delete/`;
            console.log('[DELETE] Sending DELETE request to:', deleteUrl);
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             document.querySelector('meta[name="csrf-token"]')?.content || '';
            
            if (!csrfToken) {
                console.warn('[DELETE] No CSRF token found, request may fail');
            }
            
            // ENHANCED REQUEST WITH DEBUGGING
            console.log('[DELETE] ðŸ“¡ Sending DELETE request with:', {
                url: deleteUrl,
                method: 'DELETE',
                hasCSRFToken: !!csrfToken,
                csrfTokenLength: csrfToken ? csrfToken.length : 0
            });
            
            const response = await fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'  // Ensure cookies are sent
            });
            
            // Only log non-permission responses
            if (response.status !== 403) {
                console.log('[DELETE] Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
            }
            
            if (!response.ok) {
                let errorData;
                try {
                    errorData = await response.json();
                } catch (jsonError) {
                    errorData = { error: `HTTP error! status: ${response.status}` };
                }
                
                // Handle permission errors with enhanced debugging
                if (response.status === 403) {
                    // COMPREHENSIVE PERMISSION DENIAL DEBUGGING
                    const permissionDebug = {
                        status: 'Access Denied (403)',
                        examId: examId,
                        errorResponse: errorData,
                        userInfo: deleteDebugInfo,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.group('%c[DELETE] âŒ PERMISSION DENIED', 'color: #e74c3c; font-weight: bold');
                    console.log('Debug Info:', permissionDebug);
                    console.log('Server Response:', errorData);
                    console.log('Detailed Error:', errorData.details || 'No details provided');
                    console.groupEnd();
                    
                    // Clean up the error message for better user experience
                    let permissionMessage = errorData.error || 
                        "You do not have permission to delete this exam.";
                    
                    // Log permission denial with full context
                    console.info('%c[DELETE] Permission check result:', 'color: #f39c12', {
                        status: 'Access Denied',
                        reason: errorData.details?.reason || 'Insufficient permissions',
                        required: 'FULL access',
                        message: 'This is expected behavior - user needs FULL access to delete'
                    });
                    
                    // Clean up message if needed
                    if (!permissionMessage.includes('Access Denied') && !permissionMessage.includes('FULL access')) {
                        permissionMessage = "You do not have the required access level to delete this exam. Only teachers with FULL access can delete exams.";
                    }
                    
                    // Show user-friendly notification
                    if (window.showErrorNotification) {
                        window.showErrorNotification(permissionMessage);
                    } else {
                        alert('Access Denied\n\n' + permissionMessage);
                    }
                    
                    // Mark as permission denied - DON'T throw error, DON'T return early
                    isPermissionDenied = true;
                    console.log('[DELETE] Permission denied flag set, skipping further processing');
                } else {
                    // Only log non-permission errors
                    console.error('[DELETE] Server error (non-403):', {
                        status: response.status,
                        error: errorData,
                        examId: examId
                    });
                    
                    // For other errors, throw to be caught by catch block
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
            }
            
            // Only process success response if not a permission denial
            if (!isPermissionDenied && response.ok) {
                const result = await response.json();
                console.log('[DELETE] Processing success response:', {
                    success: result.success,
                    message: result.message,
                    examId: examId
                });
                
                if (result.success) {
                    // Find and remove the exam card from DOM
                    const examCard = document.querySelector(`button[onclick*="${examId}"]`)?.closest('.exam-card');
                    if (examCard) {
                        console.log('[DELETE] Removing exam card from DOM');
                        const classExams = examCard.closest('.class-exams');
                        
                        // Animate removal
                        examCard.style.transition = 'opacity 0.3s, transform 0.3s';
                        examCard.style.opacity = '0';
                        examCard.style.transform = 'scale(0.95)';
                        
                        setTimeout(() => {
                            examCard.remove();
                            
                            // Check if this was the last exam
                            if (classExams && classExams.querySelectorAll('.exam-card').length === 0) {
                                classExams.innerHTML = '<div class="no-exams">No exams in this class</div>';
                            }
                            
                            // Show success notification
                            if (window.showSuccessNotification) {
                                window.showSuccessNotification('Exam deleted successfully');
                            } else {
                                alert('Exam deleted successfully');
                            }
                        }, 300);
                    } else {
                        console.log('[DELETE] Exam card not found, reloading page');
                        alert('Exam deleted successfully');
                        setTimeout(() => window.location.reload(), 1500);
                    }
                } else if (!isPermissionDenied && result) {
                    // Log as warning, not error, since this is a controlled response
                    console.warn('[DELETE] Server returned success:false', result);
                    alert(result.message || result.error || 'Failed to delete exam');
                }
            }
        } catch (error) {
            // Don't log or handle if permission was already denied
            if (isPermissionDenied) {
                console.log('[DELETE] Skipping error handling - permission already denied');
                return;
            }
            
            // Only log actual errors, not permission denials
            if (error && error.message && !error.message.includes('permission') && !error.message.includes('Access Denied')) {
                console.error('[DELETE] Exception caught:', error);
            }
            
            // Only show error if it's not a permission error (already handled above)
            if (error && error.message && !error.message.includes('permission') && !error.message.includes('Access Denied')) {
                if (window.showErrorNotification) {
                    window.showErrorNotification('Error deleting exam: ' + error.message);
                } else {
                    alert('Error deleting exam: ' + error.message);
                }
            }
        } finally {
            // Always clean up state
            delete window.DELETION_IN_PROGRESS[examId];
            
            // Re-enable delete buttons
            const deleteButtons = document.querySelectorAll('button[onclick*="confirmDelete"]');
            deleteButtons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(examId)) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
            
            console.log('[DELETE] Cleanup complete for exam:', examId);
        }
    };
    
    // Copy functionality
    window.openCopyModal = function(examId, examName) {
        console.log('%c[COPY] openCopyModal called', 'color: #3498db; font-weight: bold', {
            examId: examId,
            examName: examName,
            timestamp: new Date().toISOString()
        });
        
        if (!examId) {
            console.error('[COPY] No exam ID provided');
            alert('Error: No exam ID provided for copying');
            return;
        }
        
        // Check if modal manager is available
        if (window.CopyModalManager && window.CopyModalManager.open) {
            console.log('[COPY] Using CopyModalManager');
            window.CopyModalManager.open(examId, examName);
        } else if (window.openCopyModalInternal) {
            console.log('[COPY] Using openCopyModalInternal');
            window.openCopyModalInternal(examId, examName);
        } else {
            console.error('[COPY] No copy modal handler available yet');
            // Store for later execution
            window.pendingCopyModal = { examId, examName };
            alert('Copy modal is still loading. Please try again in a moment.');
        }
    };
    
    window.closeCopyModal = function() {
        console.log('%c[COPY] closeCopyModal called', 'color: #3498db; font-weight: bold');
        
        if (window.CopyModalManager && window.CopyModalManager.close) {
            window.CopyModalManager.close();
        } else if (window.closeCopyModalInternal) {
            window.closeCopyModalInternal();
        } else {
            // Fallback: try to hide modal directly
            const modal = document.getElementById('copyExamModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
    };
    
    // Notification functions
    window.showSuccessNotification = function(message) {
        console.log('[NOTIFICATION] Success:', message);
        if (window.showNotification) {
            window.showNotification(message, 'success');
        } else {
            alert('âœ“ ' + message);
        }
    };
    
    window.showErrorNotification = function(message) {
        console.log('[NOTIFICATION] Error:', message);
        if (window.showNotification) {
            window.showNotification(message, 'error');
        } else {
            alert('âœ— ' + message);
        }
    };
    
    window.showNotification = function(message, type) {
        type = type || 'info';
        console.log(`[NOTIFICATION] ${type}:`, message);
        
        // Remove any existing notifications
        const existingNotification = document.querySelector('.exam-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `exam-notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 10001;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `;
        
        // Set colors based on type
        if (type === 'success') {
            notification.style.backgroundColor = '#4CAF50';
            notification.style.color = 'white';
        } else if (type === 'error') {
            notification.style.backgroundColor = '#f44336';
            notification.style.color = 'white';
        } else {
            notification.style.backgroundColor = '#2196F3';
            notification.style.color = 'white';
        }
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    };
    
    // Toggle functions for collapsible sections
    window.toggleProgram = function(program) {
        console.log('%c[TOGGLE] toggleProgram called', 'color: #9b59b6; font-weight: bold', { program });
        const section = document.querySelector(`.program-section[data-program="${program}"]`);
        if (section) {
            section.classList.toggle('collapsed');
        } else {
            console.warn('[TOGGLE] Program section not found:', program);
        }
    };
    
    window.toggleClass = function(classCode) {
        console.log('%c[TOGGLE] toggleClass called', 'color: #9b59b6; font-weight: bold', { classCode });
        const section = document.querySelector(`.class-section[data-class="${classCode}"]`);
        if (section) {
            section.classList.toggle('collapsed');
        } else {
            console.warn('[TOGGLE] Class section not found:', classCode);
        }
    };
    
    // Mark as ready
    window.EXAM_FUNCTIONS_READY = true;
    
    // Log initialization complete
    const initTime = Date.now() - window.EXAM_FUNCTIONS_INIT_TIME;
    console.log('%c[CRITICAL_FUNCTIONS] Global functions ready!', 'color: #27ae60; font-weight: bold', {
        initTime: initTime + 'ms',
        functions: ['confirmDelete', 'deleteExam', 'openCopyModal', 'closeCopyModal', 'toggleProgram', 'toggleClass'],
        ready: window.EXAM_FUNCTIONS_READY
    });
    
    // Verify functions are available
    console.log('[CRITICAL_FUNCTIONS] Function availability check:', {
        confirmDelete: typeof window.confirmDelete,
        deleteExam: typeof window.deleteExam,
        openCopyModal: typeof window.openCopyModal,
        closeCopyModal: typeof window.closeCopyModal,
        toggleProgram: typeof window.toggleProgram,
        toggleClass: typeof window.toggleClass
    });
    
})();

// Double-check functions are in global scope
console.log('[GLOBAL_CHECK] Functions in window:', {
    confirmDelete: typeof window.confirmDelete === 'function',
    deleteExam: typeof window.deleteExam === 'function',
    openCopyModal: typeof window.openCopyModal === 'function',
    closeCopyModal: typeof window.closeCopyModal === 'function',
    toggleProgram: typeof window.toggleProgram === 'function',
    toggleClass: typeof window.toggleClass === 'function'
});
</script>

<style>
    /* Main Layout */
    .exam-library-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .library-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    /* Global Access Level Indicator */
    .global-access-indicator {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 20px;
    }
    
    .global-access-indicator.view-only {
        background: #fff3e0;
        border: 1px solid #ff9800;
        color: #f57c00;
    }
    
    .global-access-indicator.full-access {
        background: #e8f5e9;
        border: 1px solid #4caf50;
        color: #2e7d32;
    }
    
    .library-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .header-controls {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    /* Filter Toggle */
    .filter-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .filter-toggle input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .filter-toggle label {
        cursor: pointer;
        user-select: none;
        font-weight: 500;
    }
    
    /* NEW OWNERSHIP TAB SYSTEM */
    .ownership-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 20px;
        border-bottom: 3px solid #dee2e6;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px 12px 0 0;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .ownership-tab {
        flex: 1;
        padding: 18px 25px;
        text-align: center;
        cursor: pointer;
        background: transparent;
        border: none;
        color: #495057;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        position: relative;
    }
    
    .ownership-tab:hover {
        background: rgba(46, 125, 50, 0.1);
        color: #1B5E20;
        transform: translateY(-2px);
        font-weight: 600;
    }
    
    /* WCAG AAA Compliant - High Contrast Active Ownership Tab */
    .ownership-tab.active {
        background: linear-gradient(135deg, #E8F5E9, #F1F8F4);
        color: #0D4F1F;
        font-weight: 700;
        box-shadow: inset 0 3px 0 #2E7D32, 0 2px 4px rgba(0,0,0,0.1);
        border-top: 3px solid #2E7D32;
    }
    
    .ownership-tab.active:hover {
        transform: none;
        background: linear-gradient(135deg, #F1F8F4, #FFFFFF);
        color: #0D4F1F;
    }
    
    /* Sub Tab System (Exam Types) */
    .exam-type-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 30px;
        border-bottom: 2px solid #dee2e6;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
    }
    
    .exam-type-tab {
        flex: 1;
        padding: 15px 20px;
        text-align: center;
        cursor: pointer;
        background: #f8f9fa;
        border: none;
        color: #6c757d;
        font-weight: 500;
        transition: all 0.3s;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .exam-type-tab:hover {
        background: #e0f2e1;
        color: #1B5E20;
        transition: all 0.3s ease;
    }
    
    /* WCAG AAA Compliant - High Contrast Active Exam Type Tab */
    .exam-type-tab.active {
        background: #E8F5E9;
        color: #0D4F1F;
        font-weight: 600;
        border-bottom: 3px solid #2E7D32;
        box-shadow: inset 0 -3px 0 #2E7D32;
    }
    
    .tab-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
        background: rgba(0,0,0,0.1);
        min-width: 24px;
    }
    
    .exam-type-tab.active .tab-badge {
        background: #2E7D32;
        color: white;
        font-weight: bold;
    }
    
    /* Focus States for Keyboard Accessibility */
    .ownership-tab:focus,
    .exam-type-tab:focus {
        outline: 2px solid #2E7D32;
        outline-offset: 2px;
        z-index: 1;
    }
    
    .ownership-tab.active:focus,
    .exam-type-tab.active:focus {
        outline: 2px solid #0D4F1F;
        outline-offset: 2px;
    }
    
    /* Button Contrast Improvements - Removed duplicate .btn-edit styles */
    
    /* Hierarchical Display */
    .program-section {
        margin-bottom: 40px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    /* WCAG Compliant Program Headers */
    .program-header {
        background: linear-gradient(135deg, #F1F8F4, #E8F5E9);
        color: #0D4F1F;
        padding: 15px 20px;
        font-size: 1.3rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid #2E7D32;
        border-bottom: 2px solid #E8F5E9;
    }
    
    .program-header:hover {
        background: linear-gradient(135deg, #E8F5E9, #DFF2E1);
        color: #0A3D19;
    }
    
    .program-toggle {
        font-size: 1.2rem;
        transition: transform 0.3s;
    }
    
    .program-section.collapsed .program-toggle {
        transform: rotate(-90deg);
    }
    
    .program-content {
        padding: 20px;
        background: #fafafa;
    }
    
    .program-section.collapsed .program-content {
        display: none;
    }
    
    /* Class Sections */
    .class-section {
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        background: white;
    }
    
    .class-section.accessible {
        border: 2px solid #81C784;
        background: linear-gradient(to right, #E8F5E9 0%, white 5%);
    }
    
    .class-header {
        padding: 14px 18px;
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s ease;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .class-header:hover {
        background: linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%);
    }
    
    .class-section.accessible .class-header {
        background: linear-gradient(135deg, #E8F5E9 0%, #E0F2E0 100%);
    }
    
    .class-section.accessible .class-header:hover {
        background: linear-gradient(135deg, #E0F2E0 0%, #D4E8D4 100%);
    }
    
    .class-name {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .access-badge {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .access-badge.full {
        background: #4CAF50;
        color: white;
    }
    
    .access-badge.co-teacher {
        background: #1B5E20;
        color: white;
    }
    
    .access-badge.view {
        background: #9E9E9E;
        color: white;
    }
    
    .access-badge.owner {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(40,167,69,0.2);
        animation: subtle-glow 2s ease-in-out infinite;
    }
    
    @keyframes subtle-glow {
        0%, 100% { box-shadow: 0 2px 4px rgba(40,167,69,0.2); }
        50% { box-shadow: 0 2px 8px rgba(40,167,69,0.4); }
    }
    
    .class-toggle {
        transition: transform 0.3s;
    }
    
    .class-section.collapsed .class-toggle {
        transform: rotate(-90deg);
    }
    
    .class-exams {
        padding: 15px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 15px;
    }
    
    .class-section.collapsed .class-exams {
        display: none;
    }
    
    /* Exam Cards */
    .exam-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
        margin-bottom: 15px;
    }
    
    .exam-card:hover {
        box-shadow: 0 4px 12px rgba(27, 41, 81, 0.15);
        transform: translateX(4px);
    }
    
    .exam-card.editable {
        border-left: 4px solid #2E7D32;  /* Green for editable */
    }
    
    /* Program-specific exam card borders - All Green Theme */
    .program-section[data-program="CORE"] .exam-card {
        border-left: 3px solid #4CAF50;  /* Primary green */
    }
    
    .program-section[data-program="ASCENT"] .exam-card {
        border-left: 3px solid #2E7D32;  /* Dark green */
    }
    
    .program-section[data-program="EDGE"] .exam-card {
        border-left: 3px solid #388E3C;  /* Medium green */
    }
    
    .program-section[data-program="PINNACLE"] .exam-card {
        border-left: 3px solid #1B5E20;  /* Deep green */
    }
    
    .exam-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 1rem;
    }
    
    .exam-meta {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .exam-meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    /* Answer Mapping Status */
    .answer-status {
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
    
    .answer-status.complete {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .answer-status.partial {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
    }
    
    .answer-status.not-started {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .answer-progress-bar {
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        margin: 5px 0;
    }
    
    .answer-progress-fill {
        height: 100%;
        transition: width 0.3s;
    }
    
    .answer-progress-fill.complete {
        background: #28a745;
    }
    
    .answer-progress-fill.partial {
        background: #ffc107;
    }
    
    /* Action Buttons - Improved alignment */
    .exam-actions {
        display: flex;
        gap: 10px;
        flex-wrap: nowrap;  /* Keep buttons on same line */
        margin-top: 10px;
        align-items: center;
    }
    
    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 0.9rem;
        text-decoration: none;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-weight: 500;
        min-width: 90px;
        text-align: center;
        display: inline-block;
    }
    
    .btn-view {
        background: #6c757d;
        color: white !important;  /* Ensure white text */
        border-color: #6c757d;
        font-weight: 500;
    }
    
    .btn-view:hover {
        background: #5a6268;
        border-color: #545b62;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
    }
    
    .btn-edit {
        background: #28a745;  /* Green for edit/create actions */
        color: white !important;  /* Ensure white text */
        border-color: #28a745;
        font-weight: 500;
    }
    
    .btn-edit:hover {
        background: #218838;
        border-color: #1e7e34;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }
    
    .btn-copy {
        background: #43A047;  /* Medium green for copy */
        color: white !important;  /* Ensure white text */
        border-color: #43A047;
        font-weight: 500;
    }
    
    .btn-copy:hover {
        background: #388E3C;
        border-color: #2E7D32;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(67, 160, 71, 0.3);
    }
    
    /* Delete Button - Clean Red Styling */
    .btn-danger {
        background: #dc3545;
        color: white !important;  /* Ensure white text */
        border-color: #dc3545;
        font-weight: 500;
    }
    
    .btn-danger:hover {
        background: #c82333;
        border-color: #bd2130;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
    
    .btn-danger:active {
        background: #bd2130;
        border-color: #b21f2d;
    }
    
    /* ULTIMATE DELETE BUTTON FIX - Maximum CSS specificity and comprehensive coverage */
    
    /* Target ALL possible delete button selectors with maximum specificity */
    html body.routinetest-theme .exam-library-container .exam-actions button.btn-danger,
    html body.routinetest-theme .exam-library-container .exam-actions button[onclick*="confirmDelete"],
    html body.routinetest-theme .exam-hierarchy .exam-actions button.btn-danger,
    html body.routinetest-theme .exam-hierarchy .exam-actions button[onclick*="confirmDelete"],
    html body .exam-library-container .exam-actions button.btn-danger,
    html body .exam-library-container .exam-actions button[onclick*="confirmDelete"],
    html body .exam-hierarchy .exam-actions button.btn-danger,
    html body .exam-hierarchy .exam-actions button[onclick*="confirmDelete"],
    /* Fallback selectors for various scenarios */
    button.btn-danger,
    .btn.btn-danger,
    .exam-actions .btn-danger,
    button[onclick*="confirmDelete"],
    .exam-actions button[onclick*="confirmDelete"],
    /* Override theme CSS that might be greening the buttons */
    .routinetest-theme .btn.btn-danger,
    .routinetest-theme button.btn-danger,
    .routinetest-theme .exam-actions .btn-danger,
    .routinetest-theme .exam-actions button[onclick*="confirmDelete"] {
        background: #dc3545 !important;
        background-color: #dc3545 !important;
        background-image: none !important;
        color: white !important;
        border: 1px solid #dc3545 !important;
        border-color: #dc3545 !important;
        border-top-color: #dc3545 !important;
        border-right-color: #dc3545 !important;
        border-bottom-color: #dc3545 !important;
        border-left-color: #dc3545 !important;
        /* Prevent any theme overrides */
        box-shadow: none !important;
        transform: none !important;
    }
    
    /* Hover states with same specificity pattern */
    html body.routinetest-theme .exam-library-container .exam-actions button.btn-danger:hover,
    html body.routinetest-theme .exam-library-container .exam-actions button[onclick*="confirmDelete"]:hover,
    html body.routinetest-theme .exam-hierarchy .exam-actions button.btn-danger:hover,
    html body.routinetest-theme .exam-hierarchy .exam-actions button[onclick*="confirmDelete"]:hover,
    html body .exam-library-container .exam-actions button.btn-danger:hover,
    html body .exam-library-container .exam-actions button[onclick*="confirmDelete"]:hover,
    html body .exam-hierarchy .exam-actions button.btn-danger:hover,
    html body .exam-hierarchy .exam-actions button[onclick*="confirmDelete"]:hover,
    button.btn-danger:hover,
    .btn.btn-danger:hover,
    .exam-actions .btn-danger:hover,
    button[onclick*="confirmDelete"]:hover,
    .exam-actions button[onclick*="confirmDelete"]:hover,
    .routinetest-theme .btn.btn-danger:hover,
    .routinetest-theme button.btn-danger:hover,
    .routinetest-theme .exam-actions .btn-danger:hover,
    .routinetest-theme .exam-actions button[onclick*="confirmDelete"]:hover {
        background: #c82333 !important;
        background-color: #c82333 !important;
        background-image: none !important;
        border-color: #bd2130 !important;
        border-top-color: #bd2130 !important;
        border-right-color: #bd2130 !important;
        border-bottom-color: #bd2130 !important;
        border-left-color: #bd2130 !important;
        color: white !important;
        /* Keep hover effects but ensure red color */
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3) !important;
    }
    
    /* Focus and active states */
    html body .exam-actions button.btn-danger:focus,
    html body .exam-actions button.btn-danger:active,
    html body .exam-actions button[onclick*="confirmDelete"]:focus,
    html body .exam-actions button[onclick*="confirmDelete"]:active {
        background: #bd2130 !important;
        background-color: #bd2130 !important;
        border-color: #bd2130 !important;
        color: white !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .no-exams {
        padding: 20px;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
    
    /* Summary Stats */
    .summary-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .stat-label {
        font-weight: 500;
        color: #6c757d;
    }
    
    .stat-value {
        font-weight: 600;
        color: #2c3e50;
    }
    
    /* Modal Styles - Fixed with proper specificity */
    .modal {
        display: none;
        position: fixed;
        z-index: 10001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    /* High specificity rule to ensure modal shows */
    body .modal.show,
    body #copyExamModal.show {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        z-index: 10002;
    }
    
    /* Ensure modal content is visible */
    #copyExamModal .modal-content {
        background-color: white !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 28px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
        line-height: 20px;
        width: 30px;
        height: 30px;
        text-align: center;
    }
    
    .modal-close:hover,
    .modal-close:focus {
        color: #000;
    }
    
    .modal-content h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #2c3e50;
        font-size: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #495057;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 1rem;
    }
    
    .form-group p {
        margin: 5px 0;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #dee2e6;
    }
    
    .modal-actions .btn {
        min-width: 100px;
    }
    
    .modal-actions .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .modal-actions .btn-secondary:hover {
        background-color: #5a6268;
    }
    
    /* Ensure modal is always on top */
    #copyExamModal {
        z-index: 10000;
    }
    
    #copyExamModal .modal-content {
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .library-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .class-exams {
            grid-template-columns: 1fr;
        }
        
        /* Responsive button layout for mobile */
        .exam-actions {
            flex-wrap: wrap;  /* Allow wrapping on small screens */
        }
        
        .exam-actions .btn {
            flex: 1;  /* Equal width buttons on mobile */
            min-width: 80px;  /* Smaller minimum width on mobile */
        }
        
        .summary-stats {
            flex-direction: column;
        }
        
        .modal-content {
            width: 95%;
            padding: 20px;
        }
    }
</style>

<div class="exam-library-container">
    <!-- Header -->
    <div class="library-header">
        <h1 class="library-title">Exam Library</h1>
        <div class="header-controls">
            <!-- Upload Button (Admin or Full Access Teachers) -->
            
            <a href="/RoutineTest/exams/create/" class="btn btn-edit">
                ðŸ“¤ Upload New Exam
            </a>
            
        </div>
    </div>
    
    <!-- Global Access Level Indicator -->
    
    
    <!-- NEW: Ownership-based Tab Layer -->
    <div class="ownership-tabs">
        <a href="?ownership=my&exam_type=ALL" 
           class="ownership-tab active"
           onclick="return handleOwnershipTabSwitch('my', 'ALL')">
            <span>ðŸ“ My Test Files</span>
        </a>
        
        <a href="?ownership=others&exam_type=ALL" 
           class="ownership-tab "
           onclick="return handleOwnershipTabSwitch('others', 'ALL')">
            <span>ðŸ‘¥ Other Teachers' Test Files</span>
        </a>
    </div>
    
    <!-- Summary Stats -->
    <div class="summary-stats">
        <div class="stat-item">
            <span class="stat-label">Total Exams:</span>
            <span class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Complete:</span>
            <span class="stat-value" style="color: #28a745;">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Partial:</span>
            <span class="stat-value" style="color: #ffc107;">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Not Started:</span>
            <span class="stat-value" style="color: #dc3545;">0</span>
        </div>
        
    </div>
    
    <!-- UPDATED: Exam Type Tabs with New Ownership System -->
    <div class="exam-type-tabs">
        <a href="?ownership=my&exam_type=REVIEW" 
           class="exam-type-tab "
           onclick="return handleExamTypeTabSwitch('my', 'REVIEW')">
            <span>ðŸ“š Review / Monthly</span>
            <span class="tab-badge">4</span>
        </a>
        
        <a href="?ownership=my&exam_type=QUARTERLY" 
           class="exam-type-tab "
           onclick="return handleExamTypeTabSwitch('my', 'QUARTERLY')">
            <span>ðŸ“Š Quarterly</span>
            <span class="tab-badge">8</span>
        </a>
        
        <a href="?ownership=my&exam_type=ALL" 
           class="exam-type-tab active"
           onclick="return handleExamTypeTabSwitch('my', 'ALL')">
            <span>ðŸ“‹ All Exams</span>
            <span class="tab-badge">12</span>
        </a>
    </div>
    
    <!-- Hierarchical Exam Display -->
    <!-- DEBUG SECTION - Server Data Analysis -->
    
    <script>
        console.log('========================================');
        console.log('[SERVER_DATA_DEBUG] FILTER IS ON - Analyzing server data');
        console.log('[SERVER_DATA_DEBUG] Filter state from Django: True');
        
        // Count VIEW ONLY exams in server data
        let serverViewOnlyCount = 0;
        let serverTotalExams = 0;
        
        
            
            
            
        
            
            
            
        
            
            
            
        
            
            
            
        
        
        console.log('[SERVER_DATA_DEBUG] Total exams from server:', serverTotalExams);
        console.log('[SERVER_DATA_DEBUG] VIEW ONLY exams from server:', serverViewOnlyCount);
        
        if (serverViewOnlyCount > 0) {
            console.log('[SERVER_DATA_DEBUG] âŒâŒâŒ CRITICAL: Server sent VIEW ONLY exams when filter is ON!');
        } else {
            console.log('[SERVER_DATA_DEBUG] âœ… Server data is correct - no VIEW ONLY exams');
        }
        console.log('========================================');
    </script>
    
    
    <!-- Debug: hierarchical_exams = {} -->
    <div class="exam-hierarchy">
        
            
            
            
        
            
            
            
        
            
            
            
        
            
            
            
        
        
        
        
        <div class="empty-state">
            <h3>Exams not organized</h3>
            <p>12 exam(s) found in database but could not be organized into programs. This typically means exams are missing class assignments.</p>
            <p><small>Debug: hierarchical_exams has 0 programs</small></p>
        </div>
        
    </div>
</div>

<!-- Copy Exam Modal -->
<div id="copyExamModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeCopyModal()">&times;</span>
        <h3>Copy Exam to Another Class</h3>
        <form id="copyExamForm">
            <input type="hidden" id="sourceExamId" name="source_exam_id">
            
            <div class="form-group">
                <label>Source Exam:</label>
                <p id="sourceExamName" style="font-weight: 600; color: #2c3e50;">Loading...</p>
            </div>
            
            <div class="form-group">
                <label for="targetClass">Target Class:</label>
                <select id="targetClass" name="target_class" required>
                    <option value="">Select a class...</option>
                    
                        
                        <option value="B2">B2</option>
                        
                    
                        
                        <option value="B3">B3</option>
                        
                    
                    
                        <!-- Admin can copy to any class -->
                        
                    
                </select>
            </div>
            
            <div class="form-group">
                <label for="copyExamType">Exam Type:</label>
                <select id="copyExamType" name="exam_type" required>
                    <option value="">Select exam type...</option>
                    <option value="REVIEW">Review / Monthly</option>
                    <option value="QUARTERLY">Quarterly</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="academicYear">Academic Year:</label>
                <select id="academicYear" name="academic_year" required>
                    <option value="">Select year...</option>
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="timeslot">Time Period:</label>
                <select id="timeslot" name="timeslot" required disabled>
                    <option value="">First select exam type...</option>
                </select>
                <small class="form-text text-muted" id="timeslotDebugInfo" style="display: none;">
                    If dropdown remains disabled: Open browser console and run <code>fixTimeslotDropdown()</code>
                </small>
            </div>
            
            <!-- Curriculum Selection Section -->
            <div class="form-group">
                <h5 style="margin-top: 20px; margin-bottom: 15px; color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 8px;">
                    <i class="fas fa-graduation-cap"></i> Curriculum Selection
                </h5>
            </div>
            
            <div class="form-group">
                <label for="copyProgramSelect">Program:</label>
                <select id="copyProgramSelect" name="program_select" required>
                    <option value="">-- Select Program --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="copySubprogramSelect">SubProgram:</label>
                <select id="copySubprogramSelect" name="subprogram_select" required disabled>
                    <option value="">-- First select a Program --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="copyLevelSelect">Level:</label>
                <select id="copyLevelSelect" name="level_select" required disabled>
                    <option value="">-- First select a SubProgram --</option>
                </select>
            </div>
            
            <!-- Hidden field to store the curriculum level ID -->
            <input type="hidden" id="copyCurriculumLevel" name="curriculum_level" value="">
            
            <div class="form-group">
                <label for="customSuffix">Custom Name Suffix (Optional):</label>
                <input type="text" id="customSuffix" name="custom_suffix" class="form-control" 
                       placeholder="e.g., 123 or version2" maxlength="50">
                <small class="text-muted">This will be appended to the auto-generated exam name (e.g., _123)</small>
            </div>
            
            <div class="form-group">
                <label>Preview of New Exam Name:</label>
                <div id="examNamePreview" style="padding: 10px; background: #f0f0f0; border-radius: 4px; font-weight: 600;">
                    <span id="previewText">Please complete all fields to see preview...</span>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" onclick="closeCopyModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-copy">Copy Exam</button>
            </div>
        </form>
    </div>
</div>

<!-- Copy Exam Modal JavaScript - Clean Implementation -->
<script>
// Minimal initialization to ensure functions are available immediately
console.log('[COPY_EXAM_CLEAN] Initializing clean copy exam modal system...');

// Placeholder functions to prevent errors until the main script loads
window.openCopyModal = function(examId, examName) {
    console.log('[COPY_EXAM_PLACEHOLDER] Copy modal function called, waiting for main script...');
    setTimeout(function() {
        if (window.openCopyModal.isPlaceholder) {
            alert('Copy Exam feature is still loading. Please try again in a moment.');
        } else {
            window.openCopyModal(examId, examName);
        }
    }, 500);
};
window.openCopyModal.isPlaceholder = true;

window.closeCopyModal = function() {
    const modal = document.getElementById('copyExamModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
};

console.log('[COPY_EXAM_CLEAN] Placeholder functions ready. Main script will load shortly...');
</script>

<script>
// Main copy exam functionality script

// ============================================================================
// CLOSE MODAL FUNCTION - Internal implementation
// ============================================================================
window.closeCopyModalInternal = function() {
    console.group('%c[COPY MODAL] Closing Modal', 'color: #888; font-weight: bold;');
    
    try {
        const modal = document.getElementById('copyExamModal');
        if (!modal) {
            console.warn('[COPY MODAL] Modal element not found during close');
            console.groupEnd();
            return;
        }
        
        // Hide the modal
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = ''; // Restore scrolling
        
        // Clear state
        window.CopyModalState.currentExamId = null;
        window.CopyModalState.currentExamName = null;
        
        // Reset form
        const copyForm = document.getElementById('copyExamForm');
        if (copyForm) {
            copyForm.reset();
            console.log('[COPY MODAL] Form reset on close');
        }
        
        // Remove event handlers
        modal.onclick = null;
        
        console.log('[COPY MODAL] Modal closed successfully');
        console.groupEnd();
        
    } catch (error) {
        console.error('[COPY MODAL] Error during close:', error);
        console.groupEnd();
    }
};

// Create global aliases for backward compatibility
var openCopyModal = window.openCopyModal;
var closeCopyModal = window.closeCopyModal;

console.log('[COPY MODAL] Functions registered globally:');
console.log('  - window.openCopyModal:', typeof window.openCopyModal);
console.log('  - window.closeCopyModal:', typeof window.closeCopyModal);
console.log('  - openCopyModal (alias):', typeof openCopyModal);
console.log('  - closeCopyModal (alias):', typeof closeCopyModal);

// Tab switching handlers - Clear all filters when switching tabs
// Function to update filter badges (if needed)
function updateFilterBadges() {
    console.log('[FILTER_BADGES] Updating filter badges...');
    // This function can be implemented later if badge updates are needed
    // For now, it prevents the "undefined function" error
}

function handleOwnershipTabSwitch(ownership, examType) {
    console.log('[TAB_SWITCH] Switching ownership tab to:', ownership);
    console.log('[TAB_SWITCH] Exam type:', examType);
    
    // Build clean URL with only ownership and exam_type parameters
    const newUrl = `?ownership=${ownership}&exam_type=${examType}`;
    
    console.log('[TAB_SWITCH] Navigating to clean URL:', newUrl);
    window.location.href = newUrl;
    
    // Prevent default link behavior
    return false;
}

function handleExamTypeTabSwitch(ownership, examType) {
    console.log('[TAB_SWITCH] Switching exam type tab to:', examType);
    console.log('[TAB_SWITCH] Ownership:', ownership);
    
    // Build clean URL with only ownership and exam_type parameters
    const newUrl = `?ownership=${ownership}&exam_type=${examType}`;
    
    console.log('[TAB_SWITCH] Navigating to clean URL:', newUrl);
    window.location.href = newUrl;
    
    // Prevent default link behavior
    return false;
}

// Make tab switching functions globally available
window.handleOwnershipTabSwitch = handleOwnershipTabSwitch;
window.handleExamTypeTabSwitch = handleExamTypeTabSwitch;

// PAGE LOAD DEBUGGING - Track exams and filter state - ENHANCED VERSION
(function() {
    console.log('========================================');
    console.log('[PAGE_LOAD_DEBUG] Exam Library Page Loaded - ENHANCED DEBUGGING v2');
    console.log('[PAGE_LOAD_DEBUG] Current URL:', window.location.href);
    console.log('[PAGE_LOAD_DEBUG] Timestamp:', new Date().toISOString());
    
    // NEW: Check ownership state
    const urlParams = new URLSearchParams(window.location.search);
    const ownershipState = urlParams.get('ownership') || 'my';  // Default to 'my'
    const examTypeState = urlParams.get('exam_type') || 'ALL';
    
    console.log('[PAGE_LOAD_DEBUG] NEW Ownership parameter:', ownershipState);
    console.log('[PAGE_LOAD_DEBUG] NEW Exam type parameter:', examTypeState);
    console.log('[PAGE_LOAD_DEBUG] Server-side ownership filter: my');
    console.log('[PAGE_LOAD_DEBUG] Legacy show_assigned_only: true');
    
    // Count and log exam cards with their badges
    const examCards = document.querySelectorAll('.exam-card');
    console.log('[PAGE_LOAD_DEBUG] Total exam cards displayed:', examCards.length);
    
    // Analyze access badges
    const badgeCounts = {
        'OWNER': 0,
        'FULL ACCESS': 0,
        'EDIT': 0,
        'VIEW ONLY': 0
    };
    
    examCards.forEach((card, index) => {
        const badge = card.querySelector('.access-badge');
        const examName = card.querySelector('.exam-title')?.textContent?.trim() || 'Unknown';
        const badgeText = badge?.textContent?.trim() || 'NO BADGE';
        
        if (index < 5) { // Log first 5 exams for detailed debugging
            console.log(`[PAGE_LOAD_DEBUG] Exam ${index + 1}: "${examName}" - Badge: ${badgeText}`);
        }
        
        // Count badges
        if (badgeCounts.hasOwnProperty(badgeText)) {
            badgeCounts[badgeText]++;
        }
    });
    
    console.log('[PAGE_LOAD_DEBUG] Badge distribution:', badgeCounts);
    
    // NEW: Check if we're in "My Test Files" mode (equivalent to old filter)
    if (ownershipState === 'my') {
        console.log('[PAGE_LOAD_DEBUG] âš ï¸ OWNERSHIP: My Test Files - Should show exams from EDITABLE classes only');
        console.log('[PAGE_LOAD_DEBUG] Expected: Exams with OWNER, FULL ACCESS and EDIT badges only');
        console.log('[PAGE_LOAD_DEBUG] NOT Expected: VIEW ONLY badges (should be filtered out)');
        if (badgeCounts['VIEW ONLY'] > 0) {
            console.log('[PAGE_LOAD_DEBUG] âŒâŒâŒ CRITICAL BUG DETECTED âŒâŒâŒ');
            console.log('[PAGE_LOAD_DEBUG] Found ' + badgeCounts['VIEW ONLY'] + ' VIEW ONLY exams that should be HIDDEN!');
            
            // List all VIEW ONLY exams that shouldn't be visible
            console.log('[PAGE_LOAD_DEBUG] VIEW ONLY exams that should be hidden:');
            examCards.forEach((card, index) => {
                const badge = card.querySelector('.badge');
                const examName = card.querySelector('.exam-title')?.textContent?.trim() || 'Unknown';
                const badgeText = badge?.textContent?.trim() || 'NO BADGE';
                
                if (badgeText === 'VIEW ONLY' || badgeText.includes('VIEW')) {
                    const examClasses = card.querySelector('.exam-classes')?.textContent || 'No classes';
                    console.log(`[PAGE_LOAD_DEBUG]   âŒ Exam "${examName}"`);
                    console.log(`[PAGE_LOAD_DEBUG]      Badge: ${badgeText}`);
                    console.log(`[PAGE_LOAD_DEBUG]      Classes: ${examClasses}`);
                }
            });
        } else {
            console.log('[PAGE_LOAD_DEBUG] âœ… Correct: No VIEW ONLY exams shown (filtered out as expected)');
        }
    } else if (ownershipState === 'others') {
        console.log('[PAGE_LOAD_DEBUG] OWNERSHIP: Other Teachers\' Test Files - Showing all visible exams');
        console.log('[PAGE_LOAD_DEBUG] Expected: All badges including VIEW ONLY');
        console.log('[PAGE_LOAD_DEBUG] VIEW ONLY exams should be visible in this mode');
    }
    
    console.log('========================================');
})();

// IMMEDIATE DELETE BUTTON FIX - Run once without infinite loop
(function() {
    // Apply red color to all delete buttons immediately
    const fixDeleteButtons = function() {
        const deleteButtons = document.querySelectorAll('.btn-danger:not([data-delete-fixed]), button[onclick*="confirmDelete"]:not([data-delete-fixed])');
        deleteButtons.forEach(button => {
            // Force red styling via inline styles with highest priority
            button.style.setProperty('background-color', '#dc3545', 'important');
            button.style.setProperty('border-color', '#dc3545', 'important');
            button.style.setProperty('color', 'white', 'important');
            
            // Remove any conflicting classes
            button.classList.remove('btn-success', 'btn-primary', 'btn-secondary');
            // Ensure btn-danger class is present
            if (!button.classList.contains('btn-danger')) {
                button.classList.add('btn-danger');
            }
            
            // Mark as fixed to avoid reprocessing
            button.setAttribute('data-delete-fixed', 'true');
        });
    };
    
    // Run immediately
    fixDeleteButtons();
    
    // Run on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fixDeleteButtons);
    }
    
    // Run once after a short delay to catch any late-applied styles
    setTimeout(fixDeleteButtons, 100);
})();

// DELETE BUTTON FIX CONTINUES HERE - Functions already defined above

// Note: Toggle functions (toggleProgram, toggleClass) are now defined in critical functions file

// NEW: Ownership Tab Navigation Logging (No JavaScript needed - handled by server)
(function() {
    console.log('[OWNERSHIP_SYSTEM] âœ… New tab-based navigation system active');
    console.log('[OWNERSHIP_SYSTEM] Current ownership filter: my');
    console.log('[OWNERSHIP_SYSTEM] Filter intent: SHOW_EDITABLE');
    console.log('[OWNERSHIP_SYSTEM] Current exam type filter: ALL');
    console.log('[OWNERSHIP_SYSTEM] Navigation handled by server-side routing');
    
    // Log tab state for debugging
    const ownershipTabs = document.querySelectorAll('.ownership-tab');
    const examTypeTabs = document.querySelectorAll('.exam-type-tab');
    
    console.log('[OWNERSHIP_SYSTEM] Ownership tabs found:', ownershipTabs.length);
    console.log('[OWNERSHIP_SYSTEM] Exam type tabs found:', examTypeTabs.length);
    
    ownershipTabs.forEach((tab, index) => {
        const isActive = tab.classList.contains('active');
        const href = tab.getAttribute('href');
        console.log(`[OWNERSHIP_SYSTEM] Tab ${index + 1}: ${isActive ? 'ACTIVE' : 'inactive'}, URL: ${href}`);
    });
})();

// COMPREHENSIVE FILTERING VALIDATION AND DEBUGGING
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const ownership = urlParams.get('ownership') || 'my';  // Default to 'my'
    
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘            EXAM FILTERING VALIDATION SYSTEM ACTIVE            â•‘');
    console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
    console.log(`â•‘ Current Mode: ${ownership === 'my' ? 'MY TEST FILES' : 'OTHER TEACHERS\' TEST FILES'}${' '.repeat(ownership === 'my' ? 34 : 24)}â•‘`);
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    // Comprehensive badge analysis
    function analyzeAndValidateExams() {
        const badges = document.querySelectorAll('.badge');
        const analysis = {
            'VIEW ONLY': [],
            'FULL ACCESS': [],
            'OWNER': [],
            'EDIT': [],
            'CO_TEACHER': [],
            'OTHER': []
        };
        
        badges.forEach(badge => {
            const text = badge.textContent.trim().toUpperCase();
            const examCard = badge.closest('.exam-card');
            const examName = examCard ? examCard.querySelector('.exam-title')?.textContent.trim() : 'Unknown';
            
            // Categorize badges
            if (text.includes('VIEW')) {
                analysis['VIEW ONLY'].push(examName);
            } else if (text.includes('FULL')) {
                analysis['FULL ACCESS'].push(examName);
            } else if (text.includes('OWNER')) {
                analysis['OWNER'].push(examName);
            } else if (text.includes('EDIT')) {
                analysis['EDIT'].push(examName);
            } else if (text.includes('CO_TEACHER')) {
                analysis['CO_TEACHER'].push(examName);
            } else {
                analysis['OTHER'].push(`${examName} (${text})`);
            }
        });
        
        // Validation based on current mode
        console.log('\nðŸ“Š BADGE ANALYSIS RESULTS:');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        let hasError = false;
        
        if (ownership === 'my') {
            // MY TEST FILES: Should ONLY have FULL/OWNER/EDIT badges
            console.log('âœ… EXPECTED: FULL ACCESS, OWNER, EDIT, CO_TEACHER badges');
            console.log('âŒ NOT EXPECTED: VIEW ONLY badges\n');
            
            if (analysis['VIEW ONLY'].length > 0) {
                hasError = true;
                console.error('ðŸš¨ðŸš¨ðŸš¨ CRITICAL ERROR: Found VIEW ONLY exams in MY TEST FILES mode!');
                console.error('The following exams should NOT be visible:');
                analysis['VIEW ONLY'].forEach(exam => {
                    console.error(`  âŒ ${exam}`);
                });
                
                // Auto-fix: Hide these incorrect exams
                console.log('\nðŸ”§ APPLYING AUTO-FIX: Hiding VIEW ONLY exams...');
                badges.forEach(badge => {
                    if (badge.textContent.trim().toUpperCase().includes('VIEW')) {
                        const examCard = badge.closest('.exam-card');
                        if (examCard) {
                            examCard.style.display = 'none';
                            console.log(`  ðŸ”§ Hidden: ${examCard.querySelector('.exam-title')?.textContent.trim()}`);
                        }
                    }
                });
            }
            
            // Show what IS correctly displayed
            console.log('\nâœ… Correctly displayed exams:');
            ['OWNER', 'FULL ACCESS', 'EDIT', 'CO_TEACHER'].forEach(type => {
                if (analysis[type].length > 0) {
                    console.log(`  ${type}: ${analysis[type].length} exam(s)`);
                    if (analysis[type].length <= 3) {
                        analysis[type].forEach(exam => console.log(`    â€¢ ${exam}`));
                    }
                }
            });
            
        } else if (ownership === 'others') {
            // OTHER TEACHERS' TEST FILES: Should ONLY have VIEW ONLY badges
            console.log('âœ… EXPECTED: VIEW ONLY badges');
            console.log('âŒ NOT EXPECTED: FULL ACCESS, OWNER, EDIT badges\n');
            
            const wrongBadges = ['FULL ACCESS', 'OWNER', 'EDIT', 'CO_TEACHER'];
            wrongBadges.forEach(type => {
                if (analysis[type].length > 0) {
                    hasError = true;
                    console.error(`ðŸš¨ ERROR: Found ${type} exams in OTHER TEACHERS' mode!`);
                    console.error(`The following ${type} exams should NOT be visible:`);
                    analysis[type].forEach(exam => {
                        console.error(`  âŒ ${exam}`);
                    });
                }
            });
            
            if (hasError) {
                // Auto-fix: Hide incorrect exams
                console.log('\nðŸ”§ APPLYING AUTO-FIX: Hiding non-VIEW ONLY exams...');
                badges.forEach(badge => {
                    const text = badge.textContent.trim().toUpperCase();
                    if (!text.includes('VIEW')) {
                        const examCard = badge.closest('.exam-card');
                        if (examCard) {
                            examCard.style.display = 'none';
                            console.log(`  ðŸ”§ Hidden: ${examCard.querySelector('.exam-title')?.textContent.trim()}`);
                        }
                    }
                });
            }
            
            // Show what IS correctly displayed
            if (analysis['VIEW ONLY'].length > 0) {
                console.log(`\nâœ… Correctly displayed VIEW ONLY exams: ${analysis['VIEW ONLY'].length}`);
                if (analysis['VIEW ONLY'].length <= 5) {
                    analysis['VIEW ONLY'].forEach(exam => console.log(`    â€¢ ${exam}`));
                }
            }
        }
        
        // Final status
        console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        if (hasError) {
            console.error('âŒ FILTER VALIDATION FAILED - Auto-fix applied');
            console.log('ðŸ“ Please report this issue to development team');
        } else {
            console.log('âœ… FILTER VALIDATION PASSED - All exams correctly filtered');
        }
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
        
        return !hasError;
    }
    
    // Run analysis immediately
    const isValid = analyzeAndValidateExams();
    
    // Re-run after DOM changes
    setTimeout(() => {
        console.log('ðŸ”„ Re-validating after DOM settlement...');
        analyzeAndValidateExams();
    }, 500);
    
    // Monitor for dynamic changes
    const observer = new MutationObserver(() => {
        console.log('ðŸ”„ DOM changed, re-validating...');
        analyzeAndValidateExams();
    });
    
    // Only observe if we found errors initially
    if (!isValid) {
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
})();

// ============================================================================
// COPY MODAL EVENT INITIALIZATION AND FORM HANDLING
// ============================================================================
console.log('[COPY MODAL] Setting up event handlers and form submission...');
        modal.style.removeProperty('visibility');
        modal.style.removeProperty('opacity');
        
        // Force a reflow to ensure the class change is applied
        modal.offsetHeight;
        
        console.log('Modal should be visible now');
        console.log('Modal classes:', modal.className);
        console.log('Computed display:', window.getComputedStyle(modal).display);
        console.log('Computed visibility:', window.getComputedStyle(modal).visibility);
        
        // Add click handler to close on background click
        modal.onclick = function(event) {
            if (event.target === modal) {
                closeCopyModal();
            }
        };
        
    } catch (error) {
        console.error('Error opening copy modal:', error);
        alert('Error opening copy modal: ' + error.message);
    }
}

// This function is now defined in critical_functions.html
// which calls closeCopyModalInternal defined above
console.log('[FUNCTION_NOTE] closeCopyModal is defined globally, using closeCopyModalInternal internally');

// Validate that all copy modal functions are available
function validateCopyModalFunctions() {
    console.log('[VALIDATE] Checking copy modal functions...');
    const checks = {
        modal: document.getElementById('copyExamModal'),
        form: document.getElementById('copyExamForm'),
        openCopyModal: typeof window.openCopyModal === 'function',
        closeCopyModal: typeof window.closeCopyModal === 'function',
        openCopyModalInternal: typeof window.openCopyModalInternal === 'function',
        closeCopyModalInternal: typeof window.closeCopyModalInternal === 'function'
    };
    
    console.log('[VALIDATE] Copy modal status:', checks);
    return checks;
}

// Handle copy form submission
function initializeCopyFormSubmission() {
    const copyExamForm = document.getElementById('copyExamForm');
    if (!copyExamForm) {
        console.error('copyExamForm not found');
        return;
    }
    
    copyExamForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Copy form submitted');
        
        const formData = new FormData(this);
        const data = {
            source_exam_id: formData.get('source_exam_id'),
            target_class: formData.get('target_class'),
            target_timeslot: formData.get('timeslot')
        };
        
        console.log('Form data:', data);
        
        // Validate data
        if (!data.source_exam_id || !data.target_class || !data.target_timeslot) {
            console.error('Validation failed:', data);
            showErrorNotification('Please fill in all required fields');
            return;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Copying...';
        submitBtn.disabled = true;
    
    try {
        const response = await fetch('/RoutineTest/api/copy-exam/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': 'oiWKaBAqJZ1OE85Q2wr3vC38hWjAeM8NShaHqh4EypS4ijCFiRR7yKZXgghxIPlk'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccessNotification(result.message || 'Exam copied successfully!');
            closeCopyModal();
            // Reload after a short delay to show the notification
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showErrorNotification(result.error || 'Failed to copy exam');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Copy error:', error);
        showErrorNotification('Error copying exam: ' + error.message);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
    });
    
    console.log('Copy form submission handler initialized');
}

// Delete functions are now defined in critical_functions.html at the top of the page
// This ensures they're available before any onclick handlers are rendered
// The functions are: window.confirmDelete and window.deleteExam

// Verify delete functions are available
function verifyDeleteFunctions() {
    const functionsAvailable = {
        confirmDelete: typeof window.confirmDelete === 'function',
        deleteExam: typeof window.deleteExam === 'function',
        openCopyModal: typeof window.openCopyModal === 'function',
        closeCopyModal: typeof window.closeCopyModal === 'function',
        ready: window.EXAM_FUNCTIONS_READY
    };
    
    console.log('[VERIFY] Critical functions status:', functionsAvailable);
    
    if (!functionsAvailable.confirmDelete || !functionsAvailable.deleteExam) {
        console.error('[VERIFY] Critical delete functions not available!');
    }
    
    return functionsAvailable;
}

// Notification helper functions
function showSuccessNotification(message) {
    showNotification(message, 'success');
}

function showErrorNotification(message) {
    showNotification(message, 'error');
}

function showNotification(message, type = 'info') {
    // Remove any existing notification
    const existingNotification = document.getElementById('exam-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create new notification
    const notification = document.createElement('div');
    notification.id = 'exam-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 4px;
        z-index: 10000;
        transition: opacity 0.3s;
        font-weight: 500;
        min-width: 250px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    
    // Set colors based on type
    if (type === 'success') {
        notification.style.backgroundColor = '#d4edda';
        notification.style.color = '#155724';
        notification.style.border = '1px solid #c3e6cb';
    } else if (type === 'error') {
        notification.style.backgroundColor = '#f8d7da';
        notification.style.color = '#721c24';
        notification.style.border = '1px solid #f5c6cb';
    } else {
        notification.style.backgroundColor = '#d1ecf1';
        notification.style.color = '#0c5460';
        notification.style.border = '1px solid #bee5eb';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Fade in
    setTimeout(() => {
        notification.style.opacity = '1';
    }, 10);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 3000);
}

// Delete button color enforcement - Fixed to prevent infinite loop
let isProcessingDeleteButtons = false;

function enforceDeleteButtonColors() {
    // Prevent recursive calls
    if (isProcessingDeleteButtons) {
        return;
    }
    
    isProcessingDeleteButtons = true;
    
    // Find all possible delete button selectors that haven't been fixed yet
    const deleteButtons = document.querySelectorAll(`
        button[onclick*="confirmDelete"]:not([data-delete-button-fixed]),
        .btn-danger:not([data-delete-button-fixed]),
        button.btn-danger:not([data-delete-button-fixed]),
        .exam-actions button[onclick*="confirmDelete"]:not([data-delete-button-fixed]),
        .exam-actions .btn-danger:not([data-delete-button-fixed])
    `);
    
    if (deleteButtons.length === 0) {
        isProcessingDeleteButtons = false;
        return; // No buttons to fix
    }
    
    console.log(`[DELETE FIX] Found ${deleteButtons.length} delete buttons to fix`);
    
    deleteButtons.forEach((button, index) => {
        // Remove any conflicting theme classes that might make it green
        button.classList.remove('btn-success', 'btn-primary', 'btn-secondary', 'btn-info');
        
        // Ensure btn-danger class is present
        if (!button.classList.contains('btn-danger')) {
            button.classList.add('btn-danger');
        }
        
        // Force red styling with maximum specificity through inline styles
        button.style.setProperty('background-color', '#dc3545', 'important');
        button.style.setProperty('background', '#dc3545', 'important');
        button.style.setProperty('border-color', '#dc3545', 'important');
        button.style.setProperty('color', 'white', 'important');
        button.style.setProperty('background-image', 'none', 'important');
        
        // Set data attribute for identification
        button.setAttribute('data-delete-button-fixed', 'true');
        
        // Remove and re-add hover event listeners to prevent conflicts
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Add proper hover events
        newButton.addEventListener('mouseenter', function(e) {
            e.target.style.setProperty('background-color', '#c82333', 'important');
            e.target.style.setProperty('background', '#c82333', 'important');
            e.target.style.setProperty('border-color', '#bd2130', 'important');
            e.target.style.setProperty('transform', 'translateY(-2px)', 'important');
            e.target.style.setProperty('box-shadow', '0 4px 8px rgba(220, 53, 69, 0.3)', 'important');
        });
        
        newButton.addEventListener('mouseleave', function(e) {
            e.target.style.setProperty('background-color', '#dc3545', 'important');
            e.target.style.setProperty('background', '#dc3545', 'important');
            e.target.style.setProperty('border-color', '#dc3545', 'important');
            e.target.style.setProperty('transform', 'none', 'important');
            e.target.style.setProperty('box-shadow', 'none', 'important');
        });
        
        console.log(`[DELETE FIX] Fixed button ${index}: ${newButton.textContent.trim()}`);
    });
    
    // Release the processing flag
    isProcessingDeleteButtons = false;
    
    // Check once more after a delay for any dynamically added buttons
    setTimeout(() => {
        // Only process if not already processing
        if (!isProcessingDeleteButtons) {
            const themeButtons = document.querySelectorAll('.routinetest-theme .btn:not([data-delete-button-fixed])');
            themeButtons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes('confirmDelete')) {
                    // Fix this specific button inline without recursion
                    btn.classList.remove('btn-success', 'btn-primary', 'btn-secondary', 'btn-info');
                    btn.classList.add('btn-danger');
                    btn.style.setProperty('background-color', '#dc3545', 'important');
                    btn.style.setProperty('border-color', '#dc3545', 'important');
                    btn.style.setProperty('color', 'white', 'important');
                    btn.setAttribute('data-delete-button-fixed', 'true');
                }
        });
    }, 100);
}

// Run immediately when page loads
document.addEventListener('DOMContentLoaded', enforceDeleteButtonColors);

// Run after a short delay to catch theme-applied buttons
setTimeout(enforceDeleteButtonColors, 500);

// Watch for dynamic content changes - Fixed to prevent infinite loop
let observerTimeoutId;

const observer = new MutationObserver(function(mutations) {
    // Clear any pending timeouts
    clearTimeout(observerTimeoutId);
    
    // Debounce the enforcement to prevent rapid re-processing
    observerTimeoutId = setTimeout(() => {
        let hasNewDeleteButtons = false;
        
        mutations.forEach(function(mutation) {
            // Only process new nodes, not attribute changes
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === 1 && (
                        (node.matches && node.matches('button[onclick*="confirmDelete"]:not([data-delete-button-fixed])')) ||
                        (node.querySelector && node.querySelector('button[onclick*="confirmDelete"]:not([data-delete-button-fixed])'))
                    )) {
                        hasNewDeleteButtons = true;
                    }
                });
            }
        });
        
        if (hasNewDeleteButtons) {
            console.log('[DELETE FIX] New delete buttons detected, processing');
            enforceDeleteButtonColors();
        }
    }, 250); // Debounce for 250ms
});

// Start observing with more specific configuration (only childList changes)
observer.observe(document.body, {
    childList: true,
    subtree: true
    // Removed attributes watching to prevent infinite loop
});

// Function to update the exam name preview
function updateCopyExamNamePreview() {
    console.log('[COPY_MODAL_PREVIEW] Updating exam name preview...');
    
    const examTypeSelect = document.getElementById('copyExamType');
    const timeslotSelect = document.getElementById('timeslot');
    const academicYearSelect = document.getElementById('academicYear');
    const customSuffixInput = document.getElementById('customSuffix');
    const previewText = document.getElementById('previewText');
    
    if (!previewText) {
        console.error('[COPY_MODAL_PREVIEW] Preview text element not found');
        return;
    }
    
    // Check if all required fields are filled
    if (!examTypeSelect?.value || !timeslotSelect?.value || !academicYearSelect?.value) {
        previewText.textContent = 'Please complete all fields to see preview...';
        console.log('[COPY_MODAL_PREVIEW] Missing required fields');
        return;
    }
    
    // Get the source exam name from the display
    const sourceExamName = document.getElementById('sourceExamName')?.textContent || '';
    
    // Build the name preview
    let nameParts = [];
    
    // Add exam type prefix
    const prefix = examTypeSelect.value === 'QUARTERLY' ? '[QTR]' : '[RT]';
    nameParts.push(prefix);
    
    // Add time period with year
    if (examTypeSelect.value === 'REVIEW') {
        // Convert month code to abbreviated name
        const monthAbbrev = {
            'JAN': 'Jan', 'FEB': 'Feb', 'MAR': 'Mar', 'APR': 'Apr',
            'MAY': 'May', 'JUN': 'Jun', 'JUL': 'Jul', 'AUG': 'Aug',
            'SEP': 'Sep', 'OCT': 'Oct', 'NOV': 'Nov', 'DEC': 'Dec'
        };
        const monthName = monthAbbrev[timeslotSelect.value] || timeslotSelect.value;
        nameParts.push(`${monthName} ${academicYearSelect.value}`);
    } else {
        nameParts.push(`${timeslotSelect.value} ${academicYearSelect.value}`);
    }
    
    // Get curriculum from selected dropdowns (preferred) or source exam name (fallback)
    const programSelect = document.getElementById('copyProgramSelect');
    const subprogramSelect = document.getElementById('copySubprogramSelect');
    const levelSelect = document.getElementById('copyLevelSelect');
    
    if (programSelect?.value && subprogramSelect?.value && levelSelect?.value) {
        // Use selected curriculum
        const program = programSelect.value;
        const subprogram = subprogramSelect.value;
        const levelNumber = levelSelect.options[levelSelect.selectedIndex].text.replace('Level ', '');
        const curriculum = `${program} ${subprogram} Lv${levelNumber}`;
        nameParts.push(curriculum);
        console.log('[COPY_MODAL_PREVIEW] Using selected curriculum:', curriculum);
    } else {
        // Fallback to extracting from source exam name
        const curriculumMatch = sourceExamName.match(/(CORE|ASCENT|EDGE|PINNACLE)\s+(\w+)\s+Lv(\d+)/);
        if (curriculumMatch) {
            const curriculum = `${curriculumMatch[1]} ${curriculumMatch[2]} Lv${curriculumMatch[3]}`;
            nameParts.push(curriculum);
            console.log('[COPY_MODAL_PREVIEW] Using source curriculum (fallback):', curriculum);
        } else {
            // Try to extract any curriculum-like pattern
            const levelMatch = sourceExamName.match(/Lv\d+/);
            if (levelMatch) {
                const beforeLevel = sourceExamName.substring(
                    sourceExamName.lastIndexOf('-') + 1,
                    sourceExamName.indexOf(levelMatch[0])
                ).trim();
                if (beforeLevel) {
                    nameParts.push(`${beforeLevel}${levelMatch[0]}`);
                    console.log('[COPY_MODAL_PREVIEW] Using extracted curriculum pattern:', `${beforeLevel}${levelMatch[0]}`);
                }
            }
        }
    }
    
    // Join parts
    let previewName = nameParts.join(' - ');
    
    // Add custom suffix if provided
    const customSuffix = customSuffixInput?.value?.trim();
    if (customSuffix) {
        previewName += customSuffix.startsWith('_') ? customSuffix : `_${customSuffix}`;
    }
    
    previewText.textContent = previewName;
    console.log('[COPY_MODAL_PREVIEW] Generated preview:', previewName);
}

// Populate timeslots based on exam type
function initializeCopyExamEventListeners() {
    console.log('Initializing copy exam event listeners...');
    
    const copyExamTypeSelect = document.getElementById('copyExamType');
    if (!copyExamTypeSelect) {
        console.error('copyExamType element not found');
        return;
    }
    
    // Remove any existing event listeners to prevent duplicates
    const newCopyExamTypeSelect = copyExamTypeSelect.cloneNode(true);
    copyExamTypeSelect.parentNode.replaceChild(newCopyExamTypeSelect, copyExamTypeSelect);
    
    newCopyExamTypeSelect.addEventListener('change', function() {
        console.log('[COPY_MODAL] Exam type changed to:', this.value);
        
        const timeslotSelect = document.getElementById('timeslot');
        if (!timeslotSelect) {
            console.error('[COPY_MODAL] timeslot element not found');
            return;
        }
        
        // Clear existing options
        timeslotSelect.innerHTML = '<option value="">Select time period...</option>';
        
        if (this.value === 'REVIEW') {
            console.log('[COPY_MODAL] Setting up monthly timeslots...');
            // Enable the select
            timeslotSelect.disabled = false;
            
            // Monthly timeslots with proper month codes
            const months = [
                {value: 'JAN', text: 'January'},
                {value: 'FEB', text: 'February'},
                {value: 'MAR', text: 'March'},
                {value: 'APR', text: 'April'},
                {value: 'MAY', text: 'May'},
                {value: 'JUN', text: 'June'},
                {value: 'JUL', text: 'July'},
                {value: 'AUG', text: 'August'},
                {value: 'SEP', text: 'September'},
                {value: 'OCT', text: 'October'},
                {value: 'NOV', text: 'November'},
                {value: 'DEC', text: 'December'}
            ];
            
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.text;
                timeslotSelect.appendChild(option);
            });
        } else if (this.value === 'QUARTERLY') {
            console.log('[COPY_MODAL] Setting up quarterly timeslots...');
            // Enable the select
            timeslotSelect.disabled = false;
            timeslotSelect.style.color = '#333';
            timeslotSelect.style.backgroundColor = '#fff';
            console.log('[COPY_MODAL] Quarterly dropdown enabled, disabled state:', timeslotSelect.disabled);
            
            // Quarterly timeslots
            ['Q1', 'Q2', 'Q3', 'Q4'].forEach(quarter => {
                const option = document.createElement('option');
                option.value = quarter;
                option.textContent = quarter;
                timeslotSelect.appendChild(option);
            });
        } else {
            console.log('[COPY_MODAL] No exam type selected, disabling timeslot');
            // No exam type selected, disable timeslot
            timeslotSelect.disabled = true;
            timeslotSelect.innerHTML = '<option value="">First select exam type...</option>';
            
            // Hide debug info when no exam type is selected
            const debugInfo = document.getElementById('timeslotDebugInfo');
            if (debugInfo) {
                debugInfo.style.display = 'none';
            }
        }
        
        // Show debug info if the dropdown is still disabled when it should be enabled
        setTimeout(() => {
            const debugInfo = document.getElementById('timeslotDebugInfo');
            if (debugInfo && this.value && timeslotSelect.disabled) {
                console.log('[DEBUG] Timeslot dropdown should be enabled but is still disabled');
                debugInfo.style.display = 'block';
            } else if (debugInfo && !timeslotSelect.disabled) {
                debugInfo.style.display = 'none';
            }
        }, 100);
        
        // Update name preview
        updateCopyExamNamePreview();
    });
    
    // Add event listeners for name preview updates
    const timeslotSelect = document.getElementById('timeslot');
    const academicYearSelect = document.getElementById('academicYear');
    const customSuffixInput = document.getElementById('customSuffix');
    
    if (timeslotSelect) {
        timeslotSelect.addEventListener('change', updateCopyExamNamePreview);
    }
    
    if (academicYearSelect) {
        academicYearSelect.addEventListener('change', updateCopyExamNamePreview);
    }
    
    if (customSuffixInput) {
        customSuffixInput.addEventListener('input', updateCopyExamNamePreview);
    }
    
    // Initialize curriculum cascading dropdowns
    initializeCopyCurriculumCascading();
    
    console.log('Copy exam event listeners initialized successfully');
}

// Debug function to fix the timeslot dropdown manually
function fixTimeslotDropdown() {
    console.log('[DEBUG] Attempting to fix timeslot dropdown...');
    
    const examTypeSelect = document.getElementById('copyExamType');
    const timeslotSelect = document.getElementById('timeslot');
    
    if (!examTypeSelect || !timeslotSelect) {
        console.error('[DEBUG] Required elements not found');
        return false;
    }
    
    console.log('[DEBUG] Current exam type:', examTypeSelect.value);
    console.log('[DEBUG] Current timeslot disabled state:', timeslotSelect.disabled);
    
    if (examTypeSelect.value === 'QUARTERLY') {
        console.log('[DEBUG] Forcing quarterly dropdown to be enabled...');
        
        timeslotSelect.disabled = false;
        timeslotSelect.style.color = '#333';
        timeslotSelect.style.backgroundColor = '#fff';
        timeslotSelect.style.cursor = 'pointer';
        
        // Clear and repopulate options
        timeslotSelect.innerHTML = '<option value="">Select time period...</option>';
        ['Q1', 'Q2', 'Q3', 'Q4'].forEach(quarter => {
            const option = document.createElement('option');
            option.value = quarter;
            option.textContent = quarter;
            timeslotSelect.appendChild(option);
        });
        
        console.log('[DEBUG] Timeslot dropdown fixed. New disabled state:', timeslotSelect.disabled);
        return true;
    } else if (examTypeSelect.value === 'REVIEW') {
        console.log('[DEBUG] Forcing monthly dropdown to be enabled...');
        
        timeslotSelect.disabled = false;
        timeslotSelect.style.color = '#333';
        timeslotSelect.style.backgroundColor = '#fff';
        timeslotSelect.style.cursor = 'pointer';
        
        // Clear and repopulate options
        timeslotSelect.innerHTML = '<option value="">Select time period...</option>';
        const months = [
            {value: 'JAN', text: 'January'}, {value: 'FEB', text: 'February'}, {value: 'MAR', text: 'March'},
            {value: 'APR', text: 'April'}, {value: 'MAY', text: 'May'}, {value: 'JUN', text: 'June'},
            {value: 'JUL', text: 'July'}, {value: 'AUG', text: 'August'}, {value: 'SEP', text: 'September'},
            {value: 'OCT', text: 'October'}, {value: 'NOV', text: 'November'}, {value: 'DEC', text: 'December'}
        ];
        
        months.forEach(month => {
            const option = document.createElement('option');
            option.value = month.value;
            option.textContent = month.text;
            timeslotSelect.appendChild(option);
        });
        
        console.log('[DEBUG] Timeslot dropdown fixed. New disabled state:', timeslotSelect.disabled);
        return true;
    }
    
    console.log('[DEBUG] No exam type selected, no fix needed');
    return false;
}

// Make the debug function globally available
window.fixTimeslotDropdown = fixTimeslotDropdown;

// ============================================================================
// CURRICULUM CASCADING FUNCTIONALITY FOR COPY MODAL
// ============================================================================

// ============================================================================
// COMPREHENSIVE COPY MODAL CURRICULUM DATA INITIALIZATION - ENHANCED v4.0
// ============================================================================

// Global curriculum data storage with enhanced state management
window.CopyCurriculumData = null;
window.CopyCurriculumDataReady = false;
window.CopyCurriculumDataInitialized = false;
window.CopyCurriculumDataError = null;

// COMPREHENSIVE FIX: Initialize enhanced curriculum data from Django context
console.group('%cðŸ” COPY MODAL CURRICULUM DEBUG - TEMPLATE ANALYSIS', 'color: #ff6b35; font-size: 16px; font-weight: bold;');
console.log('%c[TEMPLATE_DEBUG] Template rendering started at:', 'color: #0066cc;', new Date().toISOString());
console.log('%c[TEMPLATE_DEBUG] Django template context evaluation:', 'color: #0066cc;');
console.log('  - curriculum_hierarchy_for_copy available: YES');
console.log('  - curriculum_levels_for_copy available: YES');


// Use ENHANCED structured hierarchy data from Django backend
console.log('%c[COPY_CURRICULUM_FIX] âœ… curriculum_hierarchy_for_copy IS AVAILABLE from Django backend', 'color: #00aa00; font-weight: bold;');
console.log('[COPY_CURRICULUM_FIX] Loading ENHANCED hierarchical curriculum data from Django backend...');
// Note: The json_script tag is placed outside this script block to avoid rendering issues
const curriculumScriptElement = document.getElementById('copy-curriculum-hierarchy-data');
if (curriculumScriptElement) {
    try {
        const enhancedData = JSON.parse(curriculumScriptElement.textContent);
        
        // COMPREHENSIVE FIX: Handle enhanced data structure with validation
        console.group('[COPY_CURRICULUM_FIX] Processing Enhanced Curriculum Data');
        console.log('[COPY_CURRICULUM_FIX] Enhanced data structure loaded:', {
            hasData: !!enhancedData,
            hasCurriculumData: !!enhancedData.curriculum_data,
            hasMetadata: !!enhancedData.metadata,
            hasValidation: !!enhancedData.validation,
            version: enhancedData.metadata?.version
        });
        
        if (enhancedData.curriculum_data) {
            // Extract the actual curriculum data from the enhanced structure
            window.CopyCurriculumData = enhancedData.curriculum_data;
            window.CopyCurriculumDataReady = true;
            window.CopyCurriculumMetadata = enhancedData.metadata;
            window.CopyCurriculumValidation = enhancedData.validation;
            window.CopyCurriculumDebugInfo = enhancedData.debug_info;
            
            console.log('[COPY_CURRICULUM_FIX] âœ… Successfully extracted curriculum data from enhanced structure');
            console.log('[COPY_CURRICULUM_FIX] Available programs:', Object.keys(window.CopyCurriculumData));
            console.log('[COPY_CURRICULUM_FIX] Total programs loaded:', Object.keys(window.CopyCurriculumData).length);
            console.log('[COPY_CURRICULUM_FIX] Data version:', enhancedData.metadata?.version);
            console.log('[COPY_CURRICULUM_FIX] Validation passed:', enhancedData.validation?.is_valid);
            console.log('[COPY_CURRICULUM_FIX] Total levels:', enhancedData.validation?.total_levels);
            
            // Detailed program structure validation
            console.log('[COPY_CURRICULUM_FIX] Program structure validation:');
            Object.keys(window.CopyCurriculumData).forEach(program => {
                const programData = window.CopyCurriculumData[program];
                const subprograms = Object.keys(programData.subprograms || {});
                const meta = programData.meta || {};
                console.log(`[COPY_CURRICULUM_FIX]   ${program}: ${subprograms.length} subprograms, ${meta.total_levels || 0} levels`);
                console.log(`[COPY_CURRICULUM_FIX]     Subprograms: ${subprograms.join(', ')}`);
            });
            
            // Test if data is valid for frontend use
            if (enhancedData.validation?.is_valid && Object.keys(window.CopyCurriculumData).length === 4) {
                console.log('[COPY_CURRICULUM_FIX] âœ…âœ…âœ… ALL VALIDATIONS PASSED - DATA READY FOR FRONTEND');
            } else {
                console.warn('[COPY_CURRICULUM_FIX] âš ï¸ Data validation concerns:', enhancedData.validation?.validation_errors);
            }
        } else {
            console.error('[COPY_CURRICULUM_FIX] âŒ Enhanced data missing curriculum_data property');
            console.log('[COPY_CURRICULUM_FIX] Available properties:', Object.keys(enhancedData));
        }
        
        console.groupEnd();
        
    } catch (parseError) {
        console.error('[COPY_CURRICULUM_FIX] âŒ JSON parsing failed:', parseError);
        console.log('[COPY_CURRICULUM_FIX] Raw content length:', curriculumScriptElement.textContent.length);
        console.log('[COPY_CURRICULUM_FIX] First 200 chars:', curriculumScriptElement.textContent.substring(0, 200));
    }
} else {
    console.error('[COPY_CURRICULUM_FIX] âŒ Script element #copy-curriculum-hierarchy-data not found in DOM');
    console.log('[COPY_CURRICULUM_FIX] Available script elements:', Array.from(document.querySelectorAll('script[type="application/json"]')).map(s => s.id));
}


// Close the debug group and provide summary
console.log('%c[TEMPLATE_DEBUG] Django template processing completed', 'color: #0066cc;');
console.log('%c[TEMPLATE_DEBUG] Final curriculum data state:', 'color: #0066cc;');
console.log('  - window.CopyCurriculumData available:', !!window.CopyCurriculumData);
console.log('  - window.CopyCurriculumDataReady:', window.CopyCurriculumDataReady);
if (window.CopyCurriculumData) {
    console.log('  - Programs loaded:', Object.keys(window.CopyCurriculumData));
}
console.groupEnd();

// Try to populate dropdown immediately if DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('[COPY_CURRICULUM] DOM ready, attempting to populate dropdown...');
    if (typeof populateCopyProgramDropdown === 'function') {
        populateCopyProgramDropdown();
    }
});

function initializeCopyCurriculumCascading() {
    console.log('[COPY_CURRICULUM] Initializing curriculum cascading...');
    
    // Load curriculum data
    loadCopyCurriculumData().then(() => {
        setupCopyCurriculumEventListeners();
    });
}

async function loadCopyCurriculumData() {
    console.log('[COPY_CURRICULUM] Loading curriculum data...');
    
    try {
        // Check if Django context data is already available and ready
        if (window.CopyCurriculumData && window.CopyCurriculumDataReady) {
            console.log('[COPY_CURRICULUM] Using Django-provided curriculum data');
            console.log('[COPY_CURRICULUM] Available programs:', Object.keys(window.CopyCurriculumData));
            populateCopyProgramDropdown();
            return;
        }
        
        // Try legacy global variable for backward compatibility
        if (window.curriculumData) {
            window.CopyCurriculumData = window.curriculumData;
            console.log('[COPY_CURRICULUM] Using existing curriculum data');
            populateCopyProgramDropdown();
            return;
        }
        
        // If no global data, we need to construct it from the Django template
        // This is a fallback approach
        console.log('[COPY_CURRICULUM] Building curriculum data from template context...');
        
        // For now, we'll create a basic structure with the standard programs
        window.CopyCurriculumData = {
            'CORE': {
                subprograms: {
                    'Phonics': { levels: [{id: 1, number: 1}, {id: 2, number: 2}, {id: 3, number: 3}] },
                    'Sigma': { levels: [{id: 4, number: 1}, {id: 5, number: 2}, {id: 6, number: 3}] },
                    'Elite': { levels: [{id: 7, number: 1}, {id: 8, number: 2}, {id: 9, number: 3}] },
                    'Pro': { levels: [{id: 10, number: 1}, {id: 11, number: 2}, {id: 12, number: 3}] }
                }
            },
            'ASCENT': {
                subprograms: {
                    'Nova': { levels: [{id: 13, number: 1}, {id: 14, number: 2}, {id: 15, number: 3}] },
                    'Drive': { levels: [{id: 16, number: 1}, {id: 17, number: 2}, {id: 18, number: 3}] },
                    'Pro': { levels: [{id: 19, number: 1}, {id: 20, number: 2}, {id: 21, number: 3}] }
                }
            },
            'EDGE': {
                subprograms: {
                    'Spark': { levels: [{id: 22, number: 1}, {id: 23, number: 2}, {id: 24, number: 3}] },
                    'Rise': { levels: [{id: 25, number: 1}, {id: 26, number: 2}, {id: 27, number: 3}] },
                    'Pursuit': { levels: [{id: 28, number: 1}, {id: 29, number: 2}, {id: 30, number: 3}] },
                    'Pro': { levels: [{id: 31, number: 1}, {id: 32, number: 2}, {id: 33, number: 3}] }
                }
            },
            'PINNACLE': {
                subprograms: {
                    'Vision': { levels: [{id: 34, number: 1}, {id: 35, number: 2}] },
                    'Endeavor': { levels: [{id: 36, number: 1}, {id: 37, number: 2}] },
                    'Success': { levels: [{id: 38, number: 1}, {id: 39, number: 2}] },
                    'Pro': { levels: [{id: 40, number: 1}, {id: 41, number: 2}] }
                }
            }
        };
        
        // Don't auto-populate here, wait for modal open
        console.log('[COPY_CURRICULUM] Curriculum data loaded, ready for modal');
        
    } catch (error) {
        console.error('[COPY_CURRICULUM] Error loading curriculum data:', error);
    }
}

// Global flag to prevent multiple simultaneous population attempts
window.populateCopyProgramDropdownInProgress = false;
window.populateCopyProgramDropdownCompleted = false;

function populateCopyProgramDropdown(retryCount = 0) {
    // CRITICAL FIX: Allow re-population when modal reopens
    if (window.populateCopyProgramDropdownInProgress && retryCount > 0) {
        console.log('[COPY_CURRICULUM_FIX] âš ï¸ Population already in progress, skipping duplicate call');
        return false;
    }
    
    // Reset completed flag when modal reopens (retryCount = 0)
    if (retryCount === 0) {
        window.populateCopyProgramDropdownCompleted = false;
        window.populateCopyProgramDropdownInProgress = false;
    }
    
    // Set in-progress flag
    window.populateCopyProgramDropdownInProgress = true;
    
    console.group('[COPY_CURRICULUM_FIX] populateCopyProgramDropdown() - COMPREHENSIVE FIX v4');
    
    const programSelect = document.getElementById('copyProgramSelect');
    
    // COMPREHENSIVE debugging information with enhanced data integration
    console.log('[COPY_CURRICULUM_FIX] Function called at:', new Date().toISOString());
    console.log('[COPY_CURRICULUM_FIX] Retry count:', retryCount);
    console.log('[COPY_CURRICULUM_FIX] Call stack:', new Error().stack.split('\n')[1].trim());
    console.log('[COPY_CURRICULUM_FIX] DOM ready state:', document.readyState);
    console.log('[COPY_CURRICULUM_FIX] programSelect element:', !!programSelect);
    console.log('[COPY_CURRICULUM_FIX] programSelect visible:', programSelect ? window.getComputedStyle(programSelect).display !== 'none' : 'N/A');
    console.log('[COPY_CURRICULUM_FIX] window.CopyCurriculumData exists:', !!window.CopyCurriculumData);
    console.log('[COPY_CURRICULUM_FIX] window.CopyCurriculumDataReady:', window.CopyCurriculumDataReady);
    
    // ENHANCED: Check for enhanced data structure metadata
    console.log('[COPY_CURRICULUM_FIX] Enhanced data structure check:');
    console.log('[COPY_CURRICULUM_FIX]   Metadata available:', !!window.CopyCurriculumMetadata);
    console.log('[COPY_CURRICULUM_FIX]   Validation available:', !!window.CopyCurriculumValidation);
    console.log('[COPY_CURRICULUM_FIX]   Debug info available:', !!window.CopyCurriculumDebugInfo);
    
    if (window.CopyCurriculumMetadata) {
        console.log('[COPY_CURRICULUM_FIX]   Data version:', window.CopyCurriculumMetadata.version);
        console.log('[COPY_CURRICULUM_FIX]   Generated at:', window.CopyCurriculumMetadata.generated_at);
        console.log('[COPY_CURRICULUM_FIX]   Frontend optimized:', window.CopyCurriculumMetadata.frontend_optimized);
    }
    
    if (window.CopyCurriculumValidation) {
        console.log('[COPY_CURRICULUM_FIX]   Validation passed:', window.CopyCurriculumValidation.is_valid);
        console.log('[COPY_CURRICULUM_FIX]   Total levels expected:', window.CopyCurriculumValidation.total_levels);
        console.log('[COPY_CURRICULUM_FIX]   Programs expected:', window.CopyCurriculumValidation.expected_programs);
    }
    
    // COMPREHENSIVE validation with enhanced error reporting
    if (!programSelect) {
        console.error('[COPY_CURRICULUM_FIX] âŒ copyProgramSelect element not found in DOM!');
        console.log('[COPY_CURRICULUM_FIX] Checking for similar elements...');
        const possibleElements = document.querySelectorAll('select[id*="Program"], select[id*="program"]');
        console.log('[COPY_CURRICULUM_FIX] Found similar elements:', Array.from(possibleElements).map(el => el.id));
        
        // ENHANCED: Check if Copy Exam modal is even open
        const copyModal = document.getElementById('copyExamModal');
        console.log('[COPY_CURRICULUM_FIX] Copy modal exists:', !!copyModal);
        console.log('[COPY_CURRICULUM_FIX] Copy modal visible:', copyModal ? window.getComputedStyle(copyModal).display !== 'none' : 'N/A');
        
        console.groupEnd();
        return false;
    }
    
    if (!window.CopyCurriculumData) {
        console.error('[COPY_CURRICULUM_FIX] âŒ No curriculum data available!');
        console.log('[COPY_CURRICULUM_FIX] Checking for alternative data sources...');
        console.log('[COPY_CURRICULUM_FIX] window.curriculumData exists:', !!window.curriculumData);
        console.log('[COPY_CURRICULUM_FIX] All window curriculum variables:', Object.keys(window).filter(key => key.toLowerCase().includes('curriculum')));
        
        // Retry logic - wait for data to load (with proper flag reset)
        if (retryCount < 5) {
            console.log(`[COPY_CURRICULUM_FIX] â³ Data not ready, retrying in 500ms (attempt ${retryCount + 1}/5)...`);
            // Reset in-progress flag before retry
            window.populateCopyProgramDropdownInProgress = false;
            setTimeout(() => {
                populateCopyProgramDropdown(retryCount + 1);
            }, 500);
            console.groupEnd();
            return false;
        }
        
        console.log('[COPY_CURRICULUM_FIX] Attempting fallback data construction...');
        
        // Try fallback construction
        if (typeof loadCopyCurriculumData === 'function') {
            console.log('[COPY_CURRICULUM_FIX] Calling loadCopyCurriculumData fallback...');
            loadCopyCurriculumData().then(() => {
                console.log('[COPY_CURRICULUM_FIX] Fallback completed, retrying population...');
                populateCopyProgramDropdown(0); // Reset retry count for fallback
            }).catch(error => {
                console.error('[COPY_CURRICULUM_FIX] Fallback failed:', error);
                // Reset flag on fallback failure
                window.populateCopyProgramDropdownInProgress = false;
            });
        } else {
            console.error('[COPY_CURRICULUM_FIX] âŒ No fallback available - loadCopyCurriculumData not found');
            // Reset flag when no fallback available
            window.populateCopyProgramDropdownInProgress = false;
        }
        console.groupEnd();
        return false;
    }
    
    console.log('[COPY_CURRICULUM] ðŸ”„ Starting program dropdown population...');
    console.log('[COPY_CURRICULUM] Available programs:', Object.keys(window.CopyCurriculumData));
    console.log('[COPY_CURRICULUM] Data structure check:');
    
    // Validate data structure
    let structureValid = true;
    Object.keys(window.CopyCurriculumData).forEach(program => {
        if (!window.CopyCurriculumData[program].subprograms) {
            console.error(`[COPY_CURRICULUM] âŒ Invalid structure for program ${program}: missing subprograms`);
            structureValid = false;
        } else {
            const subprograms = Object.keys(window.CopyCurriculumData[program].subprograms);
            console.log(`[COPY_CURRICULUM]   âœ… ${program}: ${subprograms.length} subprograms`);
        }
    });
    
    if (!structureValid) {
        console.error('[COPY_CURRICULUM] âŒ Data structure validation failed');
        console.groupEnd();
        return false;
    }
    
    // Clear existing options except the first
    const initialHTML = '<option value="">-- Select Program --</option>';
    programSelect.innerHTML = initialHTML;
    console.log('[COPY_CURRICULUM] Reset dropdown to initial state');
    
    // Add programs with enhanced error handling
    let optionsAdded = 0;
    try {
        // Define correct program order: CORE â†’ ASCENT â†’ EDGE â†’ PINNACLE
        const programOrder = ['CORE', 'ASCENT', 'EDGE', 'PINNACLE'];
        
        // Add programs in the correct hierarchical order
        programOrder.forEach(program => {
            // Check if this program exists in the data
            if (!window.CopyCurriculumData[program]) {
                console.warn(`[COPY_CURRICULUM] Program "${program}" not found in curriculum data, skipping`);
                return;
            }
            
            const option = document.createElement('option');
            option.value = program;
            option.textContent = program;
            
            // Additional attributes for debugging
            option.setAttribute('data-subprogram-count', Object.keys(window.CopyCurriculumData[program].subprograms).length);
            
            programSelect.appendChild(option);
            optionsAdded++;
            console.log(`[COPY_CURRICULUM] âž• Added option: "${program}" (${Object.keys(window.CopyCurriculumData[program].subprograms).length} subprograms)`);
        });
        
        console.log('[COPY_CURRICULUM] âœ… Successfully added', optionsAdded, 'program options');
        console.log('[COPY_CURRICULUM] Final options count:', programSelect.options.length);
        console.log('[COPY_CURRICULUM] Options array:', Array.from(programSelect.options).map(opt => opt.textContent));
        
        // Verify dropdown is interactive
        console.log('[COPY_CURRICULUM] Dropdown interactive check:');
        console.log('[COPY_CURRICULUM]   - disabled:', programSelect.disabled);
        console.log('[COPY_CURRICULUM]   - style.display:', programSelect.style.display);
        console.log('[COPY_CURRICULUM]   - computed visibility:', window.getComputedStyle(programSelect).visibility);
        
        console.log('[COPY_CURRICULUM] ðŸŽ‰ Program dropdown populated successfully');
        
        // Force trigger change event to update dependent dropdowns
        programSelect.dispatchEvent(new Event('change', { bubbles: true }));
        console.log('[COPY_CURRICULUM] Triggered change event on program dropdown');
        
        // Mark as completed and reset in-progress flag
        window.populateCopyProgramDropdownCompleted = true;
        window.populateCopyProgramDropdownInProgress = false;
        
        console.groupEnd();
        return true;
        
    } catch (error) {
        console.error('[COPY_CURRICULUM] âŒ Error during option creation:', error);
        console.error('[COPY_CURRICULUM] Stack trace:', error.stack);
        
        // Restore initial state on error
        programSelect.innerHTML = initialHTML;
        console.log('[COPY_CURRICULUM] Restored initial state after error');
        
        // Reset flags on error
        window.populateCopyProgramDropdownInProgress = false;
        
        console.groupEnd();
        return false;
    }
}

// Global debug function for testing
window.debugCopyModal = function() {
    console.log('=== COPY MODAL DEBUG ===');
    console.log('Modal element:', document.getElementById('copyExamModal'));
    console.log('Program select:', document.getElementById('copyProgramSelect'));
    console.log('Curriculum data available:', !!window.CopyCurriculumData);
    console.log('Curriculum data ready:', window.CopyCurriculumDataReady);
    if (window.CopyCurriculumData) {
        console.log('Available programs:', Object.keys(window.CopyCurriculumData));
    }
    
    console.log('\nForcing dropdown population...');
    populateCopyProgramDropdown(0);
};

console.log('[DEBUG] window.debugCopyModal() available for manual testing');

// ============================================================================
// ENHANCED v4.0: HELPER FUNCTIONS FOR ROBUST CURRICULUM DATA HANDLING
// ============================================================================

// Fallback curriculum initialization function
async function tryFallbackCurriculumInitialization() {
    console.log('[FALLBACK] Attempting fallback curriculum data initialization...');
    
    try {
        // Try to construct from individual curriculum levels (legacy support)
        if (!window.CopyCurriculumData || Object.keys(window.CopyCurriculumData).length === 0) {
            console.log('[FALLBACK] Building basic curriculum structure...');
            
            // Create basic structure with expected programs
            window.CopyCurriculumData = {
                'CORE': {
                    subprograms: {
                        'Phonics': { levels: [{id: 1, number: 1}, {id: 2, number: 2}, {id: 3, number: 3}] },
                        'Sigma': { levels: [{id: 4, number: 1}, {id: 5, number: 2}, {id: 6, number: 3}] },
                        'Elite': { levels: [{id: 7, number: 1}, {id: 8, number: 2}, {id: 9, number: 3}] },
                        'Pro': { levels: [{id: 10, number: 1}, {id: 11, number: 2}, {id: 12, number: 3}] }
                    }
                },
                'EDGE': {
                    subprograms: {
                        'Spark': { levels: [{id: 13, number: 1}, {id: 14, number: 2}, {id: 15, number: 3}] },
                        'Rise': { levels: [{id: 16, number: 1}, {id: 17, number: 2}, {id: 18, number: 3}] },
                        'Pursuit': { levels: [{id: 19, number: 1}, {id: 20, number: 2}, {id: 21, number: 3}] },
                        'Pro': { levels: [{id: 22, number: 1}, {id: 23, number: 2}, {id: 24, number: 3}] }
                    }
                },
                'ASCENT': {
                    subprograms: {
                        'Nova': { levels: [{id: 25, number: 1}, {id: 26, number: 2}, {id: 27, number: 3}] },
                        'Drive': { levels: [{id: 28, number: 1}, {id: 29, number: 2}, {id: 30, number: 3}] },
                        'Pro': { levels: [{id: 31, number: 1}, {id: 32, number: 2}, {id: 33, number: 3}] }
                    }
                },
                'PINNACLE': {
                    subprograms: {
                        'Vision': { levels: [{id: 34, number: 1}, {id: 35, number: 2}] },
                        'Endeavor': { levels: [{id: 36, number: 1}, {id: 37, number: 2}] },
                        'Success': { levels: [{id: 38, number: 1}, {id: 39, number: 2}] },
                        'Pro': { levels: [{id: 40, number: 1}, {id: 41, number: 2}] }
                    }
                }
            };
            
            window.CopyCurriculumDataReady = true;
            window.CopyCurriculumDataInitialized = true;
            window.CopyCurriculumDataError = null;
            
            console.log('[FALLBACK] âœ… Fallback curriculum data constructed successfully');
            console.log('[FALLBACK] Programs available:', Object.keys(window.CopyCurriculumData));
        }
    } catch (error) {
        console.error('[FALLBACK] âŒ Fallback initialization failed:', error);
        window.CopyCurriculumDataError = { message: error.message, source: 'fallback' };
    }
}

// Show curriculum data error to user
function showCurriculumDataError() {
    console.error('[ERROR_DISPLAY] Showing curriculum data error to user');
    
    const dropdown = document.getElementById('copyProgramSelect');
    if (dropdown) {
        dropdown.innerHTML = '<option value="">âš ï¸ Curriculum data unavailable</option>';
        dropdown.style.backgroundColor = '#ffebee';
        dropdown.style.color = '#c62828';
    }
    
    // Could also show a more user-friendly message
    const errorMessage = document.createElement('div');
    errorMessage.style.cssText = 'color: #c62828; font-size: 12px; margin-top: 5px; padding: 8px; background: #ffebee; border-radius: 4px;';
    errorMessage.textContent = 'Unable to load curriculum data. Please refresh the page or contact support.';
    
    if (dropdown && dropdown.parentNode) {
        dropdown.parentNode.appendChild(errorMessage);
    }
}

// Enhanced diagnostic function
function runCurriculumDiagnostic() {
    console.group('%c[DIAGNOSTIC] COMPREHENSIVE CURRICULUM DATA DIAGNOSTIC', 'color: #ff6b35; font-size: 14px; font-weight: bold;');
    
    console.log('[DIAGNOSTIC] ==> GLOBAL VARIABLES:');
    console.log('  window.CopyCurriculumData:', !!window.CopyCurriculumData);
    console.log('  window.CopyCurriculumDataReady:', window.CopyCurriculumDataReady);
    console.log('  window.CopyCurriculumDataInitialized:', window.CopyCurriculumDataInitialized);
    console.log('  window.CopyCurriculumDataError:', window.CopyCurriculumDataError);
    
    if (window.CopyCurriculumData) {
        console.log('  Data keys:', Object.keys(window.CopyCurriculumData));
        console.log('  Data structure valid:', typeof window.CopyCurriculumData === 'object');
    }
    
    console.log('[DIAGNOSTIC] ==> DOM ELEMENTS:');
    const dropdown = document.getElementById('copyProgramSelect');
    console.log('  copyProgramSelect exists:', !!dropdown);
    if (dropdown) {
        console.log('  Options count:', dropdown.options.length);
        console.log('  Visible options:', Array.from(dropdown.options).map(opt => opt.textContent));
        console.log('  Dropdown disabled:', dropdown.disabled);
        console.log('  Dropdown visible:', window.getComputedStyle(dropdown).display !== 'none');
    }
    
    console.log('[DIAGNOSTIC] ==> FUNCTIONS:');
    console.log('  populateCopyProgramDropdown exists:', typeof populateCopyProgramDropdown === 'function');
    console.log('  tryFallbackCurriculumInitialization exists:', typeof tryFallbackCurriculumInitialization === 'function');
    
    console.log('[DIAGNOSTIC] ==> JSON SCRIPT ELEMENT:');
    const scriptElement = document.getElementById('copy-curriculum-hierarchy-data');
    console.log('  Script element exists:', !!scriptElement);
    if (scriptElement) {
        const content = scriptElement.textContent || '';
        console.log('  Content length:', content.length);
        console.log('  Content preview:', content.substring(0, 100) + (content.length > 100 ? '...' : ''));
        
        try {
            const parsed = JSON.parse(content);
            console.log('  JSON valid:', true);
            console.log('  JSON keys:', Object.keys(parsed));
        } catch (e) {
            console.log('  JSON valid:', false);
            console.log('  JSON error:', e.message);
        }
    }
    
    console.groupEnd();
}

function setupCopyCurriculumEventListeners() {
    const programSelect = document.getElementById('copyProgramSelect');
    const subprogramSelect = document.getElementById('copySubprogramSelect');
    const levelSelect = document.getElementById('copyLevelSelect');
    
    if (!programSelect || !subprogramSelect || !levelSelect) {
        console.error('[COPY_CURRICULUM] Missing curriculum dropdown elements');
        return;
    }
    
    // Program change handler
    programSelect.addEventListener('change', function() {
        const program = this.value;
        console.log('[COPY_CURRICULUM] Program changed to:', program);
        
        // Clear and disable dependent dropdowns
        subprogramSelect.innerHTML = '<option value="">-- Select SubProgram --</option>';
        levelSelect.innerHTML = '<option value="">-- Select Level --</option>';
        subprogramSelect.disabled = !program;
        levelSelect.disabled = true;
        document.getElementById('copyCurriculumLevel').value = '';
        
        if (program && window.CopyCurriculumData[program]) {
            const subprograms = window.CopyCurriculumData[program].subprograms;
            
            // Define correct subprogram order for each program
            const subprogramOrder = {
                'CORE': ['Phonics', 'Sigma', 'Elite', 'Pro'],
                'ASCENT': ['Nova', 'Drive', 'Pro'],
                'EDGE': ['Spark', 'Rise', 'Pursuit', 'Pro'],
                'PINNACLE': ['Vision', 'Endeavor', 'Success', 'Pro']
            };
            
            // Get the correct order for this program
            const orderForProgram = subprogramOrder[program];
            
            if (orderForProgram) {
                // Add subprograms in the defined correct order
                console.log('[COPY_CURRICULUM] Using predefined order for', program, ':', orderForProgram);
                orderForProgram.forEach(subprogram => {
                    // Check if this subprogram exists in the data
                    if (!subprograms[subprogram]) {
                        console.log('[COPY_CURRICULUM] Subprogram not found in data:', subprogram);
                        return; // Skip if not found
                    }
                    
                    const option = document.createElement('option');
                    option.value = subprogram;
                    option.textContent = subprogram;
                    subprogramSelect.appendChild(option);
                });
            } else {
                // Fallback: Use the order from the data (should already be correct from backend)
                console.log('[COPY_CURRICULUM] No predefined order for', program, ', using data order');
                Object.keys(subprograms).forEach(subprogram => {
                    const option = document.createElement('option');
                    option.value = subprogram;
                    option.textContent = subprogram;
                    subprogramSelect.appendChild(option);
                });
            }
        }
        
        updateCopyExamNamePreview();
    });
    
    // SubProgram change handler
    subprogramSelect.addEventListener('change', function() {
        const program = programSelect.value;
        const subprogram = this.value;
        console.log('[COPY_CURRICULUM] SubProgram changed to:', subprogram);
        
        // Clear and disable level dropdown
        levelSelect.innerHTML = '<option value="">-- Select Level --</option>';
        levelSelect.disabled = !subprogram;
        document.getElementById('copyCurriculumLevel').value = '';
        
        if (program && subprogram && window.CopyCurriculumData[program]?.subprograms[subprogram]) {
            const levels = window.CopyCurriculumData[program].subprograms[subprogram].levels;
            levels.forEach(level => {
                const option = document.createElement('option');
                option.value = level.id;
                option.textContent = `Level ${level.number}`;
                levelSelect.appendChild(option);
            });
        }
        
        updateCopyExamNamePreview();
    });
    
    // Level change handler
    levelSelect.addEventListener('change', function() {
        const levelId = this.value;
        console.log('[COPY_CURRICULUM] Level changed to:', levelId);
        
        // Store the curriculum level ID
        document.getElementById('copyCurriculumLevel').value = levelId;
        
        updateCopyExamNamePreview();
    });
    
    console.log('[COPY_CURRICULUM] Event listeners set up');
}

// Initialize all copy exam functionality when DOM is ready
function initializeAllCopyExamFunctionality() {
    initializeCopyExamEventListeners();
    initializeCopyFormSubmission();
    console.log('All copy exam functionality initialized');
}

// Debug function to test modal directly
window.testCopyModal = function() {
    console.log('Testing copy modal...');
    const modal = document.getElementById('copyExamModal');
    if (modal) {
        console.log('Modal found. Current display:', window.getComputedStyle(modal).display);
        console.log('Modal has show class:', modal.classList.contains('show'));
        
        // Toggle the modal using the proper functions
        if (modal.classList.contains('show')) {
            console.log('Closing modal...');
            closeCopyModal();
        } else {
            console.log('Opening modal with test data...');
            openCopyModal('test-id-123', 'Test Exam Name');
        }
        
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
            console.log('Modal content found');
        } else {
            console.error('Modal content not found');
        }
        
        console.log('Modal should be visible now');
        console.log('Final display:', window.getComputedStyle(modal).display);
    } else {
        console.error('Modal not found in DOM');
        
        // Check if the modal HTML exists at all
        const allModals = document.querySelectorAll('.modal');
        console.log('Found modals:', allModals.length);
        allModals.forEach((m, i) => {
            console.log(`Modal ${i}:`, m.id, m.className);
        });
    }
};

// CRITICAL: Ensure openCopyModal is always available
(function() {
    // Create temporary placeholder functions that will be replaced by comprehensive fix
    if (typeof window.openCopyModal === 'undefined') {
        console.log('[PLACEHOLDER] Creating placeholder openCopyModal function');
        window.openCopyModal = function(examId, examName) {
            console.log('[PLACEHOLDER] openCopyModal called, waiting for comprehensive fix to load');
            console.log('Exam ID:', examId, 'Exam Name:', examName);
            
            // Try to load the modal after a short delay (in case script hasn't loaded yet)
            setTimeout(function() {
                if (window.openCopyModal !== arguments.callee) {
                    // Function has been replaced, call it again
                    window.openCopyModal(examId, examName);
                } else {
                    alert('Copy Exam feature is loading. Please try again in a moment.');
                }
            }, 500);
        };
    }
    
    if (typeof window.closeCopyModal === 'undefined') {
        console.log('[PLACEHOLDER] Creating placeholder closeCopyModal function');
        window.closeCopyModal = function() {
            const modal = document.getElementById('copyExamModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
        };
    }
    
    console.log('[FUNCTION_CHECK] openCopyModal type:', typeof window.openCopyModal);
    console.log('[FUNCTION_CHECK] closeCopyModal type:', typeof window.closeCopyModal);
})();

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initializeAllCopyExamFunctionality();
        console.log('Copy exam functionality initialized on DOMContentLoaded');
        
        // Verify functions are available after initialization
        console.log('[POST_INIT] openCopyModal available:', typeof window.openCopyModal === 'function');
        console.log('[POST_INIT] closeCopyModal available:', typeof window.closeCopyModal === 'function');
    });
} else {
    initializeAllCopyExamFunctionality();
    console.log('Copy exam functionality initialized immediately');
    
    // Verify functions are available after initialization
    console.log('[POST_INIT] openCopyModal available:', typeof window.openCopyModal === 'function');
    console.log('[POST_INIT] closeCopyModal available:', typeof window.closeCopyModal === 'function');
}

// ============================================================================
</script>

<!-- Place the curriculum data JSON script tag here to avoid rendering issues -->

<script id="copy-curriculum-hierarchy-data" type="application/json">{"curriculum_data": {"CORE": {"subprograms": {"Phonics": {"levels": [{"id": 47, "number": 1}, {"id": 48, "number": 2}, {"id": 49, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}, "Sigma": {"levels": [{"id": 59, "number": 1}, {"id": 60, "number": 2}, {"id": 61, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}, "Elite": {"levels": [{"id": 71, "number": 1}, {"id": 72, "number": 2}, {"id": 73, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}, "Pro": {"levels": [{"id": 83, "number": 1}, {"id": 84, "number": 2}, {"id": 85, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}}, "meta": {"total_subprograms": 4, "total_levels": 12}}, "ASCENT": {"subprograms": {"Nova": {"levels": [{"id": 50, "number": 1}, {"id": 51, "number": 2}, {"id": 52, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}, "Drive": {"levels": [{"id": 62, "number": 1}, {"id": 63, "number": 2}, {"id": 64, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}, "Pro": {"levels": [{"id": 74, "number": 1}, {"id": 75, "number": 2}, {"id": 76, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}}, "meta": {"total_subprograms": 3, "total_levels": 9}}, "EDGE": {"subprograms": {"Spark": {"levels": [{"id": 53, "number": 1}, {"id": 54, "number": 2}, {"id": 55, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}, "Rise": {"levels": [{"id": 65, "number": 1}, {"id": 66, "number": 2}, {"id": 67, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}, "Pursuit": {"levels": [{"id": 77, "number": 1}, {"id": 78, "number": 2}, {"id": 79, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}, "Pro": {"levels": [{"id": 86, "number": 1}, {"id": 87, "number": 2}, {"id": 88, "number": 3}], "meta": {"level_count": 3, "level_range": "1-3"}}}, "meta": {"total_subprograms": 4, "total_levels": 12}}, "PINNACLE": {"subprograms": {"Vision": {"levels": [{"id": 56, "number": 1}, {"id": 57, "number": 2}], "meta": {"level_count": 2, "level_range": "1-2"}}, "Endeavor": {"levels": [{"id": 68, "number": 1}, {"id": 69, "number": 2}], "meta": {"level_count": 2, "level_range": "1-2"}}, "Success": {"levels": [{"id": 80, "number": 1}, {"id": 81, "number": 2}], "meta": {"level_count": 2, "level_range": "1-2"}}, "Pro": {"levels": [{"id": 89, "number": 1}, {"id": 90, "number": 2}], "meta": {"level_count": 2, "level_range": "1-2"}}}, "meta": {"total_subprograms": 4, "total_levels": 8}}}, "metadata": {"generated_at": "2025-08-24T13:11:54.963664+00:00", "method": "get_routinetest_curriculum_hierarchy_for_frontend", "version": "2.0_comprehensive_fix", "frontend_optimized": true}, "validation": {"is_valid": true, "validation_errors": [], "programs_count": 4, "total_levels": 41, "expected_programs": ["CORE", "ASCENT", "EDGE", "PINNACLE"], "structure_check": {"CORE": {"present": true, "subprograms_count": 4, "levels_count": 12}, "ASCENT": {"present": true, "subprograms_count": 3, "levels_count": 9}, "EDGE": {"present": true, "subprograms_count": 4, "levels_count": 12}, "PINNACLE": {"present": true, "subprograms_count": 4, "levels_count": 8}}}, "debug_info": {"whitelist_count": 41, "database_levels_found": 41, "json_serializable": true, "structure_valid": true}}</script>


<!-- Load the comprehensive copy modal fix -->
<script src="/static/js/routinetest/copy-exam-modal-comprehensive-final.js?v=1756041114" defer></script>


        </div>
    </div>
    
    <!-- Load RoutineTest Theme CSS IMMEDIATELY after base styles -->
    <link rel="stylesheet" href="/static/css/routinetest-theme.css?v=1756041114">
    
    <!-- Pre-apply theme class to prevent FOUC and ensure CSS rules work -->
    <script>
    (function() {
        // Apply theme class immediately to prevent flash of unstyled content
        document.documentElement.classList.add('routinetest-theme');
        document.addEventListener('DOMContentLoaded', function() {
            if (!document.body.classList.contains('routinetest-theme')) {
                document.body.classList.add('routinetest-theme');
                console.log('[Theme Pre-apply] Added routinetest-theme class to body');
            }
        });
    })();
    </script>
    
    <!-- Load RoutineTest Theme JS -->
    <script src="/static/js/routinetest-theme.js?v=1756041114"></script>
    
    <!-- Removed redundant matrix tab JavaScript files - Navigation V8 handles this -->
    
    <!-- Navigation JavaScript with Console Debugging -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.group('%c[RoutineTest Navigation] Initialization', 'color: #1B2951; font-weight: bold;');
            
            // Log navigation state
            const navTabs = document.querySelectorAll('.nav-tabs a');
            console.log(`Found ${navTabs.length} navigation tabs`);
            
            // Log active tab
            const activeTab = document.querySelector('.nav-tabs a.active');
            if (activeTab) {
                console.log('Active Tab:', activeTab.getAttribute('data-nav') || activeTab.textContent.trim());
                console.log('Active URL:', activeTab.href);
            }
            
            // Add click tracking to all nav items
            navTabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    const navName = this.getAttribute('data-nav') || this.textContent.trim();
                    console.log(`%c[RoutineTest Nav Click] ${navName}`, 'color: #1B2951;');
                    console.log('Target URL:', this.href);
                    console.log('Timestamp:', new Date().toISOString());
                    
                    // Track navigation in sessionStorage
                    const navHistory = JSON.parse(sessionStorage.getItem('routinetest_nav_history') || '[]');
                    navHistory.push({
                        tab: navName,
                        url: this.href,
                        timestamp: new Date().toISOString()
                    });
                    sessionStorage.setItem('routinetest_nav_history', JSON.stringify(navHistory.slice(-10))); // Keep last 10
                });
            });
            
            // Log authentication state
            const authState = {
                authenticated: true,
                username: 'admin',
                fullName: 'admin',
                is_staff: true,
                page: 'exam_list',
                path: '/RoutineTest/exams/',
                timestamp: new Date().toISOString()
            };
            
            console.log('[RoutineTest Auth State]', authState);
            
            // Log theme confirmation
            console.log('[RoutineTest Theme Check]', {
                primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primepath-navy') || '#1B2951',
                headerBg: getComputedStyle(document.querySelector('.header')).background,
                navBg: getComputedStyle(document.querySelector('.nav-tabs')).backgroundColor
            });
            
            // Performance metrics
            if (window.performance) {
                const perfData = window.performance.timing;
                const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
                console.log(`[RoutineTest Performance] Page load time: ${pageLoadTime}ms`);
            }
            
            console.groupEnd();
            
            // Navigation history display
            const navHistory = JSON.parse(sessionStorage.getItem('routinetest_nav_history') || '[]');
            if (navHistory.length > 0) {
                console.group('%c[RoutineTest Navigation History]', 'color: #007C3F;');
                console.table(navHistory);
                console.groupEnd();
            }
        });
        
        // Logout confirmation
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', function(e) {
                console.log('[RoutineTest] Logout initiated');
                if (!confirm('Are you sure you want to logout?')) {
                    e.preventDefault();
                    console.log('[RoutineTest] Logout cancelled');
                }
            });
        }
        
        // Global error handler for debugging
        window.addEventListener('error', function(e) {
            console.error('[RoutineTest Error]', {
                message: e.message,
                filename: e.filename,
                line: e.lineno,
                column: e.colno,
                error: e.error
            });
        });
    </script>
    
    <!-- Navigation Error Handler - Prevents Matrix tab errors -->
    <script src="/static/js/routinetest/navigation-error-handler.js"></script>
    
    <!-- Enhanced Navigation Debugging -->
    <script>
        console.log('%c[ROUTINETEST_BASE] Navigation error handler loaded', 
            'background: #4CAF50; color: white; padding: 3px 6px; border-radius: 3px;');
        
        // Final verification of navigation state
        document.addEventListener('DOMContentLoaded', function() {
            console.group('%c[NAV_FINAL_CHECK] RoutineTest Navigation Status', 
                'background: #2196F3; color: white; padding: 5px; border-radius: 3px; font-weight: bold;');
            
            // Check for Matrix-related elements that shouldn't exist
            const matrixElements = document.querySelectorAll('[href*="matrix"], [data-nav*="matrix"], #matrix-tab-injected');
            if (matrixElements.length > 0) {
                console.error(`Found ${matrixElements.length} Matrix elements that should not exist:`, matrixElements);
                matrixElements.forEach(elem => {
                    console.log('Removing element:', elem);
                    const parent = elem.closest('li') || elem;
                    parent.remove();
                });
            } else {
                console.log('âœ… No Matrix elements found (correct)');
            }
            
            // Verify Classes & Exams tab
            const classesExamsTab = document.querySelector('[data-nav="classes-exams"]');
            if (classesExamsTab) {
                console.log('âœ… Classes & Exams tab present');
            } else {
                console.error('âŒ Classes & Exams tab missing!');
            }
            
            // Log final navigation structure
            const allTabs = document.querySelectorAll('.nav-tabs a[data-nav]');
            console.log('Final Navigation Structure:');
            allTabs.forEach((tab, i) => {
                console.log(`  ${i+1}. ${tab.textContent.trim()} [${tab.getAttribute('data-nav')}]`);
            });
            
            console.groupEnd();
        });
    </script>
    
    
</body>
</html>