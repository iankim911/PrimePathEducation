{% load grade_tags %}
{% comment %}
Question Panel Component
Usage: {% include 'components/placement_test/question_panel.html' with question=question %}

Parameters:
- question: Question object (required)
- question_number: Question number for display
- show_points: Show point value (default: True)
- show_navigation: Show prev/next buttons (default: True)
{% endcomment %}

<div id="question-{{ question.question_number }}" 
     class="question-panel {% if question.question_number == 1 %}active{% else %}hidden{% endif %}"
     data-question-id="{{ question.id }}"
     data-question-number="{{ question.question_number }}"
     data-question-type="{{ question.question_type }}">
    
    <h3>Question {{ question.question_number }}</h3>
    
    {% if question.audio_file %}
    {% include 'components/placement_test/audio_player.html' with audio_file=question.audio_file %}
    {% endif %}
    
    {% if show_points|default:True and question.points %}
    <div class="points-display">
        Worth {{ question.points }} point{% if question.points != 1 %}s{% endif %}
    </div>
    {% endif %}
    
    <div class="answer-options">
        {% if question.question_type == 'MCQ' %}
            {% if ',' not in question.correct_answer %}
                <!-- Single Choice (Radio Buttons) -->
                {% with letters="ABCDEFGHIJ"|slice:question.options_count %}
                {% for letter in letters %}
                <label class="answer-option-label">
                    <input type="radio" 
                           name="q_{{ question.id }}" 
                           value="{{ letter }}"
                           data-question-num="{{ question.question_number }}"
                           class="answer-input">
                    <span class="answer-letter">{{ letter }}</span>
                </label>
                {% endfor %}
                {% endwith %}
            {% else %}
                <!-- Multiple Choice (Checkboxes) -->
                {% with letters="ABCDEFGHIJ"|slice:question.options_count %}
                {% for letter in letters %}
                <label class="answer-option-label">
                    <input type="checkbox" 
                           name="q_{{ question.id }}_{{ letter }}" 
                           value="{{ letter }}"
                           data-question-num="{{ question.question_number }}"
                           class="answer-input">
                    <span class="answer-letter">{{ letter }}</span>
                </label>
                {% endfor %}
                {% endwith %}
            {% endif %}
            
        {% elif question.question_type == 'CHECKBOX' %}
            <!-- Multiple Choice (Checkboxes) -->
            {% with letters="ABCDEFGHIJ"|slice:question.options_count %}
            {% for letter in letters %}
            <label class="answer-option-label">
                <input type="checkbox" 
                       name="q_{{ question.id }}_{{ letter }}" 
                       value="{{ letter }}"
                       data-question-num="{{ question.question_number }}"
                       class="answer-input">
                <span class="answer-letter">{{ letter }}</span>
            </label>
            {% endfor %}
            {% endwith %}
            
        {% elif question.question_type == 'SHORT' %}
            <!-- Short Answer -->
            {% if question|has_multiple_answers %}
                <!-- Multiple Short Answers -->
                {% with answer_letters=question|get_answer_letters %}
                {% for letter in answer_letters %}
                    <div class="short-answer-row">
                        <label class="short-answer-label">
                            <span class="answer-letter">{{ letter }}</span>
                            <input type="text" 
                                   name="q_{{ question.id }}_{{ letter }}"
                                   class="answer-input text-input"
                                   placeholder="Answer for {{ letter }}"
                                   data-question-num="{{ question.question_number }}">
                        </label>
                    </div>
                {% endfor %}
                {% endwith %}
            {% else %}
                <!-- Single Short Answer -->
                <input type="text" 
                       name="q_{{ question.id }}"
                       class="answer-input text-input"
                       placeholder="Type your answer here"
                       data-question-num="{{ question.question_number }}">
            {% endif %}
                   
        {% elif question.question_type == 'LONG' %}
            <!-- Long Answer -->
            {% if question|has_multiple_answers %}
                <!-- Multiple long answer textareas -->
                <div class="multiple-long-answer">
                    {% with answer_letters=question|get_answer_letters %}
                    {% for letter in answer_letters %}
                    <div class="long-answer-item">
                        <label class="long-answer-label">
                            Response {{ letter }}:
                        </label>
                        <textarea name="q_{{ question.id }}_{{ letter }}"
                                  class="answer-input textarea-input"
                                  rows="5"
                                  placeholder="Write your response for {{ letter }}"
                                  data-question-num="{{ question.question_number }}"></textarea>
                    </div>
                    {% endfor %}
                    {% endwith %}
                </div>
            {% else %}
                <!-- Single long answer textarea -->
                <textarea name="q_{{ question.id }}"
                          class="answer-input textarea-input"
                          rows="5"
                          placeholder="Type your answer here"
                          data-question-num="{{ question.question_number }}"></textarea>
            {% endif %}
                      
        {% elif question.question_type == 'MIXED' %}
            <!-- Mixed Type with Multiple Components -->
            {% with components=question|get_mixed_components %}
            {% if components %}
                {% for component in components %}
                    {% if component.type == 'input' %}
                        <div class="short-answer-row">
                            <label class="short-answer-label">
                                <span class="answer-letter">{{ component.letter }}</span>
                                <input type="text" 
                                       name="q_{{ question.id }}_{{ component.letter }}"
                                       class="answer-input text-input"
                                       placeholder="Answer for {{ component.letter }}"
                                       data-question-num="{{ question.question_number }}">
                            </label>
                        </div>
                    {% elif component.type == 'textarea' %}
                        <div class="long-answer-row" style="margin-bottom: 15px;">
                            <label class="long-answer-label" style="display: block; font-weight: bold; margin-bottom: 5px;">
                                Response {{ component.letter }}:
                            </label>
                            <textarea name="q_{{ question.id }}_{{ component.letter }}"
                                      class="answer-input textarea-input"
                                      rows="5"
                                      placeholder="Write your response for {{ component.letter }}"
                                      data-question-num="{{ question.question_number }}"
                                      style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-family: inherit;"></textarea>
                        </div>
                    {% elif component.type == 'mcq' %}
                        <div class="mcq-component" style="margin-bottom: 20px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <div class="component-label" style="font-weight: bold; margin-bottom: 10px;">
                                Multiple Choice {{ component.letter }}:
                            </div>
                            {% for option in component.options %}
                            <div class="mcq-option" style="margin-left: 20px; margin-bottom: 8px;">
                                <label class="answer-option-label" style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" 
                                           name="q_{{ question.id }}_{{ component.index }}_{{ option }}" 
                                           value="{{ option }}"
                                           data-question-num="{{ question.question_number }}"
                                           class="answer-input">
                                    <span class="answer-letter" style="margin-left: 10px;">{{ option }}</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <!-- Fallback for MIXED questions without parsed components -->
                {% if question.options_count > 1 %}
                    {% with letters="ABCDEFGHIJ"|slice:question.options_count %}
                    {% for letter in letters %}
                        <div class="short-answer-row">
                            <label class="short-answer-label">
                                <span class="answer-letter">{{ letter }}</span>
                                <input type="text" 
                                       name="q_{{ question.id }}_{{ letter }}"
                                       class="answer-input text-input"
                                       placeholder="Answer for {{ letter }}"
                                       data-question-num="{{ question.question_number }}">
                            </label>
                        </div>
                    {% endfor %}
                    {% endwith %}
                {% else %}
                    <textarea name="q_{{ question.id }}"
                              class="answer-input textarea-input"
                              rows="4"
                              placeholder="Type your answer here"
                              data-question-num="{{ question.question_number }}"></textarea>
                {% endif %}
            {% endif %}
            {% endwith %}
        {% endif %}
    </div>
    
    {% if show_navigation|default:True %}
    <div class="question-nav-buttons">
        {% if question.question_number > 1 %}
        <button type="button" 
                class="btn-prev"
                data-action="prev-question"
                data-target="{{ question.question_number|add:-1 }}">
            ← Previous
        </button>
        {% else %}
        <div></div>
        {% endif %}
        
        {% if question.question_number < questions|length %}
        <button type="button" 
                class="btn-next"
                data-action="next-question"
                data-target="{{ question.question_number|add:1 }}">
            Next →
        </button>
        {% else %}
        <button type="button" 
                class="btn-review"
                data-action="review-test">
            Review & Submit
        </button>
        {% endif %}
    </div>
    {% endif %}
</div>